<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†è€…å¾Œå°</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #3498db; --success: #2ecc71; --warning: #f39c12; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; }
        .sidebar { width: 250px; background: white; position: fixed; height: 100vh; overflow-y: auto; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .main-content { margin-left: 250px; padding: 20px; }
        .logo { padding: 20px; text-align: center; border-bottom: 1px solid #eee; }
        .logo h2 { margin: 0; color: #2c3e50; }
        .nav-menu { padding: 20px 0; }
        .nav-item { padding: 15px 25px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: all 0.3s; }
        .nav-item:hover { background: #f8f9fa; }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-item i { font-size: 18px; }
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .card-title { font-size: 16px; color: #7f8c8d; margin-bottom: 10px; }
        .card-value { font-size: 32px; font-weight: bold; color: #2c3e50; }
        .card-change { font-size: 14px; margin-top: 5px; }
        .card-change.positive { color: var(--success); }
        .card-change.negative { color: var(--danger); }
        .section-title { font-size: 24px; color: #2c3e50; margin: 30px 0 20px; }
        .table-container { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 15px; text-align: left; font-weight: bold; color: #2c3e50; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f8f9fa; }
        .btn { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-small { padding: 5px 10px; font-size: 12px; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #f8d7da; color: #721c24; }
        .status-pending { background: #fff3cd; color: #856404; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; width: 90%; max-width: 600px; margin: 50px auto; border-radius: 15px; padding: 30px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title { font-size: 20px; font-weight: bold; color: #2c3e50; }
        .modal-close { cursor: pointer; font-size: 24px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: bold; color: #2c3e50; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .chart-container { height: 300px; margin-top: 20px; }
        .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: bold; }
        .search-box { flex: 1; max-width: 300px; }
        .hidden { display: none; }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
    </style>
</head>
<body>
    <!-- å´é‚Šæ¬„ -->
    <div class="sidebar">
        <div class="logo">
            <h2>ğŸ¢ ç®¡ç†è€…å¾Œå°</h2>
            <div style="font-size: 12px; color: #7f8c8d; margin-top: 5px;" id="admin-info"></div>
        </div>
        
        <div class="nav-menu">
            <div class="nav-item active" onclick="showSection('dashboard')">
                ğŸ“Š å„€è¡¨æ¿
            </div>
            <div class="nav-item" onclick="showSection('users')">
                ğŸ‘¥ ç”¨æˆ¶ç®¡ç†
            </div>
            <div class="nav-item" onclick="showSection('teams')">
                ğŸ† åœ˜éšŠç®¡ç†
            </div>
            <div class="nav-item" onclick="showSection('role-requests')">
                ğŸ”„ è§’è‰²ç”³è«‹
            </div>
            <div class="nav-item" onclick="showSection('points')">
                â­ ç©åˆ†ç®¡ç†
            </div>
            <div class="nav-item" onclick="showSection('tasks')">
                âœ… ä»»å‹™ç®¡ç†
            </div>
            <div class="nav-item" onclick="showSection('reports')">
                ğŸ“ˆ æ•¸æ“šå ±è¡¨
            </div>
            <div class="nav-item" onclick="showSection('audit')">
                ğŸ“‹ æ“ä½œæ—¥èªŒ
            </div>
            <div class="nav-item" onclick="showSection('settings')">
                âš™ï¸ ç³»çµ±è¨­å®š
            </div>
        </div>
        
        <div style="padding: 20px; position: absolute; bottom: 0; width: 100%;">
            <button class="btn" style="width: 100%; background: #f8f9fa;" onclick="window.location.href='index.html'">
                â† è¿”å›ä¸»é 
            </button>
        </div>
    </div>
    
    <!-- ä¸»è¦å…§å®¹å€ -->
    <div class="main-content">
        <!-- å„€è¡¨æ¿ -->
        <div id="dashboard-section">
            <h1 class="section-title">ğŸ“Š ç³»çµ±å„€è¡¨æ¿</h1>
            
            <!-- çµ±è¨ˆå¡ç‰‡ -->
            <div class="dashboard-cards">
                <div class="card">
                    <div class="card-title">ç¸½ç”¨æˆ¶æ•¸</div>
                    <div class="card-value" id="total-users">0</div>
                    <div class="card-change positive" id="user-change">+0 æœ¬é€±</div>
                </div>
                <div class="card">
                    <div class="card-title">æ´»èºåœ˜éšŠ</div>
                    <div class="card-value" id="active-teams">0</div>
                    <div class="card-change positive" id="team-change">+0 æœ¬é€±</div>
                </div>
                <div class="card">
                    <div class="card-title">å¾…å¯©ç”³è«‹</div>
                    <div class="card-value" id="pending-requests">0</div>
                    <div class="card-change negative" id="request-change">éœ€è™•ç†</div>
                </div>
                <div class="card">
                    <div class="card-title">ç¸½ç©åˆ†</div>
                    <div class="card-value" id="total-points">0</div>
                    <div class="card-change positive" id="points-change">+0 ä»Šæ—¥</div>
                </div>
            </div>
            
            <!-- åœ–è¡¨ -->
            <div class="card">
                <div class="card-title">ğŸ“ˆ ç”¨æˆ¶å¢é•·è¶¨å‹¢</div>
                <div class="chart-container">
                    <canvas id="growth-chart"></canvas>
                </div>
            </div>
            
            <!-- æœ€è¿‘æ´»å‹• -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-title">ğŸ• æœ€è¿‘æ´»å‹•</div>
                <div id="recent-activities">
                    <div class="loading">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
        </div>
        
        <!-- ç”¨æˆ¶ç®¡ç† -->
        <div id="users-section" class="hidden">
            <h1 class="section-title">ğŸ‘¥ ç”¨æˆ¶ç®¡ç†</h1>
            
            <div class="filter-bar">
                <input type="text" class="form-control search-box" placeholder="æœå°‹ç”¨æˆ¶..." oninput="searchUsers(this.value)">
                <select class="form-control" style="width: 150px;" onchange="filterUsersByRole(this.value)">
                    <option value="">æ‰€æœ‰è§’è‰²</option>
                    <option value="member">å­¸å“¡</option>
                    <option value="captain">éšŠé•·</option>
                    <option value="deputy">å‰¯éšŠé•·</option>
                    <option value="admin">ç®¡ç†å“¡</option>
                </select>
                <select class="form-control" style="width: 150px;" onchange="filterUsersByStatus(this.value)">
                    <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                    <option value="active">æ´»èº</option>
                    <option value="inactive">ä¸æ´»èº</option>
                    <option value="locked">å·²é–å®š</option>
                </select>
                <button class="btn btn-primary" onclick="exportUsers()">ğŸ“¥ åŒ¯å‡ºç”¨æˆ¶</button>
                <button class="btn btn-success" onclick="showAddUserModal()">â• æ–°å¢ç”¨æˆ¶</button>
            </div>
            
            <div class="table-container">
                <table id="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>å§“å</th>
                            <th>è§’è‰²</th>
                            <th>è¨ˆç•«</th>
                            <th>ç©åˆ†</th>
                            <th>éšŠä¼</th>
                            <th>ç‹€æ…‹</th>
                            <th>è¨»å†Šæ™‚é–“</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="9" class="loading">è¼‰å…¥ç”¨æˆ¶è³‡æ–™ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- åˆ†é æ§åˆ¶ -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                <div id="pagination-info">é¡¯ç¤º 0-0 å…± 0 ç­†</div>
                <div>
                    <button class="btn" onclick="changeUserPage(-1)">â† ä¸Šä¸€é </button>
                    <span style="margin: 0 10px;" id="current-page">1</span>
                    <button class="btn" onclick="changeUserPage(1)">ä¸‹ä¸€é  â†’</button>
                </div>
            </div>
        </div>
        
        <!-- åœ˜éšŠç®¡ç† -->
        <div id="teams-section" class="hidden">
            <h1 class="section-title">ğŸ† åœ˜éšŠç®¡ç†</h1>
            <!-- åœ˜éšŠç®¡ç†å…§å®¹ -->
        </div>
        
        <!-- è§’è‰²ç”³è«‹ -->
        <div id="role-requests-section" class="hidden">
            <h1 class="section-title">ğŸ”„ è§’è‰²ä¿®æ”¹ç”³è«‹</h1>
            <!-- è§’è‰²ç”³è«‹å…§å®¹ -->
        </div>
        
        <!-- å…¶ä»–éƒ¨åˆ†çœç•¥ä»¥ç¯€çœç¯‡å¹…... -->
    </div>
    
    <!-- æ–°å¢ç”¨æˆ¶æ¨¡æ…‹æ¡† -->
    <div id="add-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">â• æ–°å¢ç”¨æˆ¶</div>
                <div class="modal-close" onclick="closeModal('add-user-modal')">Ã—</div>
            </div>
            <!-- æ–°å¢ç”¨æˆ¶è¡¨å–® -->
        </div>
    </div>
    
    <!-- ç·¨è¼¯ç”¨æˆ¶æ¨¡æ…‹æ¡† -->
    <div id="edit-user-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">âœï¸ ç·¨è¼¯ç”¨æˆ¶</div>
                <div class="modal-close" onclick="closeModal('edit-user-modal')">Ã—</div>
            </div>
            <!-- ç·¨è¼¯ç”¨æˆ¶è¡¨å–® -->
        </div>
    </div>

    <div class="nav-item" onclick="showSection('admin-management')">
    ğŸ‘‘ ç®¡ç†å“¡ç®¡ç†
</div>

<!-- åœ¨ main-content ä¸­æ·»åŠ ç®¡ç†å“¡ç®¡ç†å€å¡Š -->
<div id="admin-management-section" class="hidden">
    <h1 class="section-title">ğŸ‘‘ ç®¡ç†å“¡æ¬Šé™ç®¡ç†</h1>
    
    <!-- éŒ¯èª¤é¡¯ç¤ºå€åŸŸ -->
    <div id="admin-error-container" class="hidden"></div>
    
    <!-- è¶…ç´šç®¡ç†å“¡å°ˆç”¨åŠŸèƒ½ -->
    <div id="super-admin-section" class="hidden">
        <div class="filter-bar">
            <input type="text" class="form-control search-box" placeholder="æœå°‹ç”¨æˆ¶..." oninput="searchAdmins(this.value)">
            <button class="btn btn-success" onclick="showAddAdminModal()">â• æ–°å¢ç®¡ç†å“¡</button>
            <button class="btn btn-warning" onclick="refreshAdminList()">ğŸ”„ é‡æ–°æ•´ç†</button>
        </div>
        
        <div class="card" style="margin-bottom: 20px; border-left: 5px solid #e74c3c;">
            <h3>âš ï¸ è¶…ç´šç®¡ç†å“¡å°ˆç”¨åŠŸèƒ½</h3>
            <p style="color: #7f8c8d;">åªæœ‰è¶…ç´šç®¡ç†å“¡å¯ä»¥ç®¡ç†å…¶ä»–ç®¡ç†å“¡çš„æ¬Šé™</p>
        </div>
        
        <div class="table-container">
            <table id="admins-table">
                <thead>
                    <tr>
                        <th>ç®¡ç†å“¡</th>
                        <th>è§’è‰²</th>
                        <th>é›»å­éƒµä»¶</th>
                        <th>æ¬Šé™</th>
                        <th>ç‹€æ…‹</th>
                        <th>æœ€å¾Œç™»å…¥</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="7" class="loading">è¼‰å…¥ç®¡ç†å“¡åˆ—è¡¨ä¸­...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- æ™®é€šç®¡ç†å“¡é¡¯ç¤ºå€åŸŸ -->
    <div id="regular-admin-section" class="hidden">
        <div class="card">
            <h3>ğŸ“‹ æ‚¨çš„ç®¡ç†å“¡æ¬Šé™</h3>
            <div id="current-admin-permissions" style="margin-top: 15px;">
                <div class="loading">è¼‰å…¥æ¬Šé™ä¸­...</div>
            </div>
        </div>
        
        <div class="card" style="margin-top: 20px;">
            <h3>ğŸ“ æ¬Šé™èªªæ˜</h3>
            <ul style="margin-top: 15px;">
                <li>âœ… <strong>ç®¡ç†å“¡ç®¡ç†</strong>ï¼šå¯ä»¥æ–°å¢/ç§»é™¤å…¶ä»–ç®¡ç†å“¡</li>
                <li>âœ… <strong>åœ˜éšŠç®¡ç†</strong>ï¼šå¯ä»¥ç®¡ç†æ‰€æœ‰åœ˜éšŠå’ŒéšŠé•·</li>
                <li>âœ… <strong>ç”¨æˆ¶ç®¡ç†</strong>ï¼šå¯ä»¥ç®¡ç†æ‰€æœ‰ç”¨æˆ¶è³‡æ–™</li>
                <li>âœ… <strong>æŸ¥çœ‹å ±è¡¨</strong>ï¼šå¯ä»¥æŸ¥çœ‹ç³»çµ±çµ±è¨ˆå ±è¡¨</li>
            </ul>
        </div>
    </div>
    
    <!-- æ–°å¢ç®¡ç†å“¡æ¨¡æ…‹æ¡† -->
    <div id="add-admin-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">â• æ–°å¢ç®¡ç†å“¡</div>
                <div class="modal-close" onclick="closeModal('add-admin-modal')">Ã—</div>
            </div>
            <div class="form-group">
                <label class="form-label">é¸æ“‡ç”¨æˆ¶</label>
                <select class="form-control" id="admin-user-select">
                    <option value="">è«‹é¸æ“‡ç”¨æˆ¶...</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">ç®¡ç†å“¡é¡å‹</label>
                <select class="form-control" id="admin-type">
                    <option value="admin">æ™®é€šç®¡ç†å“¡</option>
                    <option value="super_admin">è¶…ç´šç®¡ç†å“¡</option>
                </select>
                <small style="color: #7f8c8d; display: block; margin-top: 5px;">
                    è¶…ç´šç®¡ç†å“¡æ“æœ‰æ‰€æœ‰æ¬Šé™ï¼ŒåŒ…æ‹¬ç®¡ç†å…¶ä»–ç®¡ç†å“¡
                </small>
            </div>
            <div class="form-group">
                <label class="form-label">æ¬Šé™è¨­å®š</label>
                <div style="margin-top: 10px;">
                    <label style="display: block; margin-bottom: 8px;">
                        <input type="checkbox" id="perm-manage-teams" checked>
                        åœ˜éšŠç®¡ç†æ¬Šé™
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        <input type="checkbox" id="perm-manage-users" checked>
                        ç”¨æˆ¶ç®¡ç†æ¬Šé™
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        <input type="checkbox" id="perm-view-reports" checked>
                        æŸ¥çœ‹å ±è¡¨æ¬Šé™
                    </label>
                    <label style="display: block; margin-bottom: 8px;">
                        <input type="checkbox" id="perm-manage-admins" checked>
                        ç®¡ç†å“¡ç®¡ç†æ¬Šé™ (åƒ…è¶…ç´šç®¡ç†å“¡å¯ç”¨)
                    </label>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="addNewAdmin()">ç¢ºèªæ–°å¢</button>
                <button class="btn" style="flex: 1;" onclick="closeModal('add-admin-modal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <!-- ç·¨è¼¯ç®¡ç†å“¡æ¬Šé™æ¨¡æ…‹æ¡† -->
    <div id="edit-admin-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">âš™ï¸ ç·¨è¼¯ç®¡ç†å“¡æ¬Šé™</div>
                <div class="modal-close" onclick="closeModal('edit-admin-modal')">Ã—</div>
            </div>
            <div id="edit-admin-content">
                <!-- å‹•æ…‹å…§å®¹ -->
            </div>
        </div>
    </div>
</div>

<script>
    // Supabase é…ç½®
    const SUPABASE_URL = 'https://sdloakutxcsbshcqpxwn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbG9ha3V0eGNzYnNoY3FweHduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMTE4MjYsImV4cCI6MjA4MTY4NzgyNn0.5OBQQAinARnZQ6VSCrPl60NWmcSG-QiFMmVIJRW7g-0';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // å…¨å±€è®Šæ•¸
    let currentUser = null;
    let currentAdmin = null;
    let growthChart = null;
    
    // é é¢è¼‰å…¥
    window.onload = async () => {
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        const { data: { session } } = await sb.auth.getSession();
        if (!session) {
            alert('è«‹å…ˆç™»å…¥');
            window.location.href = 'index.html';
            return;
        }
        currentUser = session.user;
        
        // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
        await checkAdminPermission();
        
        // è¼‰å…¥å„€è¡¨æ¿æ•¸æ“š
        loadDashboardData();
        
        // è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨
        loadUsers();
    };

    // åœ¨ admin.html çš„ script ä¸­æ·»åŠ ä»¥ä¸‹å‡½æ•¸

// é¡¯ç¤ºç®¡ç†å“¡ç®¡ç†å€å¡Š
async function showAdminManagement() {
    const adminSection = document.getElementById('admin-management-section');
    const superAdminSection = document.getElementById('super-admin-section');
    const regularAdminSection = document.getElementById('regular-admin-section');
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºè¶…ç´šç®¡ç†å“¡
    const { data: currentProfile } = await sb
        .from('profiles')
        .select('role, is_super_admin')
        .eq('id', currentUser.id)
        .single();
    
    if (currentProfile.is_super_admin || currentProfile.role === 'super_admin') {
        superAdminSection.classList.remove('hidden');
        regularAdminSection.classList.add('hidden');
        loadAdminList();
    } else {
        superAdminSection.classList.add('hidden');
        regularAdminSection.classList.remove('hidden');
        loadCurrentAdminPermissions();
    }
}

// è¼‰å…¥ç®¡ç†å“¡åˆ—è¡¨ï¼ˆåƒ…è¶…ç´šç®¡ç†å“¡å¯è¦‹ï¼‰
async function loadAdminList() {
    const tableBody = document.querySelector('#admins-table tbody');
    tableBody.innerHTML = '<tr><td colspan="7" class="loading">è¼‰å…¥ä¸­...</td></tr>';
    
    try {
        // ç²å–æ‰€æœ‰ç®¡ç†å“¡
        const { data: admins, error } = await sb
            .from('profiles')
            .select(`
                *,
                admin_permissions(*)
            `)
            .in('role', ['admin', 'super_admin'])
            .order('is_super_admin', { ascending: false })
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        if (!admins || admins.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">æš«ç„¡å…¶ä»–ç®¡ç†å“¡</td></tr>';
            return;
        }
        
        let html = '';
        admins.forEach(admin => {
            const permissions = admin.admin_permissions?.[0] || {};
            const isCurrentUser = admin.id === currentUser.id;
            const isSuperAdmin = admin.is_super_admin || admin.role === 'super_admin';
            
            // æ ¼å¼åŒ–æ¬Šé™æ–‡å­—
            const permissionsText = isSuperAdmin ? 
                'æ‰€æœ‰æ¬Šé™ (è¶…ç´šç®¡ç†å“¡)' :
                [
                    permissions.can_manage_teams ? 'åœ˜éšŠç®¡ç†' : null,
                    permissions.can_manage_users ? 'ç”¨æˆ¶ç®¡ç†' : null,
                    permissions.can_view_reports ? 'æŸ¥çœ‹å ±è¡¨' : null,
                    permissions.can_manage_admins ? 'ç®¡ç†å“¡ç®¡ç†' : null
                ].filter(Boolean).join(', ');
            
            // ç²å–æœ€å¾Œç™»å…¥æ™‚é–“ï¼ˆéœ€è¦å•Ÿç”¨ Supabase çš„ç™»å…¥æ—¥èªŒåŠŸèƒ½ï¼‰
            const lastLogin = admin.last_sign_in_at ? 
                new Date(admin.last_sign_in_at).toLocaleString('zh-TW') : 'å¾æœªç™»å…¥';
            
            html += `
            <tr>
                <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <img src="${admin.avatar_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(admin.full_name || 'A') + '&background=random'}" 
                             style="width: 30px; height: 30px; border-radius: 50%;">
                        <div>
                            <div style="font-weight: bold;">${admin.full_name || 'æœªè¨­å®šå§“å'}</div>
                            ${isCurrentUser ? '<span style="font-size: 12px; color: var(--primary);">(æ‚¨è‡ªå·±)</span>' : ''}
                        </div>
                    </div>
                </td>
                <td>
                    <span class="status-badge ${isSuperAdmin ? 'status-active' : 'status-pending'}">
                        ${isSuperAdmin ? 'ğŸ‘‘ è¶…ç´šç®¡ç†å“¡' : 'ğŸ‘¨â€ğŸ’¼ ç®¡ç†å“¡'}
                    </span>
                </td>
                <td>${admin.email || 'æœªè¨­å®š'}</td>
                <td style="font-size: 12px;">${permissionsText || 'æœªè¨­å®šæ¬Šé™'}</td>
                <td>
                    <span class="status-badge ${admin.is_locked ? 'status-inactive' : 'status-active'}">
                        ${admin.is_locked ? 'å·²åœç”¨' : 'æ­£å¸¸'}
                    </span>
                </td>
                <td style="font-size: 12px;">${lastLogin}</td>
                <td>
                    ${!isCurrentUser ? `
                    <button class="btn btn-small btn-primary" onclick="editAdminPermissions('${admin.id}')">
                        ç·¨è¼¯æ¬Šé™
                    </button>
                    <button class="btn btn-small ${admin.is_locked ? 'btn-success' : 'btn-warning'}" 
                            onclick="toggleAdminStatus('${admin.id}', ${admin.is_locked})">
                        ${admin.is_locked ? 'å•Ÿç”¨' : 'åœç”¨'}
                    </button>
                    <button class="btn btn-small btn-danger" onclick="removeAdmin('${admin.id}', '${admin.full_name}')">
                        ç§»é™¤
                    </button>
                    ` : '<span style="color: #7f8c8d;">ä¸å¯æ“ä½œè‡ªå·±</span>'}
                </td>
            </tr>`;
        });
        
        tableBody.innerHTML = html;
        
    } catch (error) {
        console.error('è¼‰å…¥ç®¡ç†å“¡åˆ—è¡¨éŒ¯èª¤:', error);
        tableBody.innerHTML = '<tr><td colspan="7" style="color: #e74c3c;">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</td></tr>';
    }
}

// è¼‰å…¥ç•¶å‰ç®¡ç†å“¡æ¬Šé™
async function loadCurrentAdminPermissions() {
    const container = document.getElementById('current-admin-permissions');
    
    try {
        const { data: profile } = await sb
            .from('profiles')
            .select('role, is_super_admin')
            .eq('id', currentUser.id)
            .single();
        
        const { data: permissions } = await sb
            .from('admin_permissions')
            .select('*')
            .eq('admin_id', currentUser.id)
            .maybeSingle();
        
        const isSuperAdmin = profile.is_super_admin || profile.role === 'super_admin';
        
        let html = '';
        if (isSuperAdmin) {
            html = `
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px;">
                <h4 style="margin: 0 0 10px 0;">ğŸ‘‘ è¶…ç´šç®¡ç†å“¡</h4>
                <p style="margin: 0;">æ‚¨æ“æœ‰ç³»çµ±æ‰€æœ‰æ¬Šé™ï¼ŒåŒ…æ‹¬ç®¡ç†å…¶ä»–ç®¡ç†å“¡</p>
            </div>`;
        } else if (permissions) {
            html = `
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                <div style="background: #e8f4fc; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px;">${permissions.can_manage_teams ? 'âœ…' : 'âŒ'}</div>
                    <div>åœ˜éšŠç®¡ç†</div>
                </div>
                <div style="background: #e8f4fc; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px;">${permissions.can_manage_users ? 'âœ…' : 'âŒ'}</div>
                    <div>ç”¨æˆ¶ç®¡ç†</div>
                </div>
                <div style="background: #e8f4fc; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px;">${permissions.can_view_reports ? 'âœ…' : 'âŒ'}</div>
                    <div>æŸ¥çœ‹å ±è¡¨</div>
                </div>
                <div style="background: #e8f4fc; padding: 15px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 24px;">${permissions.can_manage_admins ? 'âœ…' : 'âŒ'}</div>
                    <div>ç®¡ç†å“¡ç®¡ç†</div>
                </div>
            </div>`;
        } else {
            html = '<div style="color: #7f8c8d;">æš«ç„¡æ¬Šé™è¨­å®š</div>';
        }
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('è¼‰å…¥æ¬Šé™éŒ¯èª¤:', error);
        container.innerHTML = '<div style="color: #e74c3c;">è¼‰å…¥å¤±æ•—</div>';
    }
}

// é¡¯ç¤ºæ–°å¢ç®¡ç†å“¡æ¨¡æ…‹æ¡†
async function showAddAdminModal() {
    const modal = document.getElementById('add-admin-modal');
    const userSelect = document.getElementById('admin-user-select');
    
    // æ¸…ç©ºé¸é …
    userSelect.innerHTML = '<option value="">è«‹é¸æ“‡ç”¨æˆ¶...</option>';
    
    try {
        // ç²å–æ‰€æœ‰éç®¡ç†å“¡ç”¨æˆ¶
        const { data: users, error } = await sb
            .from('profiles')
            .select('id, full_name, email, role')
            .not('role', 'in', '("admin","super_admin")')
            .order('full_name');
        
        if (error) throw error;
        
        if (!users || users.length === 0) {
            userSelect.innerHTML += '<option value="" disabled>æš«ç„¡å¯ç”¨ç”¨æˆ¶</option>';
        } else {
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.full_name || 'æœªå‘½å'} (${user.email}) - ${user.role}`;
                userSelect.appendChild(option);
            });
        }
        
        modal.style.display = 'block';
        
    } catch (error) {
        console.error('è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨éŒ¯èª¤:', error);
        alert('ç„¡æ³•è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨: ' + error.message);
    }
}

// æ–°å¢ç®¡ç†å“¡
async function addNewAdmin() {
    const userId = document.getElementById('admin-user-select').value;
    const adminType = document.getElementById('admin-type').value;
    const isSuperAdmin = adminType === 'super_admin';
    
    if (!userId) {
        alert('è«‹é¸æ“‡ç”¨æˆ¶');
        return;
    }
    
    // ç²å–æ¬Šé™è¨­å®š
    const permissions = {
        can_manage_teams: document.getElementById('perm-manage-teams').checked,
        can_manage_users: document.getElementById('perm-manage-users').checked,
        can_view_reports: document.getElementById('perm-view-reports').checked,
        can_manage_admins: isSuperAdmin ? true : document.getElementById('perm-manage-admins').checked
    };
    
    try {
        // é–‹å§‹äº‹å‹™
        // 1. æ›´æ–°ç”¨æˆ¶è§’è‰²
        const { error: updateError } = await sb
            .from('profiles')
            .update({
                role: adminType,
                is_super_admin: isSuperAdmin,
                last_modified_by: currentUser.id,
                last_modified_at: new Date().toISOString()
            })
            .eq('id', userId);
        
        if (updateError) throw updateError;
        
        // 2. è¨­å®šæ¬Šé™
        const { error: permError } = await sb
            .from('admin_permissions')
            .upsert({
                admin_id: userId,
                ...permissions,
                updated_at: new Date().toISOString()
            });
        
        if (permError) throw permError;
        
        // 3. è¨˜éŒ„å¯©æ ¸æ—¥èªŒ
        await sb.from('audit_logs').insert([{
            user_id: currentUser.id,
            action: 'ADD_ADMIN',
            resource_type: 'USER',
            resource_id: userId,
            details: {
                admin_type: adminType,
                permissions: permissions,
                is_super_admin: isSuperAdmin
            }
        }]);
        
        alert('âœ… ç®¡ç†å“¡å·²æˆåŠŸæ–°å¢ï¼');
        closeModal('add-admin-modal');
        loadAdminList();
        
    } catch (error) {
        console.error('æ–°å¢ç®¡ç†å“¡éŒ¯èª¤:', error);
        alert('æ–°å¢å¤±æ•—: ' + error.message);
    }
}

// ç·¨è¼¯ç®¡ç†å“¡æ¬Šé™
async function editAdminPermissions(adminId) {
    try {
        // ç²å–ç®¡ç†å“¡è³‡æ–™
        const { data: admin, error } = await sb
            .from('profiles')
            .select(`
                *,
                admin_permissions(*)
            `)
            .eq('id', adminId)
            .single();
        
        if (error) throw error;
        
        const permissions = admin.admin_permissions?.[0] || {};
        const isSuperAdmin = admin.is_super_admin || admin.role === 'super_admin';
        
        const modal = document.getElementById('edit-admin-modal');
        const content = document.getElementById('edit-admin-content');
        
        // ç”Ÿæˆæ¬Šé™è¨­å®šè¡¨å–®
        content.innerHTML = `
            <form onsubmit="updateAdminPermissions(event, '${adminId}')">
                <div class="form-group">
                    <label class="form-label">ç®¡ç†å“¡åç¨±</label>
                    <input type="text" class="form-control" value="${admin.full_name || 'æœªè¨­å®š'}" disabled>
                </div>
                
                <div class="form-group">
                    <label class="form-label">é›»å­éƒµä»¶</label>
                    <input type="email" class="form-control" value="${admin.email || 'æœªè¨­å®š'}" disabled>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ç®¡ç†å“¡é¡å‹</label>
                    <div>
                        <span class="status-badge ${isSuperAdmin ? 'status-active' : 'status-pending'}" style="margin-right: 10px;">
                            ${isSuperAdmin ? 'ğŸ‘‘ è¶…ç´šç®¡ç†å“¡' : 'ğŸ‘¨â€ğŸ’¼ ç®¡ç†å“¡'}
                        </span>
                        ${isSuperAdmin ? 
                            '<small style="color: #7f8c8d;">ï¼ˆè¶…ç´šç®¡ç†å“¡ç„¡æ³•æ›´æ”¹é¡å‹ï¼‰</small>' :
                            `<button type="button" class="btn btn-small btn-warning" onclick="toggleSuperAdmin('${adminId}', ${isSuperAdmin})" style="margin-left: 10px;">
                                ${isSuperAdmin ? 'é™ç‚ºæ™®é€šç®¡ç†å“¡' : 'å‡ç‚ºè¶…ç´šç®¡ç†å“¡'}
                            </button>`
                        }
                    </div>
                </div>
                
                <div class="form-group" ${isSuperAdmin ? 'style="display: none;"' : ''}>
                    <label class="form-label">æ¬Šé™è¨­å®š</label>
                    <div style="margin-top: 10px;">
                        <label style="display: block; margin-bottom: 8px;">
                            <input type="checkbox" id="edit-perm-teams" ${permissions.can_manage_teams ? 'checked' : ''}>
                            åœ˜éšŠç®¡ç†æ¬Šé™
                        </label>
                        <label style="display: block; margin-bottom: 8px;">
                            <input type="checkbox" id="edit-perm-users" ${permissions.can_manage_users ? 'checked' : ''}>
                            ç”¨æˆ¶ç®¡ç†æ¬Šé™
                        </label>
                        <label style="display: block; margin-bottom: 8px;">
                            <input type="checkbox" id="edit-perm-reports" ${permissions.can_view_reports ? 'checked' : ''}>
                            æŸ¥çœ‹å ±è¡¨æ¬Šé™
                        </label>
                        <label style="display: block; margin-bottom: 8px;">
                            <input type="checkbox" id="edit-perm-admins" ${permissions.can_manage_admins ? 'checked' : ''}>
                            ç®¡ç†å“¡ç®¡ç†æ¬Šé™
                        </label>
                    </div>
                </div>
                
                ${isSuperAdmin ? 
                    '<div class="form-group"><p style="color: #7f8c8d;">è¶…ç´šç®¡ç†å“¡æ“æœ‰æ‰€æœ‰æ¬Šé™ï¼Œç„¡æ³•å–®ç¨è¨­å®šã€‚</p></div>' : ''
                }
                
                <div class="form-group">
                    <label class="form-label">ä¿®æ”¹åŸå› </label>
                    <textarea class="form-control" id="edit-reason" rows="3" placeholder="è«‹èªªæ˜ä¿®æ”¹æ¬Šé™çš„åŸå› ..." required></textarea>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">å„²å­˜è®Šæ›´</button>
                    <button type="button" class="btn" onclick="closeModal('edit-admin-modal')" style="flex: 1;">å–æ¶ˆ</button>
                </div>
            </form>
        `;
        
        modal.style.display = 'block';
        
    } catch (error) {
        console.error('ç·¨è¼¯ç®¡ç†å“¡æ¬Šé™éŒ¯èª¤:', error);
        alert('ç„¡æ³•è¼‰å…¥ç®¡ç†å“¡è³‡æ–™: ' + error.message);
    }
}

// æ›´æ–°ç®¡ç†å“¡æ¬Šé™
async function updateAdminPermissions(event, adminId) {
    event.preventDefault();
    
    const reason = document.getElementById('edit-reason').value;
    if (!reason.trim()) {
        alert('è«‹å¡«å¯«ä¿®æ”¹åŸå› ');
        return;
    }
    
    try {
        // æª¢æŸ¥æ˜¯å¦ç‚ºè¶…ç´šç®¡ç†å“¡
        const { data: admin } = await sb
            .from('profiles')
            .select('is_super_admin, role')
            .eq('id', adminId)
            .single();
        
        const isSuperAdmin = admin.is_super_admin || admin.role === 'super_admin';
        
        let updateData = {};
        
        if (!isSuperAdmin) {
            // ç²å–æ¬Šé™è¨­å®š
            updateData = {
                can_manage_teams: document.getElementById('edit-perm-teams').checked,
                can_manage_users: document.getElementById('edit-perm-users').checked,
                can_view_reports: document.getElementById('edit-perm-reports').checked,
                can_manage_admins: document.getElementById('edit-perm-admins').checked,
                updated_at: new Date().toISOString()
            };
            
            // æ›´æ–°æ¬Šé™è¡¨
            const { error } = await sb
                .from('admin_permissions')
                .update(updateData)
                .eq('admin_id', adminId);
            
            if (error) throw error;
        }
        
        // è¨˜éŒ„å¯©æ ¸æ—¥èªŒ
        await sb.from('audit_logs').insert([{
            user_id: currentUser.id,
            action: 'UPDATE_ADMIN_PERMISSIONS',
            resource_type: 'USER',
            resource_id: adminId,
            details: {
                reason: reason,
                changes: updateData,
                is_super_admin: isSuperAdmin
            }
        }]);
        
        alert('âœ… æ¬Šé™å·²æ›´æ–°ï¼');
        closeModal('edit-admin-modal');
        loadAdminList();
        
    } catch (error) {
        console.error('æ›´æ–°æ¬Šé™éŒ¯èª¤:', error);
        alert('æ›´æ–°å¤±æ•—: ' + error.message);
    }
}

// åˆ‡æ›è¶…ç´šç®¡ç†å“¡ç‹€æ…‹
async function toggleSuperAdmin(adminId, isCurrentlySuperAdmin) {
    const action = isCurrentlySuperAdmin ? 'é™ç‚ºæ™®é€šç®¡ç†å“¡' : 'å‡ç‚ºè¶…ç´šç®¡ç†å“¡';
    const reason = prompt(`è«‹è¼¸å…¥${action}çš„åŸå› ï¼š`);
    
    if (reason === null) return;
    
    try {
        const { error } = await sb
            .from('profiles')
            .update({
                role: isCurrentlySuperAdmin ? 'admin' : 'super_admin',
                is_super_admin: !isCurrentlySuperAdmin,
                last_modified_by: currentUser.id,
                last_modified_at: new Date().toISOString()
            })
            .eq('id', adminId);
        
        if (error) throw error;
        
        // å¦‚æœæ˜¯å‡ç‚ºè¶…ç´šç®¡ç†å“¡ï¼Œè¨­å®šå®Œæ•´æ¬Šé™
        if (!isCurrentlySuperAdmin) {
            await sb.from('admin_permissions').upsert({
                admin_id: adminId,
                can_manage_admins: true,
                can_manage_teams: true,
                can_manage_users: true,
                can_view_reports: true,
                updated_at: new Date().toISOString()
            });
        }
        
        // è¨˜éŒ„å¯©æ ¸æ—¥èªŒ
        await sb.from('audit_logs').insert([{
            user_id: currentUser.id,
            action: 'CHANGE_SUPER_ADMIN',
            resource_type: 'USER',
            resource_id: adminId,
            details: {
                action: action,
                reason: reason,
                new_status: !isCurrentlySuperAdmin
            }
        }]);
        
        alert(`ç®¡ç†å“¡å·²${action}`);
        closeModal('edit-admin-modal');
        loadAdminList();
        
    } catch (error) {
        console.error('åˆ‡æ›è¶…ç´šç®¡ç†å“¡éŒ¯èª¤:', error);
        alert(`${action}å¤±æ•—: ${error.message}`);
    }
}

// åˆ‡æ›ç®¡ç†å“¡ç‹€æ…‹ï¼ˆå•Ÿç”¨/åœç”¨ï¼‰
async function toggleAdminStatus(adminId, isCurrentlyLocked) {
    const action = isCurrentlyLocked ? 'å•Ÿç”¨' : 'åœç”¨';
    const reason = prompt(`è«‹è¼¸å…¥${action}æ­¤ç®¡ç†å“¡çš„åŸå› ï¼š`);
    
    if (reason === null) return;
    
    try {
        const { error } = await sb
            .from('profiles')
            .update({
                is_locked: !isCurrentlyLocked,
                locked_by: currentUser.id,
                locked_at: new Date().toISOString()
            })
            .eq('id', adminId);
        
        if (error) throw error;
        
        // è¨˜éŒ„å¯©æ ¸æ—¥èªŒ
        await sb.from('audit_logs').insert([{
            user_id: currentUser.id,
            action: 'TOGGLE_ADMIN_STATUS',
            resource_type: 'USER',
            resource_id: adminId,
            details: {
                action: action,
                reason: reason,
                new_status: !isCurrentlyLocked
            }
        }]);
        
        alert(`ç®¡ç†å“¡å·²${action}`);
        loadAdminList();
        
    } catch (error) {
        console.error('åˆ‡æ›ç®¡ç†å“¡ç‹€æ…‹éŒ¯èª¤:', error);
        alert(`${action}å¤±æ•—: ${error.message}`);
    }
}

// ç§»é™¤ç®¡ç†å“¡
async function removeAdmin(adminId, adminName) {
    if (!confirm(`ç¢ºå®šè¦å°‡ã€Œ${adminName}ã€ç§»é™¤ç®¡ç†å“¡è·å‹™å—ï¼Ÿ\n\næ­¤æ“ä½œæœƒå°‡å…¶é™ç´šç‚ºæ™®é€šç”¨æˆ¶ã€‚`)) {
        return;
    }
    
    const reason = prompt('è«‹è¼¸å…¥ç§»é™¤ç®¡ç†å“¡çš„åŸå› ï¼š');
    if (reason === null) return;
    
    try {
        // æ›´æ–°ç”¨æˆ¶è§’è‰²ç‚º member
        const { error } = await sb
            .from('profiles')
            .update({
                role: 'member',
                is_super_admin: false,
                last_modified_by: currentUser.id,
                last_modified_at: new Date().toISOString()
            })
            .eq('id', adminId);
        
        if (error) throw error;
        
        // åˆªé™¤æ¬Šé™è¨˜éŒ„
        await sb
            .from('admin_permissions')
            .delete()
            .eq('admin_id', adminId);
        
        // è¨˜éŒ„å¯©æ ¸æ—¥èªŒ
        await sb.from('audit_logs').insert([{
            user_id: currentUser.id,
            action: 'REMOVE_ADMIN',
            resource_type: 'USER',
            resource_id: adminId,
            details: {
                reason: reason,
                previous_role: 'admin'
            }
        }]);
        
        alert('âœ… ç®¡ç†å“¡å·²ç§»é™¤');
        loadAdminList();
        
    } catch (error) {
        console.error('ç§»é™¤ç®¡ç†å“¡éŒ¯èª¤:', error);
        alert('ç§»é™¤å¤±æ•—: ' + error.message);
    }
}

// æœå°‹ç®¡ç†å“¡
function searchAdmins(keyword) {
    const tableBody = document.querySelector('#admins-table tbody');
    const rows = tableBody.querySelectorAll('tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(keyword.toLowerCase())) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// é‡æ–°æ•´ç†ç®¡ç†å“¡åˆ—è¡¨
function refreshAdminList() {
    loadAdminList();
}

// åœ¨ checkAdminPermission å‡½æ•¸ä¸­æª¢æŸ¥è¶…ç´šç®¡ç†å“¡æ¬Šé™
async function checkAdminPermission() {
    try {
        const { data: profile, error } = await sb
            .from('profiles')
            .select('role, is_super_admin, full_name')
            .eq('id', currentUser.id)
            .single();
        
        if (error) throw error;
        
        // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡æˆ–è¶…ç´šç®¡ç†å“¡
        if (profile.role !== 'admin' && profile.role !== 'super_admin' && !profile.is_super_admin) {
            alert('åªæœ‰ç®¡ç†å“¡å¯ä»¥è¨ªå•æ­¤é é¢');
            window.location.href = 'index.html';
            return;
        }
        
        currentAdmin = profile;
        let adminTitle = 'ç®¡ç†å“¡';
        
        if (profile.is_super_admin || profile.role === 'super_admin') {
            adminTitle = 'ğŸ‘‘ è¶…ç´šç®¡ç†å“¡';
        }
        
        document.getElementById('admin-info').innerHTML = 
            `${adminTitle}: ${profile.full_name} <br><small style="font-size: 10px;">${currentUser.email}</small>`;
        
    } catch (error) {
        console.error('æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™éŒ¯èª¤:', error);
        alert('ç„¡æ³•é©—è­‰ç®¡ç†å“¡æ¬Šé™');
        window.location.href = 'index.html';
    }
}
    
    // æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™
    async function checkAdminPermission() {
        try {
            const { data: profile, error } = await sb
                .from('profiles')
                .select('role, full_name')
                .eq('id', currentUser.id)
                .single();
            
            if (error) throw error;
            
            if (profile.role !== 'admin') {
                alert('åªæœ‰ç®¡ç†å“¡å¯ä»¥è¨ªå•æ­¤é é¢');
                window.location.href = 'index.html';
                return;
            }
            
            currentAdmin = profile;
            document.getElementById('admin-info').textContent = `ç®¡ç†å“¡: ${profile.full_name}`;
            
        } catch (error) {
            console.error('æª¢æŸ¥ç®¡ç†å“¡æ¬Šé™éŒ¯èª¤:', error);
            alert('ç„¡æ³•é©—è­‰ç®¡ç†å“¡æ¬Šé™');
            window.location.href = 'index.html';
        }
    }
    
    // é¡¯ç¤º/éš±è—å€å¡Š
    function showSection(sectionId) {
        // éš±è—æ‰€æœ‰å€å¡Š
        document.querySelectorAll('[id$="-section"]').forEach(section => {
            section.classList.add('hidden');
        });
        
        // é¡¯ç¤ºç›®æ¨™å€å¡Š
        document.getElementById(sectionId + '-section').classList.remove('hidden');
        
        // æ›´æ–°å°èˆªé¸é …
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // æ ¹æ“šå€å¡Šè¼‰å…¥æ•¸æ“š
        switch(sectionId) {
            case 'dashboard':
                loadDashboardData();
                break;
            case 'users':
                loadUsers();
                break;
            case 'role-requests':
                loadRoleRequests();
                break;
            // å…¶ä»–å€å¡Š...
        }
    }
    
    // è¼‰å…¥å„€è¡¨æ¿æ•¸æ“š
    async function loadDashboardData() {
        try {
            // è¼‰å…¥ç¸½ç”¨æˆ¶æ•¸
            const { count: totalUsers } = await sb
                .from('profiles')
                .select('*', { count: 'exact', head: true });
            
            document.getElementById('total-users').textContent = totalUsers || 0;
            
            // è¼‰å…¥æœ¬é€±æ–°å¢ç”¨æˆ¶
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            const { count: weeklyUsers } = await sb
                .from('profiles')
                .select('*', { count: 'exact', head: true })
                .gte('created_at', weekAgo.toISOString());
            
            document.getElementById('user-change').textContent = `+${weeklyUsers || 0} æœ¬é€±`;
            
            // è¼‰å…¥åœ˜éšŠæ•¸æ“š
            const { count: totalTeams } = await sb
                .from('teams')
                .select('*', { count: 'exact', head: true });
            
            document.getElementById('active-teams').textContent = totalTeams || 0;
            
            // è¼‰å…¥å¾…å¯©ç”³è«‹
            const { count: pendingRequests } = await sb
                .from('role_change_requests')
                .select('*', { count: 'exact', head: true })
                .eq('status', 'pending');
            
            document.getElementById('pending-requests').textContent = pendingRequests || 0;
            
            // è¼‰å…¥ç¸½ç©åˆ†
            const { data: pointsData } = await sb
                .from('profiles')
                .select('points');
            
            const totalPoints = pointsData?.reduce((sum, user) => sum + (user.points || 0), 0) || 0;
            document.getElementById('total-points').textContent = totalPoints;
            
            // è¼‰å…¥åœ–è¡¨æ•¸æ“š
            await loadGrowthChart();
            
            // è¼‰å…¥æœ€è¿‘æ´»å‹•
            await loadRecentActivities();
            
        } catch (error) {
            console.error('è¼‰å…¥å„€è¡¨æ¿æ•¸æ“šéŒ¯èª¤:', error);
        }
    }
    
    // è¼‰å…¥å¢é•·åœ–è¡¨
    async function loadGrowthChart() {
        try {
            // ç²å–éå»30å¤©çš„æ•¸æ“š
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const { data: growthData } = await sb
                .from('profiles')
                .select('created_at')
                .gte('created_at', thirtyDaysAgo.toISOString());
            
            // è™•ç†æ•¸æ“š
            const dailyCounts = {};
            growthData?.forEach(user => {
                const date = new Date(user.created_at).toLocaleDateString('zh-TW');
                dailyCounts[date] = (dailyCounts[date] || 0) + 1;
            });
            
            // æ’åºæ—¥æœŸ
            const dates = Object.keys(dailyCounts).sort();
            const counts = dates.map(date => dailyCounts[date]);
            
            // å‰µå»ºç´¯ç©æ•¸æ“š
            const cumulativeCounts = [];
            let cumulative = 0;
            counts.forEach(count => {
                cumulative += count;
                cumulativeCounts.push(cumulative);
            });
            
            // æ¸²æŸ“åœ–è¡¨
            const ctx = document.getElementById('growth-chart').getContext('2d');
            
            if (growthChart) {
                growthChart.destroy();
            }
            
            growthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'æ¯æ—¥æ–°å¢',
                        data: counts,
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'ç´¯ç©ç”¨æˆ¶',
                        data: cumulativeCounts,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
            
        } catch (error) {
            console.error('è¼‰å…¥åœ–è¡¨æ•¸æ“šéŒ¯èª¤:', error);
        }
    }
    
    // è¼‰å…¥æœ€è¿‘æ´»å‹•
    async function loadRecentActivities() {
        try {
            const { data: activities } = await sb
                .from('audit_logs')
                .select(`
                    *,
                    user:profiles(full_name)
                `)
                .order('created_at', { ascending: false })
                .limit(10);
            
            const container = document.getElementById('recent-activities');
            if (!activities || activities.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #7f8c8d;">æš«ç„¡æ´»å‹•è¨˜éŒ„</div>';
                return;
            }
            
            let html = '';
            activities.forEach(activity => {
                const time = new Date(activity.created_at).toLocaleString('zh-TW');
                const actionMap = {
                    'REQUEST_ROLE_CHANGE': 'æäº¤è§’è‰²ä¿®æ”¹ç”³è«‹',
                    'ADMIN_ROLE_CHANGE': 'ç®¡ç†å“¡ä¿®æ”¹è§’è‰²',
                    'USER_CREATED': 'å‰µå»ºæ–°ç”¨æˆ¶',
                    'USER_UPDATED': 'æ›´æ–°ç”¨æˆ¶è³‡æ–™',
                    'TEAM_CREATED': 'å‰µå»ºåœ˜éšŠ',
                    'TASK_COMPLETED': 'å®Œæˆä»»å‹™'
                };
                
                html += `
                <div style="padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                    <div style="font-weight: bold;">${activity.user?.full_name || 'ç³»çµ±'}</div>
                    <div style="font-size: 14px; color: #7f8c8d;">${actionMap[activity.action] || activity.action}</div>
                    <div style="font-size: 12px; color: #95a5a6;">${time}</div>
                </div>`;
            });
            
            container.innerHTML = html;
            
        } catch (error) {
            console.error('è¼‰å…¥æœ€è¿‘æ´»å‹•éŒ¯èª¤:', error);
        }
    }
    
    // ç”¨æˆ¶ç®¡ç†ç›¸é—œå‡½æ•¸
    let currentPage = 1;
    const pageSize = 20;
    let allUsers = [];
    let filteredUsers = [];
    
    // è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨
    async function loadUsers() {
        try {
            const { data: users, error } = await sb
                .from('profiles')
                .select(`
                    *,
                    team:teams(team_name)
                `)
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            
            allUsers = users || [];
            filteredUsers = [...allUsers];
            renderUsersTable();
            
        } catch (error) {
            console.error('è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨éŒ¯èª¤:', error);
            document.querySelector('#users-table tbody').innerHTML = 
                '<tr><td colspan="9" style="color: #e74c3c;">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</td></tr>';
        }
    }
    
    // æ¸²æŸ“ç”¨æˆ¶è¡¨æ ¼
    function renderUsersTable() {
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const pageUsers = filteredUsers.slice(startIndex, endIndex);
        
        const tbody = document.querySelector('#users-table tbody');
        let html = '';
        
        if (pageUsers.length === 0) {
            html = '<tr><td colspan="9" style="text-align: center;">æš«ç„¡ç”¨æˆ¶è³‡æ–™</td></tr>';
        } else {
            pageUsers.forEach(user => {
                const roleNames = {
                    'member': 'å­¸å“¡',
                    'captain': 'éšŠé•·',
                    'deputy': 'å‰¯éšŠé•·',
                    'admin': 'ç®¡ç†å“¡'
                };
                
                const planNames = {
                    'slow_run': 'æ…¢è·‘',
                    'fast_run': 'å¿«è·‘',
                    'vip': 'VIP'
                };
                
                const statusClass = user.is_locked ? 'status-inactive' : 'status-active';
                const statusText = user.is_locked ? 'å·²é–å®š' : 'æ´»èº';
                
                html += `
                <tr>
                    <td>${user.id.substring(0, 8)}...</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <img src="${user.avatar_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.full_name || 'U') + '&background=random'}" 
                                 style="width: 30px; height: 30px; border-radius: 50%;">
                            ${user.full_name || 'æœªè¨­å®š'}
                        </div>
                    </td>
                    <td>${roleNames[user.role] || user.role}</td>
                    <td>${planNames[user.plan] || user.plan}</td>
                    <td><strong>${user.points || 0}</strong></td>
                    <td>${user.team?.team_name || 'ç„¡éšŠä¼'}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${new Date(user.created_at).toLocaleDateString('zh-TW')}</td>
                    <td>
                        <button class="btn btn-small btn-primary" onclick="editUser('${user.id}')">ç·¨è¼¯</button>
                        <button class="btn btn-small ${user.is_locked ? 'btn-success' : 'btn-warning'}" 
                                onclick="toggleUserLock('${user.id}', ${user.is_locked})">
                            ${user.is_locked ? 'è§£é–' : 'é–å®š'}
                        </button>
                    </td>
                </tr>`;
            });
        }
        
        tbody.innerHTML = html;
        
        // æ›´æ–°åˆ†é è³‡è¨Š
        document.getElementById('pagination-info').textContent = 
            `é¡¯ç¤º ${startIndex + 1}-${Math.min(endIndex, filteredUsers.length)} å…± ${filteredUsers.length} ç­†`;
        document.getElementById('current-page').textContent = currentPage;
    }
    
    // æœå°‹ç”¨æˆ¶
    function searchUsers(keyword) {
        if (!keyword.trim()) {
            filteredUsers = [...allUsers];
        } else {
            filteredUsers = allUsers.filter(user => 
                (user.full_name && user.full_name.includes(keyword)) ||
                (user.email && user.email.includes(keyword))
            );
        }
        currentPage = 1;
        renderUsersTable();
    }
    
    // æ ¹æ“šè§’è‰²ç¯©é¸ç”¨æˆ¶
    function filterUsersByRole(role) {
        if (!role) {
            filteredUsers = [...allUsers];
        } else {
            filteredUsers = allUsers.filter(user => user.role === role);
        }
        currentPage = 1;
        renderUsersTable();
    }
    
    // æ ¹æ“šç‹€æ…‹ç¯©é¸ç”¨æˆ¶
    function filterUsersByStatus(status) {
        if (!status) {
            filteredUsers = [...allUsers];
        } else if (status === 'locked') {
            filteredUsers = allUsers.filter(user => user.is_locked);
        } else if (status === 'active') {
            filteredUsers = allUsers.filter(user => !user.is_locked);
        }
        currentPage = 1;
        renderUsersTable();
    }
    
    // åˆ‡æ›ç”¨æˆ¶é–å®šç‹€æ…‹
    async function toggleUserLock(userId, isCurrentlyLocked) {
        const action = isCurrentlyLocked ? 'è§£é–' : 'é–å®š';
        const reason = prompt(`è«‹è¼¸å…¥${action}æ­¤ç”¨æˆ¶çš„åŸå› ï¼š`);
        
        if (reason === null) return; // ç”¨æˆ¶å–æ¶ˆ
        
        try {
            const { error } = await sb
                .from('profiles')
                .update({
                    is_locked: !isCurrentlyLocked,
                    locked_by: currentUser.id,
                    locked_at: new Date().toISOString()
                })
                .eq('id', userId);
            
            if (error) throw error;
            
            // è¨˜éŒ„å¯©æ ¸æ—¥èªŒ
            await sb.from('audit_logs').insert([{
                user_id: currentUser.id,
                action: 'USER_LOCK_TOGGLE',
                resource_type: 'USER',
                resource_id: userId,
                details: { 
                    action: action,
                    reason: reason,
                    new_status: !isCurrentlyLocked
                }
            }]);
            
            alert(`ç”¨æˆ¶å·²${action}`);
            loadUsers(); // é‡æ–°è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨
            
        } catch (error) {
            console.error(`åˆ‡æ›ç”¨æˆ¶é–å®šç‹€æ…‹éŒ¯èª¤:`, error);
            alert(`${action}å¤±æ•—: ${error.message}`);
        }
    }
    
    // ç·¨è¼¯ç”¨æˆ¶
    // ä¿®æ”¹ editUser å‡½æ•¸ï¼Œå…è¨±ç®¡ç†å“¡ä¿®æ”¹è§’è‰²
async function editUser(userId) {
    try {
        const { data: user, error } = await sb
            .from('profiles')
            .select('*, team:teams(team_name)')
            .eq('id', userId)
            .single();
        
        if (error) throw error;
        
        // æª¢æŸ¥ç•¶å‰ç®¡ç†å“¡æ¬Šé™
        const { data: currentAdminProfile } = await sb
            .from('profiles')
            .select('is_super_admin, role')
            .eq('id', currentUser.id)
            .single();
        
        const isSuperAdmin = currentAdminProfile.is_super_admin || currentAdminProfile.role === 'super_admin';
        
        // é¡¯ç¤ºç·¨è¼¯æ¨¡æ…‹æ¡†
        showEditUserModal(user, isSuperAdmin);
        
    } catch (error) {
        console.error('è¼‰å…¥ç”¨æˆ¶è³‡æ–™éŒ¯èª¤:', error);
        alert('ç„¡æ³•è¼‰å…¥ç”¨æˆ¶è³‡æ–™');
    }
}

// ä¿®æ”¹ showEditUserModal å‡½æ•¸ï¼Œæ ¹æ“šæ¬Šé™é¡¯ç¤ºä¸åŒé¸é …
function showEditUserModal(user, isSuperAdmin) {
    const modal = document.getElementById('edit-user-modal');
    const content = modal.querySelector('.modal-content');
    
    const roleOptions = {
        'member': 'å­¸å“¡',
        'captain': 'éšŠé•·', 
        'deputy': 'å‰¯éšŠé•·',
        'admin': 'ç®¡ç†å“¡'
    };
    
    // å¦‚æœä¸æ˜¯è¶…ç´šç®¡ç†å“¡ï¼Œç§»é™¤ admin é¸é …
    if (!isSuperAdmin) {
        delete roleOptions.admin;
        delete roleOptions.super_admin;
    }
    
    // å¦‚æœæ˜¯è¶…ç´šç®¡ç†å“¡ï¼Œæ·»åŠ  super_admin é¸é …
    if (isSuperAdmin) {
        roleOptions.super_admin = 'è¶…ç´šç®¡ç†å“¡';
    }
    
    const planOptions = {
        'slow_run': 'æ…¢è·‘',
        'fast_run': 'å¿«è·‘',
        'vip': 'VIP'
    };
    
    let roleOptionsHtml = '';
    for (const [value, label] of Object.entries(roleOptions)) {
        roleOptionsHtml += `<option value="${value}" ${user.role === value ? 'selected' : ''}>${label}</option>`;
    }
    
    let planOptionsHtml = '';
    for (const [value, label] of Object.entries(planOptions)) {
        planOptionsHtml += `<option value="${value}" ${user.plan === value ? 'selected' : ''}>${label}</option>`;
    }
    
    content.innerHTML = `
        <div class="modal-header">
            <div class="modal-title">âœï¸ ç·¨è¼¯ç”¨æˆ¶: ${user.full_name || 'æœªå‘½å'}</div>
            <div class="modal-close" onclick="closeModal('edit-user-modal')">Ã—</div>
        </div>
        <form onsubmit="saveUserChanges(event, '${user.id}', ${isSuperAdmin})">
            <div class="form-group">
                <label class="form-label">çœŸå¯¦å§“å</label>
                <input type="text" class="form-control" id="edit-full-name" value="${user.full_name || ''}" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">é›»å­éƒµä»¶</label>
                <input type="email" class="form-control" id="edit-email" value="${user.email || ''}" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">è§’è‰²</label>
                <select class="form-control" id="edit-role" required>
                    ${roleOptionsHtml}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">è¨ˆç•«</label>
                <select class="form-control" id="edit-plan" required>
                    ${planOptionsHtml}
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">éšŠä¼ID</label>
                <input type="text" class="form-control" id="edit-team-id" value="${user.current_team_id || ''}">
                <small style="color: #7f8c8d;">è®Šæ›´éšŠä¼æœƒå½±éŸ¿åœ˜éšŠçµ±è¨ˆ</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">ç©åˆ†</label>
                <input type="number" class="form-control" id="edit-points" value="${user.points || 0}" min="0" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="edit-is-locked" ${user.is_locked ? 'checked' : ''}>
                    é–å®šå¸³è™Ÿï¼ˆé–å®šå¾Œç”¨æˆ¶ç„¡æ³•ä¿®æ”¹è³‡æ–™ï¼‰
                </label>
            </div>
            
            <div class="form-group">
                <label class="form-label">ä¿®æ”¹åŸå› </label>
                <textarea class="form-control" id="edit-reason" rows="3" placeholder="è«‹èªªæ˜ä¿®æ”¹æ­¤ç”¨æˆ¶è³‡æ–™çš„åŸå› ..." required></textarea>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">å„²å­˜è®Šæ›´</button>
                <button type="button" class="btn" onclick="closeModal('edit-user-modal')" style="flex: 1;">å–æ¶ˆ</button>
            </div>
        </form>`;
    
    modal.style.display = 'block';
}

// ä¿®æ”¹ saveUserChanges å‡½æ•¸ï¼Œæ”¯æ´ç®¡ç†å“¡æ“ä½œ
async function saveUserChanges(event, userId, isSuperAdmin) {
    event.preventDefault();
    
    const reason = document.getElementById('edit-reason').value;
    if (!reason.trim()) {
        alert('è«‹å¡«å¯«ä¿®æ”¹åŸå› ');
        return;
    }
    
    const newRole = document.getElementById('edit-role').value;
    
    // æª¢æŸ¥æ¬Šé™ï¼šåªæœ‰è¶…ç´šç®¡ç†å“¡å¯ä»¥è¨­å®š super_admin è§’è‰²
    if (newRole === 'super_admin' && !isSuperAdmin) {
        alert('åªæœ‰è¶…ç´šç®¡ç†å“¡å¯ä»¥è¨­å®šè¶…ç´šç®¡ç†å“¡è§’è‰²');
        return;
    }
    
    // æª¢æŸ¥æ¬Šé™ï¼šæ™®é€šç®¡ç†å“¡ä¸èƒ½è¨­å®š admin è§’è‰²
    if (newRole === 'admin' && !isSuperAdmin) {
        alert('åªæœ‰è¶…ç´šç®¡ç†å“¡å¯ä»¥è¨­å®šç®¡ç†å“¡è§’è‰²');
        return;
    }
    
    const updateData = {
        full_name: document.getElementById('edit-full-name').value,
        role: newRole,
        plan: document.getElementById('edit-plan').value,
        current_team_id: document.getElementById('edit-team-id').value || null,
        points: parseInt(document.getElementById('edit-points').value),
        is_locked: document.getElementById('edit-is-locked').checked,
        is_super_admin: newRole === 'super_admin',
        last_modified_by: currentUser.id,
        last_modified_at: new Date().toISOString()
    };
    
    try {
        const { error } = await sb
            .from('profiles')
            .update(updateData)
            .eq('id', userId);
        
        if (error) throw error;
        
        // å¦‚æœæ˜¯è¨­å®šç‚ºç®¡ç†å“¡ï¼ŒåŒæ™‚è¨­å®šé è¨­æ¬Šé™
        if (newRole === 'admin' || newRole === 'super_admin') {
            const permData = {
                admin_id: userId,
                can_manage_teams: true,
                can_manage_users: true,
                can_view_reports: true,
                can_manage_admins: newRole === 'super_admin',
                updated_at: new Date().toISOString()
            };
            
            await sb.from('admin_permissions')
                .upsert(permData);
        }
        
        // è¨˜éŒ„å¯©æ ¸æ—¥èªŒ
        await sb.from('audit_logs').insert([{
            user_id: currentUser.id,
            action: 'ADMIN_USER_UPDATE',
            resource_type: 'USER',
            resource_id: userId,
            details: {
                reason: reason,
                changes: updateData,
                performed_by_admin: true
            }
        }]);
        
        alert('âœ… ç”¨æˆ¶è³‡æ–™å·²æ›´æ–°');
        closeModal('edit-user-modal');
        loadUsers(); // é‡æ–°è¼‰å…¥ç”¨æˆ¶åˆ—è¡¨
        
    } catch (error) {
        console.error('æ›´æ–°ç”¨æˆ¶è³‡æ–™éŒ¯èª¤:', error);
        alert('æ›´æ–°å¤±æ•—: ' + error.message);
    }
}
    
    // åŒ¯å‡ºç”¨æˆ¶è³‡æ–™
    async function exportUsers() {
        try {
            const { data: users } = await sb
                .from('profiles')
                .select(`
                    *,
                    team:teams(team_name)
                `)
                .order('created_at', { ascending: false });
            
            if (!users || users.length === 0) {
                alert('æš«ç„¡ç”¨æˆ¶è³‡æ–™å¯åŒ¯å‡º');
                return;
            }
            
            // è½‰æ›ç‚ºCSVæ ¼å¼
            const headers = ['ID', 'å§“å', 'é›»å­éƒµä»¶', 'è§’è‰²', 'è¨ˆç•«', 'ç©åˆ†', 'éšŠä¼', 'ç‹€æ…‹', 'è¨»å†Šæ™‚é–“'];
            const rows = users.map(user => [
                user.id,
                user.full_name || '',
                user.email || '',
                user.role,
                user.plan,
                user.points || 0,
                user.team?.team_name || 'ç„¡éšŠä¼',
                user.is_locked ? 'å·²é–å®š' : 'æ´»èº',
                new Date(user.created_at).toLocaleString('zh-TW')
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');
            
            // ä¸‹è¼‰æª”æ¡ˆ
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `ç”¨æˆ¶è³‡æ–™_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
        } catch (error) {
            console.error('åŒ¯å‡ºç”¨æˆ¶è³‡æ–™éŒ¯èª¤:', error);
            alert('åŒ¯å‡ºå¤±æ•—: ' + error.message);
        }
    }
    
    // è¼‰å…¥è§’è‰²ç”³è«‹
    async function loadRoleRequests() {
        // å¯¦ç¾è§’è‰²ç”³è«‹ç®¡ç†åŠŸèƒ½
    }
    
    // å·¥å…·å‡½æ•¸
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    
    function changeUserPage(delta) {
        const totalPages = Math.ceil(filteredUsers.length / pageSize);
        const newPage = currentPage + delta;
        
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderUsersTable();
        }
    }

    // åœ¨ admin.html çš„ script ä¸­æ·»åŠ 

// è¼‰å…¥è§’è‰²ç”³è«‹
async function loadRoleRequests() {
    try {
        const { data: requests, error } = await sb
            .from('role_change_requests')
            .select(`
                *,
                user:profiles!role_change_requests_user_id_fkey(full_name, avatar_url, role),
                reviewer:profiles!role_change_requests_reviewed_by_fkey(full_name)
            `)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const container = document.getElementById('role-requests-section');
        if (!container) return;
        
        let html = `
        <div class="filter-bar">
            <select class="form-control" style="width: 150px;" onchange="filterRequestsByStatus(this.value)">
                <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                <option value="pending">å¾…å¯©æ ¸</option>
                <option value="approved">å·²æ‰¹å‡†</option>
                <option value="rejected">å·²æ‹’çµ•</option>
            </select>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>ç”³è«‹äºº</th>
                        <th>ç•¶å‰è§’è‰²</th>
                        <th>ç”³è«‹è§’è‰²</th>
                        <th>ç”³è«‹åŸå› </th>
                        <th>ç”³è«‹æ™‚é–“</th>
                        <th>ç‹€æ…‹</th>
                        <th>å¯©æ ¸äºº</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>`;
        
        if (!requests || requests.length === 0) {
            html += `<tr><td colspan="8" style="text-align: center;">æš«ç„¡è§’è‰²ä¿®æ”¹ç”³è«‹</td></tr>`;
        } else {
            requests.forEach(request => {
                const roleNames = {
                    'member': 'å­¸å“¡',
                    'captain': 'éšŠé•·',
                    'deputy': 'å‰¯éšŠé•·',
                    'admin': 'ç®¡ç†å“¡'
                };
                
                const statusClass = {
                    'pending': 'status-pending',
                    'approved': 'status-active',
                    'rejected': 'status-inactive'
                }[request.status] || '';
                
                const statusText = {
                    'pending': 'å¾…å¯©æ ¸',
                    'approved': 'å·²æ‰¹å‡†',
                    'rejected': 'å·²æ‹’çµ•'
                }[request.status] || request.status;
                
                html += `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <img src="${request.user?.avatar_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(request.user?.full_name || 'U') + '&background=random'}" 
                                 style="width: 30px; height: 30px; border-radius: 50%;">
                            ${request.user?.full_name || 'æœªå‘½å'}
                        </div>
                    </td>
                    <td>${roleNames[request.current_role] || request.current_role}</td>
                    <td>${roleNames[request.requested_role] || request.requested_role}</td>
                    <td>${request.reason || 'ç„¡'}</td>
                    <td>${new Date(request.created_at).toLocaleDateString('zh-TW')}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>${request.reviewer?.full_name || '-'}</td>
                    <td>`;
                
                if (request.status === 'pending') {
                    html += `
                        <button class="btn btn-small btn-success" onclick="approveRoleRequest('${request.id}', '${request.user_id}', '${request.requested_role}')">æ‰¹å‡†</button>
                        <button class="btn btn-small btn-danger" onclick="rejectRoleRequest('${request.id}')">æ‹’çµ•</button>`;
                } else {
                    html += `<span style="color: #7f8c8d;">å·²è™•ç†</span>`;
                }
                
                html += `</td></tr>`;
            });
        }
        
        html += `</tbody></table></div>`;
        container.innerHTML = html;
        
    } catch (error) {
        console.error('è¼‰å…¥è§’è‰²ç”³è«‹éŒ¯èª¤:', error);
        const container = document.getElementById('role-requests-section');
        if (container) {
            container.innerHTML = `<div style="color: #e74c3c;">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</div>`;
        }
    }
}

// æ‰¹å‡†è§’è‰²ç”³è«‹
async function approveRoleRequest(requestId, userId, newRole) {
    const reason = prompt('è«‹è¼¸å…¥æ‰¹å‡†åŸå› ï¼š');
    if (reason === null) return;
    
    try {
        // é–‹å§‹äº‹å‹™
        // 1. æ›´æ–°ç”¨æˆ¶è§’è‰²
        const { error: updateError } = await sb
            .from('profiles')
            .update({ 
                role: newRole,
                last_modified_by: currentUser.id,
                last_modified_at: new Date().toISOString()
            })
            .eq('id', userId);
        
        if (updateError) throw updateError;
        
        // 2. æ›´æ–°ç”³è«‹ç‹€æ…‹
        const { error: requestError } = await sb
            .from('role_change_requests')
            .update({
                status: 'approved',
                reviewed_by: currentUser.id,
                reviewed_at: new Date().toISOString()
            })
            .eq('id', requestId);
        
        if (requestError) throw requestError;
        
        // 3. è¨˜éŒ„å¯©æ ¸æ—¥èªŒ
        await sb.from('audit_logs').insert([{
            user_id: currentUser.id,
            action: 'ROLE_REQUEST_APPROVED',
            resource_type: 'USER',
            resource_id: userId,
            details: { 
                request_id: requestId,
                new_role: newRole,
                reason: reason
            }
        }]);
        
        alert('è§’è‰²ç”³è«‹å·²æ‰¹å‡†');
        loadRoleRequests();
        
    } catch (error) {
        console.error('æ‰¹å‡†è§’è‰²ç”³è«‹éŒ¯èª¤:', error);
        alert('æ‰¹å‡†å¤±æ•—: ' + error.message);
    }
}

// æ‹’çµ•è§’è‰²ç”³è«‹
async function rejectRoleRequest(requestId) {
    const reason = prompt('è«‹è¼¸å…¥æ‹’çµ•åŸå› ï¼š');
    if (reason === null) return;
    
    try {
        const { error } = await sb
            .from('role_change_requests')
            .update({
                status: 'rejected',
                reviewed_by: currentUser.id,
                reviewed_at: new Date().toISOString()
            })
            .eq('id', requestId);
        
        if (error) throw error;
        
        // è¨˜éŒ„å¯©æ ¸æ—¥èªŒ
        await sb.from('audit_logs').insert([{
            user_id: currentUser.id,
            action: 'ROLE_REQUEST_REJECTED',
            resource_type: 'USER',
            details: { 
                request_id: requestId,
                reason: reason
            }
        }]);
        
        alert('è§’è‰²ç”³è«‹å·²æ‹’çµ•');
        loadRoleRequests();
        
    } catch (error) {
        console.error('æ‹’çµ•è§’è‰²ç”³è«‹éŒ¯èª¤:', error);
        alert('æ‹’çµ•å¤±æ•—: ' + error.message);
    }
}

// æ ¹æ“šç‹€æ…‹ç¯©é¸ç”³è«‹
function filterRequestsByStatus(status) {
    const rows = document.querySelectorAll('#role-requests-section table tbody tr');
    
    rows.forEach(row => {
        if (!status) {
            row.style.display = '';
            return;
        }
        
        const statusCell = row.querySelector('.status-badge');
        const statusText = statusCell?.textContent.trim();
        const statusMap = {
            'pending': 'å¾…å¯©æ ¸',
            'approved': 'å·²æ‰¹å‡†',
            'rejected': 'å·²æ‹’çµ•'
        };
        
        if (statusMap[status] === statusText) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

    // è¼‰å…¥åœ˜éšŠç®¡ç†æ•¸æ“š
async function loadTeamsManagement() {
    const container = document.getElementById('teams-section');
    
    try {
        // ç²å–æ‰€æœ‰åœ˜éšŠ
        const { data: teams, error } = await sb
            .from('teams')
            .select(`
                *,
                captain:profiles!teams_captain_id_fkey(id, full_name, email),
                deputy:profiles!teams_deputy_id_fkey(id, full_name, email),
                members:profiles(count)
            `);
        
        if (error) throw error;
        
        let html = `
        <div class="filter-bar">
            <input type="text" class="form-control search-box" placeholder="æœå°‹åœ˜éšŠ..." id="team-search">
            <button class="btn btn-success" onclick="createNewTeam()">â• å»ºç«‹æ–°åœ˜éšŠ</button>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>åœ˜éšŠåç¨±</th>
                        <th>éšŠé•·</th>
                        <th>å‰¯éšŠé•·</th>
                        <th>æˆå“¡æ•¸</th>
                        <th>å‰µå»ºæ™‚é–“</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>`;
        
        if (!teams || teams.length === 0) {
            html += `<tr><td colspan="6" style="text-align: center;">æš«ç„¡åœ˜éšŠè³‡æ–™</td></tr>`;
        } else {
            teams.forEach(team => {
                html += `
                <tr>
                    <td><strong>${team.team_name || 'æœªå‘½å'}</strong><br><small>ID: ${team.id}</small></td>
                    <td>
                        ${team.captain ? 
                            `<div>${team.captain.full_name || 'æœªå‘½å'}</div>
                             <small>${team.captain.email}</small>
                             <button class="btn btn-small btn-warning" onclick="changeCaptain('${team.id}', '${team.captain.id}')">æ›´æ›</button>` 
                            : 'æœªè¨­å®š'}
                    </td>
                    <td>
                        ${team.deputy ? 
                            `<div>${team.deputy.full_name || 'æœªå‘½å'}</div>
                             <small>${team.deputy.email}</small>
                             <button class="btn btn-small btn-warning" onclick="changeDeputy('${team.id}', '${team.deputy?.id || ''}')">æ›´æ›</button>` 
                            : '<button class="btn btn-small btn-success" onclick="assignDeputy(\'' + team.id + '\')">æŒ‡æ´¾</button>'}
                    </td>
                    <td>${team.members?.[0]?.count || 0} äºº</td>
                    <td>${new Date(team.created_at).toLocaleDateString('zh-TW')}</td>
                    <td>
                        <button class="btn btn-small btn-primary" onclick="viewTeamDetails('${team.id}')">æŸ¥çœ‹</button>
                        <button class="btn btn-small btn-danger" onclick="deleteTeam('${team.id}', '${team.team_name}')">åˆªé™¤</button>
                    </td>
                </tr>`;
            });
        }
        
        html += `</tbody></table></div>`;
        container.innerHTML = html;
        
        // ç¶å®šæœå°‹åŠŸèƒ½
        document.getElementById('team-search')?.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = container.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
        
    } catch (error) {
        console.error('è¼‰å…¥åœ˜éšŠç®¡ç†éŒ¯èª¤:', error);
        container.innerHTML = '<div class="error-message">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</div>';
    }
}

// æ›´æ›éšŠé•·
async function changeCaptain(teamId, currentCaptainId) {
    const newCaptainEmail = prompt('è«‹è¼¸å…¥æ–°éšŠé•·çš„é›»å­éƒµä»¶ï¼š');
    
    if (!newCaptainEmail) return;
    
    try {
        // å°‹æ‰¾æ–°éšŠé•·ç”¨æˆ¶
        const { data: newCaptain, error: findError } = await sb
            .from('profiles')
            .select('id, full_name, current_team_id')
            .eq('email', newCaptainEmail)
            .single();
        
        if (findError || !newCaptain) {
            alert('æ‰¾ä¸åˆ°è©²ç”¨æˆ¶ï¼Œè«‹ç¢ºèªé›»å­éƒµä»¶æ˜¯å¦æ­£ç¢º');
            return;
        }
        
        // æ›´æ–°åœ˜éšŠéšŠé•·
        const { error: updateError } = await sb
            .from('teams')
            .update({
                captain_id: newCaptain.id,
                updated_at: new Date().toISOString()
            })
            .eq('id', teamId);
        
        if (updateError) throw updateError;
        
        // æ›´æ–°åŸéšŠé•·è§’è‰²
        await sb
            .from('profiles')
            .update({
                role: 'member',
                last_modified_by: currentUser.id,
                last_modified_at: new Date().toISOString()
            })
            .eq('id', currentCaptainId);
        
        // æ›´æ–°æ–°éšŠé•·è§’è‰²
        await sb
            .from('profiles')
            .update({
                role: 'captain',
                current_team_id: teamId,
                last_modified_by: currentUser.id,
                last_modified_at: new Date().toISOString()
            })
            .eq('id', newCaptain.id);
        
        // è¨˜éŒ„å¯©æ ¸æ—¥èªŒ
        await sb.from('audit_logs').insert([{
            user_id: currentUser.id,
            action: 'CHANGE_TEAM_CAPTAIN',
            resource_type: 'TEAM',
            resource_id: teamId,
            details: {
                old_captain_id: currentCaptainId,
                new_captain_id: newCaptain.id,
                new_captain_email: newCaptainEmail
            }
        }]);
        
        alert(`âœ… éšŠé•·å·²æ›´æ›ç‚º ${newCaptain.full_name}`);
        loadTeamsManagement();
        
    } catch (error) {
        console.error('æ›´æ›éšŠé•·éŒ¯èª¤:', error);
        alert('æ›´æ›å¤±æ•—: ' + error.message);
    }
}

// æŒ‡æ´¾/æ›´æ›å‰¯éšŠé•·
async function changeDeputy(teamId, currentDeputyId = null) {
    const newDeputyEmail = prompt('è«‹è¼¸å…¥æ–°å‰¯éšŠé•·çš„é›»å­éƒµä»¶ï¼š');
    
    if (!newDeputyEmail) return;
    
    try {
        // å°‹æ‰¾æ–°å‰¯éšŠé•·ç”¨æˆ¶
        const { data: newDeputy, error: findError } = await sb
            .from('profiles')
            .select('id, full_name, current_team_id')
            .eq('email', newDeputyEmail)
            .single();
        
        if (findError || !newDeputy) {
            alert('æ‰¾ä¸åˆ°è©²ç”¨æˆ¶ï¼Œè«‹ç¢ºèªé›»å­éƒµä»¶æ˜¯å¦æ­£ç¢º');
            return;
        }
        
        // æ›´æ–°åœ˜éšŠå‰¯éšŠé•·
        const { error: updateError } = await sb
            .from('teams')
            .update({
                deputy_id: newDeputy.id,
                updated_at: new Date().toISOString()
            })
            .eq('id', teamId);
        
        if (updateError) throw updateError;
        
        // å¦‚æœæœ‰åŸå‰¯éšŠé•·ï¼Œæ›´æ–°å…¶è§’è‰²
        if (currentDeputyId) {
            await sb
                .from('profiles')
                .update({
                    role: 'member',
                    last_modified_by: currentUser.id,
                    last_modified_at: new Date().toISOString()
                })
                .eq('id', currentDeputyId);
        }
        
        // æ›´æ–°æ–°å‰¯éšŠé•·è§’è‰²
        await sb
            .from('profiles')
            .update({
                role: 'deputy',
                current_team_id: teamId,
                last_modified_by: currentUser.id,
                last_modified_at: new Date().toISOString()
            })
            .eq('id', newDeputy.id);
        
        // è¨˜éŒ„å¯©æ ¸æ—¥èªŒ
        await sb.from('audit_logs').insert([{
            user_id: currentUser.id,
            action: 'CHANGE_TEAM_DEPUTY',
            resource_type: 'TEAM',
            resource_id: teamId,
            details: {
                old_deputy_id: currentDeputyId,
                new_deputy_id: newDeputy.id,
                new_deputy_email: newDeputyEmail
            }
        }]);
        
        alert(`âœ… å‰¯éšŠé•·å·²è¨­å®šç‚º ${newDeputy.full_name}`);
        loadTeamsManagement();
        
    } catch (error) {
        console.error('è¨­å®šå‰¯éšŠé•·éŒ¯èª¤:', error);
        alert('è¨­å®šå¤±æ•—: ' + error.message);
    }
}
</script>
</body>
</html>
