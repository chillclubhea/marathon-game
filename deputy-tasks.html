<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰¯éšŠé•·ä»»å‹™ç®¡ç†</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #3498db; --success: #2ecc71; --warning: #f39c12; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 25px; padding: 20px; background: white; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        h1 { color: #2c3e50; margin: 0; font-size: 28px; }
        .subtitle { color: #7f8c8d; margin-top: 8px; font-size: 14px; }
        .back-btn { position: fixed; top: 20px; left: 20px; background: white; color: var(--primary); border: 2px solid var(--primary); padding: 10px 20px; border-radius: 50px; cursor: pointer; font-weight: bold; z-index: 100; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; flex-wrap: wrap; }
        .date-selector, .team-selector { display: flex; gap: 10px; align-items: center; }
        select, input { padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
        .refresh-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .team-members { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .member-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .member-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .member-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
        .member-info { flex: 1; }
        .member-name { font-weight: bold; color: #2c3e50; font-size: 18px; }
        .member-detail { font-size: 12px; color: #7f8c8d; }
        .tasks-list { margin-top: 15px; }
        .task-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f0f0f0; }
        .task-item:last-child { border-bottom: none; }
        .task-name { flex: 1; }
        .task-status { display: flex; gap: 10px; }
        .status-btn { padding: 6px 12px; border: none; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: bold; }
        .status-complete { background: var(--success); color: white; }
        .status-pending { background: #f0f0f0; color: #7f8c8d; }
        .summary-card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
        .summary-item { text-align: center; padding: 15px; background: #f8fafc; border-radius: 10px; }
        .summary-value { font-size: 24px; font-weight: bold; color: var(--primary); }
        .summary-label { font-size: 12px; color: #7f8c8d; margin-top: 5px; }
        .hidden { display: none; }
        .error-message { background: #fee; color: #c33; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #c33; }
        .retry-btn { background: var(--warning); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>
    <button class="back-btn" onclick="window.location.href='index.html'">â† è¿”å›</button>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ‘‘ å‰¯éšŠé•·ä»»å‹™ç®¡ç†</h1>
            <div class="subtitle">æ¨™è¨˜åœ˜éšŠæˆå“¡ä»»å‹™å®Œæˆç‹€æ…‹ â€¢ æ¯æ—¥æ›´æ–°</div>
        </div>
        
        <!-- éŒ¯èª¤é¡¯ç¤ºå€åŸŸ -->
        <div id="error-container" class="hidden"></div>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <div class="date-selector">
                <input type="date" id="date-selector" value="">
                <select id="team-selector">
                    <option value="">é¸æ“‡åœ˜éšŠ...</option>
                </select>
            </div>
            <button class="refresh-btn" onclick="loadTeamData()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
        </div>
        
        <!-- çµ±è¨ˆæ‘˜è¦ -->
        <div id="summary-container" class="summary-card hidden">
            <h3>ğŸ“Š åœ˜éšŠä»»å‹™çµ±è¨ˆ</h3>
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-value" id="total-members">0</div>
                    <div class="summary-label">åœ˜éšŠæˆå“¡</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="completed-tasks">0%</div>
                    <div class="summary-label">ä»»å‹™å®Œæˆç‡</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="pending-tasks">0</div>
                    <div class="summary-label">å¾…ç¢ºèªä»»å‹™</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="team-points">0</div>
                    <div class="summary-label">åœ˜éšŠç¸½ç©åˆ†</div>
                </div>
            </div>
        </div>
        
        <!-- åœ˜éšŠæˆå“¡åˆ—è¡¨ -->
        <div id="team-container">
            <div class="member-card">
                <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                    <div style="font-size: 48px;">ğŸ‘¥</div>
                    <div>æ­£åœ¨è¼‰å…¥åœ˜éšŠè³‡æ–™...</div>
                    <div style="font-size: 14px; margin-top: 10px;">è«‹é¸æ“‡æ—¥æœŸå’Œåœ˜éšŠ</div>
                </div>
            </div>
        </div>
    </div>

<script>
    // Supabase é…ç½®
    const SUPABASE_URL = 'https://sdloakutxcsbshcqpxwn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbG9ha3V0eGNzYnNoY3FweHduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMTE4MjYsImV4cCI6MjA4MTY4NzgyNn0.5OBQQAinARnZQ6VSCrPl60NWmcSG-QiFMmVIJRW7g-0';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // å…¨å±€è®Šæ•¸
    let currentUser = null;
    let currentTeam = null;
    let teamMembers = [];
    
    // é é¢è¼‰å…¥
    window.onload = async () => {
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        const { data: { session } } = await sb.auth.getSession();
        if (!session) {
            showError('è«‹å…ˆç™»å…¥ç³»çµ±', true);
            return;
        }
        currentUser = session.user;
        
        // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦ç‚ºå‰¯éšŠé•·
        await checkDeputyStatus();
        
        // è¨­ç½®æ—¥æœŸé¸æ“‡å™¨ç‚ºä»Šå¤©
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date-selector').value = today;
        
        // è¼‰å…¥åœ˜éšŠåˆ—è¡¨
        await loadTeamList();
    };
    
    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    function showError(message, isCritical = false) {
        const errorContainer = document.getElementById('error-container');
        errorContainer.innerHTML = `
            <div class="error-message">
                <strong>éŒ¯èª¤ï¼š</strong> ${message}
                <br>
                <button class="retry-btn" onclick="location.reload()">é‡æ–°æ•´ç†é é¢</button>
                ${isCritical ? '<br><small>å¦‚æœå•é¡ŒæŒçºŒï¼Œè«‹è¯çµ¡ç®¡ç†å“¡</small>' : ''}
            </div>
        `;
        errorContainer.classList.remove('hidden');
    }
    
    // éš±è—éŒ¯èª¤è¨Šæ¯
    function hideError() {
        document.getElementById('error-container').classList.add('hidden');
    }
    
    // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦ç‚ºå‰¯éšŠé•·
    async function checkDeputyStatus() {
        try {
            const { data: profile, error } = await sb
                .from('profiles')
                .select('role')
                .eq('id', currentUser.id)
                .single();
            
            if (error) throw error;
            
            if (profile.role !== 'deputy' && profile.role !== 'captain' && profile.role !== 'admin') {
                showError('åªæœ‰å‰¯éšŠé•·ã€éšŠé•·æˆ–ç®¡ç†å“¡å¯ä»¥è¨ªå•æ­¤é é¢', true);
                return false;
            }
            
            return true;
        } catch (error) {
            console.error('æª¢æŸ¥å‰¯éšŠé•·ç‹€æ…‹éŒ¯èª¤:', error);
            showError('ç„¡æ³•é©—è­‰ç”¨æˆ¶æ¬Šé™', true);
            return false;
        }
    }
    
    // è¼‰å…¥åœ˜éšŠåˆ—è¡¨
    async function loadTeamList() {
        const selector = document.getElementById('team-selector');
        selector.innerHTML = '<option value="">é¸æ“‡åœ˜éšŠ...</option>';
        
        try {
            // æŸ¥æ‰¾ç”¨æˆ¶ç®¡ç†çš„åœ˜éšŠ
            const { data: teams, error } = await sb
                .from('teams')
                .select('id, team_name')
                .or(`captain_id.eq.${currentUser.id},deputy_id.eq.${currentUser.id}`);
            
            if (error) throw error;
            
            if (!teams || teams.length === 0) {
                selector.innerHTML += '<option value="" disabled>æ‚¨ç›®å‰æ²’æœ‰ç®¡ç†çš„åœ˜éšŠ</option>';
                return;
            }
            
            teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.id;
                option.textContent = team.team_name;
                selector.appendChild(option);
            });
            
        } catch (error) {
            console.error('è¼‰å…¥åœ˜éšŠåˆ—è¡¨éŒ¯èª¤:', error);
            showError('ç„¡æ³•è¼‰å…¥åœ˜éšŠåˆ—è¡¨');
        }
    }
    
    // è¼‰å…¥åœ˜éšŠæ•¸æ“š
    async function loadTeamData() {
        const teamId = document.getElementById('team-selector').value;
        const dateStr = document.getElementById('date-selector').value;
        
        if (!teamId || !dateStr) {
            showError('è«‹é¸æ“‡åœ˜éšŠå’Œæ—¥æœŸ');
            return;
        }
        
        currentTeam = teamId;
        const container = document.getElementById('team-container');
        container.innerHTML = '<div class="member-card"><div style="text-align: center; padding: 40px;">è¼‰å…¥ä¸­...</div></div>';
        
        try {
            // ç²å–åœ˜éšŠæˆå“¡
            const { data: members, error } = await sb
                .from('team_members')
                .select(`
                    member:profiles(
                        id,
                        full_name,
                        avatar_url,
                        role,
                        points
                    )
                `)
                .eq('team_id', teamId);
            
            if (error) throw error;
            
            if (!members || members.length === 0) {
                container.innerHTML = '<div class="member-card"><div style="text-align: center; padding: 40px;">æ­¤åœ˜éšŠæš«ç„¡æˆå“¡</div></div>';
                return;
            }
            
            teamMembers = members.map(m => m.member);
            
            // é¡¯ç¤ºçµ±è¨ˆæ‘˜è¦
            showSummary();
            
            // è¼‰å…¥æ¯å€‹æˆå“¡çš„ä»»å‹™ç‹€æ…‹ä¸¦é¡¯ç¤º
            let html = '';
            
            for (const member of teamMembers) {
                // ç²å–æˆå“¡ä»Šæ—¥ä»»å‹™ç‹€æ…‹
                const { data: dailyScore } = await sb
                    .from('daily_scores')
                    .select('*')
                    .eq('user_id', member.id)
                    .eq('date', dateStr)
                    .maybeSingle();
                
                html += generateMemberCard(member, dailyScore, dateStr);
            }
            
            container.innerHTML = html;
            hideError();
            
        } catch (error) {
            console.error('è¼‰å…¥åœ˜éšŠæ•¸æ“šéŒ¯èª¤:', error);
            showError('ç„¡æ³•è¼‰å…¥åœ˜éšŠæ•¸æ“š');
        }
    }
    
    // é¡¯ç¤ºçµ±è¨ˆæ‘˜è¦
    function showSummary() {
        const summaryContainer = document.getElementById('summary-container');
        summaryContainer.classList.remove('hidden');
        
        document.getElementById('total-members').textContent = teamMembers.length;
        // å…¶ä»–çµ±è¨ˆæ•¸æ“šå¯ä»¥åœ¨loadTeamDataä¸­è¨ˆç®—å¾Œæ›´æ–°
    }
    
    // ç”Ÿæˆæˆå“¡å¡ç‰‡
    function generateMemberCard(member, dailyScore, dateStr) {
        const tasks = [
            { id: 'weight_recorded', name: 'ç£…ç£… + æ‰“å¡é£²é£Ÿ', completed: dailyScore ? dailyScore.weight_recorded : false },
            { id: 'shake_used', name: 'ä½¿ç”¨Shake', completed: dailyScore ? dailyScore.shake_used : false },
            { id: 'task_completed', name: 'å®Œæˆç›´æ’­', completed: dailyScore ? dailyScore.task_completed : false },
            { id: 'exercise_done', name: 'å®Œæˆé‹å‹•', completed: dailyScore ? dailyScore.exercise_done : false },
            { id: 'social_shared', name: 'ç¤¾äº¤åˆ†äº«', completed: dailyScore ? dailyScore.social_shared : false }
        ];
        
        const completedTasks = tasks.filter(t => t.completed).length;
        const completionRate = Math.round((completedTasks / tasks.length) * 100);
        
        let tasksHtml = '';
        tasks.forEach(task => {
            tasksHtml += `
            <div class="task-item">
                <div class="task-name">${task.name}</div>
                <div class="task-status">
                    <button class="status-btn ${task.completed ? 'status-complete' : 'status-pending'}" 
                            onclick="toggleTaskStatus('${member.id}', '${dateStr}', '${task.id}', ${!task.completed})">
                        ${task.completed ? 'âœ… å·²å®Œæˆ' : 'â³ å¾…ç¢ºèª'}
                    </button>
                </div>
            </div>`;
        });
        
        return `
        <div class="member-card">
            <div class="member-header">
                <img class="member-avatar" src="${member.avatar_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(member.full_name || 'User') + '&background=random'}" alt="${member.full_name}">
                <div class="member-info">
                    <div class="member-name">${member.full_name || 'æœªè¨­å®šå§“å'}</div>
                    <div class="member-detail">
                        ${member.role === 'captain' ? 'ğŸ‘‘ éšŠé•·' : member.role === 'deputy' ? 'â­ å‰¯éšŠé•·' : 'ğŸ‘¤ å­¸å“¡'} â€¢ 
                        ç©åˆ†: ${member.points || 0} â€¢ 
                        å®Œæˆç‡: ${completionRate}%
                    </div>
                </div>
            </div>
            <div class="tasks-list">
                ${tasksHtml}
            </div>
            <div style="margin-top: 15px; text-align: right;">
                <button class="status-btn" style="background: var(--primary); color: white;" 
                        onclick="markAllTasks('${member.id}', '${dateStr}')">
                    æ¨™è¨˜æ‰€æœ‰ä»»å‹™ç‚ºå®Œæˆ
                </button>
            </div>
        </div>`;
    }
    
    // åˆ‡æ›ä»»å‹™ç‹€æ…‹
    window.toggleTaskStatus = async function(userId, dateStr, taskField, newStatus) {
        try {
            // é¦–å…ˆç²å–ç¾æœ‰çš„è¨˜éŒ„
            const { data: existingRecord } = await sb
                .from('daily_scores')
                .select('*')
                .eq('user_id', userId)
                .eq('date', dateStr)
                .maybeSingle();
            
            // æº–å‚™æ›´æ–°æ•¸æ“š
            let updateData = existingRecord || {
                user_id: userId,
                date: dateStr,
                created_at: new Date().toISOString()
            };
            
            // æ›´æ–°å°æ‡‰æ¬„ä½
            updateData[taskField] = newStatus;
            
            // é‡æ–°è¨ˆç®—ç¸½åˆ†æ•¸
            updateData.total_points = calculateDailyPoints(updateData);
            updateData.updated_at = new Date().toISOString();
            
            // ä½¿ç”¨ upsert æ›´æ–°æˆ–å‰µå»ºè¨˜éŒ„
            const { error } = await sb
                .from('daily_scores')
                .upsert(updateData, { 
                    onConflict: 'user_id,date',
                    returning: 'minimal'
                });
            
            if (error) {
                console.error('æ›´æ–°ä»»å‹™ç‹€æ…‹éŒ¯èª¤:', error);
                alert('æ›´æ–°å¤±æ•—: ' + error.message);
                return;
            }
            
            // é‡æ–°è¼‰å…¥åœ˜éšŠæ•¸æ“š
            loadTeamData();
            
        } catch (error) {
            console.error('åˆ‡æ›ä»»å‹™ç‹€æ…‹éŒ¯èª¤:', error);
            alert('æ“ä½œå¤±æ•—: ' + error.message);
        }
    };
    
    // æ¨™è¨˜æ‰€æœ‰ä»»å‹™ç‚ºå®Œæˆ
    window.markAllTasks = async function(userId, dateStr) {
        if (!confirm('ç¢ºå®šè¦æ¨™è¨˜æ­¤æˆå“¡çš„æ‰€æœ‰ä»»å‹™ç‚ºå®Œæˆå—ï¼Ÿ')) {
            return;
        }
        
        try {
            // é¦–å…ˆç²å–ç¾æœ‰çš„è¨˜éŒ„
            const { data: existingRecord } = await sb
                .from('daily_scores')
                .select('*')
                .eq('user_id', userId)
                .eq('date', dateStr)
                .maybeSingle();
            
            // æº–å‚™æ›´æ–°æ•¸æ“š
            let updateData = existingRecord || {
                user_id: userId,
                date: dateStr,
                created_at: new Date().toISOString()
            };
            
            // æ¨™è¨˜æ‰€æœ‰ä»»å‹™ç‚ºå®Œæˆ
            updateData.weight_recorded = true;
            updateData.shake_used = true;
            updateData.task_completed = true;
            updateData.exercise_done = true;
            updateData.social_shared = true;
            
            // é‡æ–°è¨ˆç®—ç¸½åˆ†æ•¸
            updateData.total_points = calculateDailyPoints(updateData);
            updateData.updated_at = new Date().toISOString();
            
            // ä½¿ç”¨ upsert æ›´æ–°æˆ–å‰µå»ºè¨˜éŒ„
            const { error } = await sb
                .from('daily_scores')
                .upsert(updateData, { 
                    onConflict: 'user_id,date',
                    returning: 'minimal'
                });
            
            if (error) {
                console.error('æ¨™è¨˜æ‰€æœ‰ä»»å‹™éŒ¯èª¤:', error);
                alert('æ›´æ–°å¤±æ•—: ' + error.message);
                return;
            }
            
            // é‡æ–°è¼‰å…¥åœ˜éšŠæ•¸æ“š
            loadTeamData();
            
        } catch (error) {
            console.error('æ¨™è¨˜æ‰€æœ‰ä»»å‹™éŒ¯èª¤:', error);
            alert('æ“ä½œå¤±æ•—: ' + error.message);
        }
    };
    
    // è¨ˆç®—æ¯æ—¥ç©åˆ†
    function calculateDailyPoints(data) {
        let points = 0;
        
        // å®Œæˆä¸€åœˆï¼ˆé«”é‡+é£²é£Ÿ+å¥¶æ˜”+ç›´æ’­ï¼‰
        if (data.weight_recorded && data.shake_used && data.task_completed) {
            points += 1;
        }
        
        // å…¶ä»–ä»»å‹™å„1åˆ†
        if (data.weight_recorded) points += 1;
        if (data.shake_used) points += 1;
        if (data.exercise_done) points += 1;
        if (data.social_shared) points += 1;
        if (data.task_completed) points += 1;
        
        return points;
    }
</script>
</body>
</html>
