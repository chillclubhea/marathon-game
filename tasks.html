<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦¬æ‹‰æ¾ä»»å‹™å€</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #3498db; --success: #2ecc71; --warning: #f39c12; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 25px; padding: 20px; background: white; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        h1 { color: #2c3e50; margin: 0; font-size: 28px; }
        .subtitle { color: #7f8c8d; margin-top: 8px; font-size: 14px; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .stat-value { font-size: 32px; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 14px; color: #7f8c8d; margin-top: 5px; }
        .task-card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .task-title { font-size: 18px; font-weight: bold; color: #2c3e50; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .task-desc { color: #5d6d7e; margin-bottom: 20px; line-height: 1.5; }
        .task-meta { display: flex; justify-content: space-between; color: #7f8c8d; font-size: 14px; margin-bottom: 15px; }
        .task-points { background: #e8f4fc; color: var(--primary); padding: 5px 15px; border-radius: 20px; font-weight: bold; }
        .task-actions { display: flex; gap: 10px; }
        .task-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .task-btn.complete { background: var(--success); color: white; }
        .task-btn.pending { background: #f0f0f0; color: #7f8c8d; }
        .task-btn.disabled { opacity: 0.5; cursor: not-allowed; }
        .task-btn:hover:not(.disabled) { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        .checklist { margin: 20px 0; }
        .checklist-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .checklist-item:last-child { border-bottom: none; }
        .checklist-checkbox { width: 24px; height: 24px; margin-right: 12px; cursor: pointer; }
        .checklist-label { flex: 1; }
        .checklist-points { color: var(--primary); font-weight: bold; }
        .back-btn { position: fixed; top: 20px; left: 20px; background: white; color: var(--primary); border: 2px solid var(--primary); padding: 10px 20px; border-radius: 50px; cursor: pointer; font-weight: bold; z-index: 100; }
        .lottery-section { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; text-align: center; }
        .lottery-title { font-size: 24px; font-weight: bold; margin-bottom: 15px; }
        .lottery-ticket { background: white; color: #333; border-radius: 10px; padding: 15px; margin: 15px 0; display: inline-block; font-size: 20px; font-weight: bold; }
        .lottery-count { font-size: 48px; font-weight: bold; margin: 10px 0; }
        .hidden { display: none; }
        .completed-badge { background: var(--success); color: white; padding: 5px 10px; border-radius: 20px; font-size: 12px; margin-left: 10px; }
        .date-navigation { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 20px; }
        .date-btn { background: white; border: 2px solid var(--primary); color: var(--primary); padding: 8px 16px; border-radius: 50px; cursor: pointer; font-weight: bold; }
        .current-date { font-weight: bold; color: #2c3e50; }
        .error-message { background: #fee; color: #c33; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #c33; }
        .retry-btn { background: var(--warning); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>
    <button class="back-btn" onclick="window.location.href='index.html'">â† è¿”å›</button>
    
    <div class="container">
        <div class="header">
            <h1>âœ… é¦¬æ‹‰æ¾ä»»å‹™å€</h1>
            <div class="subtitle">æ¯æ—¥æ›´æ–°ä»»å‹™ â€¢ å®Œæˆä»»å‹™ç²å¾—ç©åˆ†èˆ‡æŠ½çåˆ¸</div>
        </div>
        
        <!-- éŒ¯èª¤é¡¯ç¤ºå€åŸŸ -->
        <div id="error-container" class="hidden"></div>
        
        <!-- æ—¥æœŸå°èˆª -->
        <div class="date-navigation">
            <button class="date-btn" onclick="changeDate(-1)">â† å‰ä¸€å¤©</button>
            <div class="current-date" id="current-date"></div>
            <button class="date-btn" onclick="changeDate(1)">å¾Œä¸€å¤© â†’</button>
        </div>
        
        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="today-points">0</div>
                <div class="stat-label">ä»Šæ—¥ç©åˆ†</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-tickets">0</div>
                <div class="stat-label">ç´¯ç©æŠ½çåˆ¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completed-tasks">0/0</div>
                <div class="stat-label">å®Œæˆä»»å‹™</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="task-streak">0</div>
                <div class="stat-label">é€£çºŒå®Œæˆå¤©æ•¸</div>
            </div>
        </div>
        
        <!-- æŠ½çåˆ¸å€ -->
        <div class="lottery-section">
            <div class="lottery-title">ğŸŸï¸ ä»»å‹™å€æŠ½çç³»çµ±</div>
            <div>å®Œæˆæ¯æ—¥ä»»å‹™å³å¯ç²å¾—æŠ½çåˆ¸ï¼Œæ¯10å¤©ç•¢æ¥­å…¸ç¦®æŠ½çï¼</div>
            <div class="lottery-ticket">æŠ½çåˆ¸ç·¨è™Ÿ: <span id="ticket-number">--</span></div>
            <div class="lottery-count" id="ticket-count">0</div>
            <div>å¼µå¯ç”¨æŠ½çåˆ¸</div>
            <div style="margin-top: 15px; font-size: 14px; opacity: 0.9;">
                æŠ½çåˆ¸ä¾†æº: æ¯æ—¥å ±åˆ°(1å¼µ) + å®Œæˆä»»å‹™(1-3å¼µ) + è½‰ä»‹ç´¹(é¡å¤–çå‹µ)
            </div>
        </div>
        
        <!-- ä»»å‹™åˆ—è¡¨ -->
        <div id="tasks-container">
            <div class="task-card">
                <div class="task-title">ğŸ“Š è¼‰å…¥ä»»å‹™ä¸­...</div>
                <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                    <div style="font-size: 48px;">â³</div>
                    <div>æ­£åœ¨è¼‰å…¥ä»Šæ—¥ä»»å‹™</div>
                </div>
            </div>
        </div>
        
        <!-- ä»»å‹™å®Œæˆæç¤º -->
        <div id="completion-message" class="task-card hidden" style="background: #e8f6ef; border-left: 5px solid var(--success);">
            <div class="task-title">ğŸ‰ æ­å–œå®Œæˆä»Šæ—¥ä»»å‹™ï¼</div>
            <div>ä½ å·²ç²å¾— <strong id="earned-points">0</strong> ç©åˆ†å’Œ <strong id="earned-tickets">0</strong> å¼µæŠ½çåˆ¸</div>
            <div style="margin-top: 15px; font-size: 14px; color: #27ae60;">
                è¨˜å¾—æ˜å¤©ç¹¼çºŒå®Œæˆä»»å‹™ï¼Œä¿æŒé€£å‹ç´€éŒ„ï¼
            </div>
        </div>
    </div>

<script>
    // Supabase é…ç½®
    const SUPABASE_URL = 'https://sdloakutxcsbshcqpxwn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbG9ha3V0eGNzYnNoY3FweHduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMTE4MjYsImV4cCI6MjA4MTY4NzgyNn0.5OBQQAinARnZQ6VSCrPl60NWmcSG-QiFMmVIJRW7g-0';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // å…¨å±€è®Šæ•¸
    let currentUser = null;
    let currentDate = new Date();
    let dailyTasks = [];
    
    // é é¢è¼‰å…¥
    window.onload = async () => {
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        const { data: { session } } = await sb.auth.getSession();
        if (!session) {
            showError('è«‹å…ˆç™»å…¥ç³»çµ±', true);
            return;
        }
        currentUser = session.user;
        
        // è¼‰å…¥ä»»å‹™
        await loadTasks();
        await updateStats();
        
        // è¨­ç½®ç•¶å‰æ—¥æœŸé¡¯ç¤º
        updateDateDisplay();
    };
    
    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    function showError(message, isCritical = false) {
        const errorContainer = document.getElementById('error-container');
        errorContainer.innerHTML = `
            <div class="error-message">
                <strong>éŒ¯èª¤ï¼š</strong> ${message}
                <br>
                <button class="retry-btn" onclick="location.reload()">é‡æ–°æ•´ç†é é¢</button>
                ${isCritical ? '<br><small>å¦‚æœå•é¡ŒæŒçºŒï¼Œè«‹è¯çµ¡ç®¡ç†å“¡</small>' : ''}
            </div>
        `;
        errorContainer.classList.remove('hidden');
    }
    
    // éš±è—éŒ¯èª¤è¨Šæ¯
    function hideError() {
        document.getElementById('error-container').classList.add('hidden');
    }
    
    // æ›´æ–°æ—¥æœŸé¡¯ç¤º
    function updateDateDisplay() {
        const dateStr = currentDate.toLocaleDateString('zh-TW', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            weekday: 'long'
        });
        document.getElementById('current-date').textContent = dateStr;
    }
    
    // è®Šæ›´æ—¥æœŸï¼ˆä¿®æ­£ï¼šç¢ºä¿é€™å€‹å‡½æ•¸åœ¨å…¨å±€ä½œç”¨åŸŸä¸­å®šç¾©ï¼‰
    window.changeDate = function(days) {
        currentDate.setDate(currentDate.getDate() + days);
        updateDateDisplay();
        loadTasks();
    };
    
    // æª¢æŸ¥ä¸¦å‰µå»ºè³‡æ–™è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    async function checkAndCreateTables() {
        try {
            // æª¢æŸ¥ daily_scores è¡¨æ˜¯å¦å­˜åœ¨
            const { error: checkError } = await sb
                .from('daily_scores')
                .select('count')
                .limit(1);
            
            // å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œæœƒè¿”å›éŒ¯èª¤ï¼Œä½†æˆ‘å€‘ä¸è™•ç†é€™å€‹éŒ¯èª¤
            // å› ç‚ºå¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œæˆ‘å€‘æœƒåœ¨å‰µå»ºæ™‚è™•ç†
            return true;
        } catch (error) {
            console.log('æª¢æŸ¥è¡¨çµæ§‹æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            return false;
        }
    }
    
    // è¼‰å…¥ä»»å‹™
    async function loadTasks() {
        const container = document.getElementById('tasks-container');
        container.innerHTML = '<div class="task-card"><div class="task-title">ğŸ“Š è¼‰å…¥ä»»å‹™ä¸­...</div></div>';
        
        // ç²å–ä»Šæ—¥æ—¥æœŸå­—ä¸²
        const dateStr = currentDate.toISOString().split('T')[0];
        
        try {
            // å…ˆæª¢æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
            const tablesExist = await checkAndCreateTables();
            if (!tablesExist) {
                throw new Error('è³‡æ–™è¡¨å°šæœªåˆå§‹åŒ–');
            }
            
            // å˜—è©¦ç²å–ç”¨æˆ¶ä»Šæ—¥çš„ä»»å‹™å®Œæˆç‹€æ…‹
            let dailyScore = null;
            
            try {
                const { data, error } = await sb
                    .from('daily_scores')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('date', dateStr)
                    .maybeSingle();
                
                if (error && error.code !== 'PGRST116') { // PGRST116 è¡¨ç¤ºæ²’æœ‰æ‰¾åˆ°è³‡æ–™
                    console.warn('æŸ¥è©¢ daily_scores è¡¨æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                } else if (!error) {
                    dailyScore = data;
                }
            } catch (queryError) {
                console.warn('æŸ¥è©¢ä»»å‹™ç‹€æ…‹æ™‚ç™¼ç”ŸéŒ¯èª¤:', queryError);
            }
            
            // å®šç¾©ä»»å‹™åˆ—è¡¨ï¼ˆä½¿ç”¨éœæ…‹å®šç¾©ï¼Œé¿å…è³‡æ–™åº«å•é¡Œï¼‰
            dailyTasks = [
                {
                    id: 'weight_check',
                    title: 'âš–ï¸ å®Œæˆç£…ç£… + æ‰“å¡é£²é£Ÿ',
                    description: 'æ¸¬é‡é«”é‡ä¸¦è¨˜éŒ„ä»Šæ—¥é£²é£Ÿå…§å®¹ï¼Œéœ€é…åˆ shake + ç›´æ’­',
                    points: 1,
                    isCompleted: dailyScore ? dailyScore.weight_recorded || false : false,
                    required: true
                },
                {
                    id: 'shake_used',
                    title: 'ğŸ¥¤ ä½¿ç”¨ç‡Ÿé¤Šå¥¶æ˜” (Shake)',
                    description: 'ä»Šæ—¥ä½¿ç”¨åº·å¯¶èŠç‡Ÿé¤Šå¥¶æ˜”è‡³å°‘ä¸€æ¬¡',
                    points: 1,
                    isCompleted: dailyScore ? dailyScore.shake_used || false : false,
                    required: true
                },
                {
                    id: 'live_session',
                    title: 'ğŸ“¹ å®Œæˆç›´æ’­æˆ–è§€çœ‹',
                    description: 'å®Œæˆåœ˜éšŠç›´æ’­æ´»å‹•æˆ–è§€çœ‹ç›´æ’­å›æ”¾',
                    points: 1,
                    isCompleted: dailyScore ? dailyScore.task_completed || false : false,
                    required: true
                },
                {
                    id: 'exercise',
                    title: 'ğŸƒ å®Œæˆé‹å‹•ä»»å‹™',
                    description: 'å®Œæˆç•¶æ—¥æŒ‡å®šé‹å‹•é …ç›®è‡³å°‘30åˆ†é˜',
                    points: 1,
                    isCompleted: dailyScore ? dailyScore.exercise_done || false : false,
                    required: false
                },
                {
                    id: 'social_share',
                    title: 'ğŸ“± ç¤¾äº¤åª’é«”åˆ†äº«',
                    description: 'åœ¨ç¤¾äº¤åª’é«”åˆ†äº«ä½ çš„é¦¬æ‹‰æ¾é€²åº¦æˆ–æˆæœ',
                    points: 1,
                    isCompleted: dailyScore ? dailyScore.social_shared || false : false,
                    required: false
                }
            ];
            
            // ç”Ÿæˆä»»å‹™ HTML
            let html = '';
            let completedCount = 0;
            
            dailyTasks.forEach(task => {
                const isToday = currentDate.toDateString() === new Date().toDateString();
                const canComplete = isToday || task.isCompleted;
                
                html += `
                <div class="task-card">
                    <div class="task-title">
                        ${task.title}
                        ${task.isCompleted ? '<span class="completed-badge">å·²å®Œæˆ</span>' : ''}
                    </div>
                    <div class="task-desc">${task.description}</div>
                    <div class="task-meta">
                        <div>${task.required ? 'å¿…åšä»»å‹™' : 'é¸åšä»»å‹™'}</div>
                        <div class="task-points">+${task.points} ç©åˆ†</div>
                    </div>
                    
                    <div class="task-actions">
                        <button class="task-btn ${task.isCompleted ? 'complete' : 'pending'} ${!canComplete ? 'disabled' : ''}" 
                                onclick="toggleTask('${task.id}')"
                                ${!canComplete ? 'disabled' : ''}>
                            ${task.isCompleted ? 'âœ… å·²å®Œæˆ' : 'â¬œ æ¨™è¨˜å®Œæˆ'}
                        </button>
                        ${task.id === 'social_share' ? `
                        <button class="task-btn" style="background: #4267B2; color: white;" onclick="shareToSocial()">
                            ğŸ“˜ ç«‹å³åˆ†äº«
                        </button>
                        ` : ''}
                    </div>
                </div>`;
                
                if (task.isCompleted) completedCount++;
            });
            
            // æ·»åŠ è½‰ä»‹ç´¹ä»»å‹™ï¼ˆç‰¹æ®Šä»»å‹™ï¼‰
            html += `
            <div class="task-card" style="border-left: 5px solid #9b59b6;">
                <div class="task-title">ğŸ‘¥ è½‰ä»‹ç´¹ä»»å‹™ (é¡å¤–çå‹µ)</div>
                <div class="task-desc">
                    ä»‹ç´¹1ä½æœ‹å‹åƒåŠ é¦¬æ‹‰æ¾ä¸¦ä»‹ç´¹ä½¿ç”¨æ…¢è·‘è¨ˆç®—ï¼Œå¯ç²å¾— <strong>15ç©åˆ†</strong><br>
                    é‚€è«‹æ–°æœ‹å‹åƒåŠ ç ”è¨æœƒï¼š<strong>2ç©åˆ†</strong><br>
                    æœ‹å‹é¦–æ¬¡åƒåŠ ç ”è¨æœƒï¼š<strong>2ç©åˆ†</strong>
                </div>
                <div class="task-meta">
                    <div>ç‰¹åˆ¥ä»»å‹™</div>
                    <div class="task-points">æœ€é«˜ +19 ç©åˆ†</div>
                </div>
                
                <div class="task-actions">
                    <button class="task-btn" style="background: #9b59b6; color: white;" onclick="reportReferral()">
                        ğŸ“ å ±å‘Šè½‰ä»‹ç´¹
                    </button>
                </div>
            </div>`;
            
            container.innerHTML = html;
            hideError(); // è¼‰å…¥æˆåŠŸï¼Œéš±è—éŒ¯èª¤è¨Šæ¯
            
            // æ›´æ–°çµ±è¨ˆ
            updateTaskStats(completedCount, dailyTasks.length);
            
            // æª¢æŸ¥æ˜¯å¦æ‰€æœ‰å¿…åšä»»å‹™éƒ½å®Œæˆäº†
            const allRequiredCompleted = dailyTasks
                .filter(task => task.required)
                .every(task => task.isCompleted);
            
            const isToday = currentDate.toDateString() === new Date().toDateString();
            
            if (allRequiredCompleted && isToday) {
                document.getElementById('completion-message').classList.remove('hidden');
                document.getElementById('earned-points').textContent = dailyTasks.reduce((sum, task) => sum + (task.isCompleted ? task.points : 0), 0);
                document.getElementById('earned-tickets').textContent = calculateTickets(completedCount);
            } else {
                document.getElementById('completion-message').classList.add('hidden');
            }
            
        } catch (error) {
            console.error('è¼‰å…¥ä»»å‹™éŒ¯èª¤:', error);
            
            // é¡¯ç¤ºå‹å¥½çš„éŒ¯èª¤è¨Šæ¯
            let errorMessage = 'è¼‰å…¥ä»»å‹™å¤±æ•—';
            if (error.message.includes('è³‡æ–™è¡¨å°šæœªåˆå§‹åŒ–')) {
                errorMessage = 'ç³»çµ±æ­£åœ¨åˆå§‹åŒ–ï¼Œè«‹ç¨å¾Œå†è©¦';
            } else if (error.message.includes('network')) {
                errorMessage = 'ç¶²è·¯é€£ç·šä¸ç©©å®šï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯';
            }
            
            container.innerHTML = `
                <div class="task-card" style="text-align: center; color: #e74c3c;">
                    <h3>${errorMessage}</h3>
                    <p>éŒ¯èª¤è¨Šæ¯: ${error.message}</p>
                    <button class="retry-btn" onclick="location.reload()">é‡æ–°æ•´ç†é é¢</button>
                </div>
            `;
            
            showError(errorMessage);
        }
    }
    
    // æ›´æ–°ä»»å‹™çµ±è¨ˆ
    function updateTaskStats(completed, total) {
        document.getElementById('completed-tasks').textContent = `${completed}/${total}`;
    }
    
    // è¨ˆç®—æŠ½çåˆ¸æ•¸é‡
    function calculateTickets(completedTasks) {
        // åŸºç¤ï¼šå®Œæˆæ‰€æœ‰å¿…åšä»»å‹™ = 1å¼µ
        // é¡å¤–ï¼šæ¯å®Œæˆä¸€å€‹é¸åšä»»å‹™ = 0.5å¼µï¼ˆå››æ¨äº”å…¥ï¼‰
        const requiredTasks = dailyTasks.filter(task => task.required);
        const optionalTasks = dailyTasks.filter(task => !task.required);
        
        const requiredCompleted = requiredTasks.filter(task => task.isCompleted).length;
        const optionalCompleted = optionalTasks.filter(task => task.isCompleted).length;
        
        let tickets = 0;
        if (requiredCompleted === requiredTasks.length) {
            tickets += 1; // å®Œæˆæ‰€æœ‰å¿…åšä»»å‹™
        }
        tickets += Math.round(optionalCompleted * 0.5); // é¸åšä»»å‹™çå‹µ
        
        return tickets;
    }
    
    // æ›´æ–°çµ±è¨ˆæ•¸æ“š
    async function updateStats() {
        try {
            // ç²å–ç”¨æˆ¶è³‡æ–™
            const { data: profile, error } = await sb
                .from('profiles')
                .select('points')
                .eq('id', currentUser.id)
                .single();
            
            if (!error && profile) {
                // ä»Šæ—¥ç©åˆ†ï¼ˆç°¡åŒ–é¡¯ç¤ºï¼‰
                const today = new Date().toISOString().split('T')[0];
                const { data: todayScore } = await sb
                    .from('daily_scores')
                    .select('total_points')
                    .eq('user_id', currentUser.id)
                    .eq('date', today)
                    .maybeSingle();
                
                document.getElementById('today-points').textContent = todayScore ? todayScore.total_points || '0' : '0';
                
                // ç´¯ç©æŠ½çåˆ¸ï¼ˆæ¯100ç©åˆ†æ›1å¼µæŠ½çåˆ¸ï¼‰
                const tickets = Math.floor((profile.points || 0) / 100);
                document.getElementById('total-tickets').textContent = tickets;
                document.getElementById('ticket-count').textContent = tickets;
                
                // æŠ½çåˆ¸ç·¨è™Ÿ
                document.getElementById('ticket-number').textContent = `T${currentUser.id.substring(0, 8).toUpperCase()}`;
            }
            
            // ç²å–é€£çºŒå®Œæˆå¤©æ•¸ï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰
            const { data: streakData } = await sb
                .from('daily_scores')
                .select('date')
                .eq('user_id', currentUser.id)
                .eq('task_completed', true)
                .order('date', { ascending: false });
            
            if (streakData && streakData.length > 0) {
                document.getElementById('task-streak').textContent = Math.min(streakData.length, 30);
            }
            
        } catch (error) {
            console.error('æ›´æ–°çµ±è¨ˆéŒ¯èª¤:', error);
            // çµ±è¨ˆéŒ¯èª¤ä¸é¡¯ç¤ºçµ¦ç”¨æˆ¶ï¼Œä½¿ç”¨é»˜èªå€¼
        }
    }
    
    // åˆ‡æ›ä»»å‹™å®Œæˆç‹€æ…‹
    window.toggleTask = async function(taskId) {
        const task = dailyTasks.find(t => t.id === taskId);
        if (!task) return;
        
        const isToday = currentDate.toDateString() === new Date().toDateString();
        if (!isToday) {
            alert('åªèƒ½æ¨™è¨˜ä»Šæ—¥çš„ä»»å‹™');
            return;
        }
        
        const newStatus = !task.isCompleted;
        const dateStr = currentDate.toISOString().split('T')[0];
        
        try {
            // é¦–å…ˆå˜—è©¦ç²å–ç¾æœ‰çš„ daily_scores è¨˜éŒ„
            const { data: existingRecord } = await sb
                .from('daily_scores')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('date', dateStr)
                .maybeSingle();
            
            // æº–å‚™æ›´æ–°æ•¸æ“š
            let updateData = existingRecord || {
                user_id: currentUser.id,
                date: dateStr,
                created_at: new Date().toISOString()
            };
            
            // æ ¹æ“šä»»å‹™IDæ›´æ–°å°æ‡‰æ¬„ä½
            switch(taskId) {
                case 'weight_check':
                    updateData.weight_recorded = newStatus;
                    break;
                case 'shake_used':
                    updateData.shake_used = newStatus;
                    break;
                case 'live_session':
                    updateData.task_completed = newStatus;
                    break;
                case 'exercise':
                    updateData.exercise_done = newStatus;
                    break;
                case 'social_share':
                    updateData.social_shared = newStatus;
                    break;
            }
            
            // è¨ˆç®—ç¸½åˆ†æ•¸ï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰
            updateData.total_points = calculateDailyPoints(updateData);
            updateData.updated_at = new Date().toISOString();
            
            // ä½¿ç”¨ upsert æ›´æ–°æˆ–å‰µå»ºè¨˜éŒ„
            const { error } = await sb
                .from('daily_scores')
                .upsert(updateData, { 
                    onConflict: 'user_id,date',
                    returning: 'minimal'
                });
            
            if (error) {
                // å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œå˜—è©¦å‰µå»ºç°¡å–®è¨˜éŒ„
                console.warn('æ›´æ–° daily_scores å¤±æ•—ï¼Œä½¿ç”¨ç°¡åŒ–æ¨¡å¼:', error);
                
                // æ›´æ–°æœ¬åœ°ä»»å‹™ç‹€æ…‹
                task.isCompleted = newStatus;
                loadTasks();
                alert('ä»»å‹™ç‹€æ…‹å·²æ›´æ–°ï¼ˆæœ¬åœ°ï¼‰');
                return;
            }
            
            // æ›´æ–°æœ¬åœ°ä»»å‹™ç‹€æ…‹
            task.isCompleted = newStatus;
            
            // é‡æ–°è¼‰å…¥ä»»å‹™å’Œæ›´æ–°çµ±è¨ˆ
            loadTasks();
            updateStats();
            
        } catch (error) {
            console.error('æ›´æ–°ä»»å‹™ç‹€æ…‹éŒ¯èª¤:', error);
            alert('æ›´æ–°å¤±æ•—: ' + error.message);
        }
    };
    
    // è¨ˆç®—æ¯æ—¥ç©åˆ†ï¼ˆç°¡åŒ–ç‰ˆæœ¬ï¼‰
    function calculateDailyPoints(data) {
        let points = 0;
        
        // å®Œæˆä¸€åœˆï¼ˆé«”é‡+é£²é£Ÿ+å¥¶æ˜”+ç›´æ’­ï¼‰
        if (data.weight_recorded && data.shake_used && data.task_completed) {
            points += 1;
        }
        
        // å…¶ä»–ä»»å‹™å„1åˆ†
        if (data.weight_recorded) points += 1;
        if (data.shake_used) points += 1;
        if (data.exercise_done) points += 1;
        if (data.social_shared) points += 1;
        if (data.task_completed) points += 1;
        
        return points;
    }
    
    // å ±å‘Šè½‰ä»‹ç´¹
    window.reportReferral = function() {
        const friendName = prompt('è«‹è¼¸å…¥æ‚¨ä»‹ç´¹çš„æœ‹å‹å§“å:');
        const friendContact = prompt('è«‹è¼¸å…¥æœ‹å‹çš„è¯çµ¡æ–¹å¼ (é›»è©±/Email):');
        
        if (friendName && friendContact) {
            alert(`å·²è¨˜éŒ„è½‰ä»‹ç´¹: ${friendName}\næˆ‘å€‘æœƒè¯ç¹«æ‚¨çš„æœ‹å‹ï¼ŒæˆåŠŸåŠ å…¥å¾Œæ‚¨å°‡ç²å¾—ç©åˆ†ï¼`);
            // é€™è£¡æ‡‰è©²ç™¼é€åˆ°å¾Œç«¯è¨˜éŒ„è½‰ä»‹ç´¹
        }
    };
    
    // ç¤¾äº¤åˆ†äº«
    window.shareToSocial = function() {
        const shareText = encodeURIComponent('æˆ‘æ­£åœ¨åƒåŠ é¦¬æ‹‰æ¾å¥åº·æŒ‘æˆ°ï¼æ¯å¤©å®Œæˆä»»å‹™ç²å¾—ç©åˆ†ï¼Œä¸€èµ·ä¾†åƒåŠ å§ï¼');
        const shareUrl = encodeURIComponent(window.location.origin);
        
        // å¯ä»¥æ‰“é–‹å¤šå€‹åˆ†äº«é¸é …
        const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${shareUrl}&quote=${shareText}`;
        const whatsappUrl = `https://wa.me/?text=${shareText}%20${shareUrl}`;
        
        if (confirm('é¸æ“‡åˆ†äº«æ–¹å¼ï¼š\nç¢ºå®š = Facebook\nå–æ¶ˆ = WhatsApp')) {
            window.open(facebookUrl, '_blank');
        } else {
            window.open(whatsappUrl, '_blank');
        }
        
        // æ¨™è¨˜ç¤¾äº¤åˆ†äº«ä»»å‹™ç‚ºå®Œæˆ
        const socialTask = dailyTasks.find(t => t.id === 'social_share');
        if (socialTask && !socialTask.isCompleted) {
            toggleTask('social_share');
        }
    };
</script>
</body>
</html>
