<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰¯éšŠé•·ç®¡ç†</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #3498db; --success: #2ecc71; --warning: #f39c12; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 25px; padding: 20px; background: white; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        h1 { color: #2c3e50; margin: 0; font-size: 28px; }
        .subtitle { color: #7f8c8d; margin-top: 8px; font-size: 14px; }
        .back-btn { position: fixed; top: 20px; left: 20px; background: white; color: var(--primary); border: 2px solid var(--primary); padding: 10px 20px; border-radius: 50px; cursor: pointer; font-weight: bold; z-index: 100; }
        .card { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .btn { padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 16px; margin: 10px 5px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .hidden { display: none; }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
    </style>
</head>
<body>
    <button class="back-btn" onclick="window.location.href='index.html'">â† è¿”å›</button>
    
    <div class="container">
        <div class="header">
            <h1>â­ å‰¯éšŠé•·ç®¡ç†</h1>
            <div class="subtitle" id="team-info">è¼‰å…¥ä¸­...</div>
        </div>
        
        <div class="card">
            <h3>ğŸ“‹ å‰¯éšŠé•·ä¸»è¦åŠŸèƒ½</h3>
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="window.location.href='deputy-tasks.html'">
                    âœ… ä»»å‹™ç‹€æ…‹ç®¡ç†
                </button>
                <button class="btn btn-primary" onclick="viewTeamMembers()">
                    ğŸ‘¥ æŸ¥çœ‹åœ˜éšŠæˆå“¡
                </button>
                <button class="btn btn-primary" onclick="viewTeamProgress()">
                    ğŸ“Š åœ˜éšŠé€²åº¦å ±å‘Š
                </button>
                <button class="btn btn-success" onclick="contactCaptain()">
                    ğŸ‘‘ è¯ç¹«éšŠé•·
                </button>
            </div>
        </div>
        
        <div class="card">
            <h3>ğŸ“¢ ä»Šæ—¥æé†’</h3>
            <div id="today-tasks" style="margin-top: 15px;">
                <div class="loading">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
        
        <div class="card">
            <h3>ğŸ“ å¿«é€Ÿè¯ç¹«</h3>
            <div style="margin-top: 15px;">
                <p>éšŠé•·: <span id="captain-info">è¼‰å…¥ä¸­...</span></p>
                <p>åœ˜éšŠID: <span id="team-id">è¼‰å…¥ä¸­...</span></p>
                <button class="btn btn-primary" onclick="copyTeamId()">
                    ğŸ“‹ è¤‡è£½åœ˜éšŠID
                </button>
            </div>
        </div>
    </div>

<script>
    // Supabase é…ç½®
    const SUPABASE_URL = 'https://sdloakutxcsbshcqpxwn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbG9ha3V0eGNzYnNoY3FweHduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMTE4MjYsImV4cCI6MjA4MTY4NzgyNn0.5OBQQAinARnZQ6VSCrPl60NWmcSG-QiFMmVIJRW7g-0';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // å…¨å±€è®Šæ•¸
    let currentUser = null;
    
    // é é¢è¼‰å…¥
    window.onload = async () => {
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        const { data: { session } } = await sb.auth.getSession();
        if (!session) {
            window.location.href = 'index.html';
            return;
        }
        currentUser = session.user;
        
        // æª¢æŸ¥å‰¯éšŠé•·æ¬Šé™
        await checkDeputyPermission();
        
        // è¼‰å…¥åœ˜éšŠè³‡æ–™
        await loadTeamInfo();
    };
    
    // æª¢æŸ¥å‰¯éšŠé•·æ¬Šé™
    async function checkDeputyPermission() {
        try {
            const { data: profile, error } = await sb
                .from('profiles')
                .select('role')
                .eq('id', currentUser.id)
                .single();
            
            if (error) throw error;
            
            if (profile.role !== 'deputy' && profile.role !== 'captain' && profile.role !== 'admin') {
                alert('åªæœ‰å‰¯éšŠé•·ã€éšŠé•·æˆ–ç®¡ç†å“¡å¯ä»¥è¨ªå•æ­¤é é¢');
                window.location.href = 'index.html';
                return false;
            }
            
            return true;
        } catch (error) {
            console.error('æª¢æŸ¥å‰¯éšŠé•·æ¬Šé™éŒ¯èª¤:', error);
            window.location.href = 'index.html';
            return false;
        }
    }
    
    // è¼‰å…¥åœ˜éšŠè³‡æ–™
    async function loadTeamInfo() {
        try {
            // ç²å–å‰¯éšŠé•·è³‡æ–™
            const { data: deputyProfile, error } = await sb
                .from('profiles')
                .select('current_team_id, full_name')
                .eq('id', currentUser.id)
                .single();
            
            if (error) throw error;
            
            if (!deputyProfile.current_team_id) {
                document.getElementById('team-info').textContent = 'æ‚¨ç›®å‰æ²’æœ‰åŠ å…¥åœ˜éšŠ';
                return;
            }
            
            const teamId = deputyProfile.current_team_id;
            document.getElementById('team-id').textContent = teamId;
            document.getElementById('team-info').textContent = `å‰¯éšŠé•·: ${deputyProfile.full_name} | åœ˜éšŠID: ${teamId}`;
            
            // ç²å–éšŠé•·è³‡è¨Š
            const { data: captain } = await sb
                .from('profiles')
                .select('full_name, email')
                .eq('current_team_id', teamId)
                .eq('role', 'captain')
                .maybeSingle();
            
            if (captain) {
                document.getElementById('captain-info').textContent = `${captain.full_name} (${captain.email})`;
            }
            
            // è¼‰å…¥ä»Šæ—¥ä»»å‹™æé†’
            await loadTodayTasks();
            
        } catch (error) {
            console.error('è¼‰å…¥åœ˜éšŠè³‡æ–™éŒ¯èª¤:', error);
        }
    }
    
    // è¼‰å…¥ä»Šæ—¥ä»»å‹™
    async function loadTodayTasks() {
        const today = new Date().toISOString().split('T')[0];
        const container = document.getElementById('today-tasks');
        
        try {
            // ç²å–åœ˜éšŠæˆå“¡
            const { data: deputyProfile } = await sb
                .from('profiles')
                .select('current_team_id')
                .eq('id', currentUser.id)
                .single();
            
            const teamId = deputyProfile.current_team_id;
            
            const { data: members } = await sb
                .from('profiles')
                .select('id, full_name')
                .eq('current_team_id', teamId);
            
            if (!members || members.length === 0) {
                container.innerHTML = '<p>åœ˜éšŠæš«ç„¡æˆå“¡</p>';
                return;
            }
            
            // æª¢æŸ¥æœªå ±åˆ°æˆå“¡
            const memberIds = members.map(m => m.id);
            const { data: todayRecords } = await sb
                .from('weight_records')
                .select('user_id')
                .in('user_id', memberIds)
                .eq('date', today);
            
            const checkedInIds = todayRecords ? todayRecords.map(r => r.user_id) : [];
            const pendingMembers = members.filter(m => !checkedInIds.includes(m.id));
            
            if (pendingMembers.length === 0) {
                container.innerHTML = '<p>âœ… æ‰€æœ‰æˆå“¡ä»Šæ—¥å·²å ±åˆ°ï¼</p>';
            } else {
                let html = '<p>â³ ä»¥ä¸‹æˆå“¡ä»Šæ—¥å°šæœªå ±åˆ°ï¼š</p><ul style="margin-left: 20px;">';
                pendingMembers.forEach(member => {
                    html += `<li>${member.full_name || 'æœªå‘½å'}</li>`;
                });
                html += '</ul>';
                container.innerHTML = html;
            }
            
        } catch (error) {
            console.error('è¼‰å…¥ä»Šæ—¥ä»»å‹™éŒ¯èª¤:', error);
            container.innerHTML = '<p>ç„¡æ³•è¼‰å…¥ä»»å‹™ç‹€æ…‹</p>';
        }
    }
    
    // æŸ¥çœ‹åœ˜éšŠæˆå“¡
    function viewTeamMembers() {
        window.location.href = 'team.html';
    }
    
    // æŸ¥çœ‹åœ˜éšŠé€²åº¦
    function viewTeamProgress() {
        window.location.href = 'leaderboard.html';
    }
    
    // è¯ç¹«éšŠé•·
    function contactCaptain() {
        const captainInfo = document.getElementById('captain-info').textContent;
        alert(`éšŠé•·è³‡è¨Šï¼š\n${captainInfo}\n\nå»ºè­°è¯ç¹«æ–¹å¼ï¼š\n1. WhatsApp\n2. é›»è©±\n3. åœ˜éšŠæœƒè­°`);
    }
    
    // è¤‡è£½åœ˜éšŠID
    function copyTeamId() {
        const teamId = document.getElementById('team-id').textContent;
        navigator.clipboard.writeText(teamId).then(() => {
            alert('åœ˜éšŠIDå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        });
    }
</script>
</body>
</html>
