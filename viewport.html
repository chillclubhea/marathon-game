<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase 團隊數據管理</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .main-content {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
        }
        
        .card h2 {
            color: #4f46e5;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #475569;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .btn {
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 14px 25px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }
        
        .btn-secondary {
            background: #64748b;
        }
        
        .btn-success {
            background: #10b981;
        }
        
        .btn-danger {
            background: #ef4444;
        }
        
        .result-container {
            margin-top: 25px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result-title {
            font-weight: 600;
            color: #475569;
            margin-bottom: 10px;
        }
        
        pre {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .error {
            color: #ef4444;
            background: #fef2f2;
            border: 1px solid #fecaca;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .success {
            color: #10b981;
            background: #ecfdf5;
            border: 1px solid #a7f3d0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #64748b;
        }
        
        .loading.active {
            display: block;
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        footer {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-size: 14px;
            border-top: 1px solid #e2e8f0;
            margin-top: 30px;
        }
        
        .instructions {
            background: #e0e7ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .data-info {
            background: #f0f9ff;
            border-left: 4px solid #0ea5e9;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .data-info h3 {
            color: #0369a1;
            margin-bottom: 10px;
        }
        
        .data-info ul {
            padding-left: 20px;
        }
        
        .data-info li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Supabase 團隊數據管理</h1>
            <p class="subtitle">根據實際表結構優化團隊成員查詢</p>
        </header>
        
        <div class="main-content">
            <!-- 左側：數據庫結構信息 -->
            <div class="card">
                <h2>1. 數據庫結構確認</h2>
                <div class="data-info">
                    <h3>已確認的表結構：</h3>
                    <ul>
                        <li><strong>profiles 表</strong>：包含 current_team_id 字段，關聯到 teams.id</li>
                        <li><strong>team_members 表</strong>：包含 team_id 和 member_id 字段</li>
                        <li><strong>member_id</strong>：關聯到 profiles.id</li>
                        <li><strong>team_id</strong>：關聯到 teams.id</li>
                    </ul>
                    <p>團隊關係同時存儲在兩個地方：<br>
                    1. profiles.current_team_id (當前團隊)<br>
                    2. team_members 表 (團隊成員關係)</p>
                </div>
                
                <div class="form-group">
                    <label for="supabaseUrl">Supabase URL:</label>
                    <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co" value="https://sdloakutxcsbshcqpxwn.supabase.co">
                </div>
                
                <div class="form-group">
                    <label for="supabaseKey">Supabase Anon Key:</label>
                    <input type="password" id="supabaseKey" placeholder="你的匿名密鑰">
                </div>
                
                <button class="btn" onclick="checkDatabaseStructure()">檢查數據庫結構</button>
                <button class="btn btn-secondary" onclick="testProfilesQuery()">測試 Profiles 查詢</button>
                
                <div class="loading" id="loading1">
                    <div class="loading-spinner"></div>
                    檢查中...
                </div>
                
                <div id="structureResult" class="result-container"></div>
            </div>
            
            <!-- 右側：團隊成員查詢 -->
            <div class="card">
                <h2>2. 團隊成員查詢方案</h2>
                <div class="instructions">
                    <p><strong>錯誤原因：</strong>profiles 表中沒有 team_id 字段，只有 current_team_id</p>
                    <p><strong>解決方案：</strong>使用 current_team_id 或通過 team_members 表查詢</p>
                </div>
                
                <div class="form-group">
                    <label for="teamId">團隊 ID:</label>
                    <input type="text" id="teamId" value="1780c31e-c226-4814-b087-5f339b7ba016">
                </div>
                
                <div class="btn-group">
                    <button class="btn" onclick="testCurrentTeamIdQuery()">使用 current_team_id 查詢</button>
                    <button class="btn btn-secondary" onclick="testTeamMembersQuery()">通過 team_members 查詢</button>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-success" onclick="createTestData()">創建測試數據</button>
                    <button class="btn btn-danger" onclick="clearTestData()">清除測試數據</button>
                </div>
                
                <div class="loading" id="loading2">
                    <div class="loading-spinner"></div>
                    處理中...
                </div>
                
                <div id="teamResult" class="result-container"></div>
            </div>
        </div>
        
        <div class="card" style="margin: 0 30px 30px;">
            <h2>3. 查詢方法詳解</h2>
            
            <div class="data-info">
                <h3>方法一：使用 current_team_id (推薦)</h3>
                <p>直接查詢 profiles 表中 current_team_id 等於指定團隊的用戶：</p>
                <pre>
const { data, error } = await supabase
  .from('profiles')
  .select('id, full_name, avatar_url, role')
  .eq('current_team_id', '團隊ID');
                </pre>
                <p><strong>優點：</strong>簡單直接，一次查詢<br>
                <strong>缺點：</strong>只能獲取當前團隊成員</p>
            </div>
            
            <div class="data-info">
                <h3>方法二：通過 team_members 表</h3>
                <p>先查詢 team_members 表，再獲取用戶信息：</p>
                <pre>
// 第一步：獲取團隊成員ID
const { data: teamMembers, error: tmError } = await supabase
  .from('team_members')
  .select('member_id')
  .eq('team_id', '團隊ID');

// 第二步：獲取用戶信息
const memberIds = teamMembers.map(member => member.member_id);
const { data: profiles, error: pError } = await supabase
  .from('profiles')
  .select('id, full_name, avatar_url, role')
  .in('id', memberIds);
                </pre>
                <p><strong>優點：</strong>可以獲取所有歷史團隊成員<br>
                <strong>缺點：</strong>需要兩次查詢</p>
            </div>
            
            <div class="form-group">
                <label for="customQuery">自定義查詢 (SQL):</label>
                <textarea id="customQuery" rows="4">SELECT p.id, p.full_name, p.avatar_url, p.role, p.current_team_id, tm.joined_at FROM profiles p LEFT JOIN team_members tm ON p.id = tm.member_id WHERE p.current_team_id = '1780c31e-c226-4814-b087-5f339b7ba016';</textarea>
            </div>
            
            <button class="btn" onclick="runCustomQuery()">執行自定義查詢</button>
            
            <div id="customResult" class="result-container"></div>
        </div>
        
        <footer>
            <p>Supabase 團隊數據管理工具 &copy; 2024</p>
            <p>根據實際表結構優化 - profiles.current_team_id 和 team_members 表</p>
        </footer>
    </div>

    <script>
        let supabaseClient = null;
        
        // 初始化 Supabase 客戶端
        function initSupabase() {
            const supabaseUrl = document.getElementById('supabaseUrl').value.trim();
            const supabaseKey = document.getElementById('supabaseKey').value.trim();
            
            if (!supabaseUrl || !supabaseKey) {
                alert('請填寫 Supabase URL 和 Anon Key');
                return false;
            }
            
            supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
            return true;
        }
        
        // 檢查數據庫結構
        async function checkDatabaseStructure() {
            if (!initSupabase()) return;
            
            const loading = document.getElementById('loading1');
            const resultDiv = document.getElementById('structureResult');
            
            loading.classList.add('active');
            resultDiv.innerHTML = '';
            
            try {
                // 檢查 profiles 表結構
                const { data: profilesData, error: profilesError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .limit(2);
                
                if (profilesError) throw profilesError;
                
                // 檢查 team_members 表結構
                const { data: teamMembersData, error: tmError } = await supabaseClient
                    .from('team_members')
                    .select('*')
                    .limit(2);
                
                // 顯示結果
                let html = `
                    <div class="result-title">數據庫結構分析</div>
                    <div class="success">
                        <p><strong>✓ Supabase 連接成功</strong></p>
                        <p>URL: ${document.getElementById('supabaseUrl').value}</p>
                    </div>
                `;
                
                if (profilesData && profilesData.length > 0) {
                    const profile = profilesData[0];
                    const fields = Object.keys(profile);
                    
                    html += `
                        <div class="success" style="margin-top: 15px;">
                            <p><strong>profiles 表結構 (示例記錄):</strong></p>
                            <pre>${JSON.stringify(profile, null, 2)}</pre>
                            <p><strong>重要字段:</strong></p>
                            <ul>
                                <li>id: ${profile.id}</li>
                                <li>full_name: ${profile.full_name || '空'}</li>
                                <li>current_team_id: ${profile.current_team_id || '空'}</li>
                                <li>role: ${profile.role || '空'}</li>
                            </ul>
                        </div>
                    `;
                    
                    // 檢查是否有 current_team_id
                    const hasCurrentTeamId = fields.includes('current_team_id');
                    const hasTeamId = fields.includes('team_id');
                    
                    html += `
                        <div class="${hasCurrentTeamId ? 'success' : 'error'}" style="margin-top: 15px;">
                            <p><strong>profiles 表分析:</strong></p>
                            <p>是否有 current_team_id 字段: ${hasCurrentTeamId ? '✓ 是' : '✗ 否'}</p>
                            <p>是否有 team_id 字段: ${hasTeamId ? '✓ 是' : '✗ 否'}</p>
                            <p>當前示例的 current_team_id: ${profile.current_team_id || '未設置'}</p>
                        </div>
                    `;
                }
                
                if (teamMembersData && teamMembersData.length > 0) {
                    const teamMember = teamMembersData[0];
                    
                    html += `
                        <div class="success" style="margin-top: 15px;">
                            <p><strong>team_members 表結構 (示例記錄):</strong></p>
                            <pre>${JSON.stringify(teamMember, null, 2)}</pre>
                            <p><strong>重要字段:</strong></p>
                            <ul>
                                <li>team_id: ${teamMember.team_id}</li>
                                <li>member_id: ${teamMember.member_id}</li>
                                <li>joined_at: ${new Date(teamMember.joined_at).toLocaleString()}</li>
                            </ul>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="error" style="margin-top: 15px;">
                            <p><strong>team_members 表:</strong> 表中沒有數據或無法訪問</p>
                            <p>請創建測試數據</p>
                        </div>
                    `;
                }
                
                // 檢查 teams 表
                const { data: teamsData, error: teamsError } = await supabaseClient
                    .from('"Teams"')
                    .select('id, team_name')
                    .limit(3);
                
                if (!teamsError && teamsData && teamsData.length > 0) {
                    html += `
                        <div class="success" style="margin-top: 15px;">
                            <p><strong>teams 表 (前3個團隊):</strong></p>
                            <pre>${JSON.stringify(teamsData, null, 2)}</pre>
                        </div>
                    `;
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <p><strong>檢查數據庫結構時出錯:</strong></p>
                        <pre>${error.message}</pre>
                    </div>
                `;
            } finally {
                loading.classList.remove('active');
            }
        }

        async function testProfilesQuery() {
    if (!initSupabase()) return;

    const loading = document.getElementById('loading1');
    const resultDiv = document.getElementById('structureResult');

    loading.classList.add('active');
    resultDiv.innerHTML = '<div class="result-title">测试原始错误查询</div>';

    try {
        const teamId = document.getElementById('teamId').value;

        // 测试1: 使用错误的字段 'team_id' 查询（这将失败）
        resultDiv.innerHTML += `<p><strong>测试1 (错误查询):</strong> 使用 'team_id' 字段查询</p>`;
        const { data: data1, error: error1 } = await supabaseClient
            .from('profiles')
            .select('id, full_name, avatar_url, role')
            .eq('team_id', teamId); // profiles 表中没有 team_id 字段

        if (error1) {
            resultDiv.innerHTML += `<div class="error"><p>预期中的失败: ${error1.message}</p></div>`;
        }

        // 测试2: 使用正确的字段 'current_team_id' 查询（这应该成功）
        resultDiv.innerHTML += `<p style="margin-top:20px"><strong>测试2 (正确查询):</strong> 使用 'current_team_id' 字段查询</p>`;
        const { data: data2, error: error2 } = await supabaseClient
            .from('profiles')
            .select('id, full_name, avatar_url, role, current_team_id')
            .eq('current_team_id', teamId); // 使用正确的字段

        if (error2) {
            resultDiv.innerHTML += `<div class="error"><p>查询失败: ${error2.message}</p></div>`;
        } else {
            resultDiv.innerHTML += `<div class="success"><p>查询成功！找到 ${data2.length} 个团队成员。</p><pre>${JSON.stringify(data2, null, 2)}</pre></div>`;
        }

    } catch (error) {
        resultDiv.innerHTML += `<div class="error"><p>函数执行出错: ${error.message}</p></div>`;
    } finally {
        loading.classList.remove('active');
    }
}
        
        // 測試使用 current_team_id 查詢
        async function testCurrentTeamIdQuery() {
            if (!initSupabase()) return;
            
            const loading = document.getElementById('loading2');
            const resultDiv = document.getElementById('teamResult');
            const teamId = document.getElementById('teamId').value;
            
            loading.classList.add('active');
            resultDiv.innerHTML = '<div class="result-title">使用 current_team_id 查詢</div>';
            
            try {
                // 方法1: 直接使用 current_team_id 查詢
                resultDiv.innerHTML += `<p><strong>查詢語句:</strong> profiles?select=id,full_name,avatar_url,role&current_team_id=eq.${teamId}</p>`;
                
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('id, full_name, avatar_url, role, current_team_id')
                    .eq('current_team_id', teamId);
                
                if (error) {
                    resultDiv.innerHTML += `
                        <div class="error">
                            <p>查詢失敗: ${error.message}</p>
                            <p>可能原因: profiles 表中沒有 current_team_id 字段，或字段名稱不同</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML += `
                        <div class="${data.length > 0 ? 'success' : 'error'}">
                            <p>查詢成功: 找到 ${data.length} 個當前團隊成員</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
                
                // 測試原始錯誤的查詢方式
                resultDiv.innerHTML += `<p style="margin-top: 20px;"><strong>對比測試 (原始錯誤查詢):</strong></p>`;
                resultDiv.innerHTML += `<p>嘗試: profiles?select=id,full_name,avatar_url,role&team_id=eq.${teamId}</p>`;
                
                const { data: data2, error: error2 } = await supabaseClient
                    .from('profiles')
                    .select('id, full_name, avatar_url, role')
                    .eq('team_id', teamId);
                
                if (error2) {
                    resultDiv.innerHTML += `
                        <div class="error">
                            <p>原始查詢失敗 (預期中): ${error2.message}</p>
                            <p>這就是原始錯誤的原因 - profiles 表中沒有 team_id 字段</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML += `
                    <div class="error">
                        <p><strong>查詢時出錯:</strong></p>
                        <pre>${error.message}</pre>
                    </div>
                `;
            } finally {
                loading.classList.remove('active');
            }
        }
        
        // 測試通過 team_members 表查詢
        async function testTeamMembersQuery() {
            if (!initSupabase()) return;
            
            const loading = document.getElementById('loading2');
            const resultDiv = document.getElementById('teamResult');
            const teamId = document.getElementById('teamId').value;
            
            loading.classList.add('active');
            resultDiv.innerHTML = '<div class="result-title">通過 team_members 表查詢</div>';
            
            try {
                // 方法1: 分兩步查詢
                resultDiv.innerHTML += `<p><strong>方法1: 分兩步查詢</strong></p>`;
                
                // 第一步: 獲取 team_members 中的 member_id
                const { data: teamMembers, error: step1Error } = await supabaseClient
                    .from('team_members')
                    .select('member_id, joined_at')
                    .eq('team_id', teamId);
                
                if (step1Error) {
                    resultDiv.innerHTML += `
                        <div class="error">
                            <p>第一步失敗: ${step1Error.message}</p>
                            <p>可能 team_members 表是空的或字段名稱不同</p>
                        </div>
                    `;
                } else if (teamMembers.length === 0) {
                    resultDiv.innerHTML += `
                        <div class="error">
                            <p>團隊 ${teamId} 中沒有成員記錄</p>
                            <p>team_members 表中沒有找到相關記錄</p>
                        </div>
                    `;
                } else {
                    // 第二步: 根據 member_id 獲取 profiles
                    const memberIds = teamMembers.map(m => m.member_id);
                    
                    const { data: memberProfiles, error: step2Error } = await supabaseClient
                        .from('profiles')
                        .select('id, full_name, avatar_url, role, current_team_id')
                        .in('id', memberIds);
                    
                    if (step2Error) {
                        resultDiv.innerHTML += `
                            <div class="error">
                                <p>第二步失敗: ${step2Error.message}</p>
                            </div>
                        `;
                    } else {
                        // 合併數據，加入 joined_at
                        const combinedData = memberProfiles.map(profile => {
                            const teamMember = teamMembers.find(tm => tm.member_id === profile.id);
                            return {
                                ...profile,
                                joined_at: teamMember ? teamMember.joined_at : null
                            };
                        });
                        
                        resultDiv.innerHTML += `
                            <div class="success">
                                <p>分兩步查詢成功: 找到 ${combinedData.length} 個團隊成員</p>
                                <pre>${JSON.stringify(combinedData, null, 2)}</pre>
                            </div>
                        `;
                    }
                }
                
                // 方法2: 連接查詢
                resultDiv.innerHTML += `<p style="margin-top: 20px;"><strong>方法2: 使用 Supabase 連接查詢</strong></p>`;
                
                try {
                    const { data: joinedData, error: joinError } = await supabaseClient
                        .from('team_members')
                        .select(`
                            member_id,
                            joined_at,
                            profiles:member_id (id, full_name, avatar_url, role, current_team_id)
                        `)
                        .eq('team_id', teamId);
                    
                    if (joinError) {
                        resultDiv.innerHTML += `
                            <div class="error">
                                <p>連接查詢失敗: ${joinError.message}</p>
                                <p>Supabase 可能不支持這種連接方式，或字段名稱不匹配</p>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML += `
                            <div class="success">
                                <p>連接查詢成功: 找到 ${joinedData.length} 個團隊成員</p>
                                <pre>${JSON.stringify(joinedData, null, 2)}</pre>
                            </div>
                        `;
                    }
                } catch (joinErr) {
                    resultDiv.innerHTML += `
                        <div class="error">
                            <p>連接查詢異常: ${joinErr.message}</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML += `
                    <div class="error">
                        <p><strong>查詢時出錯:</strong></p>
                        <pre>${error.message}</pre>
                    </div>
                `;
            } finally {
                loading.classList.remove('active');
            }
        }
        
        // 創建測試數據
        async function createTestData() {
            if (!initSupabase()) return;
            
            if (!confirm('這將創建測試團隊和成員數據。確定繼續嗎？')) return;
            
            const loading = document.getElementById('loading2');
            const resultDiv = document.getElementById('teamResult');
            
            loading.classList.add('active');
            resultDiv.innerHTML = '<div class="result-title">創建測試數據</div>';
            
            try {
                const teamId = document.getElementById('teamId').value;
                
                // 1. 檢查/創建團隊
                const { data: existingTeams, error: checkError } = await supabaseClient
                    .from('"Teams"')
                    .select('id, name')
                    .eq('id', teamId);
                
                let teamExists = false;
                
                if (!checkError && existingTeams && existingTeams.length > 0) {
                    teamExists = true;
                    resultDiv.innerHTML += `
                        <div class="success">
                            <p>團隊已存在: ${existingTeams[0].name} (${existingTeams[0].id})</p>
                        </div>
                    `;
                }
                
                // 2. 如果團隊不存在，創建一個
                if (!teamExists) {
                    resultDiv.innerHTML += `<p>創建新團隊...</p>`;
                    
                    const { data: newTeam, error: teamError } = await supabaseClient
                        .from('"Teams"')
                        .insert([
                            {
                                id: teamId,
                                name: '測試團隊',
                                description: '這是創建的測試團隊',
                                created_at: new Date().toISOString()
                            }
                        ])
                        .select();
                    
                    if (teamError) {
                        resultDiv.innerHTML += `
                            <div class="error">
                                <p>創建團隊失敗: ${teamError.message}</p>
                            </div>
                        `;
                        return;
                    } else {
                        resultDiv.innerHTML += `
                            <div class="success">
                                <p>團隊創建成功: ${newTeam[0].name}</p>
                            </div>
                        `;
                    }
                }
                
                // 3. 獲取一些用戶來添加到團隊
                resultDiv.innerHTML += `<p>獲取用戶添加到團隊...</p>`;
                
                const { data: profiles, error: profilesError } = await supabaseClient
                    .from('profiles')
                    .select('id, full_name')
                    .limit(3);
                
                if (profilesError || !profiles || profiles.length === 0) {
                    resultDiv.innerHTML += `
                        <div class="error">
                            <p>無法獲取用戶: ${profilesError ? profilesError.message : '沒有找到用戶'}</p>
                            <p>請先確保 profiles 表中有數據</p>
                        </div>
                    `;
                } else {
                    // 4. 更新用戶的 current_team_id
                    resultDiv.innerHTML += `<p>更新用戶的 current_team_id...</p>`;
                    
                    const updatePromises = profiles.map(profile => 
                        supabaseClient
                            .from('profiles')
                            .update({ current_team_id: teamId })
                            .eq('id', profile.id)
                    );
                    
                    const updateResults = await Promise.all(updatePromises);
                    const updateErrors = updateResults.filter(r => r.error).map(r => r.error);
                    
                    if (updateErrors.length > 0) {
                        resultDiv.innerHTML += `
                            <div class="error">
                                <p>更新 current_team_id 時部分失敗:</p>
                                <pre>${JSON.stringify(updateErrors, null, 2)}</pre>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML += `
                            <div class="success">
                                <p>成功更新 ${profiles.length} 個用戶的 current_team_id</p>
                            </div>
                        `;
                    }
                    
                    // 5. 將用戶添加到 team_members
                    const teamMembersData = profiles.map(profile => ({
                        team_id: teamId,
                        member_id: profile.id,
                        role: 'member',
                        joined_at: new Date().toISOString()
                    }));
                    
                    resultDiv.innerHTML += `<p>將 ${profiles.length} 個用戶添加到 team_members...</p>`;
                    
                    const { data: newMembers, error: membersError } = await supabaseClient
                        .from('team_members')
                        .insert(teamMembersData)
                        .select();
                    
                    if (membersError) {
                        resultDiv.innerHTML += `
                            <div class="error">
                                <p>添加團隊成員失敗: ${membersError.message}</p>
                                <p>可能 team_members 表結構不同或權限問題</p>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML += `
                            <div class="success">
                                <p>成功創建 ${newMembers.length} 個團隊成員記錄！</p>
                                <p>現在可以使用兩種方法查詢團隊成員：</p>
                                <ol>
                                    <li>使用 current_team_id 查詢當前團隊成員</li>
                                    <li>通過 team_members 表查詢所有團隊成員記錄</li>
                                </ol>
                            </div>
                        `;
                    }
                }
                
            } catch (error) {
                resultDiv.innerHTML += `
                    <div class="error">
                        <p><strong>創建測試數據時出錯:</strong></p>
                        <pre>${error.message}</pre>
                    </div>
                `;
            } finally {
                loading.classList.remove('active');
            }
        }
        
        // 清除測試數據
        async function clearTestData() {
            if (!initSupabase()) return;
            
            if (!confirm('這將刪除測試團隊成員數據。確定繼續嗎？')) return;
            
            const loading = document.getElementById('loading2');
            const resultDiv = document.getElementById('teamResult');
            
            loading.classList.add('active');
            resultDiv.innerHTML = '<div class="result-title">清除測試數據</div>';
            
            try {
                const teamId = document.getElementById('teamId').value;
                
                // 刪除 team_members 中的測試數據
                const { error: deleteError } = await supabaseClient
                    .from('team_members')
                    .delete()
                    .eq('team_id', teamId);
                
                if (deleteError) {
                    resultDiv.innerHTML += `
                        <div class="error">
                            <p>刪除團隊成員失敗: ${deleteError.message}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML += `
                        <div class="success">
                            <p>已清除團隊 ${teamId} 的所有成員記錄</p>
                        </div>
                    `;
                }
                
                // 清除 current_team_id
                const { error: updateError } = await supabaseClient
                    .from('profiles')
                    .update({ current_team_id: null })
                    .eq('current_team_id', teamId);
                
                if (updateError) {
                    resultDiv.innerHTML += `
                        <div class="error">
                            <p>清除 current_team_id 時出錯: ${updateError.message}</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML += `
                        <div class="success">
                            <p>已清除相關用戶的 current_team_id</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML += `
                    <div class="error">
                        <p><strong>清除測試數據時出錯:</strong></p>
                        <pre>${error.message}</pre>
                    </div>
                `;
            } finally {
                loading.classList.remove('active');
            }
        }
        
        // 執行自定義查詢
        async function runCustomQuery() {
            if (!initSupabase()) return;
            
            const query = document.getElementById('customQuery').value.trim();
            if (!query) {
                alert('請輸入查詢語句');
                return;
            }
            
            const resultDiv = document.getElementById('customResult');
            resultDiv.innerHTML = '<div class="result-title">自定義查詢結果</div>';
            
            try {
                // 嘗試解析查詢類型
                if (query.toLowerCase().includes('select')) {
                    // 簡單的查詢，直接執行
                    if (query.toLowerCase().includes('from profiles')) {
                        // 查詢 profiles 表
                        const { data, error } = await supabaseClient
                            .from('profiles')
                            .select('*')
                            .limit(10);
                        
                        if (error) {
                            resultDiv.innerHTML += `
                                <div class="error">
                                    <p>查詢失敗: ${error.message}</p>
                                </div>
                            `;
                        } else {
                            resultDiv.innerHTML += `
                                <div class="success">
                                    <p>查詢成功: 找到 ${data.length} 條記錄</p>
                                    <pre>${JSON.stringify(data, null, 2)}</pre>
                                </div>
                            `;
                        }
                    } else if (query.toLowerCase().includes('from team_members')) {
                        // 查詢 team_members 表
                        const { data, error } = await supabaseClient
                            .from('team_members')
                            .select('*')
                            .limit(10);
                        
                        if (error) {
                            resultDiv.innerHTML += `
                                <div class="error">
                                    <p>查詢失敗: ${error.message}</p>
                                </div>
                            `;
                        } else {
                            resultDiv.innerHTML += `
                                <div class="success">
                                    <p>查詢成功: 找到 ${data.length} 條記錄</p>
                                    <pre>${JSON.stringify(data, null, 2)}</pre>
                                </div>
                            `;
                        }
                    } else {
                        resultDiv.innerHTML += `
                            <div class="error">
                                <p>不支持的表名，請使用 profiles 或 team_members 表</p>
                            </div>
                        `;
                    }
                } else {
                    resultDiv.innerHTML += `
                        <div class="error">
                            <p>此工具僅支持簡單的 SELECT 查詢測試</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                resultDiv.innerHTML += `
                    <div class="error">
                        <p><strong>執行自定義查詢時出錯:</strong></p>
                        <pre>${error.message}</pre>
                    </div>
                `;
            }
        }
        
        // 頁面加載時顯示使用說明
        window.onload = function() {
            const resultDiv = document.getElementById('structureResult');
            resultDiv.innerHTML = `
                <div class="instructions">
                    <p><strong>問題診斷完成！</strong></p>
                    <p><strong>原始錯誤原因:</strong> profiles 表中沒有 team_id 字段</p>
                    <p><strong>正確字段:</strong> profiles.current_team_id</p>
                    <p><strong>解決方案:</strong></p>
                    <ol>
                        <li>使用 profiles.current_team_id 查詢當前團隊成員</li>
                        <li>或通過 team_members 表查詢所有團隊成員關係</li>
                    </ol>
                    <p><strong>前端代碼修正:</strong> 將查詢條件從 team_id 改為 current_team_id</p>
                </div>
            `;
        };
    </script>
</body>
</html>
