<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšŠä¼ä¹å®®æ ¼æˆ°æ³</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f5; padding: 20px; text-align: center; }
        .grid-container { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; 
            max-width: 450px; margin: 20px auto; padding: 10px; background: #fff; border-radius: 15px;
        }
        .member-card { 
            background: #f8f9fa; border-radius: 10px; padding: 10px 5px; 
            display: flex; flex-direction: column; align-items: center; min-height: 140px;
        }
        .avatar { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; margin-bottom: 5px; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .name { font-weight: bold; font-size: 13px; margin-bottom: 5px; }
        .data-row { font-size: 10px; width: 95%; margin-bottom: 2px; padding: 2px; border-radius: 4px; }
        .diff { font-size: 9px; font-weight: normal; }
        .done { background-color: #d4edda; color: #155724; }
        .pending { background-color: #ffeeba; color: #856404; }
        .btn-capture { background: #e67e22; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .btn-home { display: block; width: 120px; margin: 10px auto; color: #3498db; text-decoration: none; font-size: 14px; }
        .hidden { display: none !important; }
        .invite-box { font-size: 12px; color: #7f8c8d; background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px dashed #ccc; cursor: pointer; }
    </style>
</head>
<body>

    <h2 id="team-title">ğŸ† æˆ°éšŠä¹å®®æ ¼</h2>
    
    <div id="invite-area"></div>

    <div id="grid-display" class="grid-container">
        <p style="grid-column: span 3;">è³‡æ–™è®€å–ä¸­...</p>
    </div>

    <div id="controls">
        <button id="captain-tools" class="btn-capture hidden" onclick="generateImage()">ç”Ÿæˆæˆ°å ±åœ–ç‰‡</button>
        <a href="index.html" class="btn-home">å›å€‹äººä¸­å¿ƒ</a>
    </div>

const SUPABASE_URL = 'https://sdloakutxcsbshcqpxwn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbG9ha3V0eGNzYnNoY3FweHduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMTE4MjYsImV4cCI6MjA4MTY4NzgyNn0.5OBQQAinARnZQ6VSCrPl60NWmcSG-QiFMmVIJRW7g-0';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

window.onload = loadTeamData;

async function loadTeamData() {
    const gridElement = document.getElementById('grid-display');
    
    try {
        // 1. å–å¾—ç™»å…¥è€…
        const { data: { user }, error: authError } = await sb.auth.getUser();
        if (authError || !user) {
            gridElement.innerHTML = "<p style='grid-column: span 3;'>âŒ æœªç™»å…¥æˆ–ç™»å…¥å¤±æ•ˆï¼Œè«‹é‡æ–°ç™»å…¥</p>";
            return;
        }

        // 2. å–å¾—æˆ‘çš„ Profile
        const { data: myProfile, error: profileError } = await sb.from('profiles').select('*').eq('id', user.id).single();
        if (profileError || !myProfile) {
            gridElement.innerHTML = "<p style='grid-column: span 3;'>âŒ æ‰¾ä¸åˆ°å€‹äººè³‡æ–™ï¼Œè«‹å…ˆå›ä¸­å¿ƒè¨­å®š</p>";
            return;
        }

        const teamId = myProfile.current_team_id;
        if (!teamId) {
            gridElement.innerHTML = "<p style='grid-column: span 3;'>âŒ å°šæœªåŠ å…¥éšŠä¼ï¼Œè«‹è¼¸å…¥é‚€è«‹ç¢¼</p>";
            return;
        }

        // 3. éšŠé•·æ¬Šé™é¡¯ç¤º
        if (myProfile.role === 'captain') {
            const captainBtn = document.getElementById('captain-tools');
            if (captainBtn) captainBtn.classList.remove('hidden');
            document.getElementById('invite-area').innerHTML = `
                <div class="invite-box" onclick="copyInvite('${teamId}')">
                    ğŸ“¢ é‚€è«‹ç¢¼ï¼š${teamId} (é»æ“Šè¤‡è£½)
                </div>`;
        }

        // 4. å–å¾—éšŠå‹èˆ‡é«”é‡è³‡æ–™
        const { data: members, error: membersError } = await sb.from('profiles').select('*').eq('current_team_id', teamId);
        if (membersError) throw membersError;

        const today = new Date().toISOString().split('T')[0];
        const yesterdayDate = new Date();
        yesterdayDate.setDate(yesterdayDate.getDate() - 1);
        const yesterday = yesterdayDate.toISOString().split('T')[0];

        const { data: records, error: recordsError } = await sb.from('weight_records')
            .select('*')
            .in('user_id', members.map(m => m.id))
            .in('date', [today, yesterday]);
        
        if (recordsError) throw recordsError;

        // 5. æ¸²æŸ“ä¹å®®æ ¼
        gridElement.innerHTML = "";
        for (let i = 0; i < 9; i++) {
            const member = members[i] || null;
            const card = document.createElement('div');
            card.className = "member-card";

            if (member) {
                const tData = records.find(r => r.user_id === member.id && r.date === today);
                const yData = records.find(r => r.user_id === member.id && r.date === yesterday);

                const getDiff = (now, prev) => {
                    if (now === undefined || prev === undefined) return '--';
                    const d = (now - prev).toFixed(1);
                    return d > 0 ? `+${d}` : d;
                };

                card.innerHTML = `
                    <img class="avatar" src="${member.avatar_url || 'https://via.placeholder.com/60'}" crossorigin="anonymous" onerror="this.src='https://via.placeholder.com/60'">
                    <div class="name">${member.full_name || 'éšŠå‹'}</div>
                    <div class="data-row ${tData ? 'done' : 'pending'}">
                        é«”é‡: ${tData ? tData.weight : '--'} <span class="diff">(${getDiff(tData?.weight, yData?.weight)})</span>
                    </div>
                    <div class="data-row" style="color:#666">
                        é«”è„‚: ${tData?.fat_rate !== undefined ? tData.fat_rate : '--'}% <span class="diff">(${getDiff(tData?.fat_rate, yData?.fat_rate)})</span>
                    </div>
                    <div class="data-row" style="color:#666">
                        è‚Œè‚‰: ${tData?.muscle_mass !== undefined ? tData.muscle_mass : '--'} <span class="diff">(${getDiff(tData?.muscle_mass, yData?.muscle_mass)})</span>
                    </div>
                `;
            } else {
                card.innerHTML = `<div style="color:#ccc; margin-top:40px;">å¾…åŠ å…¥</div>`;
            }
            gridElement.appendChild(card);
        }
    } catch (err) {
        console.error("è¼‰å…¥å¤±æ•—:", err);
        gridElement.innerHTML = `<p style='grid-column: span 3; color:red;'>è¼‰å…¥å¤±æ•—: ${err.message || 'æœªçŸ¥éŒ¯èª¤'}</p>`;
    }
}
