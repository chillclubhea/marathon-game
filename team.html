<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšŠä¼ä¹å®®æ ¼æˆ°æ³</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f0f2f5; padding: 20px; text-align: center; }
        .grid-container { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; 
            max-width: 450px; margin: 20px auto; padding: 10px; background: #fff; border-radius: 15px;
        }
        .member-card { 
            background: #f8f9fa; border-radius: 10px; padding: 10px 5px; 
            display: flex; flex-direction: column; align-items: center; min-height: 140px;
        }
        .avatar { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; margin-bottom: 5px; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .name { font-weight: bold; font-size: 13px; margin-bottom: 5px; }
        .data-row { font-size: 10px; width: 95%; margin-bottom: 2px; padding: 2px; border-radius: 4px; }
        .diff { font-size: 9px; font-weight: normal; }
        .done { background-color: #d4edda; color: #155724; }
        .pending { background-color: #ffeeba; color: #856404; }
        .btn-capture { background: #e67e22; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .btn-home { display: block; width: 120px; margin: 10px auto; color: #3498db; text-decoration: none; font-size: 14px; }
        .hidden { display: none !important; }
        .invite-box { font-size: 12px; color: #7f8c8d; background: #fff; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px dashed #ccc; cursor: pointer; }
    </style>
</head>
<body>

    <h2 id="team-title">ğŸ† æˆ°éšŠä¹å®®æ ¼</h2>
    
    <div id="invite-area"></div>

    <div id="grid-display" class="grid-container">
        <p style="grid-column: span 3;">è³‡æ–™è®€å–ä¸­...</p>
    </div>

    <div id="controls">
        <button id="captain-tools" class="btn-capture hidden" onclick="generateImage()">ç”Ÿæˆæˆ°å ±åœ–ç‰‡</button>
        <a href="index.html" class="btn-home">å›å€‹äººä¸­å¿ƒ</a>
    </div>

<script>
    const SUPABASE_URL = 'https://sdloakutxcsbshcqpxwn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbG9ha3V0eGNzYnNoY3FweHduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMTE4MjYsImV4cCI6MjA4MTY4NzgyNn0.5OBQQAinARnZQ6VSCrPl60NWmcSG-QiFMmVIJRW7g-0';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    window.onload = loadTeamData;

    async function loadTeamData() {
        const gridElement = document.getElementById('grid-display');
        
        try {
            const { data: { user } } = await sb.auth.getUser();
            if (!user) {
                gridElement.innerHTML = "<p style='grid-column: span 3;'>è«‹å…ˆç™»å…¥</p>";
                return;
            }

            // 1. æŠ“å–æˆ‘çš„è³‡æ–™èˆ‡åœ˜éšŠ ID
            const { data: myProfile } = await sb.from('profiles').select('*').eq('id', user.id).single();
            if (!myProfile?.current_team_id) {
                gridElement.innerHTML = "<p style='grid-column: span 3;'>å°šæœªåŠ å…¥éšŠä¼</p>";
                return;
            }

            // 2. å¦‚æœæ˜¯éšŠé•·ï¼Œé¡¯ç¤ºå·¥å…·
            if (myProfile.role === 'captain') {
                document.getElementById('captain-tools').classList.remove('hidden');
                document.getElementById('invite-area').innerHTML = `
                    <div class="invite-box" onclick="copyInvite('${myProfile.current_team_id}')">
                        ğŸ“¢ é‚€è«‹ç¢¼ï¼š${myProfile.current_team_id} (é»æ“Šè¤‡è£½)
                    </div>`;
            }

            // 3. æŠ“å–éšŠå‹è³‡æ–™
            const { data: members } = await sb.from('profiles').select('*').eq('current_team_id', myProfile.current_team_id);
            
            // 4. æŠ“å–ä»Šå¤©èˆ‡æ˜¨å¤©æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            const yesterdayDate = new Date();
            yesterdayDate.setDate(yesterdayDate.getDate() - 1);
            const yesterday = yesterdayDate.toISOString
