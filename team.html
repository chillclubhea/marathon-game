<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšŠä¼ä¹å®®æ ¼æˆ°æ³</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --success: #2ecc71;
            --warning: #f1c40f;
            --bg: #f0f2f5;
        }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg); padding: 20px; text-align: center; margin: 0; }
        
        /* ä¹å®®æ ¼å®¹å™¨ */
        .grid-container { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 12px; 
            max-width: 450px; 
            margin: 20px auto; 
            padding: 15px; 
            background: #ffffff; 
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* å€‹äººå¡ç‰‡æ¨£å¼ */
        .member-card { 
            background: #fff; 
            border: 1px solid #eee;
            border-radius: 12px; 
            padding: 10px 5px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 150px;
            transition: 0.3s;
        }
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-bottom: 8px; border: 2px solid var(--primary); background: #eee; }
        .name { font-weight: bold; font-size: 14px; color: #2c3e50; margin-bottom: 8px; }

        /* æ•¸æ“šè¡Œæ¨£å¼ */
        .data-row { font-size: 11px; width: 90%; margin-bottom: 4px; padding: 3px; border-radius: 4px; text-align: center; }
        .diff { font-size: 10px; font-weight: bold; }
        .done { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .pending { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

        /* æŒ‰éˆ•èˆ‡æç¤º */
        .btn-capture { background: #e67e22; color: white; border: none; padding: 12px 25px; border-radius: 30px; font-weight: bold; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 10px rgba(230,126,34,0.3); }
        .btn-home { display: block; margin-top: 20px; color: #7f8c8d; text-decoration: none; font-size: 14px; }
        .invite-box { font-size: 13px; color: #34495e; background: #fff; padding: 12px; border-radius: 10px; max-width: 400px; margin: 0 auto 15px; border: 2px dashed var(--primary); cursor: pointer; }
        
        .hidden { display: none !important; }
        .error-msg { color: #e74c3c; font-weight: bold; padding: 20px; }
    </style>
</head>
<body>

    <h2 id="team-title">ğŸ† æˆ°éšŠä¹å®®æ ¼æˆ°æ³</h2>
    
    <div id="invite-area"></div>

    <div id="grid-display" class="grid-container">
        <p style="grid-column: span 3;">ğŸ“¡ è³‡æ–™åŒæ­¥ä¸­ï¼Œè«‹ç¨å€™...</p>
    </div>

    <div id="controls">
        <button id="captain-tools" class="btn-capture hidden" onclick="generateImage()">ğŸ“¸ ç”Ÿæˆä»Šæ—¥æˆ°å ±åœ–ç‰‡</button>
        <a href="index.html" class="btn-home">â¬…ï¸ è¿”å›å€‹äººä¸­å¿ƒ</a>
    </div>

<script>
    const SUPABASE_URL = 'https://sdloakutxcsbshcqpxwn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbG9ha3V0eGNzYnNoY3FweHduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMTE4MjYsImV4cCI6MjA4MTY4NzgyNn0.5OBQQAinARnZQ6VSCrPl60NWmcSG-QiFMmVIJRW7g-0';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    window.onload = loadTeamData;

    async function loadTeamData() {
        const gridElement = document.getElementById('grid-display');
        
        try {
            // 1. é©—è­‰ä½¿ç”¨è€…èº«ä»½
            const { data: { user }, error: authError } = await sb.auth.getUser();
            if (authError || !user) throw new Error("è«‹å…ˆç™»å…¥å¸³è™Ÿ");

            // 2. å–å¾—å€‹äººè³‡æ–™èˆ‡éšŠä¼ ID
            const { data: myProfile, error: profileError } = await sb.from('profiles').select('*').eq('id', user.id).single();
            if (profileError || !myProfile) throw new Error("æ‰¾ä¸åˆ°å€‹äººè³‡æ–™");
            
            const teamId = myProfile.current_team_id;
            if (!teamId) throw new Error("å°šæœªåŠ å…¥ä»»ä½•éšŠä¼");

            // 3. éšŠé•·æ¬Šé™é‚è¼¯
            if (myProfile.role === 'captain') {
                document.getElementById('captain-tools').classList.remove('hidden');
                document.getElementById('invite-area').innerHTML = `
                    <div class="invite-box" onclick="copyInvite('${teamId}')">
                        ğŸ”‘ éšŠä¼é‚€è«‹ç¢¼ï¼š<strong>${teamId}</strong><br>
                        <span style="font-size:11px; color:var(--primary)">(é»æ“Šå³å¯è¤‡è£½çµ¦éšŠå“¡)</span>
                    </div>`;
            }

            // 4. å–å¾—æ‰€æœ‰éšŠå‹
            const { data: members, error: memError } = await sb.from('profiles')
                .select('*')
                .eq('current_team_id', teamId)
                .order('created_at', { ascending: true });
            if (memError) throw memError;

            // 5. æº–å‚™æ—¥æœŸ (æœ¬åœ°æ™‚å€åŸºæº–)
            const today = new Date().toISOString().split('T')[0];
            const yesterdayDate = new Date();
            yesterdayDate.setDate(yesterdayDate.getDate() - 1);
            const yesterday = yesterdayDate.toISOString().split('T')[0];

            // 6. å–å¾—é«”é‡ç´€éŒ„
            const memberIds = members.map(m => m.id);
            const { data: records, error: recError } = await sb.from('weight_records')
                .select('*')
                .in('user_id', memberIds)
                .in('date', [today, yesterday]);
            if (recError) throw recError;

            // 7. æ¸²æŸ“ä¹å®®æ ¼
            gridElement.innerHTML = "";
            for (let i = 0; i < 9; i++) {
                const member = members[i] || null;
                const card = document.createElement('div');
                card.className = "member-card";

                if (member) {
                    const tData = records.find(r => r.user_id === member.id && r.date === today);
                    const yData = records.find(r => r.user_id === member.id && r.date === yesterday);

                    // è¨ˆç®—è®ŠåŒ–å€¼
                    const calcDiff = (now, prev) => {
                        if (now === undefined || prev === undefined) return '--';
                        const diff = (now - prev).toFixed(1);
                        return diff > 0 ? `+${diff}` : diff;
                    };

                    card.innerHTML = `
                        <img class="avatar" src="${member.avatar_url || 'https://via.placeholder.com/60'}" 
                             crossorigin="anonymous" onerror="this.src='https://via.placeholder.com/60'">
                        <div class="name">${member.full_name || 'æœªå‘½å'}</div>
                        
                        <div class="data-row ${tData ? 'done' : 'pending'}">
                            é‡: ${tData ? tData.weight : '--'} <span class="diff">(${calcDiff(tData?.weight, yData?.weight)})</span>
                        </div>
                        <div class="data-row" style="color:#666; font-size:9px;">
                            è„‚: ${tData?.fat_rate ?? '--'}% <span class="diff">(${calcDiff(tData?.fat_rate, yData?.fat_rate)})</span>
                        </div>
                        <div class="data-row" style="color:#666; font-size:9px;">
                            è‚Œ: ${tData?.muscle_mass ?? '--'} <span class="diff">(${calcDiff(tData?.muscle_mass, yData?.muscle_mass)})</span>
                        </div>
                    `;
                } else {
                    card.innerHTML = `<div style="color:#ccc; margin-top:50px; font-size:12px;">(ç©ºä½)</div>`;
                }
                gridElement.appendChild(card);
            }
        } catch (err) {
            console.error(err);
            gridElement.innerHTML = `<div class="error-msg">âš ï¸ è®€å–å¤±æ•—<br><small>${err.message}</small></div>`;
        }
    }

    function copyInvite(id) {
        navigator.clipboard.writeText(id).then(() => alert("é‚€è«‹ç¢¼å·²è¤‡è£½ï¼"));
    }

    async function generateImage() {
        const element = document.getElementById('grid-display');
        const btn = document.getElementById('captain-tools');
        
        btn.innerText = "æ­£åœ¨ç”Ÿæˆä¸­...";
        btn.disabled = true;

        try {
            const canvas = await html2canvas(element, {
                useCORS: true,
                scale: 2,
                backgroundColor: '#f0f2f5',
                logging: false
            });
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = `é¦¬æ‹‰æ¾æˆ°å ±_${new Date().toLocaleDateString()}.png`;
            link.click();
        } catch (e) {
            alert("åœ–ç‰‡ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¢ºèªæ˜¯å¦æ‰€æœ‰é ­åƒçš†å·²æ­£ç¢ºè¼‰å…¥ã€‚");
        } finally {
            btn.innerText = "ğŸ“¸ ç”Ÿæˆä»Šæ—¥æˆ°å ±åœ–ç‰‡";
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
