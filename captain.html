<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éšŠé•·ç®¡ç†å¾Œå°</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #3498db; --success: #2ecc71; --warning: #f39c12; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 25px; padding: 20px; background: white; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        h1 { color: #2c3e50; margin: 0; font-size: 28px; }
        .subtitle { color: #7f8c8d; margin-top: 8px; font-size: 14px; }
        .back-btn { position: fixed; top: 20px; left: 20px; background: white; color: var(--primary); border: 2px solid var(--primary); padding: 10px 20px; border-radius: 50px; cursor: pointer; font-weight: bold; z-index: 100; }
        .dashboard-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .card-title { font-size: 16px; color: #7f8c8d; margin-bottom: 10px; }
        .card-value { font-size: 32px; font-weight: bold; color: #2c3e50; }
        .section-title { font-size: 24px; color: #2c3e50; margin: 30px 0 20px; }
        .tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: bold; }
        .table-container { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 15px; text-align: left; font-weight: bold; color: #2c3e50; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        .btn { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .hidden { display: none; }
        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .form-control { padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .member-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .member-card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .member-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .member-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; }
        .member-info { flex: 1; }
        .member-name { font-weight: bold; color: #2c3e50; font-size: 18px; }
        .member-detail { font-size: 12px; color: #7f8c8d; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; }
        .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #f8d7da; color: #721c24; }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
        .error-message { background: #fee; color: #c33; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #c33; }
    </style>
</head>
<body>
    <button class="back-btn" onclick="window.location.href='index.html'">â† è¿”å›</button>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ‘‘ éšŠé•·ç®¡ç†å¾Œå°</h1>
            <div class="subtitle" id="team-info">è¼‰å…¥ä¸­...</div>
        </div>
        
        <!-- éŒ¯èª¤é¡¯ç¤ºå€åŸŸ -->
        <div id="error-container" class="hidden"></div>
        
        <!-- å„€è¡¨æ¿å¡ç‰‡ -->
        <div class="dashboard-cards">
            <div class="card">
                <div class="card-title">åœ˜éšŠæˆå“¡</div>
                <div class="card-value" id="team-members-count">0</div>
            </div>
            <div class="card">
                <div class="card-title">ä»Šæ—¥å®Œæˆç‡</div>
                <div class="card-value" id="today-completion">0%</div>
            </div>
            <div class="card">
                <div class="card-title">åœ˜éšŠç¸½ç©åˆ†</div>
                <div class="card-value" id="team-points">0</div>
            </div>
            <div class="card">
                <div class="card-title">æœ¬é€±æ¸›é‡</div>
                <div class="card-value" id="week-weight-loss">0.0 kg</div>
            </div>
        </div>
        
        <!-- é ç±¤ -->
        <div class="tabs">
            <div class="tab active" onclick="showTab('members')">ğŸ‘¥ åœ˜éšŠæˆå“¡</div>
            <div class="tab" onclick="showTab('progress')">ğŸ“Š åœ˜éšŠé€²åº¦</div>
            <div class="tab" onclick="showTab('settings')">âš™ï¸ åœ˜éšŠè¨­å®š</div>
            <div class="tab" onclick="showTab('announcement')">ğŸ“¢ åœ˜éšŠå…¬å‘Š</div>
        </div>
        
        <!-- åœ˜éšŠæˆå“¡ -->
        <div id="members-tab">
            <div class="filter-bar">
                <input type="text" class="form-control" placeholder="æœå°‹æˆå“¡..." id="member-search" oninput="filterMembers()" style="flex: 1;">
                <select class="form-control" id="status-filter" onchange="filterMembers()">
                    <option value="">æ‰€æœ‰ç‹€æ…‹</option>
                    <option value="active">æ´»èº</option>
                    <option value="inactive">æœªå ±åˆ°</option>
                </select>
                <button class="btn btn-primary" onclick="exportTeamData()">ğŸ“¥ åŒ¯å‡ºè³‡æ–™</button>
                <button class="btn btn-success" onclick="inviteMember()">â• é‚€è«‹æˆå“¡</button>
            </div>
            
            <div id="members-container" class="member-grid">
                <div class="loading">è¼‰å…¥åœ˜éšŠæˆå“¡ä¸­...</div>
            </div>
        </div>
        
        <!-- åœ˜éšŠé€²åº¦ -->
        <div id="progress-tab" class="hidden">
            <div class="card">
                <h3>ğŸ“ˆ åœ˜éšŠè¶¨å‹¢åœ–</h3>
                <div id="progress-chart" style="height: 300px; margin-top: 20px;">
                    <div class="loading">åœ–è¡¨è¼‰å…¥ä¸­...</div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <h3>ğŸ† åœ˜éšŠæ’è¡Œæ¦œ</h3>
                <div class="table-container">
                    <table id="team-leaderboard">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>æˆå“¡</th>
                                <th>ç¸½ç©åˆ†</th>
                                <th>æ¸›é‡ (kg)</th>
                                <th>ä»Šæ—¥ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" class="loading">è¼‰å…¥ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- åœ˜éšŠè¨­å®š -->
        <div id="settings-tab" class="hidden">
            <div class="card">
                <h3>ğŸ”§ åœ˜éšŠåŸºæœ¬è¨­å®š</h3>
                <div style="margin-top: 20px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">åœ˜éšŠåç¨±</label>
                        <input type="text" class="form-control" id="team-name" style="width: 100%;" placeholder="è¼¸å…¥åœ˜éšŠåç¨±">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">åœ˜éšŠç›®æ¨™</label>
                        <textarea class="form-control" id="team-goal" rows="4" placeholder="è¨­å®šåœ˜éšŠç›®æ¨™..." style="width: 100%;"></textarea>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å‰¯éšŠé•·</label>
                        <select class="form-control" id="deputy-select" style="width: 100%;">
                            <option value="">é¸æ“‡å‰¯éšŠé•·</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="saveTeamSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
                </div>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <h3>ğŸ“£ åœ˜éšŠé‚€è«‹</h3>
                <div style="margin-top: 15px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="font-weight: bold; margin-bottom: 5px;">é‚€è«‹ç¢¼</div>
                        <div style="font-size: 24px; font-weight: bold; color: var(--primary);" id="team-invite-code">è¼‰å…¥ä¸­...</div>
                        <div style="font-size: 12px; color: #7f8c8d; margin-top: 5px;">åˆ†äº«æ­¤é‚€è«‹ç¢¼çµ¦æ–°æˆå“¡åŠ å…¥åœ˜éšŠ</div>
                    </div>
                    <button class="btn btn-success" onclick="copyInviteCode()">ğŸ“‹ è¤‡è£½é‚€è«‹ç¢¼</button>
                    <button class="btn btn-warning" onclick="generateNewInviteCode()">ğŸ”„ é‡æ–°ç”¢ç”Ÿ</button>
                </div>
            </div>
        </div>
        
        <!-- åœ˜éšŠå…¬å‘Š -->
        <div id="announcement-tab" class="hidden">
            <div class="card">
                <h3>ğŸ“¢ ç™¼å¸ƒåœ˜éšŠå…¬å‘Š</h3>
                <div style="margin-top: 20px;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å…¬å‘Šæ¨™é¡Œ</label>
                        <input type="text" class="form-control" id="announcement-title" style="width: 100%;" placeholder="è¼¸å…¥å…¬å‘Šæ¨™é¡Œ">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å…¬å‘Šå…§å®¹</label>
                        <textarea class="form-control" id="announcement-content" rows="6" placeholder="è¼¸å…¥å…¬å‘Šå…§å®¹..." style="width: 100%;"></textarea>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å…¬å‘Šé¡å‹</label>
                        <select class="form-control" id="announcement-type" style="width: 100%;">
                            <option value="general">ä¸€èˆ¬å…¬å‘Š</option>
                            <option value="important">é‡è¦å…¬å‘Š</option>
                            <option value="reminder">æé†’äº‹é …</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="publishAnnouncement()">ğŸ“¢ ç™¼å¸ƒå…¬å‘Š</button>
                </div>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <h3>ğŸ“œ æ­·å²å…¬å‘Š</h3>
                <div id="announcements-list" style="margin-top: 15px;">
                    <div class="loading">è¼‰å…¥å…¬å‘Šä¸­...</div>
                </div>
            </div>
        </div>
    </div>

<script>
    // Supabase é…ç½®
    const SUPABASE_URL = 'https://sdloakutxcsbshcqpxwn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbG9ha3V0eGNzYnNoY3FweHduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMTE4MjYsImV4cCI6MjA4MTY4NzgyNn0.5OBQQAinARnZQ6VSCrPl60NWmcSG-QiFMmVIJRW7g-0';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // å…¨å±€è®Šæ•¸
    let currentUser = null;
    let currentTeam = null;
    let teamMembers = [];
    let allMembers = [];
    
    // é é¢è¼‰å…¥
    window.onload = async () => {
        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        const { data: { session } } = await sb.auth.getSession();
        if (!session) {
            showError('è«‹å…ˆç™»å…¥ç³»çµ±', true);
            return;
        }
        currentUser = session.user;
        
        // æª¢æŸ¥éšŠé•·æ¬Šé™
        await checkCaptainPermission();
        
        // è¼‰å…¥åœ˜éšŠè³‡æ–™
        await loadTeamData();
    };
    
    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    function showError(message, isCritical = false) {
        const errorContainer = document.getElementById('error-container');
        errorContainer.innerHTML = `
            <div class="error-message">
                <strong>éŒ¯èª¤ï¼š</strong> ${message}
                <br>
                <button class="btn btn-warning" onclick="location.reload()">é‡æ–°æ•´ç†é é¢</button>
                ${isCritical ? '<br><small>å¦‚æœå•é¡ŒæŒçºŒï¼Œè«‹è¯çµ¡ç®¡ç†å“¡</small>' : ''}
            </div>
        `;
        errorContainer.classList.remove('hidden');
    }
    
    // æª¢æŸ¥éšŠé•·æ¬Šé™
    async function checkCaptainPermission() {
        try {
            const { data: profile, error } = await sb
                .from('profiles')
                .select('role')
                .eq('id', currentUser.id)
                .single();
            
            if (error) throw error;
            
            if (profile.role !== 'captain' && profile.role !== 'admin') {
                showError('åªæœ‰éšŠé•·æˆ–ç®¡ç†å“¡å¯ä»¥è¨ªå•æ­¤é é¢', true);
                return false;
            }
            
            return true;
        } catch (error) {
            console.error('æª¢æŸ¥éšŠé•·æ¬Šé™éŒ¯èª¤:', error);
            showError('ç„¡æ³•é©—è­‰ç”¨æˆ¶æ¬Šé™', true);
            return false;
        }
    }
    
    // è¼‰å…¥åœ˜éšŠè³‡æ–™
    async function loadTeamData() {
        try {
            // ç²å–éšŠé•·è³‡æ–™å’Œåœ˜éšŠID
            const { data: captainProfile, error: profileError } = await sb
                .from('profiles')
                .select('current_team_id, full_name')
                .eq('id', currentUser.id)
                .single();
            
            if (profileError) throw profileError;
            
            if (!captainProfile.current_team_id) {
                showError('æ‚¨ç›®å‰æ²’æœ‰ç®¡ç†çš„åœ˜éšŠ', false);
                return;
            }
            
            currentTeam = captainProfile.current_team_id;
            
            // é¡¯ç¤ºåœ˜éšŠè³‡è¨Š
            document.getElementById('team-info').textContent = `éšŠé•·: ${captainProfile.full_name} | åœ˜éšŠID: ${currentTeam}`;
            
            // è¼‰å…¥åœ˜éšŠæˆå“¡
            await loadTeamMembers();
            
            // è¼‰å…¥çµ±è¨ˆæ•¸æ“š
            await loadTeamStats();
            
        } catch (error) {
            console.error('è¼‰å…¥åœ˜éšŠè³‡æ–™éŒ¯èª¤:', error);
            showError('ç„¡æ³•è¼‰å…¥åœ˜éšŠè³‡æ–™');
        }
    }
    
    // è¼‰å…¥åœ˜éšŠæˆå“¡
    async function loadTeamMembers() {
        const container = document.getElementById('members-container');
        container.innerHTML = '<div class="loading">è¼‰å…¥åœ˜éšŠæˆå“¡ä¸­...</div>';
        
        try {
            // ç²å–åœ˜éšŠæˆå“¡
            const { data: members, error } = await sb
                .from('profiles')
                .select('*')
                .eq('current_team_id', currentTeam);
            
            if (error) throw error;
            
            teamMembers = members || [];
            allMembers = [...teamMembers];
            
            if (teamMembers.length === 0) {
                container.innerHTML = '<div class="member-card"><div style="text-align: center; padding: 40px;">åœ˜éšŠæš«ç„¡æˆå“¡</div></div>';
                return;
            }
            
            // æ›´æ–°æˆå“¡æ•¸é‡
            document.getElementById('team-members-count').textContent = teamMembers.length;
            
            // ç²å–ä»Šæ—¥æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            
            // æ¸²æŸ“æˆå“¡å¡ç‰‡
            let html = '';
            for (const member of teamMembers) {
                // æª¢æŸ¥ä»Šæ—¥æ˜¯å¦å·²å ±åˆ°
                const { data: todayRecord } = await sb
                    .from('weight_records')
                    .select('*')
                    .eq('user_id', member.id)
                    .eq('date', today)
                    .maybeSingle();
                
                const isActive = !!todayRecord;
                
                html += `
                <div class="member-card">
                    <div class="member-header">
                        <img class="member-avatar" src="${member.avatar_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(member.full_name || 'User') + '&background=random'}" alt="${member.full_name}">
                        <div class="member-info">
                            <div class="member-name">${member.full_name || 'æœªè¨­å®šå§“å'}</div>
                            <div class="member-detail">
                                ${member.role === 'captain' ? 'ğŸ‘‘ éšŠé•·' : member.role === 'deputy' ? 'â­ å‰¯éšŠé•·' : 'ğŸ‘¤ å­¸å“¡'} â€¢ 
                                ç©åˆ†: ${member.points || 0}
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <span class="status-badge ${isActive ? 'status-active' : 'status-inactive'}">
                            ${isActive ? 'âœ… ä»Šæ—¥å·²å ±åˆ°' : 'â³ ä»Šæ—¥æœªå ±åˆ°'}
                        </span>
                        ${member.id !== currentUser.id ? 
                            `<button class="btn btn-danger btn-small" onclick="removeMember('${member.id}', '${member.full_name}')" style="float: right; padding: 5px 10px; font-size: 12px;">
                                ç§»é™¤
                            </button>` : ''
                        }
                    </div>
                </div>`;
            }
            
            container.innerHTML = html;
            
        } catch (error) {
            console.error('è¼‰å…¥åœ˜éšŠæˆå“¡éŒ¯èª¤:', error);
            container.innerHTML = '<div class="error-message">è¼‰å…¥æˆå“¡å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</div>';
        }
    }
    
    // è¼‰å…¥åœ˜éšŠçµ±è¨ˆ
    async function loadTeamStats() {
        try {
            // è¨ˆç®—ä»Šæ—¥å®Œæˆç‡
            const today = new Date().toISOString().split('T')[0];
            const { data: todayRecords } = await sb
                .from('weight_records')
                .select('user_id')
                .eq('date', today);
            
            const todayCount = todayRecords ? todayRecords.length : 0;
            const completionRate = teamMembers.length > 0 ? Math.round((todayCount / teamMembers.length) * 100) : 0;
            
            document.getElementById('today-completion').textContent = `${completionRate}%`;
            
            // è¨ˆç®—åœ˜éšŠç¸½ç©åˆ†
            const totalPoints = teamMembers.reduce((sum, member) => sum + (member.points || 0), 0);
            document.getElementById('team-points').textContent = totalPoints;
            
            // è¨ˆç®—æœ¬é€±æ¸›é‡
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            const { data: weightRecords } = await sb
                .from('weight_records')
                .select('*')
                .in('user_id', teamMembers.map(m => m.id))
                .gte('date', weekAgo.toISOString().split('T')[0]);
            
            // é€™è£¡å¯ä»¥å¯¦ç¾æ›´è©³ç´°çš„æ¸›é‡è¨ˆç®—é‚è¼¯
            document.getElementById('week-weight-loss').textContent = 'è¨ˆç®—ä¸­...';
            
            // é¡¯ç¤ºé‚€è«‹ç¢¼
            document.getElementById('team-invite-code').textContent = currentTeam;
            
        } catch (error) {
            console.error('è¼‰å…¥çµ±è¨ˆéŒ¯èª¤:', error);
        }
    }
    
    // é¡¯ç¤º/éš±è—é ç±¤
    function showTab(tabName) {
        // æ›´æ–°é ç±¤ç‹€æ…‹
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // é¡¯ç¤ºå°æ‡‰å…§å®¹
        document.getElementById('members-tab').classList.add('hidden');
        document.getElementById('progress-tab').classList.add('hidden');
        document.getElementById('settings-tab').classList.add('hidden');
        document.getElementById('announcement-tab').classList.add('hidden');
        
        document.getElementById(tabName + '-tab').classList.remove('hidden');
        
        // è¼‰å…¥å°æ‡‰æ•¸æ“š
        if (tabName === 'progress') {
            loadProgressData();
        } else if (tabName === 'settings') {
            loadTeamSettings();
        } else if (tabName === 'announcement') {
            loadAnnouncements();
        }
    }
    
    // ç¯©é¸æˆå“¡
    function filterMembers() {
        const searchTerm = document.getElementById('member-search').value.toLowerCase();
        const statusFilter = document.getElementById('status-filter').value;
        
        // é€™è£¡å¯ä»¥å¯¦ç¾æ›´è©³ç´°çš„ç¯©é¸é‚è¼¯
        const filtered = allMembers.filter(member => {
            const matchesSearch = member.full_name?.toLowerCase().includes(searchTerm) || 
                                 member.email?.toLowerCase().includes(searchTerm);
            // ç‹€æ…‹ç¯©é¸éœ€è¦é¡å¤–æŸ¥è©¢ä»Šæ—¥å ±åˆ°ç‹€æ…‹
            return matchesSearch;
        });
        
        // æ›´æ–°é¡¯ç¤º
        const container = document.getElementById('members-container');
        // ç°¡å–®å¯¦ç¾ï¼šé‡æ–°è¼‰å…¥æ™‚å†å„ªåŒ–
        container.innerHTML = '<div class="loading">ç¯©é¸ä¸­...</div>';
        setTimeout(() => {
            // é‡æ–°è¼‰å…¥æˆå“¡
            loadTeamMembers();
        }, 300);
    }
    
    // ç§»é™¤æˆå“¡
    async function removeMember(userId, userName) {
        if (!confirm(`ç¢ºå®šè¦ç§»é™¤æˆå“¡ ${userName} å—ï¼Ÿ`)) {
            return;
        }
        
        try {
            const { error } = await sb
                .from('profiles')
                .update({ current_team_id: null })
                .eq('id', userId);
            
            if (error) throw error;
            
            alert('æˆå“¡å·²ç§»é™¤');
            loadTeamMembers();
            
        } catch (error) {
            console.error('ç§»é™¤æˆå“¡éŒ¯èª¤:', error);
            alert('ç§»é™¤å¤±æ•—: ' + error.message);
        }
    }
    
    // é‚€è«‹æˆå“¡
    function inviteMember() {
        const inviteCode = currentTeam;
        const inviteMessage = `è«‹ä½¿ç”¨ä»¥ä¸‹é‚€è«‹ç¢¼åŠ å…¥æˆ‘çš„åœ˜éšŠï¼š\n\n${inviteCode}\n\néšŠé•·ï¼š${currentUser.email}`;
        
        if (navigator.share) {
            navigator.share({
                title: 'åŠ å…¥æˆ‘çš„é¦¬æ‹‰æ¾åœ˜éšŠ',
                text: inviteMessage,
                url: window.location.origin
            });
        } else {
            navigator.clipboard.writeText(inviteMessage).then(() => {
                alert('é‚€è«‹è¨Šæ¯å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼\n\nè«‹åˆ†äº«çµ¦æ‚¨è¦é‚€è«‹çš„æˆå“¡ã€‚');
            });
        }
    }
    
    // è¤‡è£½é‚€è«‹ç¢¼
    function copyInviteCode() {
        navigator.clipboard.writeText(currentTeam).then(() => {
            alert('é‚€è«‹ç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        });
    }
    
    // è¼‰å…¥é€²åº¦æ•¸æ“š
    async function loadProgressData() {
        // å¯¦ç¾åœ–è¡¨å’Œæ’è¡Œæ¦œ
        const leaderboardBody = document.querySelector('#team-leaderboard tbody');
        leaderboardBody.innerHTML = '';
        
        // ç°¡å–®ç¤ºä¾‹ï¼šé¡¯ç¤ºæˆå“¡ç©åˆ†æ’è¡Œ
        teamMembers.sort((a, b) => (b.points || 0) - (a.points || 0));
        
        teamMembers.forEach((member, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${member.full_name || 'æœªå‘½å'}</td>
                <td><strong>${member.points || 0}</strong></td>
                <td>0.0</td>
                <td><span class="status-badge status-active">æ´»èº</span></td>
            `;
            leaderboardBody.appendChild(row);
        });
    }
    
    // è¼‰å…¥åœ˜éšŠè¨­å®š
    async function loadTeamSettings() {
        // è¼‰å…¥å‰¯éšŠé•·é¸é …
        const deputySelect = document.getElementById('deputy-select');
        deputySelect.innerHTML = '<option value="">é¸æ“‡å‰¯éšŠé•·</option>';
        
        teamMembers.forEach(member => {
            if (member.role === 'member') {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.full_name || 'æœªå‘½å';
                deputySelect.appendChild(option);
            }
        });
    }
    
    // å„²å­˜åœ˜éšŠè¨­å®š
    async function saveTeamSettings() {
        const deputyId = document.getElementById('deputy-select').value;
        
        if (deputyId) {
            // æ›´æ–°å‰¯éšŠé•·è§’è‰²
            try {
                const { error } = await sb
                    .from('profiles')
                    .update({ role: 'deputy' })
                    .eq('id', deputyId);
                
                if (error) throw error;
                
                alert('å‰¯éšŠé•·è¨­å®šå·²æ›´æ–°');
                location.reload();
                
            } catch (error) {
                console.error('æ›´æ–°å‰¯éšŠé•·éŒ¯èª¤:', error);
                alert('æ›´æ–°å¤±æ•—: ' + error.message);
            }
        }
    }
    
    // è¼‰å…¥å…¬å‘Š
    async function loadAnnouncements() {
        const container = document.getElementById('announcements-list');
        container.innerHTML = '<div class="loading">è¼‰å…¥å…¬å‘Šä¸­...</div>';
        
        // é€™è£¡å¯ä»¥å¯¦ç¾å¾è³‡æ–™åº«è¼‰å…¥å…¬å‘Šçš„é‚è¼¯
        setTimeout(() => {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;">æš«ç„¡å…¬å‘Š</div>';
        }, 1000);
    }
    
    // ç™¼å¸ƒå…¬å‘Š
    async function publishAnnouncement() {
        const title = document.getElementById('announcement-title').value;
        const content = document.getElementById('announcement-content').value;
        const type = document.getElementById('announcement-type').value;
        
        if (!title || !content) {
            alert('è«‹å¡«å¯«å…¬å‘Šæ¨™é¡Œå’Œå…§å®¹');
            return;
        }
        
        // é€™è£¡å¯ä»¥å¯¦ç¾å„²å­˜å…¬å‘Šåˆ°è³‡æ–™åº«çš„é‚è¼¯
        alert('å…¬å‘Šå·²ç™¼å¸ƒï¼\n\n(æ­¤åŠŸèƒ½ç‚ºæ¼”ç¤ºï¼Œå¯¦éš›éœ€é€£æ¥è³‡æ–™åº«)');
        
        // æ¸…ç©ºè¡¨å–®
        document.getElementById('announcement-title').value = '';
        document.getElementById('announcement-content').value = '';
        
        // é‡æ–°è¼‰å…¥å…¬å‘Šåˆ—è¡¨
        loadAnnouncements();
    }
    
    // åŒ¯å‡ºåœ˜éšŠè³‡æ–™
    async function exportTeamData() {
        try {
            // å»ºç«‹CSVå…§å®¹
            const headers = ['å§“å', 'è§’è‰²', 'ç©åˆ†', 'è¨ˆç•«', 'åŠ å…¥æ™‚é–“'];
            const rows = teamMembers.map(member => [
                member.full_name || '',
                member.role === 'captain' ? 'éšŠé•·' : member.role === 'deputy' ? 'å‰¯éšŠé•·' : 'å­¸å“¡',
                member.points || 0,
                member.plan || '',
                new Date(member.created_at).toLocaleDateString('zh-TW')
            ]);
            
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');
            
            // ä¸‹è¼‰æª”æ¡ˆ
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `åœ˜éšŠè³‡æ–™_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
        } catch (error) {
            console.error('åŒ¯å‡ºè³‡æ–™éŒ¯èª¤:', error);
            alert('åŒ¯å‡ºå¤±æ•—: ' + error.message);
        }
    }
</script>
</body>
</html>
