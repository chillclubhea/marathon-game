<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦¬æ‹‰æ¾ç©å®¶ä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #3498db; --success: #2ecc71; --warning: #f39c12; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; display: flex; justify-content: center; padding: 20px; }
        .container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); width: 100%; max-width: 450px; }
        .header { text-align: center; margin-bottom: 25px; }
        h2 { color: #2c3e50; margin: 0; font-size: 24px; }
        #user-display { font-size: 12px; color: #95a5a6; margin-top: 5px; }
        .card { background: #fff; border: 1px solid #edf2f7; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .card-title { font-weight: bold; color: #2d3748; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: bold; color: #4a5568; font-size: 14px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        input:disabled, select:disabled { background-color: #f8fafc; color: #94a3b8; cursor: not-allowed; }
        .row { display: flex; gap: 10px; }
        .row .form-group { flex: 1; }
        button { width: 100%; padding: 14px; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; }
        .btn-primary { background-color: var(--primary); }
        .btn-success { background-color: var(--success); }
        .btn-warning { background-color: var(--warning); }
        .btn-danger { background-color: var(--danger); }
        .btn-admin { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-captain { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .btn-deputy { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .hidden { display: none !important; }
        .avatar-preview { width: 80px; height: 80px; border-radius: 50%; background: #eee; margin: 0 auto 15px; display: block; object-fit: cover; border: 3px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .ticket-stats { display: flex; justify-content: space-between; margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 10px; }
        .ticket-stats div { text-align: center; }
        .ticket-stats span { display: block; font-size: 12px; color: #64748b; margin-bottom: 5px; }
        .ticket-stats b { display: block; font-size: 24px; color: #0ea5e9; }
        .mission-item { background: #f1f5f9; padding: 10px; margin-bottom: 8px; border-radius: 8px; font-size: 14px; }
        .mission-item.active { background: #dbeafe; border-left: 4px solid #3b82f6; }
        
        /* æ–°å¢ï¼šæ•¸æ“šè®ŠåŒ–æ¨£å¼ */
        .progress-card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; border-left: 5px solid var(--success); }
        .progress-title { font-weight: bold; color: #2d3748; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .progress-list { max-height: 300px; overflow-y: auto; }
        .progress-item { padding: 10px; border-bottom: 1px solid #f0f0f0; }
        .progress-item:last-child { border-bottom: none; }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .progress-name { font-weight: bold; color: #2d3748; font-size: 14px; }
        .progress-date { font-size: 12px; color: #94a3b8; }
        .progress-details { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 8px; }
        .progress-detail { text-align: center; }
        .progress-label { font-size: 11px; color: #64748b; }
        .progress-value { font-size: 14px; font-weight: bold; }
        .progress-change { font-size: 12px; }
        .change-positive { color: var(--success); }
        .change-negative { color: var(--danger); }
        
        /* åœ–è¡¨å®¹å™¨ */
        .chart-container { height: 200px; margin-top: 15px; }
        
        /* è§’è‰²æŒ‰éˆ•å®¹å™¨ */
        .role-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
        .role-buttons button { margin: 0; }
    </style>
</head>
<body>

<div class="container">
    <!-- æˆªæ­¢æ™‚é–“é€šçŸ¥ -->
    <div id="deadline-notice" style="background:#fff3cd; color:#856404; padding:8px; border-radius:8px; font-size:13px; margin-bottom:10px; text-align:center;">
        âš ï¸ ä»Šæ—¥å ±åˆ°æˆªæ­¢ï¼šé¦™æ¸¯æ™‚é–“ 23:59
    </div>

    <!-- ç™»å…¥å€å¡Š -->
    <div id="auth-section">
        <div class="header">
            <h2>ğŸ”‘ ç™»å…¥é¦¬æ‹‰æ¾</h2>
            <div id="login-msg" style="font-size:14px; color:#666; margin-top:5px;">è«‹ç™»å…¥ä»¥ç¹¼çºŒ</div>
        </div>
        <form onsubmit="signIn(); return false;" class="card" style="margin-top: 20px;">
            <div class="form-group">
                <label>é›»å­ä¿¡ç®±</label>
                <input type="email" id="email" placeholder="Email" required>
            </div>
            <div class="form-group">
                <label>å¯†ç¢¼</label>
                <input type="password" id="password" placeholder="Password" required>
            </div>
            <button type="button" class="btn-primary" onclick="signUp()">è¨»å†Š</button>
            <button type="submit" class="btn-success">ç™»å…¥</button>
        </form>
    </div>

    <!-- å€‹äººè³‡æ–™å€å¡Š -->
    <div id="profile-section" class="hidden">
        <div class="header">
            <h2>ğŸƒ ç©å®¶ä¸­å¿ƒ</h2>
            <div id="user-display"></div>
        </div>

        <!-- ç©åˆ†çµ±è¨ˆ -->
        <div class="ticket-stats">
            <div><span>ç´¯ç©ç©åˆ† ğŸŸï¸</span><b id="ticket-count">0</b></div>
            <div><span>é¦¬æ‹‰æ¾é€²åº¦</span><b id="day-progress">Day 0</b></div>
            <div><span>éšŠä¼ç‹€æ…‹</span><b id="team-status">æœªåŠ å…¥</b></div>
        </div>

        <!-- è§’è‰²å°ˆå±¬æŒ‰éˆ• -->
        <div id="role-buttons" class="role-buttons hidden">
            <!-- ç®¡ç†å“¡æŒ‰éˆ• -->
            <button id="admin-btn" class="hidden btn-admin" onclick="window.location.href='admin.html'">
                ğŸ‘‘ ç®¡ç†å“¡å¾Œå°
            </button>
            <!-- éšŠé•·æŒ‰éˆ• -->
            <button id="captain-btn" class="hidden btn-captain" onclick="window.location.href='captain.html'">
                ğŸ† éšŠé•·å¾Œå°
            </button>
            <!-- å‰¯éšŠé•·æŒ‰éˆ• -->
            <button id="deputy-btn" class="hidden btn-deputy" onclick="window.location.href='deputy.html'">
                â­ å‰¯éšŠé•·å¾Œå°
            </button>
        </div>

        <!-- ç·¨è¼¯æŒ‰éˆ• -->
        <button id="edit-profile-btn" class="hidden" onclick="toggleProfileEdit()" 
                style="background: #edf2f7; color: #4a5568; font-size: 14px; margin-bottom: 15px; padding: 8px; border:none; border-radius:8px; width:100%;">
            âš™ï¸ ä¿®æ”¹å€‹äººè³‡æ–™æˆ–æ›´æ›éšŠä¼
        </button>

        <!-- å€‹äººè¨­å®šå¡ç‰‡ -->
        <div id="setup-card" class="card">
            <div class="card-title">ğŸ‘¤ å€‹äººè¨­å®š & åŠ å…¥éšŠä¼</div>
            <img id="avatar-img" class="avatar-preview" src="https://ui-avatars.com/api/?name=User&background=random">
            <div class="form-group">
                <label>æ›´æ›é ­åƒ</label>
                <input type="file" id="avatar_file" accept="image/*" onchange="previewAvatar()">
            </div>
            <div class="form-group">
                <label>çœŸå¯¦å§“å</label>
                <input type="text" id="full_name" placeholder="éšŠå‹å¦‚ä½•ç¨±å‘¼ä½ ">
            </div>
            <div class="row">
                <div class="form-group">
                    <label>è§’è‰²</label>
                    <select id="role">
                        <option value="member">å­¸å“¡</option>
                        <option value="captain">éšŠé•·</option>
                        <option value="deputy">å‰¯éšŠé•·</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è¨ˆç•«</label>
                    <select id="plan">
                        <option value="slow_run">æ…¢è·‘</option>
                        <option value="fast_run">å¿«è·‘</option>
                        <option value="vip">VIP</option>
                    </select>
                </div>
            </div>
            <div class="form-group" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                <label>åŠ å…¥éšŠä¼é‚€è«‹ç¢¼ (Team ID)</label>
                <input type="text" id="team_id_input" placeholder="è²¼ä¸ŠéšŠé•·çµ¦çš„ ID">
                <small style="color:#666; display:block; margin-top:5px;">è‹¥ç„¡éšŠä¼ä»£ç¢¼ï¼Œè«‹è¯çµ¡éšŠé•·</small>
            </div>
            <button class="btn-primary" onclick="updateProfile()">å„²å­˜ä¸¦é–‹å§‹éŠæˆ²</button>
        </div>

        <!-- å€‹äººæ•¸æ“šè®ŠåŒ–åœ–è¡¨ -->
        <div id="personal-progress-section" class="progress-card hidden">
            <div class="progress-title">ğŸ“ˆ æˆ‘çš„æ•¸æ“šè®ŠåŒ–è¶¨å‹¢</div>
            <div class="chart-container">
                <canvas id="personal-progress-chart"></canvas>
            </div>
        </div>

        <!-- åœ˜éšŠæ•¸æ“šè®ŠåŒ–ï¼ˆéšŠé•·å’Œå‰¯éšŠé•·å¯è¦‹ï¼‰ -->
        <div id="team-progress-section" class="progress-card hidden">
            <div class="progress-title">ğŸ‘¥ åœ˜éšŠæ•¸æ“šè®ŠåŒ–</div>
            <div class="progress-list" id="team-progress-list">
                <div style="text-align: center; padding: 20px; color: #7f8c8d;">
                    è¼‰å…¥åœ˜éšŠæ•¸æ“šä¸­...
                </div>
            </div>
        </div>

        <!-- æ¯æ—¥æ•¸æ“šå ±åˆ°å¡ç‰‡ -->
        <div class="card" style="border-left: 5px solid var(--warning);">
            <div class="card-title">âš–ï¸ æ¯æ—¥æ•¸æ“šå ±åˆ°</div>
            <div class="form-group">
                <label>ä»Šæ—¥é«”é‡ (kg)</label>
                <input type="number" id="weight" step="0.1" placeholder="0.0">
            </div>
            <div class="row">
                <div class="form-group">
                    <label>é«”è„‚ç‡ (%)</label>
                    <input type="number" id="fat_rate" step="0.1" placeholder="0.0">
                </div>
                <div class="form-group">
                    <label>è‚Œè‚‰é‡ (kg)</label>
                    <input type="number" id="muscle_mass" step="0.1" placeholder="0.0">
                </div>
            </div>
            
            <!-- ä»»å‹™å®Œæˆç‹€æ…‹ -->
            <div class="form-group" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                <label>ä»Šæ—¥ä»»å‹™å®Œæˆç‹€æ…‹</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <label style="font-size: 13px; display: flex; align-items: center;">
                        <input type="checkbox" id="task_shake" style="margin-right: 8px;"> ä½¿ç”¨Shake
                    </label>
                    <label style="font-size: 13px; display: flex; align-items: center;">
                        <input type="checkbox" id="task_live" style="margin-right: 8px;"> å®Œæˆç›´æ’­
                    </label>
                    <label style="font-size: 13px; display: flex; align-items: center;">
                        <input type="checkbox" id="task_diet" style="margin-right: 8px;"> æ‰“å¡é£²é£Ÿ
                    </label>
                    <label style="font-size: 13px; display: flex; align-items: center;">
                        <input type="checkbox" id="task_exercise" style="margin-right: 8px;"> å®Œæˆé‹å‹•
                    </label>
                </div>
            </div>
            
            <button class="btn-warning" onclick="saveDailyData()">é€å‡ºä»Šæ—¥å ±åˆ°</button>
            <p id="status-msg" style="text-align: center; color: var(--success); font-size: 14px; font-weight: bold; margin-top: 10px; min-height: 20px;"></p>
        </div>

        <!-- åŠŸèƒ½æŒ‰éˆ• -->
        <div class="card" style="text-align: center;">
            <button class="btn-success" onclick="window.open('team.html', '_blank')" style="margin-bottom: 10px;">
                ğŸ† æŸ¥çœ‹ä¹å®®æ ¼æˆ°æ³
            </button>
            <button class="btn-primary" onclick="window.open('leaderboard.html', '_blank')" style="margin-bottom: 10px;">
                ğŸ“Š æŸ¥çœ‹æ’è¡Œæ¦œ
            </button>
            <button class="btn-primary" onclick="window.open('tasks.html', '_blank')">
                âœ… æŸ¥çœ‹ä»»å‹™å€
            </button>
        </div>

        <!-- ç™»å‡ºæŒ‰éˆ• -->
        <button class="btn-danger" style="margin-top:20px;" onclick="signOut()">å®‰å…¨ç™»å‡º</button>
    </div>
</div>

<script>
    // Supabase åˆå§‹åŒ–
    const SUPABASE_URL = 'https://sdloakutxcsbshcqpxwn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbG9ha3V0eGNzYnNoY3FweHduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMTE4MjYsImV4cCI6MjA4MTY4NzgyNn0.5OBQQAinARnZQ6VSCrPl60NWmcSG-QiFMmVIJRW7g-0';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // å…¨å±€è®Šæ•¸
    let currentUser = null;
    let personalChart = null;

    // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    window.onload = async () => {
        const { data: { session }, error } = await sb.auth.getSession();
        if (error) {
            console.error("æª¢æŸ¥ç™»å…¥ç‹€æ…‹éŒ¯èª¤:", error);
            return;
        }
        
        if (session) {
            console.log("å·²ç™»å…¥ï¼Œç”¨æˆ¶:", session.user.email);
            await showProfile(session.user);
        } else {
            console.log("æœªç™»å…¥ï¼Œé¡¯ç¤ºç™»å…¥è¡¨å–®");
            document.getElementById('auth-section').classList.remove('hidden');
        }
    };

    // é è¦½é ­åƒ
    function previewAvatar() {
        const fileInput = document.getElementById('avatar_file');
        const avatarImg = document.getElementById('avatar-img');
        
        if (fileInput.files && fileInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                avatarImg.src = e.target.result;
            };
            reader.readAsDataURL(fileInput.files[0]);
        }
    }

    // ç²å–é¦™æ¸¯æ™‚é–“
    function getHKTime() {
        const now = new Date();
        const hkOffset = 8 * 60; // é¦™æ¸¯ UTC+8
        const localOffset = now.getTimezoneOffset();
        return new Date(now.getTime() + (hkOffset + localOffset) * 60000);
    }

    // é¡¯ç¤ºå€‹äººè³‡æ–™
    async function showProfile(user) {
        console.log("é¡¯ç¤ºç”¨æˆ¶è³‡æ–™:", user.email);
        
        // ä¿å­˜ç•¶å‰ç”¨æˆ¶
        currentUser = user;
        
        // åˆ‡æ›é¡¯ç¤ºå€åŸŸ
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('profile-section').classList.remove('hidden');
        document.getElementById('user-display').innerText = `å¸³è™Ÿ: ${user.email}`;

        try {
            // æŸ¥è©¢ç”¨æˆ¶è³‡æ–™
            const { data: profile, error } = await sb
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .maybeSingle();

            if (error) {
                console.error("æŸ¥è©¢ç”¨æˆ¶è³‡æ–™éŒ¯èª¤:", error);
                return;
            }

            console.log("æŸ¥è©¢åˆ°çš„ç”¨æˆ¶è³‡æ–™:", profile);

            // æ›´æ–°è¡¨å–®è³‡æ–™
            if (profile) {
                // åŸºæœ¬è³‡æ–™
                document.getElementById('full_name').value = profile.full_name || '';
                document.getElementById('role').value = profile.role || 'member';
                document.getElementById('plan').value = profile.plan || 'slow_run';
                document.getElementById('team_id_input').value = profile.current_team_id || '';
                
                // é ­åƒ
                if (profile.avatar_url) {
                    document.getElementById('avatar-img').src = profile.avatar_url;
                } else if (profile.full_name) {
                    document.getElementById('avatar-img').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(profile.full_name)}&background=random`;
                }

                // æª¢æŸ¥æ˜¯å¦å·²å®Œæˆè¨­å®š
                const isSetupComplete = profile.full_name && profile.current_team_id;
                
                // æ§åˆ¶é¡¯ç¤º/éš±è—å’Œé–å®šç‹€æ…‹
                if (isSetupComplete) {
                    document.getElementById('setup-card').classList.add('hidden');
                    document.getElementById('edit-profile-btn').classList.remove('hidden');
                    
                    // é–å®šè¼¸å…¥æ¬„ä½
                    document.getElementById('full_name').disabled = true;
                    document.getElementById('role').disabled = true;
                    document.getElementById('plan').disabled = true;
                    document.getElementById('team_id_input').disabled = true;
                    
                    // æ›´æ–°éšŠä¼ç‹€æ…‹é¡¯ç¤º
                    document.getElementById('team-status').textContent = 'å·²åŠ å…¥';
                    
                    // è¨ˆç®—ä¸¦é¡¯ç¤ºç©åˆ†
                    await calculateTotalPoints(user.id);
                    
                    // æª¢æŸ¥ä»Šæ—¥æ˜¯å¦å·²å ±åˆ°
                    await checkDailyCheckin(user.id);
                    
                    // è¼‰å…¥å€‹äººæ•¸æ“šè®ŠåŒ–åœ–è¡¨
                    await loadPersonalProgressChart(user.id);
                    
                    // æ ¹æ“šè§’è‰²é¡¯ç¤ºå°ˆå±¬æŒ‰éˆ•å’Œåœ˜éšŠæ•¸æ“š
                    showRoleSpecificContent(profile);
                    
                } else {
                    document.getElementById('setup-card').classList.remove('hidden');
                    document.getElementById('edit-profile-btn').classList.add('hidden');
                    document.getElementById('team-status').textContent = 'æœªåŠ å…¥';
                }
            } else {
                // å¦‚æœæ²’æœ‰å€‹äººè³‡æ–™ï¼Œé¡¯ç¤ºè¨­å®šå¡ç‰‡
                document.getElementById('setup-card').classList.remove('hidden');
                document.getElementById('edit-profile-btn').classList.add('hidden');
                document.getElementById('team-status').textContent = 'æœªè¨­å®š';
            }
        } catch (err) {
            console.error("é¡¯ç¤ºå€‹äººè³‡æ–™éŒ¯èª¤:", err);
        }
    }

    // æ ¹æ“šè§’è‰²é¡¯ç¤ºå°ˆå±¬å…§å®¹
    async function showRoleSpecificContent(profile) {
        const roleButtons = document.getElementById('role-buttons');
        const adminBtn = document.getElementById('admin-btn');
        const captainBtn = document.getElementById('captain-btn');
        const deputyBtn = document.getElementById('deputy-btn');
        
        // éš±è—æ‰€æœ‰æŒ‰éˆ•
        adminBtn.classList.add('hidden');
        captainBtn.classList.add('hidden');
        deputyBtn.classList.add('hidden');
        roleButtons.classList.add('hidden');
        
        // æ ¹æ“šè§’è‰²é¡¯ç¤ºå°æ‡‰æŒ‰éˆ•
        if (profile.role === 'admin' || profile.role === 'super_admin') {
            adminBtn.classList.remove('hidden');
            roleButtons.classList.remove('hidden');
        } else if (profile.role === 'captain') {
            captainBtn.classList.remove('hidden');
            roleButtons.classList.remove('hidden');
            
            // é¡¯ç¤ºåœ˜éšŠæ•¸æ“š
            document.getElementById('team-progress-section').classList.remove('hidden');
            await loadTeamProgress(profile.current_team_id, true); // trueè¡¨ç¤ºæ˜¯éšŠé•·
        } else if (profile.role === 'deputy') {
            deputyBtn.classList.remove('hidden');
            roleButtons.classList.remove('hidden');
            
            // é¡¯ç¤ºåœ˜éšŠæ•¸æ“š
            document.getElementById('team-progress-section').classList.remove('hidden');
            await loadTeamProgress(profile.current_team_id, false); // falseè¡¨ç¤ºæ˜¯å‰¯éšŠé•·
        }
        
        // é¡¯ç¤ºå€‹äººæ•¸æ“šåœ–è¡¨
        document.getElementById('personal-progress-section').classList.remove('hidden');
    }

    // è¼‰å…¥å€‹äººæ•¸æ“šè®ŠåŒ–åœ–è¡¨
    async function loadPersonalProgressChart(userId) {
        try {
            // ç²å–æœ€è¿‘14å¤©çš„æ•¸æ“š
            const twoWeeksAgo = new Date();
            twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
            
            const { data: records, error } = await sb
                .from('weight_records')
                .select('*')
                .eq('user_id', userId)
                .gte('date', twoWeeksAgo.toISOString().split('T')[0])
                .order('date', { ascending: true });
            
            if (error) throw error;
            
            const ctx = document.getElementById('personal-progress-chart').getContext('2d');
            
            // å¦‚æœå·²æœ‰åœ–è¡¨ï¼ŒéŠ·æ¯€å®ƒ
            if (personalChart) {
                personalChart.destroy();
            }
            
            if (!records || records.length === 0) {
                // æ²’æœ‰æ•¸æ“šæ™‚é¡¯ç¤ºæç¤º
                ctx.font = '14px sans-serif';
                ctx.fillStyle = '#7f8c8d';
                ctx.textAlign = 'center';
                ctx.fillText('æš«ç„¡æ•¸æ“šï¼Œè«‹é–‹å§‹æ¯æ—¥å ±åˆ°', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            // æº–å‚™æ•¸æ“š
            const dates = records.map(record => {
                const date = new Date(record.date);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            });
            
            const weights = records.map(record => record.weight || 0);
            const fatRates = records.map(record => record.fat_rate || 0);
            const muscleMasses = records.map(record => record.muscle_mass || 0);
            
            // è¨ˆç®—è®ŠåŒ–è¶¨å‹¢
            const weightChanges = weights.map((weight, index) => {
                if (index === 0) return 0;
                return weight - weights[index - 1];
            });
            
            personalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'é«”é‡ (kg)',
                            data: weights,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4
                        },
                        {
                            label: 'é«”è„‚ç‡ (%)',
                            data: fatRates,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4
                        },
                        {
                            label: 'è‚Œè‚‰é‡ (kg)',
                            data: muscleMasses,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y.toFixed(1);
                                    
                                    // å¦‚æœæ˜¯é«”é‡ï¼Œé¡¯ç¤ºè®ŠåŒ–
                                    if (context.datasetIndex === 0 && context.dataIndex > 0) {
                                        const change = weightChanges[context.dataIndex];
                                        if (change !== 0) {
                                            label += ` (${change > 0 ? '+' : ''}${change.toFixed(1)})`;
                                        }
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'é«”é‡/è‚Œè‚‰é‡ (kg)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'é«”è„‚ç‡ (%)'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
            
        } catch (error) {
            console.error('è¼‰å…¥å€‹äººæ•¸æ“šåœ–è¡¨éŒ¯èª¤:', error);
        }
    }

    // è¼‰å…¥åœ˜éšŠæ•¸æ“šè®ŠåŒ–
    async function loadTeamProgress(teamId, isCaptain) {
        const container = document.getElementById('team-progress-list');
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #7f8c8d;">è¼‰å…¥åœ˜éšŠæ•¸æ“šä¸­...</div>';
        
        try {
            // ç²å–åœ˜éšŠæˆå“¡
            const { data: members, error } = await sb
                .from('profiles')
                .select('id, full_name, avatar_url, role')
                .eq('current_team_id', teamId)
                .order('created_at', { ascending: true });
            
            if (error) throw error;
            
            if (!members || members.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;">åœ˜éšŠæš«ç„¡æˆå“¡</div>';
                return;
            }
            
            // ç²å–æœ€è¿‘2å¤©çš„æ—¥æœŸ
            const today = getHKTime();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            const todayStr = today.toISOString().split('T')[0];
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            // ç²å–æ‰€æœ‰æˆå“¡çš„æ•¸æ“š
            const memberIds = members.map(member => member.id);
            const { data: records } = await sb
                .from('weight_records')
                .select('*')
                .in('user_id', memberIds)
                .in('date', [todayStr, yesterdayStr])
                .order('date', { ascending: false });
            
            // çµ„ç¹”æ•¸æ“š
            const memberData = {};
            members.forEach(member => {
                memberData[member.id] = {
                    ...member,
                    today: null,
                    yesterday: null
                };
            });
            
            // å¡«å……æ•¸æ“š
            records?.forEach(record => {
                if (record.date === todayStr) {
                    memberData[record.user_id].today = record;
                } else if (record.date === yesterdayStr) {
                    memberData[record.user_id].yesterday = record;
                }
            });
            
            // ç”ŸæˆHTML
            let html = '';
            
            Object.values(memberData).forEach(member => {
                const todayRecord = member.today;
                const yesterdayRecord = member.yesterday;
                
                let weightChange = null;
                let fatChange = null;
                let muscleChange = null;
                
                if (todayRecord && yesterdayRecord) {
                    weightChange = todayRecord.weight - yesterdayRecord.weight;
                    fatChange = todayRecord.fat_rate - yesterdayRecord.fat_rate;
                    muscleChange = todayRecord.muscle_mass - yesterdayRecord.muscle_mass;
                }
                
                html += `
                <div class="progress-item">
                    <div class="progress-header">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <img src="${member.avatar_url || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(member.full_name || 'User') + '&background=random'}" 
                                 style="width: 30px; height: 30px; border-radius: 50%;">
                            <div>
                                <div class="progress-name">${member.full_name || 'æœªå‘½å'}</div>
                                <div style="font-size: 11px; color: #94a3b8;">
                                    ${member.role === 'captain' ? 'ğŸ‘‘ éšŠé•·' : member.role === 'deputy' ? 'â­ å‰¯éšŠé•·' : 'ğŸ‘¤ å­¸å“¡'}
                                </div>
                            </div>
                        </div>
                        <div class="progress-date">
                            ${todayRecord ? 'âœ… ä»Šæ—¥å·²å ±åˆ°' : 'â³ ä»Šæ—¥æœªå ±åˆ°'}
                        </div>
                    </div>
                    
                    <div class="progress-details">
                        <div class="progress-detail">
                            <div class="progress-label">é«”é‡</div>
                            <div class="progress-value">
                                ${todayRecord ? todayRecord.weight.toFixed(1) + ' kg' : '--'}
                            </div>
                            ${weightChange !== null ? `
                                <div class="progress-change ${weightChange < 0 ? 'change-positive' : weightChange > 0 ? 'change-negative' : ''}">
                                    ${weightChange < 0 ? 'â†“' : weightChange > 0 ? 'â†‘' : 'â†’'} ${Math.abs(weightChange).toFixed(1)} kg
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="progress-detail">
                            <div class="progress-label">é«”è„‚</div>
                            <div class="progress-value">
                                ${todayRecord ? todayRecord.fat_rate.toFixed(1) + ' %' : '--'}
                            </div>
                            ${fatChange !== null ? `
                                <div class="progress-change ${fatChange < 0 ? 'change-positive' : fatChange > 0 ? 'change-negative' : ''}">
                                    ${fatChange < 0 ? 'â†“' : fatChange > 0 ? 'â†‘' : 'â†’'} ${Math.abs(fatChange).toFixed(1)} %
                                </div>
                            ` : ''}
                        </div>
                        
                        <div class="progress-detail">
                            <div class="progress-label">è‚Œè‚‰</div>
                            <div class="progress-value">
                                ${todayRecord ? todayRecord.muscle_mass.toFixed(1) + ' kg' : '--'}
                            </div>
                            ${muscleChange !== null ? `
                                <div class="progress-change ${muscleChange > 0 ? 'change-positive' : muscleChange < 0 ? 'change-negative' : ''}">
                                    ${muscleChange > 0 ? 'â†‘' : muscleChange < 0 ? 'â†“' : 'â†’'} ${Math.abs(muscleChange).toFixed(1)} kg
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>`;
            });
            
            // å¦‚æœæ˜¯éšŠé•·ï¼Œé¡¯ç¤ºåœ˜éšŠçµ±è¨ˆ
            if (isCaptain) {
                // è¨ˆç®—åœ˜éšŠç¸½è¨ˆ
                const totalMembers = members.length;
                const checkedInToday = Object.values(memberData).filter(m => m.today).length;
                const completionRate = Math.round((checkedInToday / totalMembers) * 100);
                
                const totalWeightLoss = Object.values(memberData).reduce((sum, member) => {
                    if (member.today && member.yesterday) {
                        return sum + (member.today.weight - member.yesterday.weight);
                    }
                    return sum;
                }, 0);
                
                html = `
                <div style="background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; text-align: center;">
                        <div>
                            <div style="font-size: 12px; color: #64748b;">åœ˜éšŠæˆå“¡</div>
                            <div style="font-size: 24px; font-weight: bold;">${totalMembers} äºº</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #64748b;">ä»Šæ—¥å ±åˆ°ç‡</div>
                            <div style="font-size: 24px; font-weight: bold; color: ${completionRate >= 80 ? 'var(--success)' : 'var(--warning)'}">${completionRate}%</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 10px;">
                        <div style="font-size: 12px; color: #64748b;">æ˜¨æ—¥ç¸½æ¸›é‡</div>
                        <div style="font-size: 20px; font-weight: bold; color: ${totalWeightLoss < 0 ? 'var(--success)' : 'var(--danger)'}">
                            ${totalWeightLoss < 0 ? 'â†“' : totalWeightLoss > 0 ? 'â†‘' : ''} ${Math.abs(totalWeightLoss).toFixed(1)} kg
                        </div>
                    </div>
                </div>
                ` + html;
            }
            
            container.innerHTML = html;
            
        } catch (error) {
            console.error('è¼‰å…¥åœ˜éšŠæ•¸æ“šéŒ¯èª¤:', error);
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: #e74c3c;">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</div>';
        }
    }

    // æª¢æŸ¥ä»Šæ—¥æ˜¯å¦å·²å ±åˆ°
    async function checkDailyCheckin(userId) {
        const today = getHKTime().toISOString().split('T')[0];
        
        const { data, error } = await sb
            .from('weight_records')
            .select('*')
            .eq('user_id', userId)
            .eq('date', today)
            .maybeSingle();
            
        if (data) {
            // å¦‚æœä»Šæ—¥å·²å ±åˆ°ï¼Œå¡«å…¥è³‡æ–™
            document.getElementById('weight').value = data.weight || '';
            document.getElementById('fat_rate').value = data.fat_rate || '';
            document.getElementById('muscle_mass').value = data.muscle_mass || '';
            
            // æª¢æŸ¥ä»»å‹™ç‹€æ…‹
            const { data: dailyScore } = await sb
                .from('daily_scores')
                .select('*')
                .eq('user_id', userId)
                .eq('date', today)
                .maybeSingle();
                
            if (dailyScore) {
                document.getElementById('task_shake').checked = dailyScore.shake_used || false;
                document.getElementById('task_live').checked = dailyScore.task_completed || false;
                document.getElementById('task_diet').checked = dailyScore.weight_recorded || false;
                document.getElementById('task_exercise').checked = dailyScore.exercise_done || false;
            }
        }
    }

    // è¨ˆç®—ç¸½ç©åˆ†
    async function calculateTotalPoints(userId) {
        try {
            const { data: profile } = await sb
                .from('profiles')
                .select('points')
                .eq('id', userId)
                .single();
                
            if (profile && profile.points) {
                document.getElementById('ticket-count').textContent = profile.points;
            } else {
                document.getElementById('ticket-count').textContent = '0';
            }
        } catch (err) {
            console.error("è¨ˆç®—ç©åˆ†éŒ¯èª¤:", err);
            document.getElementById('ticket-count').textContent = '0';
        }
    }

    // åˆ‡æ›ç·¨è¼¯æ¨¡å¼
    function toggleProfileEdit() {
        const setupCard = document.getElementById('setup-card');
        const isHidden = setupCard.classList.contains('hidden');
        
        if (isHidden) {
            // é¡¯ç¤ºè¨­å®šå¡ç‰‡ä¸¦è§£é–
            setupCard.classList.remove('hidden');
            document.getElementById('full_name').disabled = false;
            document.getElementById('role').disabled = false;
            document.getElementById('plan').disabled = false;
            document.getElementById('team_id_input').disabled = false;
        } else {
            // éš±è—è¨­å®šå¡ç‰‡ä¸¦é–å®š
            setupCard.classList.add('hidden');
            document.getElementById('full_name').disabled = true;
            document.getElementById('role').disabled = true;
            document.getElementById('plan').disabled = true;
            document.getElementById('team_id_input').disabled = true;
        }
    }

    // æ›´æ–°å€‹äººè³‡æ–™
    async function updateProfile() {
        const { data: { user }, error: authError } = await sb.auth.getUser();
        if (authError || !user) {
            alert("è«‹å…ˆç™»å…¥");
            return;
        }

        const fullName = document.getElementById('full_name').value.trim();
        const role = document.getElementById('role').value;
        const plan = document.getElementById('plan').value;
        const teamId = document.getElementById('team_id_input').value.trim();
        
        if (!fullName) {
            alert("è«‹è¼¸å…¥çœŸå¯¦å§“å");
            return;
        }

        // è™•ç†é ­åƒä¸Šå‚³
        let avatarUrl = document.getElementById('avatar-img').src;
        const avatarFile = document.getElementById('avatar_file').files[0];
        
        if (avatarFile) {
            const fileName = `${user.id}_${Date.now()}.png`;
            const { error: uploadError } = await sb.storage
                .from('avatars')
                .upload(fileName, avatarFile, { upsert: true });
                
            if (!uploadError) {
                const { data: urlData } = sb.storage
                    .from('avatars')
                    .getPublicUrl(fileName);
                avatarUrl = urlData.publicUrl;
            }
        }

        // æ›´æ–°æˆ–å‰µå»ºå€‹äººè³‡æ–™
        const { error } = await sb
            .from('profiles')
            .upsert({
                id: user.id,
                full_name: fullName,
                role: role,
                plan: plan,
                current_team_id: teamId || null,
                avatar_url: avatarUrl,
                updated_at: new Date().toISOString()
            });

        if (error) {
            console.error("æ›´æ–°è³‡æ–™éŒ¯èª¤:", error);
            alert("å„²å­˜å¤±æ•—ï¼š" + error.message);
        } else {
            alert("âœ… è¨­å®šå·²å„²å­˜ï¼");
            location.reload(); // é‡æ–°è¼‰å…¥ä»¥æ›´æ–°é¡¯ç¤ºç‹€æ…‹
        }
    }

    // å„²å­˜æ¯æ—¥æ•¸æ“š
    async function saveDailyData() {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) {
            alert("è«‹å…ˆç™»å…¥");
            return;
        }

        const weight = parseFloat(document.getElementById('weight').value);
        if (!weight || weight <= 0) {
            alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é«”é‡");
            return;
        }

        const today = getHKTime().toISOString().split('T')[0];
        const fatRate = parseFloat(document.getElementById('fat_rate').value) || 0;
        const muscleMass = parseFloat(document.getElementById('muscle_mass').value) || 0;
        
        // ç²å–ä»»å‹™ç‹€æ…‹
        const hasShake = document.getElementById('task_shake').checked;
        const hasLive = document.getElementById('task_live').checked;
        const hasDiet = document.getElementById('task_diet').checked;
        const hasExercise = document.getElementById('task_exercise').checked;

        try {
            // å„²å­˜é«”é‡è¨˜éŒ„
            const { error: weightError } = await sb
                .from('weight_records')
                .upsert({
                    user_id: user.id,
                    date: today,
                    weight: weight,
                    fat_rate: fatRate,
                    muscle_mass: muscleMass
                }, { onConflict: 'user_id,date' });

            if (weightError) throw weightError;

            // è¨ˆç®—ä»Šæ—¥ç©åˆ†
            let dailyPoints = 0;
            if (weight > 0 && hasDiet && hasShake && hasLive) {
                dailyPoints += 1; // å®Œæˆä¸€åœˆ
            }
            if (hasExercise) dailyPoints += 1;
            if (hasShake) dailyPoints += 1;

            // å„²å­˜æ¯æ—¥åˆ†æ•¸
            const { error: scoreError } = await sb
                .from('daily_scores')
                .upsert({
                    user_id: user.id,
                    date: today,
                    weight_recorded: weight > 0,
                    shake_used: hasShake,
                    exercise_done: hasExercise,
                    task_completed: hasLive,
                    social_shared: false,
                    referral_made: false,
                    total_points: dailyPoints,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'user_id,date' });

            if (scoreError) throw scoreError;

            // æ›´æ–°ç‹€æ…‹è¨Šæ¯
            document.getElementById('status-msg').textContent = "âœ… ä»Šæ—¥æ•¸æ“šå·²æˆåŠŸå ±åˆ°ï¼";
            setTimeout(() => {
                document.getElementById('status-msg').textContent = "";
                location.reload(); // é‡æ–°è¼‰å…¥ä»¥æ›´æ–°åœ–è¡¨å’Œæ•¸æ“š
            }, 2000);

        } catch (error) {
            console.error("å„²å­˜æ•¸æ“šéŒ¯èª¤:", error);
            alert("å„²å­˜å¤±æ•—ï¼š" + error.message);
        }
    }

    // è¨»å†Š
    async function signUp() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        if (!email || !password) {
            alert("è«‹å¡«å¯«ä¿¡ç®±å’Œå¯†ç¢¼");
            return;
        }

        const { data, error } = await sb.auth.signUp({ email, password });
        if (error) {
            alert("è¨»å†Šå¤±æ•—ï¼š" + error.message);
        } else {
            alert("âœ… è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥ä¿¡ç®±é©—è­‰éƒµä»¶å¾Œç™»å…¥ã€‚");
        }
    }

    // ç™»å…¥
    async function signIn() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        if (!email || !password) {
            alert("è«‹å¡«å¯«ä¿¡ç®±å’Œå¯†ç¢¼");
            return;
        }

        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if (error) {
            alert("ç™»å…¥å¤±æ•—ï¼š" + error.message);
        } else {
            // ç™»å…¥æˆåŠŸï¼Œé‡æ–°è¼‰å…¥é é¢
            location.reload();
        }
    }

    // ç™»å‡º
    async function signOut() {
        await sb.auth.signOut();
        location.reload();
    }
</script>
</body>
</html>
