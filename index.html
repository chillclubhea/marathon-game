<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦¬æ‹‰æ¾ç©å®¶ä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* é€™è£¡ä¿ç•™ä½ ä¹‹å‰çš„ CSS æ¨£å¼ï¼ŒåŒ…å« .mission-item, .card, .ticket-stats ç­‰ */
        :root { --primary: #3498db; --success: #2ecc71; --warning: #f39c12; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: sans-serif; background-color: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .container { background: white; padding: 25px; border-radius: 20px; width: 100%; max-width: 450px; }
        .card { border: 1px solid #edf2f7; border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .hidden { display: none !important; }
        .ticket-stats { display: flex; justify-content: space-around; background: #6e8efb; color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; text-align: center; }
        input, select { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; }
        button { width: 100%; padding: 12px; border-radius: 8px; cursor: pointer; border: none; font-weight: bold; color: white; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
   <div id="auth-section">
    <h2>ğŸ”‘ ç™»å…¥é¦¬æ‹‰æ¾</h2>
    <div class="card">
        <form id="login-form">
            <input type="email" id="email" placeholder="é›»å­ä¿¡ç®±" autocomplete="email">
            <input type="password" id="password" placeholder="å¯†ç¢¼" autocomplete="current-password">
            <button type="button" style="background:var(--primary)" onclick="signUp()">å¿«é€Ÿè¨»å†Š</button>
            <button type="button" style="background:var(--success)" onclick="signIn()">ç«‹å³ç™»å…¥</button>
        </form>
    </div>
</div>

    <div id="profile-section" class="hidden">
        <div class="ticket-stats">
            <div><span>ç›®å‰ç©åˆ†</span><b id="ticket-count">0</b></div>
            <div><span>ç•¶å‰é€²åº¦</span><b id="day-progress">Day 0</b></div>
        </div>

        <div class="card" style="border-left: 5px solid var(--warning);">
            <div style="font-weight:bold; margin-bottom:10px;">âš–ï¸ æ¯æ—¥æ•¸æ“šå ±åˆ° (è³ºç©åˆ†)</div>
            <p id="today-mission-tip" style="font-size: 12px; color: #666;"></p>
            <input type="number" id="weight" step="0.1" placeholder="ä»Šæ—¥é«”é‡ (kg)">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 10px 0;">
                <label><input type="checkbox" id="check_diet"> å®Œæˆæ‰“å¡é£²é£Ÿ</label>
                <label><input type="checkbox" id="check_shake"> æ‹å¥¶æ˜” (Shake)</label>
                <label><input type="checkbox" id="check_live"> å·²ç›´æ’­</label>
            </div>
            <p style="font-size:11px; color: var(--danger);">* éœ€å…¨é¸ï¼ˆå®Œæˆä¸€åœˆï¼‰æ‰å¯ç²å¾— 1 ç©åˆ†</p>
            <button style="background:var(--warning)" onclick="saveDailyData()">é€å‡ºå ±åˆ°</button>
        </div>

        <button style="background:var(--danger); opacity:0.6;" onclick="signOut()">å®‰å…¨ç™»å‡º</button>
    </div>
</div>

<script>
    // è«‹ç¢ºä¿é€™å…©è¡Œå¡«å…¥ä½ æ­£ç¢ºçš„ Supabase è³‡è¨Šï¼Œä¸è¦ç•™ç©ºæˆ–æ”¾ã€Œä½ çš„URLã€
const SUPABASE_URL = 'https://sdloakutxcsbshcqpxwn.supabase.co'; 
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbG9ha3V0eGNzYnNoY3FweHduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMTE4MjYsImV4cCI6MjA4MTY4NzgyNn0.5OBQQAinARnZQ6VSCrPl60NWmcSG-QiFMmVIJRW7g-0';

// ç¢ºä¿ sb çš„å®£å‘Šåœ¨æ‰€æœ‰ function ä½¿ç”¨å®ƒä¹‹å‰
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


    // 1. åˆå§‹åŒ–æª¢æŸ¥ (ç¢ºä¿åœ¨ async å…§)
    window.onload = async () => {
    try {
        const { data: { session } } = await sb.auth.getSession();
        if (session) {
            showProfile();
            loadFullProfile(session.user);
        }
    } catch (e) {
        console.error("åˆå§‹åŒ–å¤±æ•—:", e);
    }

    function showProfile() {
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('profile-section').classList.remove('hidden');
    }

    // 2. ç™»å…¥/è¨»å†Šå‡½æ•¸ (ä¸€å®šè¦åŠ ä¸Š async)
    async function signIn() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) alert(error.message); else location.reload();
    }

    async function signUp() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const { error } = await sb.auth.signUp({ email, password });
        if (error) alert(error.message); else alert("è¨»å†ŠæˆåŠŸï¼");
    }

    async function signOut() {
        await sb.auth.signOut();
        location.reload();
    }

    // 3. ç©åˆ†è¨ˆç®—èˆ‡è¼‰å…¥
    async function loadFullProfile(user) {
        const { data: profile } = await sb.from('profiles').select('*').eq('id', user.id).single();
        if (profile) {
            // è¨ˆç®—å¤©æ•¸
            const dayNum = Math.ceil(Math.abs(new Date() - new Date(profile.created_at)) / (1000 * 60 * 60 * 24));
            document.getElementById('day-progress').innerText = `Day ${dayNum}`;
            calculateTotalPoints(user.id);
        }
    }

    async function calculateTotalPoints(userId) {
        const { data: profile } = await sb.from('profiles').select('*').eq('id', userId).single();
        const { data: records } = await sb.from('weight_records').select('*').eq('user_id', userId);

        let points = 0;

        // çºŒè·‘èˆ‡ä»‹ç´¹åˆ† (åœ–ç‰‡å…§å®¹)
        if (profile.renewal_type === '100') points += 1;
        else if (profile.renewal_type === '150') points += 2;
        else if (profile.renewal_type === '250') points += 4;
        points += (profile.referral_count || 0) * 15;

        // æ¯æ—¥è¨˜éŒ„ç©åˆ†ï¼šç£…ç£… + æ‰“å¡ + shake + ç›´æ’­ = 1åˆ†
        if (records) {
            records.forEach(rec => {
                if (rec.weight && rec.has_diet && rec.has_shake && rec.has_live) {
                    points += 1;
                }
            });
        }
        document.getElementById('ticket-count').innerText = points;
    }

    async function saveDailyData() {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) return;

        const weight = document.getElementById('weight').value;
        const hasDiet = document.getElementById('check_diet').checked;
        const hasShake = document.getElementById('check_shake').checked;
        const hasLive = document.getElementById('check_live').checked;

        if (!weight) return alert("è«‹è¼¸å…¥é«”é‡ï¼");

      // æ ¸å¿ƒä¿®æ­£ï¼šç¢ºä¿ä½¿ç”¨çš„æ˜¯ .upsert()
const { error } = await sb.from('weight_records').upsert({
    user_id: user.id,
    date: new Date().toISOString().split('T')[0], // ä»Šå¤©çš„æ—¥æœŸ
    weight: parseFloat(weight),
    has_diet: hasDiet,
    has_shake: hasShake,
    has_live: hasLive
}, { 
    onConflict: 'user_id, date' // å‘Šè¨´è³‡æ–™åº«ï¼šå¦‚æœé€™å…©å€‹æ¬„ä½è¡çªï¼Œå°±åŸ·è¡Œæ›´æ–°
})

        if (error) alert(error.message);
        else {
            alert("âœ… å ±åˆ°æˆåŠŸï¼è‹¥å››é …å…¨èƒ½å‰‡ç²å¾— 1 åˆ†");
            location.reload();
        }
    }
</script>
</body>
</html>
