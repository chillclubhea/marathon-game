<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦¬æ‹‰æ¾ç©å®¶ä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #3498db; --success: #2ecc71; --warning: #f39c12; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; display: flex; justify-content: center; padding: 20px; }
        .container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); width: 100%; max-width: 450px; }
        .header { text-align: center; margin-bottom: 25px; }
        h2 { color: #2c3e50; margin: 0; font-size: 24px; }
        #user-display { font-size: 12px; color: #95a5a6; margin-top: 5px; }
        .card { background: #fff; border: 1px solid #edf2f7; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .card-title { font-weight: bold; color: #2d3748; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: bold; color: #4a5568; font-size: 14px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        input:disabled, select:disabled { background-color: #f8fafc; color: #94a3b8; cursor: not-allowed; }
        .row { display: flex; gap: 10px; }
        .row .form-group { flex: 1; }
        button { width: 100%; padding: 14px; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; }
        .btn-primary { background-color: var(--primary); }
        .btn-success { background-color: var(--success); }
        .btn-warning { background-color: var(--warning); }
        .btn-danger { background-color: var(--danger); }
        .btn-admin { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-captain { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .btn-deputy { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .hidden { display: none !important; }
        .avatar-preview { width: 80px; height: 80px; border-radius: 50%; background: #eee; margin: 0 auto 15px; display: block; object-fit: cover; border: 3px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .ticket-stats { display: flex; justify-content: space-between; margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 10px; }
        .ticket-stats div { text-align: center; }
        .ticket-stats span { display: block; font-size: 12px; color: #64748b; margin-bottom: 5px; }
        .ticket-stats b { display: block; font-size: 24px; color: #0ea5e9; }
        .mission-item { background: #f1f5f9; padding: 10px; margin-bottom: 8px; border-radius: 8px; font-size: 14px; }
        .mission-item.active { background: #dbeafe; border-left: 4px solid #3b82f6; }
        
        /* æ–°å¢ï¼šæ•¸æ“šè®ŠåŒ–æ¨£å¼ */
        .progress-card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; border-left: 5px solid var(--success); }
        .progress-title { font-weight: bold; color: #2d3748; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .progress-list { max-height: 300px; overflow-y: auto; }
        .progress-item { padding: 10px; border-bottom: 1px solid #f0f0f0; }
        .progress-item:last-child { border-bottom: none; }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .progress-name { font-weight: bold; color: #2d3748; font-size: 14px; }
        .progress-date { font-size: 12px; color: #94a3b8; }
        .progress-details { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 8px; }
        .progress-detail { text-align: center; }
        .progress-label { font-size: 11px; color: #64748b; }
        .progress-value { font-size: 14px; font-weight: bold; }
        .progress-change { font-size: 12px; }
        .change-positive { color: var(--success); }
        .change-negative { color: var(--danger); }
        
        /* åœ–è¡¨å®¹å™¨ */
        .chart-container { height: 200px; margin-top: 15px; }
        
        /* è§’è‰²æŒ‰éˆ•å®¹å™¨ */
        .role-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
        .role-buttons button { margin: 0; }
    </style>
</head>
<body>

<div class="container">
    <!-- æˆªæ­¢æ™‚é–“é€šçŸ¥ -->
    <div id="deadline-notice" style="background:#fff3cd; color:#856404; padding:8px; border-radius:8px; font-size:13px; margin-bottom:10px; text-align:center;">
        âš ï¸ ä»Šæ—¥å ±åˆ°æˆªæ­¢ï¼šé¦™æ¸¯æ™‚é–“ 23:59
    </div>

    <!-- ç™»å…¥å€å¡Š -->
    <div id="auth-section">
        <div class="header">
            <h2>ğŸ”‘ ç™»å…¥é¦¬æ‹‰æ¾</h2>
            <div id="login-msg" style="font-size:14px; color:#666; margin-top:5px;">è«‹ç™»å…¥ä»¥ç¹¼çºŒ</div>
        </div>
        <form onsubmit="signIn(); return false;" class="card" style="margin-top: 20px;">
            <div class="form-group">
                <label>é›»å­ä¿¡ç®±</label>
                <input type="email" id="email" placeholder="Email" required>
            </div>
            <div class="form-group">
                <label>å¯†ç¢¼</label>
                <input type="password" id="password" placeholder="Password" required>
            </div>
            <button type="button" class="btn-primary" onclick="signUp()">è¨»å†Š</button>
            <button type="submit" class="btn-success">ç™»å…¥</button>
        </form>
    </div>

    <!-- å€‹äººè³‡æ–™å€å¡Š -->
    <div id="profile-section" class="hidden">
        <div class="header">
            <h2>ğŸƒ ç©å®¶ä¸­å¿ƒ</h2>
            <div id="user-display"></div>
        </div>

        <!-- ç©åˆ†çµ±è¨ˆ -->
        <div class="ticket-stats">
            <div><span>ç´¯ç©ç©åˆ† ğŸŸï¸</span><b id="ticket-count">0</b></div>
            <div><span>é¦¬æ‹‰æ¾é€²åº¦</span><b id="day-progress">Day 0</b></div>
            <div><span>éšŠä¼ç‹€æ…‹</span><b id="team-status">æœªåŠ å…¥</b></div>
        </div>

        <!-- è§’è‰²å°ˆå±¬æŒ‰éˆ• -->
        <div id="role-buttons" class="role-buttons hidden">
            <!-- ç®¡ç†å“¡æŒ‰éˆ• -->
            <button id="admin-btn" class="hidden btn-admin" onclick="window.location.href='admin.html'">
                ğŸ‘‘ ç®¡ç†å“¡å¾Œå°
            </button>
            <!-- éšŠé•·æŒ‰éˆ• -->
            <button id="captain-btn" class="hidden btn-captain" onclick="window.location.href='captain.html'">
                ğŸ† éšŠé•·å¾Œå°
            </button>
            <!-- å‰¯éšŠé•·æŒ‰éˆ• -->
            <button id="deputy-btn" class="hidden btn-deputy" onclick="window.location.href='deputy.html'">
                â­ å‰¯éšŠé•·å¾Œå°
            </button>
        </div>

        <!-- ç·¨è¼¯æŒ‰éˆ• -->
        <button id="edit-profile-btn" class="hidden" onclick="toggleProfileEdit()" 
                style="background: #edf2f7; color: #4a5568; font-size: 14px; margin-bottom: 15px; padding: 8px; border:none; border-radius:8px; width:100%;">
            âš™ï¸ ä¿®æ”¹å€‹äººè³‡æ–™æˆ–æ›´æ›éšŠä¼
        </button>

        <!-- å€‹äººè¨­å®šå¡ç‰‡ -->
        <div id="setup-card" class="card">
            <div class="card-title">ğŸ‘¤ å€‹äººè¨­å®š & åŠ å…¥éšŠä¼</div>
            <img id="avatar-img" class="avatar-preview" src="https://ui-avatars.com/api/?name=User&background=random">
            <div class="form-group">
                <label>æ›´æ›é ­åƒ</label>
                <input type="file" id="avatar_file" accept="image/*" onchange="previewAvatar()">
            </div>
            <div class="form-group">
                <label>çœŸå¯¦å§“å</label>
                <input type="text" id="full_name" placeholder="éšŠå‹å¦‚ä½•ç¨±å‘¼ä½ ">
            </div>
            <div class="row">
                <div class="form-group">
                    <label>è§’è‰²</label>
                    <select id="role">
                        <option value="member">å­¸å“¡</option>
                        <option value="captain">éšŠé•·</option>
                        <option value="deputy">å‰¯éšŠé•·</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è¨ˆç•«</label>
                    <select id="plan">
                        <option value="slow_run">æ…¢è·‘</option>
                        <option value="fast_run">å¿«è·‘</option>
                        <option value="vip">VIP</option>
                    </select>
                </div>
            </div>
            <div class="form-group" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                <label>åŠ å…¥éšŠä¼é‚€è«‹ç¢¼ (Team ID)</label>
                <input type="text" id="team_id_input" placeholder="è²¼ä¸ŠéšŠé•·çµ¦çš„ ID">
                <small style="color:#666; display:block; margin-top:5px;">è‹¥ç„¡éšŠä¼ä»£ç¢¼ï¼Œè«‹è¯çµ¡éšŠé•·</small>
            </div>
            <button class="btn-primary" onclick="updateProfile()">å„²å­˜ä¸¦é–‹å§‹éŠæˆ²</button>
        </div>

        <!-- å€‹äººæ•¸æ“šè®ŠåŒ–åœ–è¡¨ -->
        <div id="personal-progress-section" class="progress-card hidden">
            <div class="progress-title">ğŸ“ˆ æˆ‘çš„æ•¸æ“šè®ŠåŒ–è¶¨å‹¢</div>
            <div class="chart-container">
                <canvas id="personal-progress-chart"></canvas>
            </div>
        </div>

        <!-- åœ˜éšŠæ•¸æ“šè®ŠåŒ–ï¼ˆéšŠé•·å’Œå‰¯éšŠé•·å¯è¦‹ï¼‰ -->
        <div id="team-progress-section" class="progress-card hidden">
            <div class="progress-title">ğŸ‘¥ åœ˜éšŠæ•¸æ“šè®ŠåŒ–</div>
            <div class="progress-list" id="team-progress-list">
                <div style="text-align: center; padding: 20px; color: #7f8c8d;">
                    è¼‰å…¥åœ˜éšŠæ•¸æ“šä¸­...
                </div>
            </div>
        </div>

        <!-- æ¯æ—¥æ•¸æ“šå ±åˆ°å¡ç‰‡ -->
        <div class="card" style="border-left: 5px solid var(--warning);">
            <div class="card-title">âš–ï¸ æ¯æ—¥æ•¸æ“šå ±åˆ°</div>
            <div class="form-group">
                <label>ä»Šæ—¥é«”é‡ (kg)</label>
                <input type="number" id="weight" step="0.1" placeholder="0.0">
            </div>
            <div class="row">
                <div class="form-group">
                    <label>é«”è„‚ç‡ (%)</label>
                    <input type="number" id="fat_rate" step="0.1" placeholder="0.0">
                </div>
                <div class="form-group">
                    <label>è‚Œè‚‰é‡ (kg)</label>
                    <input type="number" id="muscle_mass" step="0.1" placeholder="0.0">
                </div>
            </div>
            
            <!-- ä»»å‹™å®Œæˆç‹€æ…‹ -->
            <div class="form-group" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                <label>ä»Šæ—¥ä»»å‹™å®Œæˆç‹€æ…‹</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <label style="font-size: 13px; display: flex; align-items: center;">
                        <input type="checkbox" id="task_shake" style="margin-right: 8px;"> ä½¿ç”¨Shake
                    </label>
                    <label style="font-size: 13px; display: flex; align-items: center;">
                        <input type="checkbox" id="task_live" style="margin-right: 8px;"> å®Œæˆç›´æ’­
                    </label>
                    <label style="font-size: 13px; display: flex; align-items: center;">
                        <input type="checkbox" id="task_diet" style="margin-right: 8px;"> æ‰“å¡é£²é£Ÿ
                    </label>
                    <label style="font-size: 13px; display: flex; align-items: center;">
                        <input type="checkbox" id="task_exercise" style="margin-right: 8px;"> å®Œæˆé‹å‹•
                    </label>
                </div>
            </div>
            
            <button class="btn-warning" onclick="saveDailyData()">é€å‡ºä»Šæ—¥å ±åˆ°</button>
            <p id="status-msg" style="text-align: center; color: var(--success); font-size: 14px; font-weight: bold; margin-top: 10px; min-height: 20px;"></p>
        </div>

        <!-- åŠŸèƒ½æŒ‰éˆ• -->
        <div class="card" style="text-align: center;">
            <button class="btn-success" onclick="window.open('team.html', '_blank')" style="margin-bottom: 10px;">
                ğŸ† æŸ¥çœ‹ä¹å®®æ ¼æˆ°æ³
            </button>
            <button class="btn-primary" onclick="window.open('leaderboard.html', '_blank')" style="margin-bottom: 10px;">
                ğŸ“Š æŸ¥çœ‹æ’è¡Œæ¦œ
            </button>
            <button class="btn-primary" onclick="window.open('tasks.html', '_blank')">
                âœ… æŸ¥çœ‹ä»»å‹™å€
            </button>
        </div>

        <!-- ç™»å‡ºæŒ‰éˆ• -->
        <button class="btn-danger" style="margin-top:20px;" onclick="signOut()">å®‰å…¨ç™»å‡º</button>
    </div>
</div>

<script>
    // Supabase åˆå§‹åŒ–
    const SUPABASE_URL = 'https://sdloakutxcsbshcqpxwn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbG9ha3V0eGNzYnNoY3FweHduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMTE4MjYsImV4cCI6MjA4MTY4NzgyNn0.5OBQQAinARnZQ6VSCrPl60NWmcSG-QiFMmVIJRW7g-0';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // å…¨å±€è®Šæ•¸
    let currentUser = null;
    let personalChart = null;

    // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    window.onload = async () => {
        const { data: { session }, error } = await sb.auth.getSession();
        if (error) {
            console.error("æª¢æŸ¥ç™»å…¥ç‹€æ…‹éŒ¯èª¤:", error);
            return;
        }
        
        if (session) {
            console.log("å·²ç™»å…¥ï¼Œç”¨æˆ¶:", session.user.email);
            await showProfile(session.user);
        } else {
            console.log("æœªç™»å…¥ï¼Œé¡¯ç¤ºç™»å…¥è¡¨å–®");
            document.getElementById('auth-section').classList.remove('hidden');
        }
    };

    // é è¦½é ­åƒ
    function previewAvatar() {
        const fileInput = document.getElementById('avatar_file');
        const avatarImg = document.getElementById('avatar-img');
        
        if (fileInput.files && fileInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                avatarImg.src = e.target.result;
            };
            reader.readAsDataURL(fileInput.files[0]);
        }
    }

    // ç²å–é¦™æ¸¯æ™‚é–“
    function getHKTime() {
        const now = new Date();
        const hkOffset = 8 * 60; // é¦™æ¸¯ UTC+8
        const localOffset = now.getTimezoneOffset();
        return new Date(now.getTime() + (hkOffset + localOffset) * 60000);
    }

   // ä¿®æ”¹ showProfile å‡½æ•¸ä»¥æ”¯æ´å¤šé‡è§’è‰²
async function showProfile(user) {
    console.log("é¡¯ç¤ºç”¨æˆ¶è³‡æ–™:", user.email);
    
    // ä¿å­˜ç•¶å‰ç”¨æˆ¶
    currentUser = user;
    
    // åˆ‡æ›é¡¯ç¤ºå€åŸŸ
    document.getElementById('auth-section').classList.add('hidden');
    document.getElementById('profile-section').classList.remove('hidden');
    document.getElementById('user-display').innerText = `å¸³è™Ÿ: ${user.email}`;

    try {
        // æŸ¥è©¢ç”¨æˆ¶è³‡æ–™ï¼ˆåŒ…å«åœ˜éšŠè§’è‰²ï¼‰
        const { data: profile, error } = await sb
            .from('profiles')
            .select(`
                *,
                team_members!inner(role as team_role, team_id)
            `)
            .eq('id', user.id)
            .maybeSingle();

        if (error) {
            console.error("æŸ¥è©¢ç”¨æˆ¶è³‡æ–™éŒ¯èª¤:", error);
            return;
        }

        console.log("æŸ¥è©¢åˆ°çš„ç”¨æˆ¶è³‡æ–™:", profile);

        // æ›´æ–°è¡¨å–®è³‡æ–™
        if (profile) {
            // åŸºæœ¬è³‡æ–™
            document.getElementById('full_name').value = profile.full_name || '';
            document.getElementById('plan').value = profile.plan || 'slow_run';
            
            // åˆ¤æ–·ä¸¦é¡¯ç¤ºè§’è‰²é¸é …
            await setupRoleSelection(profile);
            
            // é ­åƒ
            if (profile.avatar_url) {
                document.getElementById('avatar-img').src = profile.avatar_url;
            } else if (profile.full_name) {
                document.getElementById('avatar-img').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(profile.full_name)}&background=random`;
            }

            // æª¢æŸ¥æ˜¯å¦å·²å®Œæˆè¨­å®š
            const isSetupComplete = profile.full_name && profile.team_id;
            
            // æ§åˆ¶é¡¯ç¤º/éš±è—å’Œé–å®šç‹€æ…‹
            if (isSetupComplete) {
                document.getElementById('setup-card').classList.add('hidden');
                document.getElementById('edit-profile-btn').classList.remove('hidden');
                
                // é–å®šè¼¸å…¥æ¬„ä½
                document.getElementById('full_name').disabled = true;
                document.getElementById('role').disabled = true;
                document.getElementById('plan').disabled = true;
                document.getElementById('team_id_input').disabled = true;
                
                // æ›´æ–°éšŠä¼ç‹€æ…‹é¡¯ç¤º
                document.getElementById('team-status').textContent = 'å·²åŠ å…¥';
                
                // è¨ˆç®—ä¸¦é¡¯ç¤ºç©åˆ†
                await calculateTotalPoints(user.id);
                
                // æª¢æŸ¥ä»Šæ—¥æ˜¯å¦å·²å ±åˆ°
                await checkDailyCheckin(user.id);
                
                // è¼‰å…¥å€‹äººæ•¸æ“šè®ŠåŒ–åœ–è¡¨
                await loadPersonalProgressChart(user.id);
                
                // æ ¹æ“šå¤šé‡è§’è‰²é¡¯ç¤ºå°ˆå±¬æŒ‰éˆ•å’Œåœ˜éšŠæ•¸æ“š
                await showMultiRoleContent(profile);
                
            } else {
                document.getElementById('setup-card').classList.remove('hidden');
                document.getElementById('edit-profile-btn').classList.add('hidden');
                document.getElementById('team-status').textContent = 'æœªåŠ å…¥';
            }
        } else {
            // å¦‚æœæ²’æœ‰å€‹äººè³‡æ–™ï¼Œé¡¯ç¤ºè¨­å®šå¡ç‰‡
            document.getElementById('setup-card').classList.remove('hidden');
            document.getElementById('edit-profile-btn').classList.add('hidden');
            document.getElementById('team-status').textContent = 'æœªè¨­å®š';
        }
    } catch (err) {
        console.error("é¡¯ç¤ºå€‹äººè³‡æ–™éŒ¯èª¤:", err);
    }
}

// è¨­å®šè§’è‰²é¸æ“‡ï¼ˆæ”¯æ´å¤šé‡è§’è‰²ï¼‰
async function setupRoleSelection(profile) {
    const roleSelect = document.getElementById('role');
    
    // æ¸…ç©ºç¾æœ‰é¸é …
    roleSelect.innerHTML = '';
    
    // å–å¾—ç•¶å‰ç”¨æˆ¶çš„æ¬Šé™
    const { data: permissions } = await sb
        .from('role_permissions')
        .select('*')
        .eq('role', profile.primary_role || 'member')
        .single();
    
    const isSuperAdmin = profile.is_super_admin || profile.primary_role === 'super_admin';
    const isAdmin = profile.primary_role === 'admin' || isSuperAdmin;
    
    // åŸºæœ¬è§’è‰²é¸é …ï¼ˆæ‰€æœ‰ç”¨æˆ¶éƒ½å¯ä»¥é¸æ“‡ï¼‰
    const basicOptions = [
        { value: 'member', label: 'å­¸å“¡' },
        { value: 'captain', label: 'éšŠé•·' },
        { value: 'deputy', label: 'å‰¯éšŠé•·' }
    ];
    
    // ç®¡ç†å“¡é¸é …ï¼ˆåªæœ‰ç®¡ç†å“¡å¯ä»¥çœ‹åˆ°ï¼‰
    const adminOptions = isAdmin ? [
        { value: 'admin', label: 'ç®¡ç†å“¡' }
    ] : [];
    
    // è¶…ç´šç®¡ç†å“¡é¸é …ï¼ˆåªæœ‰è¶…ç´šç®¡ç†å“¡å¯ä»¥çœ‹åˆ°ï¼‰
    const superAdminOptions = isSuperAdmin ? [
        { value: 'super_admin', label: 'è¶…ç´šç®¡ç†å“¡' }
    ] : [];
    
    // çµ„åˆæ‰€æœ‰é¸é …
    const allOptions = [...basicOptions, ...adminOptions, ...superAdminOptions];
    
    // æ·»åŠ é¸é …åˆ°é¸æ“‡å™¨
    allOptions.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option.value;
        opt.textContent = option.label;
        
        // å¦‚æœç”¨æˆ¶å·²ç¶“æ˜¯é€™å€‹è§’è‰²ï¼Œè¨­ç‚ºé¸ä¸­
        if (profile.primary_role === option.value || 
            (profile.primary_role === 'super_admin' && option.value === 'admin')) {
            opt.selected = true;
        }
        
        roleSelect.appendChild(opt);
    });
    
    // è¨­å®šåœ˜éšŠ ID è¼¸å…¥æ¡†
    document.getElementById('team_id_input').value = profile.team_id || '';
}

// æ ¹æ“šå¤šé‡è§’è‰²é¡¯ç¤ºå°ˆå±¬å…§å®¹
async function showMultiRoleContent(profile) {
    const roleButtons = document.getElementById('role-buttons');
    const adminBtn = document.getElementById('admin-btn');
    const captainBtn = document.getElementById('captain-btn');
    const deputyBtn = document.getElementById('deputy-btn');
    
    // éš±è—æ‰€æœ‰æŒ‰éˆ•
    adminBtn.classList.add('hidden');
    captainBtn.classList.add('hidden');
    deputyBtn.classList.add('hidden');
    roleButtons.classList.add('hidden');
    
    // ç²å–ç”¨æˆ¶åœ¨åœ˜éšŠä¸­çš„è§’è‰²
    const teamRole = profile.team_members?.[0]?.team_role || 'member';
    const teamId = profile.team_members?.[0]?.team_id || profile.team_id;
    
    const isSuperAdmin = profile.is_super_admin || profile.primary_role === 'super_admin';
    const isAdmin = profile.primary_role === 'admin' || isSuperAdmin;
    const isCaptain = teamRole === 'captain' || profile.primary_role === 'captain';
    const isDeputy = teamRole === 'deputy' || profile.primary_role === 'deputy';
    
    console.log('è§’è‰²åˆ¤æ–·:', { isAdmin, isCaptain, isDeputy, teamRole, primaryRole: profile.primary_role });
    
    // é¡¯ç¤ºç®¡ç†å“¡æŒ‰éˆ•ï¼ˆå¦‚æœç”¨æˆ¶æ˜¯ç®¡ç†å“¡ï¼‰
    if (isAdmin) {
        adminBtn.classList.remove('hidden');
        roleButtons.classList.remove('hidden');
        
        // ç®¡ç†å“¡ä¹Ÿå¯ä»¥æŸ¥çœ‹åœ˜éšŠæ•¸æ“š
        if (teamId) {
            document.getElementById('team-progress-section').classList.remove('hidden');
            await loadTeamProgress(teamId, isCaptain); // isCaptain åƒæ•¸æ±ºå®šæ˜¯å¦é¡¯ç¤ºéšŠé•·çµ±è¨ˆ
        }
    }
    
    // é¡¯ç¤ºéšŠé•·æŒ‰éˆ•ï¼ˆå¦‚æœç”¨æˆ¶åœ¨åœ˜éšŠä¸­æ˜¯éšŠé•·æˆ–æ˜¯ç³»çµ±éšŠé•·ï¼‰
    if (isCaptain) {
        captainBtn.classList.remove('hidden');
        roleButtons.classList.remove('hidden');
        
        // é¡¯ç¤ºåœ˜éšŠæ•¸æ“š
        if (teamId) {
            document.getElementById('team-progress-section').classList.remove('hidden');
            await loadTeamProgress(teamId, true); // true è¡¨ç¤ºæ˜¯éšŠé•·
        }
    }
    
    // é¡¯ç¤ºå‰¯éšŠé•·æŒ‰éˆ•ï¼ˆå¦‚æœç”¨æˆ¶åœ¨åœ˜éšŠä¸­æ˜¯å‰¯éšŠé•·ï¼‰
    if (isDeputy) {
        deputyBtn.classList.remove('hidden');
        roleButtons.classList.remove('hidden');
        
        // é¡¯ç¤ºåœ˜éšŠæ•¸æ“š
        if (teamId) {
            document.getElementById('team-progress-section').classList.remove('hidden');
            await loadTeamProgress(teamId, false); // false è¡¨ç¤ºæ˜¯å‰¯éšŠé•·
        }
    }
    
    // é¡¯ç¤ºå€‹äººæ•¸æ“šåœ–è¡¨
    document.getElementById('personal-progress-section').classList.remove('hidden');
}

    // ä¿®æ”¹ loadTeamProgress å‡½æ•¸ä»¥æ”¯æ´ç®¡ç†å“¡æŸ¥çœ‹
async function loadTeamProgress(teamId, isCaptain) {
    const container = document.getElementById('team-progress-list');
    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #7f8c8d;">è¼‰å…¥åœ˜éšŠæ•¸æ“šä¸­...</div>';
    
    try {
        // ç²å–ç•¶å‰ç”¨æˆ¶è³‡æ–™
        const { data: currentProfile } = await sb
            .from('profiles')
            .select('primary_role, is_super_admin')
            .eq('id', currentUser.id)
            .single();
        
        const isAdmin = currentProfile.primary_role === 'admin' || 
                       currentProfile.primary_role === 'super_admin' || 
                       currentProfile.is_super_admin;
        
        // ç²å–åœ˜éšŠæˆå“¡ï¼ˆå¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œå¯ä»¥çœ‹åˆ°æ‰€æœ‰åœ˜éšŠï¼‰
        let membersQuery = sb
            .from('profiles')
            .select('id, full_name, avatar_url, primary_role, team_members!

// ä¿®æ”¹ updateProfile å‡½æ•¸ä»¥æ”¯æ´å¤šé‡è§’è‰²
async function updateProfile() {
    const { data: { user }, error: authError } = await sb.auth.getUser();
    if (authError || !user) {
        alert("è«‹å…ˆç™»å…¥");
        return;
    }

    const fullName = document.getElementById('full_name').value.trim();
    const selectedRole = document.getElementById('role').value;
    const plan = document.getElementById('plan').value;
    const teamId = document.getElementById('team_id_input').value.trim();
    
    if (!fullName) {
        alert("è«‹è¼¸å…¥çœŸå¯¦å§“å");
        return;
    }

    // è™•ç†é ­åƒä¸Šå‚³
    let avatarUrl = document.getElementById('avatar-img').src;
    const avatarFile = document.getElementById('avatar_file').files[0];
    
    if (avatarFile) {
        const fileName = `${user.id}_${Date.now()}.png`;
        const { error: uploadError } = await sb.storage
            .from('avatars')
            .upload(fileName, avatarFile, { upsert: true });
            
        if (!uploadError) {
            const { data: urlData } = sb.storage
                .from('avatars')
                .getPublicUrl(fileName);
            avatarUrl = urlData.publicUrl;
        }
    }

    try {
        // å…ˆç²å–ç•¶å‰ç”¨æˆ¶è³‡æ–™
        const { data: currentProfile } = await sb
            .from('profiles')
            .select('primary_role, is_super_admin')
            .eq('id', user.id)
            .single();
        
        const currentRole = currentProfile.primary_role;
        const isSuperAdmin = currentProfile.is_super_admin;
        
        // æª¢æŸ¥è§’è‰²ä¿®æ”¹æ¬Šé™
        if (selectedRole !== currentRole) {
            // å¦‚æœä¸æ˜¯è¶…ç´šç®¡ç†å“¡ï¼Œä¸èƒ½ä¿®æ”¹æˆç®¡ç†å“¡è§’è‰²
            if ((selectedRole === 'admin' || selectedRole === 'super_admin') && !isSuperAdmin) {
                alert('åªæœ‰è¶…ç´šç®¡ç†å“¡å¯ä»¥è¨­å®šç®¡ç†å“¡è§’è‰²');
                return;
            }
            
            // å¦‚æœå¾ç®¡ç†å“¡è§’è‰²ä¿®æ”¹ç‚ºéç®¡ç†å“¡è§’è‰²ï¼Œéœ€è¦ç¢ºèª
            if ((currentRole === 'admin' || currentRole === 'super_admin') && 
                (selectedRole !== 'admin' && selectedRole !== 'super_admin')) {
                if (!confirm('æ‚¨å³å°‡å¾ç®¡ç†å“¡è§’è‰²è®Šæ›´ç‚ºä¸€èˆ¬è§’è‰²ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                    return;
                }
            }
        }
        
        // æº–å‚™æ›´æ–°è³‡æ–™
        const updateData = {
            id: user.id,
            full_name: fullName,
            primary_role: selectedRole,
            role: selectedRole, // ä¿æŒå‘å¾Œå…¼å®¹
            plan: plan,
            avatar_url: avatarUrl,
            updated_at: new Date().toISOString()
        };
        
        // è™•ç†åœ˜éšŠç›¸é—œ
        if (teamId) {
            updateData.team_id = teamId;
            
            // æª¢æŸ¥åœ˜éšŠè§’è‰²
            let teamRole = 'member';
            if (selectedRole === 'captain') {
                teamRole = 'captain';
            } else if (selectedRole === 'deputy') {
                teamRole = 'deputy';
            }
            
            // æ›´æ–°æˆ–å‰µå»ºåœ˜éšŠæˆå“¡è¨˜éŒ„
            const { error: teamError } = await sb
                .from('team_members')
                .upsert({
                    team_id: teamId,
                    user_id: user.id,
                    role: teamRole,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'team_id,user_id' });
                
            if (teamError) {
                console.error('æ›´æ–°åœ˜éšŠæˆå“¡éŒ¯èª¤:', teamError);
            }
        } else {
            updateData.team_id = null;
            
            // åˆªé™¤åœ˜éšŠæˆå“¡è¨˜éŒ„ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            await sb
                .from('team_members')
                .delete()
                .eq('user_id', user.id);
        }
        
        // æ›´æ–°æˆ–å‰µå»ºå€‹äººè³‡æ–™
        const { error } = await sb
            .from('profiles')
            .upsert(updateData);

        if (error) {
            console.error("æ›´æ–°è³‡æ–™éŒ¯èª¤:", error);
            alert("å„²å­˜å¤±æ•—ï¼š" + error.message);
        } else {
            alert("âœ… è¨­å®šå·²å„²å­˜ï¼");
            location.reload(); // é‡æ–°è¼‰å…¥ä»¥æ›´æ–°é¡¯ç¤ºç‹€æ…‹
        }
    } catch (error) {
        console.error("æ›´æ–°å€‹äººè³‡æ–™éŒ¯èª¤:", error);
        alert("å„²å­˜å¤±æ•—ï¼š" + error.message);
    }
}

    // å„²å­˜æ¯æ—¥æ•¸æ“š
    async function saveDailyData() {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) {
            alert("è«‹å…ˆç™»å…¥");
            return;
        }

        const weight = parseFloat(document.getElementById('weight').value);
        if (!weight || weight <= 0) {
            alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é«”é‡");
            return;
        }

        const today = getHKTime().toISOString().split('T')[0];
        const fatRate = parseFloat(document.getElementById('fat_rate').value) || 0;
        const muscleMass = parseFloat(document.getElementById('muscle_mass').value) || 0;
        
        // ç²å–ä»»å‹™ç‹€æ…‹
        const hasShake = document.getElementById('task_shake').checked;
        const hasLive = document.getElementById('task_live').checked;
        const hasDiet = document.getElementById('task_diet').checked;
        const hasExercise = document.getElementById('task_exercise').checked;

        try {
            // å„²å­˜é«”é‡è¨˜éŒ„
            const { error: weightError } = await sb
                .from('weight_records')
                .upsert({
                    user_id: user.id,
                    date: today,
                    weight: weight,
                    fat_rate: fatRate,
                    muscle_mass: muscleMass
                }, { onConflict: 'user_id,date' });

            if (weightError) throw weightError;

            // è¨ˆç®—ä»Šæ—¥ç©åˆ†
            let dailyPoints = 0;
            if (weight > 0 && hasDiet && hasShake && hasLive) {
                dailyPoints += 1; // å®Œæˆä¸€åœˆ
            }
            if (hasExercise) dailyPoints += 1;
            if (hasShake) dailyPoints += 1;

            // å„²å­˜æ¯æ—¥åˆ†æ•¸
            const { error: scoreError } = await sb
                .from('daily_scores')
                .upsert({
                    user_id: user.id,
                    date: today,
                    weight_recorded: weight > 0,
                    shake_used: hasShake,
                    exercise_done: hasExercise,
                    task_completed: hasLive,
                    social_shared: false,
                    referral_made: false,
                    total_points: dailyPoints,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'user_id,date' });

            if (scoreError) throw scoreError;

            // æ›´æ–°ç‹€æ…‹è¨Šæ¯
            document.getElementById('status-msg').textContent = "âœ… ä»Šæ—¥æ•¸æ“šå·²æˆåŠŸå ±åˆ°ï¼";
            setTimeout(() => {
                document.getElementById('status-msg').textContent = "";
                location.reload(); // é‡æ–°è¼‰å…¥ä»¥æ›´æ–°åœ–è¡¨å’Œæ•¸æ“š
            }, 2000);

        } catch (error) {
            console.error("å„²å­˜æ•¸æ“šéŒ¯èª¤:", error);
            alert("å„²å­˜å¤±æ•—ï¼š" + error.message);
        }
    }

    // è¨»å†Š
    async function signUp() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        if (!email || !password) {
            alert("è«‹å¡«å¯«ä¿¡ç®±å’Œå¯†ç¢¼");
            return;
        }

        const { data, error } = await sb.auth.signUp({ email, password });
        if (error) {
            alert("è¨»å†Šå¤±æ•—ï¼š" + error.message);
        } else {
            alert("âœ… è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥ä¿¡ç®±é©—è­‰éƒµä»¶å¾Œç™»å…¥ã€‚");
        }
    }

    // ç™»å…¥
// ç™»å…¥ï¼ˆæ”¹é€²ç‰ˆæœ¬ï¼‰
async function signIn() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    
    if (!email || !password) {
        alert("è«‹å¡«å¯«ä¿¡ç®±å’Œå¯†ç¢¼");
        return;
    }
    
    console.log("å˜—è©¦ç™»å…¥:", email);
    
    try {
        const { data, error } = await sb.auth.signInWithPassword({ 
            email: email, 
            password: password 
        });
        
        if (error) {
            console.error("ç™»å…¥éŒ¯èª¤è©³æƒ…:", error);
            
            // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
            if (error.message.includes('Invalid login credentials')) {
                alert("ç™»å…¥å¤±æ•—ï¼šå¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
            } else if (error.message.includes('Email not confirmed')) {
                alert("è«‹å…ˆé©—è­‰æ‚¨çš„é›»å­éƒµä»¶åœ°å€");
            } else {
                alert("ç™»å…¥å¤±æ•—ï¼š" + error.message);
            }
        } else {
            console.log("ç™»å…¥æˆåŠŸï¼Œé‡æ–°è¼‰å…¥é é¢");
            // ç™»å…¥æˆåŠŸï¼Œé‡æ–°è¼‰å…¥é é¢
            location.reload();
        }
    } catch (err) {
        console.error("ç™»å…¥ç•°å¸¸:", err);
        alert("ç™»å…¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤");
    }
}

    // ç™»å‡º
    async function signOut() {
        await sb.auth.signOut();
        location.reload();
    }
        // æ¸¬è©¦ Supabase é€£æ¥
async function testConnection() {
    try {
        const { data, error } = await sb.auth.getSession();
        if (error) {
            console.warn("Supabase é€£æ¥è­¦å‘Š:", error);
        } else {
            console.log("Supabase é€£æ¥æ­£å¸¸");
        }
    } catch (err) {
        console.error("Supabase é€£æ¥æ¸¬è©¦å¤±æ•—:", err);
    }
}

        
// åœ¨ window.onload ä¸­èª¿ç”¨
window.onload = async () => {
    await testConnection(); // å…ˆæ¸¬è©¦é€£æ¥
    
    const { data: { session }, error } = await sb.auth.getSession();
    if (error) {
        console.error("æª¢æŸ¥ç™»å…¥ç‹€æ…‹éŒ¯èª¤:", error);
        document.getElementById('auth-section').classList.remove('hidden');
        return;
    }
    
    if (session) {
        console.log("å·²ç™»å…¥ï¼Œç”¨æˆ¶:", session.user.email);
        await showProfile(session.user);
    } else {
        console.log("æœªç™»å…¥ï¼Œé¡¯ç¤ºç™»å…¥è¡¨å–®");
        document.getElementById('auth-section').classList.remove('hidden');
    }
};
</script>
</body>
</html>
