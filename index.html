<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ† 10å¤©é¦¬æ‹‰æ¾ï¼šå°éšŠæˆ°å ±æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #3498db; --success: #2ecc71; --warning: #f39c12; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); width: 100%; max-width: 450px; }
        .card { border: 1px solid #edf2f7; border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .ticket-stats { display: flex; justify-content: space-around; background: linear-gradient(135deg, #6e8efb, #a777e3); color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; text-align: center; }
        .ticket-stats b { font-size: 18px; display: block; }
        .hidden { display: none !important; }
        .team-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 15px 0; }
        .member-item { aspect-ratio: 1; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f1f5f9; border: 1px solid #e2e8f0; font-size: 11px; }
        .member-item.done { background: #dcfce7; border-color: #22c55e; color: #166534; font-weight: bold; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { width: 100%; padding: 14px; border-radius: 10px; cursor: pointer; border: none; font-weight: bold; color: white; margin-top: 5px; }
        .lock-overlay { background: #fff5f5; color: #c53030; padding: 15px; border-radius: 10px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-section">
        <h2 style="text-align:center;">ğŸ”‘ ç©å®¶ç™»å…¥</h2>
        <div class="card"><form onsubmit="return false;">
            <input type="email" id="email" placeholder="é›»å­ä¿¡ç®±">
            <input type="password" id="password" placeholder="å¯†ç¢¼">
            <button type="button" style="background:var(--primary)" onclick="signIn()">ç«‹å³ç™»å…¥</button>
        </form></div>
    </div>

    <div id="profile-section" class="hidden">
        <div class="ticket-stats">
            <div><span>é¦¬æ‹‰æ¾ç©åˆ†</span><b id="ticket-count">0</b></div>
            <div><span>ç”¢å“ä»£ç”¨åˆ¸</span><b id="voucher-display">$0</b></div>
        </div>

        <div class="card">
            <div style="font-weight:bold;">ğŸ å°éšŠä»Šæ—¥æˆ°å ±</div>
            <div class="team-grid" id="team-grid-container"></div>
        </div>

        <div id="lock-notice" class="lock-overlay hidden">
            âš ï¸ æ‚¨ç›®å‰çš„ç”¢å“é»æ•¸ä¸è¶³ 60 åˆ†<br>è«‹è¯ç¹«æ•™ç·´é–‹å•Ÿå ±åˆ°è³‡æ ¼
        </div>

        <div id="checkin-box" class="card" style="border-left: 5px solid var(--warning);">
            <div style="font-weight:bold; margin-bottom:10px;">âš–ï¸ ä»Šæ—¥é«”çµ„æˆå ±åˆ°</div>
            <input type="number" id="weight" step="0.1" placeholder="é«”é‡ (kg)">
            <input type="number" id="fat_rate" step="0.1" placeholder="è„‚è‚ªç‡ (%)">
            <input type="number" id="muscle_mass" step="0.1" placeholder="è‚Œè‚‰é‡ (kg)">
            <button type="button" style="background:var(--warning)" onclick="saveDailyData()">ç¢ºèªé€å‡º</button>
        </div>

        <div class="card" style="background: #f0fdf4; border-color: #bbf7d0;">
            <b style="color: #166534;">ğŸ åˆ†äº«å¥½å‹çå‹µï¼š</b>
            <p style="font-size: 13px; margin: 5px 0;">æ¯æˆåŠŸä»‹ç´¹ä¸€ä½å¥½å‹åƒåŠ ï¼Œå³å¯ç²å¾— <b style="color:var(--danger);">$100 ç”¢å“ä»£ç”¨åˆ¸</b>ï¼</p>
            <div style="font-size: 12px; color: #666;">ç›®å‰å·²ç²è´ˆï¼š<span id="voucher-count" style="font-weight:bold; color:#166534;">0</span> å¼µ</div>
        </div>

        <button type="button" style="background:var(--danger); opacity:0.6; font-size: 11px;" onclick="signOut()">ç™»å‡º</button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://sdloakutxcsbshcqpxwn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbG9ha3V0eGNzYnNoY3FweHduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMTE4MjYsImV4cCI6MjA4MTY4NzgyNn0.5OBQQAinARnZQ6VSCrPl60NWmcSG-QiFMmVIJRW7g-0';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    window.onload = async () => {
        const { data: { session } } = await sb.auth.getSession();
        if (session) {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('profile-section').classList.remove('hidden');
            loadDashboard(session.user);
        }
    };

    async function loadDashboard(user) {
        const { data: profile } = await sb.from('profiles').select('*').eq('id', user.id).single();
        if (!profile) return;

        // 1. æª¢æŸ¥ç”¢å“åˆ†æ•¸é–€æª» (60åˆ†)
        const hasMinPoints = (profile.product_points || 0) >= 60;
        if (!hasMinPoints) {
            document.getElementById('checkin-box').classList.add('hidden');
            document.getElementById('lock-notice').classList.remove('hidden');
        }

        // 2. æ›´æ–°ä»£ç”¨åˆ¸èˆ‡ç©åˆ†é¡¯ç¤º
        const v_count = profile.referral_count || 0; // ä»‹ç´¹å¹¾äººå°±æœ‰å¹¾å¼µ
        document.getElementById('voucher-count').innerText = v_count;
        document.getElementById('voucher-display').innerText = `$${v_count * 100}`;
        
        // 3. è¼‰å…¥ä¹å®®æ ¼
        loadTeamGrid(profile.team_id);
        calculateTotalPoints(user.id);
    }

    async function loadTeamGrid(teamId) {
        const gridContainer = document.getElementById('team-grid-container');
        gridContainer.innerHTML = '';
        const today = new Date().toISOString().split('T')[0];

        const { data: members } = await sb.from('profiles').select('id, username').eq('team_id', teamId).limit(9);
        const { data: records } = await sb.from('weight_records').select('user_id').eq('date', today);
        const recordSet = new Set(records?.map(r => r.user_id));

        for (let i = 0; i < 9; i++) {
            const member = members?.[i];
            const isDone = member && recordSet.has(member.id);
            const div = document.createElement('div');
            div.className = `member-item ${isDone ? 'done' : ''}`;
            div.innerHTML = `<b>${member ? (member.username || 'ç©å®¶') : 'å¾…åŠ å…¥'}</b><span style="font-size:9px;">${isDone ? 'å·²å®Œæˆ' : 'æœªå ±åˆ°'}</span>`;
            gridContainer.appendChild(div);
        }
    }

    async function saveDailyData() {
        const { data: { user } } = await sb.auth.getUser();
        const weight = document.getElementById('weight').value;
        const fat = document.getElementById('fat_rate').value;
        const muscle = document.getElementById('muscle_mass').value;

        if (!weight || !fat || !muscle) return alert("è«‹å¡«å¯«å®Œæ•´æ•¸æ“šï¼");

        const { error } = await sb.from('weight_records').upsert({
            user_id: user.id, date: new Date().toISOString().split('T')[0],
            weight: parseFloat(weight), fat_rate: parseFloat(fat), muscle_mass: parseFloat(muscle)
        });

        if (error) alert(error.message); else { alert("âœ… å ±åˆ°æˆåŠŸï¼"); location.reload(); }
    }

    async function calculateTotalPoints(userId) {
        const { data: profile } = await sb.from('profiles').select('*').eq('id', userId).single();
        const { data: records } = await sb.from('weight_records').select('*').eq('user_id', userId);
        let pts = (profile.referral_count || 0) * 15 + (profile.seminar_status ? 2 : 0);
        if (records) records.forEach(r => { if(r.weight && r.fat_rate && r.muscle_mass) pts += 1; });
        document.getElementById('ticket-count').innerText = pts;
    }

    async function signIn() {
        const { error } = await sb.auth.signInWithPassword({
            email: document.getElementById('email').value,
            password: document.getElementById('password').value
        });
        if (error) alert(error.message); else location.reload();
    }

    async function signOut() { await sb.auth.signOut(); location.reload(); }
</script>
</body>
</html>
