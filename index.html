<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ† 10å¤©å¥åº·é¦¬æ‹‰æ¾ï¼šç©å®¶ä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #3498db; --success: #2ecc71; --warning: #f39c12; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); width: 100%; max-width: 450px; }
        .card { border: 1px solid #edf2f7; border-radius: 15px; padding: 15px; margin-bottom: 15px; position: relative; }
        .ticket-stats { display: flex; justify-content: space-around; background: linear-gradient(135deg, #6e8efb, #a777e3); color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; text-align: center; }
        .ticket-stats b { font-size: 20px; display: block; }
        .hidden { display: none !important; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { width: 100%; padding: 14px; border-radius: 10px; cursor: pointer; border: none; font-weight: bold; color: white; margin-top: 5px; transition: 0.3s; }
        button:active { transform: scale(0.98); }
        .mission-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 10px 0; background: #fff9e6; padding: 10px; border-radius: 10px; }
        label { font-size: 14px; display: flex; align-items: center; gap: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-section">
        <h2 style="text-align:center;">ğŸ® é€²å…¥é¦¬æ‹‰æ¾éŠæˆ²</h2>
        <div class="card">
            <form onsubmit="return false;">
                <input type="email" id="email" placeholder="é›»å­ä¿¡ç®±" autocomplete="email">
                <input type="password" id="password" placeholder="å¯†ç¢¼" autocomplete="current-password">
                <button type="button" style="background:var(--primary)" onclick="signUp()">å¿«é€Ÿè¨»å†Š</button>
                <button type="button" style="background:var(--success)" onclick="signIn()">ç«‹å³ç™»å…¥</button>
            </form>
        </div>
    </div>

    <div id="profile-section" class="hidden">
        <div class="ticket-stats">
            <div><span>ç´¯ç©ç©åˆ† ğŸŸï¸</span><b id="ticket-count">0</b></div>
            <div><span>é¦¬æ‹‰æ¾é€²åº¦</span><b id="day-progress">Day 0</b></div>
        </div>

        <div class="card">
            <div style="font-weight:bold; margin-bottom:8px;">ğŸ’ æˆ‘çš„çºŒè·‘å¥—é¤</div>
            <select id="renewal_select" onchange="updateRenewal()">
                <option value="0">å°šæœªé¸æ“‡å¥—é¤</option>
                <option value="100">çºŒè³¼ 100 åˆ†ç”¢å“å¥—é¤ (1åˆ†)</option>
                <option value="150">çºŒè³¼ 150 åˆ†ç”¢å“å¥—é¤ (2åˆ†)</option>
                <option value="250">çºŒè³¼ 250 åˆ†ç”¢å“å¥—é¤ (4åˆ†)</option>
            </select>
        </div>

        <div class="card" style="border-left: 5px solid var(--warning);">
            <div style="font-weight:bold;">âš–ï¸ æ¯æ—¥æ•¸æ“šå ±åˆ°</div>
            <p style="font-size: 12px; color: #666; margin: 5px 0;">å®Œæˆã€Œä¸€åœˆã€ä»»å‹™åŠ  1 ç©åˆ†ï¼</p>
            <input type="number" id="weight" step="0.1" placeholder="ä»Šæ—¥é«”é‡ (kg)">
            
            <div class="mission-grid">
                <label><input type="checkbox" id="check_diet"> ğŸ“¸ é£²é£Ÿæ‰“å¡</label>
                <label><input type="checkbox" id="check_shake"> ğŸ¥› æ‹å¥¶æ˜”</label>
                <label><input type="checkbox" id="check_live"> ğŸ¥ å·²ç›´æ’­</label>
                <label><input type="checkbox" id="check_mission"> ğŸ¯ ä»Šæ—¥æŒ‘æˆ°</label>
            </div>
            <button type="button" style="background:var(--warning)" onclick="saveDailyData()">é€å‡ºå ±åˆ°</button>
        </div>

        <div class="card" style="font-size: 13px; background: #f0f7ff;">
            <b>ğŸš€ å¿«é€Ÿæ‹¿åˆ†ç§˜è¨£ï¼š</b><br>
            â€¢ ä»‹ç´¹ 1 ä½å¥½å‹åƒåŠ ï¼š<b>+15 åˆ†</b><br>
            â€¢ é¦–æ¬¡åƒåŠ ç ”è¨æœƒï¼š<b>+2 åˆ†</b>
        </div>

        <button type="button" style="background:var(--danger); opacity:0.7; font-size: 12px; padding: 8px;" onclick="signOut()">ç™»å‡ºç©å®¶å¸³è™Ÿ</button>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://sdloakutxcsbshcqpxwn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbG9ha3V0eGNzYnNoY3FweHduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMTE4MjYsImV4cCI6MjA4MTY4NzgyNn0.5OBQQAinARnZQ6VSCrPl60NWmcSG-QiFMmVIJRW7g-0';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- æ ¸å¿ƒè¼‰å…¥é‚è¼¯ ---
    window.onload = async () => {
        const { data: { session } } = await sb.auth.getSession();
        if (session) {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('profile-section').classList.remove('hidden');
            loadFullProfile(session.user);
        }
    };

    async function loadFullProfile(user) {
        const { data: profile } = await sb.from('profiles').select('*').eq('id', user.id).single();
        if (profile) {
            // è¨ˆç®—å¤©æ•¸ (ä»¥è¨»å†Šæ—¥æœŸç‚º Day 1)
            const dayNum = Math.ceil(Math.abs(new Date() - new Date(profile.created_at)) / (1000 * 60 * 60 * 24));
            document.getElementById('day-progress').innerText = `Day ${dayNum}`;
            
            // åŒæ­¥ä¸‹æ‹‰é¸å–®ç‹€æ…‹
            if(profile.renewal_type) document.getElementById('renewal_select').value = profile.renewal_type;
            
            calculateTotalPoints(user.id);
        }
    }

    // --- ç©åˆ†è¨ˆç®—é‚è¼¯ (æ ¹æ“šæ‚¨çš„ç©åˆ†æ•´ç†è¡¨) ---
    async function calculateTotalPoints(userId) {
        const { data: profile } = await sb.from('profiles').select('*').eq('id', userId).single();
        const { data: records } = await sb.from('weight_records').select('*').eq('user_id', userId);

        let points = 0;

        // 1. çºŒè·‘å¥—é¤ç©åˆ†
        if (profile.renewal_type === '100') points += 1;
        else if (profile.renewal_type === '150') points += 2;
        else if (profile.renewal_type === '250') points += 4;

        // 2. ä»‹ç´¹å¥½å‹ç©åˆ† (15åˆ†/äºº)
        points += (profile.referral_count || 0) * 15;

        // 3. ç ”è¨æœƒç©åˆ† (é¦–æ¬¡åƒåŠ 2åˆ† + é‚€è«‹2åˆ†)
        if (profile.seminar_status) points += 2;
        points += (profile.seminar_invite_count || 0) * 2;

        // 4. æ¯æ—¥ã€Œå®Œæˆä¸€åœˆã€ (ç£…ç£… + é£²é£Ÿ + å¥¶æ˜” + ç›´æ’­ = 1åˆ†)
        if (records) {
            records.forEach(rec => {
                if (rec.weight && rec.has_diet && rec.has_shake && rec.has_live) {
                    points += 1;
                }
            });
        }
        document.getElementById('ticket-count').innerText = points;
    }

    // --- è³‡æ–™å„²å­˜å‹•ä½œ ---
    async function saveDailyData() {
        const { data: { user } } = await sb.auth.getUser();
        const weight = document.getElementById('weight').value;
        if (!weight) return alert("è«‹è¼¸å…¥ä»Šæ—¥é«”é‡ï¼");

        const { error } = await sb.from('weight_records').upsert({
            user_id: user.id,
            date: new Date().toISOString().split('T')[0],
            weight: parseFloat(weight),
            has_diet: document.getElementById('check_diet').checked,
            has_shake: document.getElementById('check_shake').checked,
            has_live: document.getElementById('check_live').checked
        });

        if (error) alert("å„²å­˜å¤±æ•—: " + error.message);
        else {
            alert("âœ… ä»Šæ—¥å ±åˆ°æˆåŠŸï¼");
            calculateTotalPoints(user.id);
        }
    }

    async function updateRenewal() {
        const { data: { user } } = await sb.auth.getUser();
        const val = document.getElementById('renewal_select').value;
        await sb.from('profiles').update({ renewal_type: val }).eq('id', user.id);
        calculateTotalPoints(user.id);
        alert("å¥—é¤ç©åˆ†å·²æ›´æ–°ï¼");
    }

    // --- å¸³æˆ¶åŠŸèƒ½ ---
    async function signIn() {
        const { error } = await sb.auth.signInWithPassword({
            email: document.getElementById('email').value,
            password: document.getElementById('password').value
        });
        if (error) alert(error.message); else location.reload();
    }

    async function signUp() {
        const { error } = await sb.auth.signUp({
            email: document.getElementById('email').value,
            password: document.getElementById('password').value
        });
        if (error) alert(error.message); else alert("è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥ï¼");
    }

    async function signOut() {
        await sb.auth.signOut();
        location.reload();
    }
</script>
</body>
</html>
