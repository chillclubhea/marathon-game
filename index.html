<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦¬æ‹‰æ¾ç©å®¶ä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #3498db; --success: #2ecc71; --warning: #f39c12; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; display: flex; justify-content: center; padding: 20px; }
        .container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); width: 100%; max-width: 450px; }
        .header { text-align: center; margin-bottom: 25px; }
        h2 { color: #2c3e50; margin: 0; font-size: 24px; }
        #user-display { font-size: 12px; color: #95a5a6; margin-top: 5px; }
        .card { background: #fff; border: 1px solid #edf2f7; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .card-title { font-weight: bold; color: #2d3748; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: bold; color: #4a5568; font-size: 14px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-size: 16px; }
        input:disabled, select:disabled { background-color: #f8fafc; color: #94a3b8; cursor: not-allowed; }
        .row { display: flex; gap: 10px; }
        .row .form-group { flex: 1; }
        button { width: 100%; padding: 14px; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; }
        .btn-primary { background-color: var(--primary); }
        .btn-success { background-color: var(--success); }
        .btn-warning { background-color: var(--warning); }
        .btn-danger { background-color: var(--danger); }
        .btn-admin { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-captain { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; }
        .btn-deputy { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .hidden { display: none !important; }
        .avatar-preview { width: 80px; height: 80px; border-radius: 50%; background: #eee; margin: 0 auto 15px; display: block; object-fit: cover; border: 3px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .ticket-stats { display: flex; justify-content: space-between; margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 10px; }
        .ticket-stats div { text-align: center; }
        .ticket-stats span { display: block; font-size: 12px; color: #64748b; margin-bottom: 5px; }
        .ticket-stats b { display: block; font-size: 24px; color: #0ea5e9; }
        .mission-item { background: #f1f5f9; padding: 10px; margin-bottom: 8px; border-radius: 8px; font-size: 14px; }
        .mission-item.active { background: #dbeafe; border-left: 4px solid #3b82f6; }
        
        /* æ–°å¢ï¼šæ•¸æ“šè®ŠåŒ–æ¨£å¼ */
        .progress-card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; border-left: 5px solid var(--success); }
        .progress-title { font-weight: bold; color: #2d3748; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
        .progress-list { max-height: 300px; overflow-y: auto; }
        .progress-item { padding: 10px; border-bottom: 1px solid #f0f0f0; }
        .progress-item:last-child { border-bottom: none; }
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .progress-name { font-weight: bold; color: #2d3748; font-size: 14px; }
        .progress-date { font-size: 12px; color: #94a3b8; }
        .progress-details { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 8px; }
        .progress-detail { text-align: center; }
        .progress-label { font-size: 11px; color: #64748b; }
        .progress-value { font-size: 14px; font-weight: bold; }
        .progress-change { font-size: 12px; }
        .change-positive { color: var(--success); }
        .change-negative { color: var(--danger); }
        
        /* åœ–è¡¨å®¹å™¨ */
        .chart-container { height: 200px; margin-top: 15px; }
        
        /* è§’è‰²æŒ‰éˆ•å®¹å™¨ */
        .role-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
        .role-buttons button { margin: 0; }
    </style>
</head>
<body>

<div class="container">
    <!-- æˆªæ­¢æ™‚é–“é€šçŸ¥ -->
    <div id="deadline-notice" style="background:#fff3cd; color:#856404; padding:8px; border-radius:8px; font-size:13px; margin-bottom:10px; text-align:center;">
        âš ï¸ ä»Šæ—¥å ±åˆ°æˆªæ­¢ï¼šé¦™æ¸¯æ™‚é–“ 23:59
    </div>

    <!-- ç™»å…¥å€å¡Š -->
    <div id="auth-section">
        <div class="header">
            <h2>ğŸ”‘ ç™»å…¥é¦¬æ‹‰æ¾</h2>
            <div id="login-msg" style="font-size:14px; color:#666; margin-top:5px;">è«‹ç™»å…¥ä»¥ç¹¼çºŒ</div>
        </div>
        <form onsubmit="signIn(); return false;" class="card" style="margin-top: 20px;">
            <div class="form-group">
                <label>é›»å­ä¿¡ç®±</label>
                <input type="email" id="email" placeholder="Email" required>
            </div>
            <div class="form-group">
                <label>å¯†ç¢¼</label>
                <input type="password" id="password" placeholder="Password" required>
            </div>
            <button type="button" class="btn-primary" onclick="signUp()">è¨»å†Š</button>
            <button type="submit" class="btn-success">ç™»å…¥</button>
        </form>
    </div>

    <!-- å€‹äººè³‡æ–™å€å¡Š -->
    <div id="profile-section" class="hidden">
        <div class="header">
            <h2>ğŸƒ ç©å®¶ä¸­å¿ƒ</h2>
            <div id="user-display"></div>
        </div>

        <!-- ç©åˆ†çµ±è¨ˆ -->
        <div class="ticket-stats">
            <div><span>ç´¯ç©ç©åˆ† ğŸŸï¸</span><b id="ticket-count">0</b></div>
            <div><span>é¦¬æ‹‰æ¾é€²åº¦</span><b id="day-progress">Day 0</b></div>
            <div><span>éšŠä¼ç‹€æ…‹</span><b id="team-status">æœªåŠ å…¥</b></div>
        </div>

        <!-- è§’è‰²å°ˆå±¬æŒ‰éˆ• -->
        <div id="role-buttons" class="role-buttons hidden">
            <!-- ç®¡ç†å“¡æŒ‰éˆ• -->
            <button id="admin-btn" class="hidden btn-admin" onclick="window.location.href='admin.html'">
                ğŸ‘‘ ç®¡ç†å“¡å¾Œå°
            </button>
            <!-- éšŠé•·æŒ‰éˆ• -->
            <button id="captain-btn" class="hidden btn-captain" onclick="window.location.href='captain.html'">
                ğŸ† éšŠé•·å¾Œå°
            </button>
            <!-- å‰¯éšŠé•·æŒ‰éˆ• -->
            <button id="deputy-btn" class="hidden btn-deputy" onclick="window.location.href='deputy.html'">
                â­ å‰¯éšŠé•·å¾Œå°
            </button>
        </div>

        <!-- ç·¨è¼¯æŒ‰éˆ• -->
        <button id="edit-profile-btn" class="hidden" onclick="toggleProfileEdit()" 
                style="background: #edf2f7; color: #4a5568; font-size: 14px; margin-bottom: 15px; padding: 8px; border:none; border-radius:8px; width:100%;">
            âš™ï¸ ä¿®æ”¹å€‹äººè³‡æ–™æˆ–æ›´æ›éšŠä¼
        </button>

        <!-- å€‹äººè¨­å®šå¡ç‰‡ -->
        <div id="setup-card" class="card">
            <div class="card-title">ğŸ‘¤ å€‹äººè¨­å®š & åŠ å…¥éšŠä¼</div>
            <img id="avatar-img" class="avatar-preview" src="https://ui-avatars.com/api/?name=User&background=random">
            <div class="form-group">
                <label>æ›´æ›é ­åƒ</label>
                <input type="file" id="avatar_file" accept="image/*" onchange="previewAvatar()">
            </div>
            <div class="form-group">
                <label>çœŸå¯¦å§“å</label>
                <input type="text" id="full_name" placeholder="éšŠå‹å¦‚ä½•ç¨±å‘¼ä½ ">
            </div>
            <div class="row">
                <div class="form-group">
                    <label>è§’è‰²</label>
                    <select id="role">
                        <option value="member">å­¸å“¡</option>
                        <option value="captain">éšŠé•·</option>
                        <option value="deputy">å‰¯éšŠé•·</option>
                        <option value="admin">ç®¡ç†å“¡</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è¨ˆç•«</label>
                    <select id="plan">
                        <option value="slow_run">æ…¢è·‘</option>
                        <option value="fast_run">å¿«è·‘</option>
                        <option value="vip">VIP</option>
                    </select>
                </div>
            </div>
            <div class="form-group" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                <label>åŠ å…¥éšŠä¼é‚€è«‹ç¢¼ (Team ID)</label>
                <input type="text" id="team_id_input" placeholder="è²¼ä¸ŠéšŠé•·çµ¦çš„ ID">
                <small style="color:#666; display:block; margin-top:5px;">è‹¥ç„¡éšŠä¼ä»£ç¢¼ï¼Œè«‹è¯çµ¡éšŠé•·</small>
            </div>
            <button class="btn-primary" onclick="updateProfile()">å„²å­˜ä¸¦é–‹å§‹éŠæˆ²</button>
        </div>

        <!-- å€‹äººæ•¸æ“šè®ŠåŒ–åœ–è¡¨ -->
        <div id="personal-progress-section" class="progress-card hidden">
            <div class="progress-title">ğŸ“ˆ æˆ‘çš„æ•¸æ“šè®ŠåŒ–è¶¨å‹¢</div>
            <div class="chart-container">
                <canvas id="personal-progress-chart"></canvas>
            </div>
        </div>

        <!-- åœ˜éšŠæ•¸æ“šè®ŠåŒ–ï¼ˆéšŠé•·å’Œå‰¯éšŠé•·å¯è¦‹ï¼‰ -->
        <div id="team-progress-section" class="progress-card hidden">
            <div class="progress-title">ğŸ‘¥ åœ˜éšŠæ•¸æ“šè®ŠåŒ–</div>
            <div class="progress-list" id="team-progress-list">
                <div style="text-align: center; padding: 20px; color: #7f8c8d;">
                    è¼‰å…¥åœ˜éšŠæ•¸æ“šä¸­...
                </div>
            </div>
        </div>

        <!-- æ¯æ—¥æ•¸æ“šå ±åˆ°å¡ç‰‡ -->
        <div class="card" style="border-left: 5px solid var(--warning);">
            <div class="card-title">âš–ï¸ æ¯æ—¥æ•¸æ“šå ±åˆ°</div>
            <div class="form-group">
                <label>ä»Šæ—¥é«”é‡ (kg)</label>
                <input type="number" id="weight" step="0.1" placeholder="0.0">
            </div>
            <div class="row">
                <div class="form-group">
                    <label>é«”è„‚ç‡ (%)</label>
                    <input type="number" id="fat_rate" step="0.1" placeholder="0.0">
                </div>
                <div class="form-group">
                    <label>è‚Œè‚‰é‡ (kg)</label>
                    <input type="number" id="muscle_mass" step="0.1" placeholder="0.0">
                </div>
            </div>
            
            <!-- ä»»å‹™å®Œæˆç‹€æ…‹ -->
            <div class="form-group" style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px;">
                <label>ä»Šæ—¥ä»»å‹™å®Œæˆç‹€æ…‹</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                    <label style="font-size: 13px; display: flex; align-items: center;">
                        <input type="checkbox" id="task_shake" style="margin-right: 8px;"> ä½¿ç”¨Shake
                    </label>
                    <label style="font-size: 13px; display: flex; align-items: center;">
                        <input type="checkbox" id="task_live" style="margin-right: 8px;"> å®Œæˆç›´æ’­
                    </label>
                    <label style="font-size: 13px; display: flex; align-items: center;">
                        <input type="checkbox" id="task_diet" style="margin-right: 8px;"> æ‰“å¡é£²é£Ÿ
                    </label>
                    <label style="font-size: 13px; display: flex; align-items: center;">
                        <input type="checkbox" id="task_exercise" style="margin-right: 8px;"> å®Œæˆé‹å‹•
                    </label>
                </div>
            </div>
            
            <button class="btn-warning" onclick="saveDailyData()">é€å‡ºä»Šæ—¥å ±åˆ°</button>
            <p id="status-msg" style="text-align: center; color: var(--success); font-size: 14px; font-weight: bold; margin-top: 10px; min-height: 20px;"></p>
        </div>

        <!-- åŠŸèƒ½æŒ‰éˆ• -->
        <div class="card" style="text-align: center;">
            <button class="btn-success" onclick="window.open('team.html', '_blank')" style="margin-bottom: 10px;">
                ğŸ† æŸ¥çœ‹ä¹å®®æ ¼æˆ°æ³
            </button>
            <button class="btn-primary" onclick="window.open('leaderboard.html', '_blank')" style="margin-bottom: 10px;">
                ğŸ“Š æŸ¥çœ‹æ’è¡Œæ¦œ
            </button>
            <button class="btn-primary" onclick="window.open('tasks.html', '_blank')">
                âœ… æŸ¥çœ‹ä»»å‹™å€
            </button>
        </div>

        <!-- ç™»å‡ºæŒ‰éˆ• -->
        <button class="btn-danger" style="margin-top:20px;" onclick="signOut()">å®‰å…¨ç™»å‡º</button>
    </div>
</div>

<script>
    // Supabase åˆå§‹åŒ–
    const SUPABASE_URL = 'https://sdloakutxcsbshcqpxwn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbG9ha3V0eGNzYnNoY3FweHduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMTE4MjYsImV4cCI6MjA4MTY4NzgyNn0.5OBQQAinARnZQ6VSCrPl60NWmcSG-QiFMmVIJRW7g-0';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // å…¨å±€è®Šæ•¸
    let currentUser = null;
    let personalChart = null;

    // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    window.onload = async () => {
        console.log("é é¢è¼‰å…¥ï¼Œæª¢æŸ¥ç™»å…¥ç‹€æ…‹...");
        
        const { data: { session }, error } = await sb.auth.getSession();
        
        if (error) {
            console.error("æª¢æŸ¥ç™»å…¥ç‹€æ…‹éŒ¯èª¤:", error);
            document.getElementById('auth-section').classList.remove('hidden');
            return;
        }
        
        if (session) {
            console.log("å·²ç™»å…¥ï¼Œç”¨æˆ¶:", session.user.email);
            await showProfile(session.user);
        } else {
            console.log("æœªç™»å…¥ï¼Œé¡¯ç¤ºç™»å…¥è¡¨å–®");
            document.getElementById('auth-section').classList.remove('hidden');
        }
    };

    // é è¦½é ­åƒ
    function previewAvatar() {
        const fileInput = document.getElementById('avatar_file');
        const avatarImg = document.getElementById('avatar-img');
        
        if (fileInput.files && fileInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                avatarImg.src = e.target.result;
            };
            reader.readAsDataURL(fileInput.files[0]);
        }
    }

    // ç²å–é¦™æ¸¯æ™‚é–“
    function getHKTime() {
        const now = new Date();
        const hkOffset = 8 * 60; // é¦™æ¸¯ UTC+8
        const localOffset = now.getTimezoneOffset();
        return new Date(now.getTime() + (hkOffset + localOffset) * 60000);
    }

    // é¡¯ç¤ºç”¨æˆ¶è³‡æ–™
    async function showProfile(user) {
        console.log("é¡¯ç¤ºç”¨æˆ¶è³‡æ–™:", user.email);
        
        // ä¿å­˜ç•¶å‰ç”¨æˆ¶
        currentUser = user;
        
        // åˆ‡æ›é¡¯ç¤ºå€åŸŸ
        document.getElementById('auth-section').classList.add('hidden');
        document.getElementById('profile-section').classList.remove('hidden');
        document.getElementById('user-display').innerText = `å¸³è™Ÿ: ${user.email}`;

        try {
            // æŸ¥è©¢ç”¨æˆ¶è³‡æ–™ - ä½¿ç”¨æ›´å»£æ³›çš„æŸ¥è©¢ï¼Œç²å–æ‰€æœ‰æ¬„ä½
            const { data: profile, error } = await sb
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .maybeSingle();

            if (error) {
                console.error("æŸ¥è©¢ç”¨æˆ¶è³‡æ–™éŒ¯èª¤:", error);
                return;
            }

            console.log("æŸ¥è©¢åˆ°çš„ç”¨æˆ¶è³‡æ–™å®Œæ•´å°è±¡:", profile);

            if (profile) {
                // é¡¯ç¤ºæ‰€æœ‰æ¬„ä½åç¨±ï¼Œå¹«åŠ©èª¿è©¦
                console.log("Profile æ‰€æœ‰æ¬„ä½:", Object.keys(profile));
                
                // æª¢æŸ¥å„ç¨®å¯èƒ½çš„ Team ID æ¬„ä½
                const possibleTeamIdFields = [
                    'current_team_id', // å„ªå…ˆæª¢æŸ¥é€™å€‹æ¬„ä½
                    'team_id',
                    'team',
                    'teamId',
                    'current_team',
                    'team_uuid'
                ];
                
                let teamId = '';
                for (const field of possibleTeamIdFields) {
                    if (profile[field]) {
                        console.log(`æ‰¾åˆ° Team ID æ¬„ä½ "${field}":`, profile[field]);
                        teamId = profile[field];
                        break;
                    }
                }
                
                // å¦‚æœæ²’æœ‰æ‰¾åˆ°ï¼Œå˜—è©¦å°‹æ‰¾åŒ…å« team æˆ– uuid çš„æ¬„ä½
                if (!teamId) {
                    for (const key in profile) {
                        if (key.toLowerCase().includes('team') && profile[key]) {
                            console.log(`åœ¨æ¬„ä½ "${key}" ä¸­æ‰¾åˆ° Team ID:`, profile[key]);
                            teamId = profile[key];
                            break;
                        }
                    }
                }
                
                // æª¢æŸ¥ profile ä¸­çš„å…¶ä»–æ¬„ä½
                const fullName = profile.full_name || profile.name || profile.display_name || '';
                const plan = profile.plan || 'slow_run';
                const role = profile.role || 'member';
                const avatarUrl = profile.avatar_url || '';
                
                console.log("è§£æå‡ºçš„è³‡æ–™:", { fullName, plan, role, teamId });
                
                // æ›´æ–°è¡¨å–®è³‡æ–™
                document.getElementById('full_name').value = fullName;
                document.getElementById('plan').value = plan;
                document.getElementById('team_id_input').value = teamId;
                
                // è¨­å®šè§’è‰²é¸æ“‡
                const roleSelect = document.getElementById('role');
                if (roleSelect) {
                    for (let i = 0; i < roleSelect.options.length; i++) {
                        if (roleSelect.options[i].value === role) {
                            roleSelect.selectedIndex = i;
                            break;
                        }
                    }
                }
                
                // é ­åƒ
                if (avatarUrl) {
                    document.getElementById('avatar-img').src = avatarUrl;
                } else if (fullName) {
                    document.getElementById('avatar-img').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(fullName)}&background=random`;
                }

                // æª¢æŸ¥æ˜¯å¦å·²å®Œæˆè¨­å®š
                const isSetupComplete = fullName && teamId;
                
                // æ§åˆ¶é¡¯ç¤º/éš±è—å’Œé–å®šç‹€æ…‹
                if (isSetupComplete) {
                    document.getElementById('setup-card').classList.add('hidden');
                    document.getElementById('edit-profile-btn').classList.remove('hidden');
                    
                    // é–å®šè¼¸å…¥æ¬„ä½
                    document.getElementById('full_name').disabled = true;
                    document.getElementById('role').disabled = true;
                    document.getElementById('plan').disabled = true;
                    document.getElementById('team_id_input').disabled = true;
                    
                    // æ›´æ–°éšŠä¼ç‹€æ…‹é¡¯ç¤º
                    document.getElementById('team-status').textContent = teamId ? 'å·²åŠ å…¥' : 'æœªåŠ å…¥';
                    
                    // è¨ˆç®—ä¸¦é¡¯ç¤ºç©åˆ†
                    await calculateTotalPoints(user.id);
                    
                    // æª¢æŸ¥ä»Šæ—¥æ˜¯å¦å·²å ±åˆ°
                    await checkDailyCheckin(user.id);
                    
                    // è¼‰å…¥å€‹äººæ•¸æ“šè®ŠåŒ–åœ–è¡¨
                    await loadPersonalProgressChart(user.id);
                    
                    // é¡¯ç¤ºå°ˆå±¬æŒ‰éˆ•
                    await showRoleSpecificContent(profile);
                    
                } else {
                    document.getElementById('setup-card').classList.remove('hidden');
                    document.getElementById('edit-profile-btn').classList.add('hidden');
                    document.getElementById('team-status').textContent = teamId ? 'å·²åŠ å…¥ä½†è³‡æ–™ä¸å®Œæ•´' : 'æœªåŠ å…¥';
                }
            } else {
                // å¦‚æœæ²’æœ‰å€‹äººè³‡æ–™ï¼Œé¡¯ç¤ºè¨­å®šå¡ç‰‡
                console.log("æ²’æœ‰æ‰¾åˆ°å€‹äººè³‡æ–™è¨˜éŒ„ï¼Œé¡¯ç¤ºè¨­å®šå¡ç‰‡");
                document.getElementById('setup-card').classList.remove('hidden');
                document.getElementById('edit-profile-btn').classList.add('hidden');
                document.getElementById('team-status').textContent = 'æœªè¨­å®š';
            }
        } catch (err) {
            console.error("é¡¯ç¤ºå€‹äººè³‡æ–™éŒ¯èª¤:", err);
        }
    }

    // é¡¯ç¤ºè§’è‰²å°ˆå±¬å…§å®¹
    async function showRoleSpecificContent(profile) {
        const roleButtons = document.getElementById('role-buttons');
        const adminBtn = document.getElementById('admin-btn');
        const captainBtn = document.getElementById('captain-btn');
        const deputyBtn = document.getElementById('deputy-btn');
        
        // éš±è—æ‰€æœ‰æŒ‰éˆ•
        adminBtn.classList.add('hidden');
        captainBtn.classList.add('hidden');
        deputyBtn.classList.add('hidden');
        roleButtons.classList.add('hidden');
        
        // ç²å–ç”¨æˆ¶è§’è‰²
        const userRole = profile.role || 'member';
        
        // ç²å– Team IDï¼ˆä½¿ç”¨èˆ‡ showProfile ç›¸åŒçš„é‚è¼¯ï¼‰
        const possibleTeamIdFields = [
            'current_team_id',
            'team_id',
            'team',
            'teamId',
            'current_team',
            'team_uuid'
        ];
        
        let teamId = '';
        for (const field of possibleTeamIdFields) {
            if (profile[field]) {
                teamId = profile[field];
                break;
            }
        }
        
        if (!teamId) {
            for (const key in profile) {
                if (key.toLowerCase().includes('team') && profile[key]) {
                    teamId = profile[key];
                    break;
                }
            }
        }
        
        console.log('è§’è‰²åˆ¤æ–·:', { userRole, teamId });
        
        // æ ¹æ“šè§’è‰²é¡¯ç¤ºç›¸æ‡‰æŒ‰éˆ•
        if (userRole === 'admin' || userRole === 'super_admin') {
            adminBtn.classList.remove('hidden');
            roleButtons.classList.remove('hidden');
            
            // ç®¡ç†å“¡å¯ä»¥æŸ¥çœ‹åœ˜éšŠæ•¸æ“š
            if (teamId) {
                document.getElementById('team-progress-section').classList.remove('hidden');
                await loadTeamProgress(teamId, true);
            }
        }
        
        if (userRole === 'captain') {
            captainBtn.classList.remove('hidden');
            roleButtons.classList.remove('hidden');
            
            // é¡¯ç¤ºåœ˜éšŠæ•¸æ“š
            if (teamId) {
                document.getElementById('team-progress-section').classList.remove('hidden');
                await loadTeamProgress(teamId, true);
            }
        }
        
        if (userRole === 'deputy') {
            deputyBtn.classList.remove('hidden');
            roleButtons.classList.remove('hidden');
            
            // é¡¯ç¤ºåœ˜éšŠæ•¸æ“š
            if (teamId) {
                document.getElementById('team-progress-section').classList.remove('hidden');
                await loadTeamProgress(teamId, false);
            }
        }
        
        // é¡¯ç¤ºå€‹äººæ•¸æ“šåœ–è¡¨
        document.getElementById('personal-progress-section').classList.remove('hidden');
    }

    // è¼‰å…¥åœ˜éšŠé€²åº¦ - ä¿®æ­£ç‰ˆæœ¬ï¼Œé¿å…æ¬„ä½ä¸å­˜åœ¨éŒ¯èª¤
    async function loadTeamProgress(teamId, isCaptain) {
        const container = document.getElementById('team-progress-list');
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #7f8c8d;">è¼‰å…¥åœ˜éšŠæ•¸æ“šä¸­...</div>';
        
        try {
            // é¦–å…ˆæª¢æŸ¥ profiles è¡¨çš„çµæ§‹
            console.log("é–‹å§‹æŸ¥è©¢åœ˜éšŠæˆå“¡ï¼ŒTeam ID:", teamId);
            
            // å˜—è©¦ä¸åŒçš„æŸ¥è©¢æ–¹å¼
            let members = [];
            
            try {
                // å…ˆå˜—è©¦ä½¿ç”¨ current_team_id æ¬„ä½
                console.log("å˜—è©¦ä½¿ç”¨ current_team_id æ¬„ä½æŸ¥è©¢...");
                const result1 = await sb
                    .from('profiles')
                    .select('id, full_name, avatar_url, role')
                    .eq('current_team_id', teamId);
                
                if (result1.data && result1.data.length > 0) {
                    members = result1.data;
                    console.log("ä½¿ç”¨ current_team_id æ‰¾åˆ°æˆå“¡:", members.length);
                }
            } catch (err) {
                console.log("current_team_id æŸ¥è©¢å¤±æ•—:", err.message);
            }
            
            // å¦‚æœæ²’æœ‰æ‰¾åˆ°ï¼Œå˜—è©¦å…¶ä»–æ¬„ä½
            if (members.length === 0) {
                try {
                    console.log("å˜—è©¦ä½¿ç”¨ team_id æ¬„ä½æŸ¥è©¢...");
                    const result2 = await sb
                        .from('profiles')
                        .select('id, full_name, avatar_url, role')
                        .eq('team_id', teamId);
                    
                    if (result2.data && result2.data.length > 0) {
                        members = result2.data;
                        console.log("ä½¿ç”¨ team_id æ‰¾åˆ°æˆå“¡:", members.length);
                    }
                } catch (err) {
                    console.log("team_id æŸ¥è©¢å¤±æ•—:", err.message);
                }
            }
            
            // å¦‚æœé‚„æ˜¯æ²’æœ‰æ‰¾åˆ°ï¼Œå˜—è©¦ç›´æ¥å¾è³‡æ–™åº«ç²å–æ‰€æœ‰ç”¨æˆ¶ï¼Œç„¶å¾Œåœ¨å®¢æˆ¶ç«¯éæ¿¾
            if (members.length === 0) {
                console.log("å˜—è©¦ç²å–æ‰€æœ‰ç”¨æˆ¶è³‡æ–™é€²è¡Œå®¢æˆ¶ç«¯éæ¿¾...");
                try {
                    const allProfiles = await sb
                        .from('profiles')
                        .select('id, full_name, avatar_url, role, current_team_id, team_id');
                    
                    if (allProfiles.data) {
                        // åœ¨å®¢æˆ¶ç«¯éæ¿¾ Team ID
                        members = allProfiles.data.filter(profile => {
                            // æª¢æŸ¥å¤šå€‹å¯èƒ½çš„ Team ID æ¬„ä½
                            return profile.current_team_id === teamId || 
                                   profile.team_id === teamId ||
                                   (profile.team && profile.team === teamId) ||
                                   (profile.teamId && profile.teamId === teamId);
                        });
                        console.log("å®¢æˆ¶ç«¯éæ¿¾æ‰¾åˆ°æˆå“¡:", members.length);
                    }
                } catch (err) {
                    console.log("ç²å–æ‰€æœ‰ç”¨æˆ¶è³‡æ–™å¤±æ•—:", err.message);
                }
            }
            
            if (!members || members.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #7f8c8d;">æš«ç„¡åœ˜éšŠæˆå“¡æ•¸æ“š<br><small>æˆ–åœ˜éšŠIDç„¡æ•ˆ</small></div>';
                return;
            }
            
            // é¡¯ç¤ºåœ˜éšŠæˆå“¡æ•¸æ“š
            let html = '';
            for (const member of members) {
                try {
                    // ç²å–æ¯å€‹æˆå“¡çš„ä»Šæ—¥æ•¸æ“š
                    const today = getHKTime().toISOString().split('T')[0];
                    const { data: weightData } = await sb
                        .from('weight_records')
                        .select('weight, fat_rate, muscle_mass')
                        .eq('user_id', member.id)
                        .eq('date', today)
                        .maybeSingle();
                    
                    const { data: scoreData } = await sb
                        .from('daily_scores')
                        .select('total_points')
                        .eq('user_id', member.id)
                        .eq('date', today)
                        .maybeSingle();
                    
                    const avatarUrl = member.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(member.full_name || 'User')}&background=random`;
                    
                    html += `
                        <div class="progress-item">
                            <div class="progress-header">
                                <div class="progress-name">
                                    <img src="${avatarUrl}" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; vertical-align: middle;">
                                    ${member.full_name || 'æœªè¨­å®š'}
                                </div>
                                <div class="progress-date">${member.role || 'å­¸å“¡'}</div>
                            </div>
                            <div class="progress-details">
                                <div class="progress-detail">
                                    <div class="progress-label">ä»Šæ—¥ç©åˆ†</div>
                                    <div class="progress-value">${scoreData?.total_points || 0}</div>
                                </div>
                                <div class="progress-detail">
                                    <div class="progress-label">ä»Šæ—¥é«”é‡</div>
                                    <div class="progress-value">${weightData?.weight ? weightData.weight.toFixed(1) + 'kg' : 'æœªè¨˜éŒ„'}</div>
                                </div>
                                <div class="progress-detail">
                                    <div class="progress-label">ä»Šæ—¥é«”è„‚</div>
                                    <div class="progress-value">${weightData?.fat_rate ? weightData.fat_rate.toFixed(1) + '%' : 'æœªè¨˜éŒ„'}</div>
                                </div>
                            </div>
                        </div>

                        <!-- åœ¨é é¢åº•éƒ¨æ·»åŠ  -->
<div class="quick-links">
    <h4>å¿«é€Ÿè¨ªå•</h4>
    <div class="link-grid">
        <a href="/">ğŸ  é¦–é </a>
        <a href="chart.html">ğŸ“ˆ æ•¸æ“šåœ–è¡¨</a>
        <a href="viewport.html">âš™ï¸ æ•¸æ“šèª¿è©¦</a>
        <a href="/profile">ğŸ‘¤ å€‹äººè³‡æ–™</a>
    </div>
</div>

<!-- æ¨£å¼ -->
<style>
    .quick-links {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-top: 30px;
    }
    
    .link-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
        margin-top: 15px;
    }
    
    .link-grid a {
        display: block;
        padding: 12px;
        background: white;
        border-radius: 8px;
        text-decoration: none;
        color: #4361ee;
        text-align: center;
        border: 1px solid #e9ecef;
        transition: all 0.3s;
    }
    
    .link-grid a:hover {
        background: #4361ee;
        color: white;
        border-color: #4361ee;
    }
</style>
                    `;
                } catch (err) {
                    console.error(`è™•ç†æˆå“¡ ${member.id} æ•¸æ“šæ™‚å‡ºéŒ¯:`, err);
                }
            }
            
            container.innerHTML = html;
            
        } catch (err) {
            console.error("è¼‰å…¥åœ˜éšŠé€²åº¦éŒ¯èª¤:", err);
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">è¼‰å…¥éŒ¯èª¤<br><small>è«‹æª¢æŸ¥æ§åˆ¶å°æŸ¥çœ‹è©³ç´°ä¿¡æ¯</small></div>';
        }
    }

    // åˆ‡æ›å€‹äººè³‡æ–™ç·¨è¼¯
    function toggleProfileEdit() {
        const setupCard = document.getElementById('setup-card');
        const isHidden = setupCard.classList.contains('hidden');
        
        if (isHidden) {
            setupCard.classList.remove('hidden');
            document.getElementById('edit-profile-btn').textContent = 'å–æ¶ˆç·¨è¼¯';
            
            // å•Ÿç”¨è¼¸å…¥æ¬„ä½
            document.getElementById('full_name').disabled = false;
            document.getElementById('role').disabled = false;
            document.getElementById('plan').disabled = false;
            document.getElementById('team_id_input').disabled = false;
        } else {
            setupCard.classList.add('hidden');
            document.getElementById('edit-profile-btn').textContent = 'âš™ï¸ ä¿®æ”¹å€‹äººè³‡æ–™æˆ–æ›´æ›éšŠä¼';
            
            // ç¦ç”¨è¼¸å…¥æ¬„ä½
            document.getElementById('full_name').disabled = true;
            document.getElementById('role').disabled = true;
            document.getElementById('plan').disabled = true;
            document.getElementById('team_id_input').disabled = true;
        }
    }

    // æª¢æŸ¥ä»Šæ—¥æ˜¯å¦å·²å ±åˆ° - ä¿®æ­£ç‰ˆæœ¬ï¼Œç¢ºä¿èƒ½è®€å– weight_records è¡¨
    async function checkDailyCheckin(userId) {
        const today = getHKTime().toISOString().split('T')[0];
        
        console.log(`æª¢æŸ¥ç”¨æˆ¶ ${userId} åœ¨ ${today} çš„å ±åˆ°è¨˜éŒ„`);
        
        try {
            const { data, error } = await sb
                .from('weight_records')
                .select('weight, fat_rate, muscle_mass')
                .eq('user_id', userId)
                .eq('date', today)
                .maybeSingle();
            
            if (error) {
                console.error("æŸ¥è©¢ä»Šæ—¥å ±åˆ°éŒ¯èª¤:", error);
                // æª¢æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
                console.log("å˜—è©¦æª¢æŸ¥ weight_records è¡¨çµæ§‹...");
                return;
            }
            
            console.log("æŸ¥è©¢åˆ°çš„é«”é‡è¨˜éŒ„:", data);
            
            if (data) {
                document.getElementById('weight').value = data.weight || '';
                document.getElementById('fat_rate').value = data.fat_rate || '';
                document.getElementById('muscle_mass').value = data.muscle_mass || '';
                
                // æª¢æŸ¥ä»»å‹™ç‹€æ…‹
                const { data: taskData } = await sb
                    .from('daily_scores')
                    .select('shake_used, exercise_done, task_completed')
                    .eq('user_id', userId)
                    .eq('date', today)
                    .maybeSingle();
                
                if (taskData) {
                    document.getElementById('task_shake').checked = taskData.shake_used || false;
                    document.getElementById('task_live').checked = taskData.task_completed || false;
                    document.getElementById('task_exercise').checked = taskData.exercise_done || false;
                }
                
                // æé†’ç”¨æˆ¶ä»Šæ—¥å·²å ±åˆ°
                if (data.weight) {
                    document.getElementById('status-msg').textContent = "âœ… ä»Šæ—¥å·²å ±åˆ°ï¼Œå¯æ›´æ–°æ•¸æ“š";
                }
            }
            
        } catch (error) {
            console.error("æª¢æŸ¥å ±åˆ°ç‹€æ…‹éŒ¯èª¤:", error);
        }
    }

    // è¼‰å…¥å€‹äººæ•¸æ“šè®ŠåŒ–åœ–è¡¨
    async function loadPersonalProgressChart(userId) {
        try {
            // ç²å–æœ€è¿‘7å¤©çš„æ•¸æ“š
            const sevenDaysAgo = new Date(getHKTime());
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const startDate = sevenDaysAgo.toISOString().split('T')[0];
            
            console.log(`è¼‰å…¥ç”¨æˆ¶ ${userId} å¾ ${startDate} èµ·çš„é«”é‡è¨˜éŒ„`);
            
            const { data, error } = await sb
                .from('weight_records')
                .select('date, weight, fat_rate, muscle_mass')
                .eq('user_id', userId)
                .gte('date', startDate)
                .order('date', { ascending: true });
            
            if (error) {
                console.error("è¼‰å…¥åœ–è¡¨æ•¸æ“šéŒ¯èª¤:", error);
                throw error;
            }
            
            console.log("è¼‰å…¥çš„é«”é‡è¨˜éŒ„æ•¸æ“š:", data);
            
            const dates = [];
            const weights = [];
            const fatRates = [];
            
            if (data && data.length > 0) {
                data.forEach(record => {
                    dates.push(record.date.substring(5)); // é¡¯ç¤º MM-DD æ ¼å¼
                    weights.push(record.weight || 0);
                    fatRates.push(record.fat_rate || 0);
                });
            }
            
            // å¦‚æœå·²æœ‰åœ–è¡¨å¯¦ä¾‹ï¼Œå…ˆéŠ·æ¯€
            if (personalChart) {
                personalChart.destroy();
            }
            
            // å‰µå»ºåœ–è¡¨
            const ctx = document.getElementById('personal-progress-chart').getContext('2d');
            personalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'é«”é‡ (kg)',
                            data: weights,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'é«”è„‚ç‡ (%)',
                            data: fatRates,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.3,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'é«”é‡ (kg)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'é«”è„‚ç‡ (%)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
            
        } catch (error) {
            console.error("è¼‰å…¥å€‹äººåœ–è¡¨éŒ¯èª¤:", error);
            document.getElementById('personal-progress-chart').parentElement.innerHTML = 
                '<div style="text-align: center; padding: 40px; color: #7f8c8d;">ç„¡æ³•è¼‰å…¥åœ–è¡¨æ•¸æ“š<br><small>å¯èƒ½å°šæœªæœ‰é«”é‡è¨˜éŒ„</small></div>';
        }
    }

    // è¨ˆç®—ç¸½ç©åˆ†
    async function calculateTotalPoints(userId) {
        try {
            const { data, error } = await sb
                .from('daily_scores')
                .select('total_points')
                .eq('user_id', userId);
            
            if (error) {
                console.error("è¨ˆç®—ç©åˆ†éŒ¯èª¤:", error);
                return;
            }
            
            let totalPoints = 0;
            if (data) {
                data.forEach(record => {
                    totalPoints += record.total_points || 0;
                });
            }
            
            document.getElementById('ticket-count').textContent = totalPoints;
            
            // è¨ˆç®—é€²åº¦å¤©æ•¸
            const dayProgress = data ? data.length : 0;
            document.getElementById('day-progress').textContent = `Day ${dayProgress}`;
            
        } catch (error) {
            console.error("è¨ˆç®—ç©åˆ†éŒ¯èª¤:", error);
        }
    }

    // æ›´æ–°å€‹äººè³‡æ–™ - æ”¯æ´å¤šç¨® Team ID æ¬„ä½åç¨±
    async function updateProfile() {
        const { data: { user }, error: authError } = await sb.auth.getUser();
        if (authError || !user) {
            alert("è«‹å…ˆç™»å…¥");
            return;
        }

        const fullName = document.getElementById('full_name').value.trim();
        const selectedRole = document.getElementById('role').value;
        const plan = document.getElementById('plan').value;
        const teamId = document.getElementById('team_id_input').value.trim();
        
        if (!fullName) {
            alert("è«‹è¼¸å…¥çœŸå¯¦å§“å");
            return;
        }

        // è™•ç†é ­åƒä¸Šå‚³
        let avatarUrl = document.getElementById('avatar-img').src;
        const avatarFile = document.getElementById('avatar_file').files[0];
        
        if (avatarFile) {
            const fileName = `${user.id}_${Date.now()}.png`;
            const { error: uploadError } = await sb.storage
                .from('avatars')
                .upload(fileName, avatarFile, { upsert: true });
                
            if (!uploadError) {
                const { data: urlData } = sb.storage
                    .from('avatars')
                    .getPublicUrl(fileName);
                avatarUrl = urlData.publicUrl;
            }
        }

        try {
            // å…ˆæŸ¥è©¢ç¾æœ‰çš„ profile ä¾†ç¢ºå®šè³‡æ–™åº«çµæ§‹
            const { data: existingProfile } = await sb
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .maybeSingle();
            
            // æº–å‚™æ›´æ–°è³‡æ–™
            const updateData = {
                id: user.id,
                full_name: fullName,
                role: selectedRole,
                plan: plan,
                avatar_url: avatarUrl,
                updated_at: new Date().toISOString()
            };
            
            // æ ¹æ“šç¾æœ‰çš„ profile çµæ§‹æ±ºå®šå¦‚ä½•å„²å­˜ Team ID
            if (existingProfile) {
                // æª¢æŸ¥ç¾æœ‰çš„ profile æœ‰å“ªäº› Team ID ç›¸é—œæ¬„ä½
                const possibleTeamFields = [
                    'current_team_id', // å„ªå…ˆä½¿ç”¨é€™å€‹æ¬„ä½
                    'team_id',
                    'team',
                    'teamId',
                    'current_team',
                    'team_uuid'
                ];
                
                // æ‰¾å‡ºç¾æœ‰ profile ä¸­å·²æœ‰çš„ Team ID æ¬„ä½
                let existingTeamField = null;
                for (const field of possibleTeamFields) {
                    if (field in existingProfile) {
                        existingTeamField = field;
                        console.log(`æ‰¾åˆ°ç¾æœ‰çš„ Team ID æ¬„ä½: ${existingTeamField}`);
                        break;
                    }
                }
                
                // å¦‚æœæœ‰ç¾æœ‰çš„æ¬„ä½ï¼Œä½¿ç”¨å®ƒ
                if (existingTeamField) {
                    if (teamId) {
                        updateData[existingTeamField] = teamId;
                    } else {
                        updateData[existingTeamField] = null;
                    }
                } else {
                    // å¦‚æœæ²’æœ‰ç¾æœ‰çš„æ¬„ä½ï¼Œå˜—è©¦ä½¿ç”¨æœ€å¸¸è¦‹çš„æ¬„ä½åç¨±
                    updateData.current_team_id = teamId || null;
                }
            } else {
                // å¦‚æœæ²’æœ‰ç¾æœ‰è¨˜éŒ„ï¼Œä½¿ç”¨é è¨­çš„æ¬„ä½åç¨±
                updateData.current_team_id = teamId || null;
            }
            
            console.log("æº–å‚™æ›´æ–°çš„è³‡æ–™:", updateData);
            
            // æ›´æ–°æˆ–å‰µå»ºå€‹äººè³‡æ–™
            const { error } = await sb
                .from('profiles')
                .upsert(updateData);

            if (error) {
                console.error("æ›´æ–°è³‡æ–™éŒ¯èª¤:", error);
                alert("å„²å­˜å¤±æ•—ï¼š" + error.message);
            } else {
                alert("âœ… è¨­å®šå·²å„²å­˜ï¼");
                location.reload(); // é‡æ–°è¼‰å…¥ä»¥æ›´æ–°é¡¯ç¤ºç‹€æ…‹
            }
        } catch (error) {
            console.error("æ›´æ–°å€‹äººè³‡æ–™éŒ¯èª¤:", error);
            alert("å„²å­˜å¤±æ•—ï¼š" + error.message);
        }
    }

    // å„²å­˜æ¯æ—¥æ•¸æ“š - ä¿®æ­£ç‰ˆæœ¬ï¼Œç¢ºä¿èƒ½æ­£ç¢ºå„²å­˜åˆ° weight_records è¡¨
    async function saveDailyData() {
        const { data: { user } } = await sb.auth.getUser();
        if (!user) {
            alert("è«‹å…ˆç™»å…¥");
            return;
        }

        const weight = parseFloat(document.getElementById('weight').value);
        if (!weight || weight <= 0) {
            alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„é«”é‡");
            return;
        }

        const today = getHKTime().toISOString().split('T')[0];
        const fatRate = parseFloat(document.getElementById('fat_rate').value) || 0;
        const muscleMass = parseFloat(document.getElementById('muscle_mass').value) || 0;
        
        // ç²å–ä»»å‹™ç‹€æ…‹
        const hasShake = document.getElementById('task_shake').checked;
        const hasLive = document.getElementById('task_live').checked;
        const hasDiet = document.getElementById('task_diet').checked;
        const hasExercise = document.getElementById('task_exercise').checked;

        console.log("æº–å‚™å„²å­˜æ¯æ—¥æ•¸æ“š:", {
            user_id: user.id,
            date: today,
            weight,
            fatRate,
            muscleMass,
            tasks: { hasShake, hasLive, hasDiet, hasExercise }
        });

        try {
            // é¦–å…ˆæª¢æŸ¥ weight_records è¡¨æ˜¯å¦å­˜åœ¨ä¸¦æœ‰æ­£ç¢ºçš„æ¬„ä½
            console.log("å˜—è©¦å„²å­˜é«”é‡è¨˜éŒ„åˆ° weight_records è¡¨...");
            
            // æº–å‚™é«”é‡è¨˜éŒ„æ•¸æ“š
            const weightRecordData = {
                user_id: user.id,
                date: today,
                weight: weight,
                fat_rate: fatRate,
                muscle_mass: muscleMass,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            console.log("é«”é‡è¨˜éŒ„æ•¸æ“š:", weightRecordData);
            
            // å„²å­˜é«”é‡è¨˜éŒ„ - ä½¿ç”¨ upsertï¼Œå¦‚æœå·²å­˜åœ¨å‰‡æ›´æ–°
            const { data: weightResult, error: weightError } = await sb
                .from('weight_records')
                .upsert(weightRecordData, { 
                    onConflict: 'user_id,date',
                    ignoreDuplicates: false 
                });

            if (weightError) {
                console.error("å„²å­˜é«”é‡è¨˜éŒ„éŒ¯èª¤è©³ç´°ä¿¡æ¯:", weightError);
                
                // å˜—è©¦ä¸åŒçš„éŒ¯èª¤è™•ç†
                if (weightError.code === '42P01') {
                    alert("éŒ¯èª¤ï¼šweight_records è¡¨ä¸å­˜åœ¨ï¼Œè«‹åœ¨ Supabase ä¸­å‰µå»ºè©²è¡¨");
                } else if (weightError.code === '42703') {
                    alert("éŒ¯èª¤ï¼šweight_records è¡¨çš„æ¬„ä½åç¨±ä¸åŒ¹é…ï¼Œè«‹æª¢æŸ¥è¡¨çµæ§‹");
                } else {
                    throw weightError;
                }
                return;
            }
            
            console.log("é«”é‡è¨˜éŒ„å„²å­˜æˆåŠŸ:", weightResult);

            // è¨ˆç®—ä»Šæ—¥ç©åˆ†
            let dailyPoints = 0;
            if (weight > 0 && hasDiet && hasShake && hasLive) {
                dailyPoints += 1; // å®Œæˆä¸€åœˆ
            }
            if (hasExercise) dailyPoints += 1;
            if (hasShake) dailyPoints += 1;

            console.log("è¨ˆç®—å‡ºçš„ä»Šæ—¥ç©åˆ†:", dailyPoints);

            // æº–å‚™æ¯æ—¥åˆ†æ•¸æ•¸æ“š
            const dailyScoreData = {
                user_id: user.id,
                date: today,
                weight_recorded: weight > 0,
                shake_used: hasShake,
                exercise_done: hasExercise,
                task_completed: hasLive,
                social_shared: false,
                referral_made: false,
                total_points: dailyPoints,
                updated_at: new Date().toISOString()
            };
            
            console.log("æ¯æ—¥åˆ†æ•¸æ•¸æ“š:", dailyScoreData);
            
            // å„²å­˜æ¯æ—¥åˆ†æ•¸
            const { data: scoreResult, error: scoreError } = await sb
                .from('daily_scores')
                .upsert(dailyScoreData, { 
                    onConflict: 'user_id,date',
                    ignoreDuplicates: false 
                });

            if (scoreError) {
                console.error("å„²å­˜æ¯æ—¥åˆ†æ•¸éŒ¯èª¤:", scoreError);
                
                // å˜—è©¦å‰µå»ºè¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                if (scoreError.code === '42P01') {
                    console.log("daily_scores è¡¨ä¸å­˜åœ¨ï¼Œè·³éåˆ†æ•¸å„²å­˜");
                } else {
                    throw scoreError;
                }
            } else {
                console.log("æ¯æ—¥åˆ†æ•¸å„²å­˜æˆåŠŸ:", scoreResult);
            }

            // æ›´æ–°ç‹€æ…‹è¨Šæ¯
            document.getElementById('status-msg').textContent = "âœ… ä»Šæ—¥æ•¸æ“šå·²æˆåŠŸå ±åˆ°ï¼";
            setTimeout(() => {
                document.getElementById('status-msg').textContent = "";
                location.reload(); // é‡æ–°è¼‰å…¥ä»¥æ›´æ–°åœ–è¡¨å’Œæ•¸æ“š
            }, 2000);

        } catch (error) {
            console.error("å„²å­˜æ•¸æ“šéŒ¯èª¤:", error);
            
            // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤ä¿¡æ¯
            let errorMsg = "å„²å­˜å¤±æ•—ï¼š" + error.message;
            
            if (error.message.includes('weight_records')) {
                errorMsg += "\n\nè«‹åœ¨ Supabase ä¸­æª¢æŸ¥ï¼š\n1. weight_records è¡¨æ˜¯å¦å­˜åœ¨\n2. è¡¨çµæ§‹æ˜¯å¦åŒ…å«ï¼šuser_id, date, weight, fat_rate, muscle_mass æ¬„ä½";
            } else if (error.message.includes('daily_scores')) {
                errorMsg += "\n\nè«‹åœ¨ Supabase ä¸­æª¢æŸ¥ daily_scores è¡¨";
            }
            
            alert(errorMsg);
        }
    }

    // è¨»å†Š
    async function signUp() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        
        if (!email || !password) {
            alert("è«‹å¡«å¯«ä¿¡ç®±å’Œå¯†ç¢¼");
            return;
        }

        const { data, error } = await sb.auth.signUp({ email, password });
        if (error) {
            alert("è¨»å†Šå¤±æ•—ï¼š" + error.message);
        } else {
            alert("âœ… è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥ä¿¡ç®±é©—è­‰éƒµä»¶å¾Œç™»å…¥ã€‚");
        }
    }

    // ç™»å…¥
    async function signIn() {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        
        if (!email || !password) {
            alert("è«‹å¡«å¯«ä¿¡ç®±å’Œå¯†ç¢¼");
            return;
        }
        
        console.log("å˜—è©¦ç™»å…¥:", email);
        
        try {
            const { data, error } = await sb.auth.signInWithPassword({ 
                email: email, 
                password: password 
            });
            
            if (error) {
                console.error("ç™»å…¥éŒ¯èª¤è©³æƒ…:", error);
                
                // æä¾›æ›´è©³ç´°çš„éŒ¯èª¤è¨Šæ¯
                if (error.message.includes('Invalid login credentials')) {
                    alert("ç™»å…¥å¤±æ•—ï¼šå¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
                } else if (error.message.includes('Email not confirmed')) {
                    alert("è«‹å…ˆé©—è­‰æ‚¨çš„é›»å­éƒµä»¶åœ°å€");
                } else {
                    alert("ç™»å…¥å¤±æ•—ï¼š" + error.message);
                }
            } else {
                console.log("ç™»å…¥æˆåŠŸï¼Œé‡æ–°è¼‰å…¥é é¢");
                // ç™»å…¥æˆåŠŸï¼Œé‡æ–°è¼‰å…¥é é¢
                location.reload();
            }
        } catch (err) {
            console.error("ç™»å…¥ç•°å¸¸:", err);
            alert("ç™»å…¥éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤");
        }
    }

    // ç™»å‡º
    async function signOut() {
        await sb.auth.signOut();
        location.reload();
    }
</script>
</body>
</html>
