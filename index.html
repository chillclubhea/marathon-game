<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ† 10å¤©å¥åº·é¦¬æ‹‰æ¾ï¼šç©å®¶ä¸­å¿ƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #3498db; --success: #2ecc71; --warning: #f39c12; --danger: #e74c3c; --bg: #f4f7f6; --gold: #ffd700;
        }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg); margin: 0; display: flex; justify-content: center; padding: 20px; }
        .container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); width: 100%; max-width: 450px; }
        h2 { color: #2c3e50; margin: 0; font-size: 24px; text-align: center; }
        
        /* æŠ½çåˆ¸çœ‹æ¿ */
        .ticket-stats { display: flex; justify-content: space-around; background: linear-gradient(135deg, #6e8efb, #a777e3); color: white; padding: 15px; border-radius: 15px; margin: 15px 0; text-align: center; }
        .ticket-stats div b { font-size: 20px; display: block; }

        .card { background: #fff; border: 1px solid #edf2f7; border-radius: 15px; padding: 20px; margin-bottom: 20px; position: relative; }
        .card-title { font-weight: bold; color: #2d3748; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }

        /* å°éšŠä¹å®®æ ¼ */
        .team-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin: 10px 0; }
        .member-item { aspect-ratio: 1; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #f1f5f9; border: 1px solid #e2e8f0; font-size: 11px; }
        .member-item.done { background: #dcfce7; border-color: #22c55e; color: #166534; font-weight: bold; }

        /* è¼¸å…¥èˆ‡æŒ‰éˆ• */
        input, select { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; }
        button { width: 100%; padding: 14px; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; }
        
        .referral-box { background: #fff9e6; border: 2px dashed #f1c40f; padding: 15px; border-radius: 10px; text-align: center; margin-top: 10px; }
        .referral-box b { color: #e67e22; }

        /* é–€æª»é–å®š */
        .lock-notice { background: #fff5f5; color: #c53030; padding: 15px; border-radius: 10px; text-align: center; font-weight: bold; margin-bottom: 20px; border: 1px solid #feb2b2; }

        /* æ”»ç•¥æ‰‹å†Šå½ˆçª— */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(5px); }
        .rules-card { background: white; width: 90%; max-width: 420px; max-height: 85vh; border-radius: 20px; overflow-y: auto; }
        .rules-header { background: var(--primary); color: white; padding: 20px; position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; }
        .rules-content { padding: 20px; line-height: 1.6; }
        
        .mission-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; }
        .mission-item.locked { color: #bdc3c7; background: #f9f9f9; }
        .mission-item.active { background: #fff9e6; border-left: 5px solid #f1c40f; font-weight: bold; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-section">
        <h2>ğŸ”‘ ç™»å…¥é¦¬æ‹‰æ¾</h2>
        <div class="card" style="margin-top: 20px;">
            <input type="email" id="email" placeholder="é›»å­ä¿¡ç®±">
            <input type="password" id="password" placeholder="å¯†ç¢¼">
            <button style="background:var(--primary)" onclick="signUp()">å¿«é€Ÿè¨»å†Š</button>
            <button style="background:var(--success)" onclick="signIn()">ç«‹å³ç™»å…¥</button>
        </div>
    </div>

    <div id="profile-section" class="hidden">
        <div class="header">
            <h2>ğŸƒ ç©å®¶ä¸­å¿ƒ</h2>
            <div id="user-display" style="text-align: center; font-size: 12px; color: #999;"></div>
        </div>

        <div class="ticket-stats">
            <div><span style="font-size:12px">ç›®å‰çåˆ¸</span><b id="ticket-count">0</b></div>
            <div><span style="font-size:12px">ç•¶å‰é€²åº¦</span><b id="day-progress">Day 0</b></div>
            <div><span style="font-size:12px">ç”¢å“æŠµç”¨åˆ¸</span><b id="voucher-display">$0</b></div>
        </div>

        <button style="background:#f39c12; box-shadow: 0 4px 0 #d35400; margin-bottom: 15px;" onclick="toggleRules()">ğŸ“œ 10å¤©å¥åº·é¦¬æ‹‰æ¾æ”»ç•¥æ‰‹å†Š</button>

        <div class="card">
            <div class="card-title">ğŸ å°éšŠä»Šæ—¥æˆ°å ±</div>
            <div class="team-grid" id="team-grid-container"></div>
            <p style="font-size: 11px; color: #94a3b8; text-align: center; margin: 0;">äº®èµ·ä»£è¡¨éšŠå‹ä»Šæ—¥å·²å®Œæˆå ±åˆ°</p>
        </div>

        <button id="edit-profile-btn" class="hidden" onclick="toggleProfileEdit()" style="background: #edf2f7; color: #4a5568; font-size: 13px; margin-bottom: 15px; padding: 8px; border:none; border-radius:8px; width:100%;">âš™ï¸ ä¿®æ”¹å§“å/å°éšŠç¢¼</button>
        <div id="setup-card" class="card">
            <div class="card-title">ğŸ‘¤ åŸºæœ¬è¨­å®š</div>
            <input type="text" id="full_name" placeholder="éšŠå‹å¦‚ä½•ç¨±å‘¼ä½ ">
            <input type="text" id="team_id_input" placeholder="å°éšŠé‚€è«‹ç¢¼ (Team ID)">
            <button style="background:var(--primary)" onclick="updateProfile()">å„²å­˜ä¸¦é–‹å§‹</button>
        </div>

        <div id="lock-notice" class="lock-notice hidden">
            âš ï¸ ç”¢å“é»æ•¸ä¸è¶³ 60 åˆ†<br>è«‹è¯ç¹«æ•™ç·´é–‹å•Ÿå ±åˆ°è³‡æ ¼
        </div>

        <div id="checkin-box" class="card" style="border-left: 5px solid var(--warning);">
            <div class="card-title">âš–ï¸ æ¯æ—¥æ•¸æ“šå ±åˆ°</div>
            <p id="today-mission-tip" style="font-size: 13px; color: var(--primary); background: #e1f5fe; padding: 8px; border-radius: 8px; margin-bottom: 10px;"></p>
            <input type="number" id="weight" step="0.1" placeholder="ä»Šæ—¥é«”é‡ (kg)">
            <input type="number" id="fat_rate" step="0.1" placeholder="ä»Šæ—¥è„‚è‚ªç‡ (%)">
            <input type="number" id="muscle_mass" step="0.1" placeholder="ä»Šæ—¥è‚Œè‚‰é‡ (kg)">
            <label style="font-size: 14px; display: flex; align-items: center; gap: 8px; margin-top: 10px;">
                <input type="checkbox" id="mission_check" style="width: auto; margin: 0;"> ğŸ¯ æˆ‘å·²å®Œæˆä»Šæ—¥ä»»å‹™æŒ‘æˆ°
            </label>
            <button style="background:var(--warning)" onclick="saveDailyData()">é€å‡ºå ±åˆ°</button>
        </div>

        <div class="referral-box">
            <b>ğŸ æ¨è–¦æœ‹å‹çå‹µ</b><br>
            <span style="font-size: 12px;">å¸¶å¥½å‹åƒåŠ ï¼Œç«‹æ‹¿ 10 å¼µåˆ¸ + <br><b>$100 ç”¢å“æŠµç”¨åˆ¸ï¼</b></span>
            <button onclick="copyReferral()" style="font-size:12px; padding:5px; margin-top:5px; background:#f1c40f; color:#333;">é»æˆ‘è¤‡è£½æ¨è–¦é€£çµ</button>
        </div>

        <button style="background:var(--danger); opacity:0.5; margin-top:15px;" onclick="signOut()">å®‰å…¨ç™»å‡º</button>
    </div>
</div>

<div id="rules-overlay" class="overlay hidden" onclick="toggleRules()">
    <div class="rules-card" onclick="event.stopPropagation()">
        <div class="rules-header">
            <h3>ğŸ† é¦¬æ‹‰æ¾å…¨æ”»ç•¥</h3>
            <span style="cursor:pointer" onclick="toggleRules()">âœ•</span>
        </div>
        <div class="rules-content">
            <h4>ğŸ“… 10 å¤©å°ˆå±¬é—œå¡</h4>
            <div id="mission-container"></div>
            <h4>ğŸŸï¸ çå‹µåˆ¶åº¦</h4>
            <ul style="font-size: 13px; background: #f4f7f6; padding: 10px; border-radius: 8px; list-style:none;">
                <li>âœ… åŸºç¤å ±åˆ°ï¼š1 å¼µåˆ¸</li>
                <li>ğŸ¯ å®ŒæˆæŒ‘æˆ°ï¼š+2 å¼µåˆ¸ (å…±3å¼µ)</li>
                <li>ğŸ‘¥ æ¨è–¦å¥½å‹ï¼š10 å¼µ + $100 æŠµç”¨åˆ¸</li>
            </ul>
        </div>
    </div>
</div>

<script>
    const SUPABASE_URL = 'https://sdloakutxcsbshcqpxwn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbG9ha3V0eGNzYnNoY3FweHduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMTE4MjYsImV4cCI6MjA4MTY4NzgyNn0.5OBQQAinARnZQ6VSCrPl60NWmcSG-QiFMmVIJRW7g-0';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const missions = [
        "é–‹è³½æ‰“å¡ï¼šæ‹ç‡ƒæ–™èˆ‡é«”é‡ï¼Œå¤§å–Šæˆ‘æº–å‚™å¥½äº†ï¼", "å½©è™¹åˆé¤ï¼šåˆé¤è¦æœ‰ 3 ç¨®é¡è‰²çš„è”¬èœã€‚",
        "åˆ†äº«æ„›ï¼šè«‹å®¶äººå–ä¸€å£å¥¶æ˜”æˆ–ä¸€èµ·é‹å‹•ã€‚", "é£²æ°´å¤§ç‹ï¼šæ‹ä¸‹ä»Šå¤©å–å®Œçš„ç¬¬ 3 ç“¶æ°´ã€‚",
        "å‹•èµ·ä¾†ï¼šåš 10 åˆ†é˜é‹å‹•æ‹æµæ±—ç…§ã€‚", "è°æ˜åƒæ²¹ï¼šæ‹ä¸‹é¤ç›¤è£¡çš„å …æœæˆ–é­šé¡ã€‚",
        "å°å°ç¶²ç´…ï¼šå°‡å¥åº·é¤ç™¼åˆ° FB/IG é™å‹•ã€‚", "èª‡èª‡éšŠå‹ï¼šåœ¨ç¾¤çµ„å°éšŠå‹èªªä¸€å¥é¼“å‹µçš„è©±ã€‚",
        "è®Šèº«è¦‹è­‰ï¼šåˆ†äº« 10 å¤©ä¾†èº«é«”ç²¾ç¥çš„è®ŠåŒ–ã€‚", "å¸¶å¥½æœ‹å‹ï¼šé‚€ä¸€ä½æœ‹å‹æ¸¬è„‚æˆ–åƒåŠ ä¸‹å ´æ¯”è³½ã€‚"
    ];

    window.onload = async () => {
        const { data: { session } } = await sb.auth.getSession();
        if (session) {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('profile-section').classList.remove('hidden');
            loadDashboard(session.user);
        }
    };

    async function loadDashboard(user) {
        const { data: profile, error } = await sb.from('profiles').select('*').eq('id', user.id).single();
        
        if (error || !profile) {
            console.error("è®€å– Profile å¤±æ•—:", error);
            return;
        }

        document.getElementById('user-display').innerText = user.email;
        document.getElementById('full_name').value = profile.full_name || '';
        document.getElementById('team_id_input').value = profile.team_id || '';
        
        // åªæœ‰åœ¨è³‡æ–™å®Œæ•´æ™‚æ‰éš±è—è¨­å®šå¡
        if (profile.full_name && profile.team_id) {
            document.getElementById('setup-card').classList.add('hidden');
            document.getElementById('edit-profile-btn').classList.remove('hidden');
        }

        // ç”¢å“é–€æª»æª¢æŸ¥ (å¦‚æœé‚„æ²’æ‰‹å‹•åŠ åˆ†ï¼Œé€™æœƒæ˜¯ false)
        const hasMinPoints = (profile.product_points || 0) >= 60;
        if (hasMinPoints) {
            document.getElementById('checkin-box').classList.remove('hidden');
            document.getElementById('lock-notice').classList.add('hidden');
        } else {
            document.getElementById('checkin-box').classList.add('hidden');
            document.getElementById('lock-notice').classList.remove('hidden');
        }

        // é¿å… team_id ç‚ºç©ºæ™‚èª¿ç”¨ API å°è‡´ 400 éŒ¯èª¤
        if (profile.team_id) {
            loadTeamGrid(profile.team_id);
        } else {
            document.getElementById('team-grid-container').innerHTML = '<div style="grid-column: span 3; color:#999; font-size:12px;">å°šæœªåŠ å…¥å°éšŠ</div>';
        }

        const dayNum = Math.ceil(Math.abs(new Date() - new Date(profile.created_at)) / (1000 * 60 * 60 * 24));
        document.getElementById('day-progress').innerText = `Day ${dayNum}`;
        document.getElementById('today-mission-tip').innerText = dayNum <= 10 ? `ğŸ¯ ä»Šæ—¥æŒ‘æˆ°ï¼š${missions[dayNum-1]}` : "ğŸ‰ è³½å­£çµæŸ";
        document.getElementById('voucher-display').innerText = `$${(profile.referral_count || 0) * 100}`;

        renderMissions(dayNum);
        updateTicketDisplay(user.id, profile);
    }

    async function loadTeamGrid(teamId) {
        const container = document.getElementById('team-grid-container');
        container.innerHTML = '';
        const today = new Date().toISOString().split('T')[0];
        const { data: members } = await sb.from('profiles').select('id, full_name').eq('team_id', teamId).limit(9);
        const { data: records } = await sb.from('weight_records').select('user_id').eq('date', today);
        const doneSet = new Set(records?.map(r => r.user_id));

        for (let i = 0; i < 9; i++) {
            const m = members?.[i];
            const isDone = m && doneSet.has(m.id);
            const div = document.createElement('div');
            div.className = `member-item ${isDone ? 'done' : ''}`;
            div.innerHTML = `<b>${m ? (m.full_name || 'éšŠå‹') : 'å¾…åŠ å…¥'}</b><span>${isDone ? 'å·²å®Œæˆ' : 'æœªå ±åˆ°'}</span>`;
            container.appendChild(div);
        }
    }

    async function saveDailyData() {
        const { data: { user } } = await sb.auth.getUser();
        const weight = document.getElementById('weight').value;
        const isMission = document.getElementById('mission_check').checked;

        if (!weight) return alert("è«‹è¼¸å…¥ä»Šæ—¥é«”é‡ï¼");

        const { error } = await sb.from('weight_records').upsert({
            user_id: user.id, date: new Date().toISOString().split('T')[0],
            weight: parseFloat(weight), fat_rate: parseFloat(document.getElementById('fat_rate').value),
            muscle_mass: parseFloat(document.getElementById('muscle_mass').value),
            mission_status: isMission
        });

        if (error) alert(error.message); else { alert("âœ… å ±åˆ°æˆåŠŸï¼"); location.reload(); }
    }

    async function updateTicketDisplay(userId, profile) {
        const { data: records } = await sb.from('weight_records').select('mission_status').eq('user_id', userId);
        let total = (profile.referral_count || 0) * 10; // æ¨è–¦å¥½å‹ 10 å¼µ
        if (records) {
            records.forEach(r => {
                total += 1; // åŸºç¤ 1
                if (r.mission_status) total += 2; // æŒ‘æˆ° +2
            });
        }
        document.getElementById('ticket-count').innerText = total;
    }

    function renderMissions(currentDay) {
        const container = document.getElementById('mission-container');
        container.innerHTML = "";
        missions.forEach((m, i) => {
            const d = i + 1;
            const div = document.createElement('div');
            div.className = `mission-item ${d > currentDay ? 'locked' : (d === currentDay ? 'active' : '')}`;
            div.innerHTML = `<span style="width:40px">D${d}</span> <span>${d > currentDay ? 'ğŸ”’ å°šæœªè§£é–' : m}</span>`;
            container.appendChild(div);
        });
    }

    async function updateProfile() {
        const { data: { user } } = await sb.auth.getUser();
        await sb.from('profiles').update({ full_name: document.getElementById('full_name').value, team_id: document.getElementById('team_id_input').value }).eq('id', user.id);
        location.reload();
    }

    function toggleRules() { document.getElementById('rules-overlay').classList.toggle('hidden'); }
    function toggleProfileEdit() { document.getElementById('setup-card').classList.toggle('hidden'); }
    function copyReferral() { alert("æ¨è–¦ç¢¼å·²è¤‡è£½ï¼ç™¼é€çµ¦å¥½å‹è¨»å†Šå³å¯é ˜å– $100 æŠµç”¨åˆ¸ï¼"); }
    async function signIn() { 
        const { error } = await sb.auth.signInWithPassword({ email: document.getElementById('email').value, password: document.getElementById('password').value });
        if (error) alert(error.message); else location.reload();
    }
    async function signUp() {
        const { error } = await sb.auth.signUp({ email: document.getElementById('email').value, password: document.getElementById('password').value });
        if (error) alert(error.message); else alert("è¨»å†ŠæˆåŠŸï¼Œè«‹ç™»å…¥ï¼");
    }
    async function signOut() { await sb.auth.signOut(); location.reload(); }
</script>
</body>
</html>
