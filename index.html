<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦¬æ‹‰æ¾å¥èº«è¿½è¹¤ç³»çµ±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --light: #f8f9fa;
            --dark: #212529;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: none;
        }

        .container.active {
            display: block;
        }

        /* ç™»å…¥/è¨»å†Šé é¢ */
        .auth-container {
            display: flex;
            min-height: 600px;
        }

        .auth-left {
            flex: 1;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 60px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .auth-right {
            flex: 1;
            padding: 60px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .auth-title {
            font-size: 2.5rem;
            margin-bottom: 20px;
            font-weight: 800;
        }

        .auth-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 40px;
        }

        .feature-list {
            list-style: none;
            margin-top: 40px;
        }

        .feature-list li {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.1rem;
        }

        .feature-list i {
            font-size: 1.5rem;
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 50%;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--secondary);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            width: 100%;
            border: 2px solid #e0e0e0;
        }

        .btn-secondary:hover {
            background: #f0f0f0;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }

        .auth-switch a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9rem;
            display: none;
        }

        /* ä¸»æ‡‰ç”¨é é¢ */
        .main-container {
            display: none;
            min-height: 700px;
        }

        .main-container.active {
            display: flex;
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px;
        }

        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .user-details h3 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .user-details p {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            color: white;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.1);
        }

        .nav-link i {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .section-title {
            font-size: 2rem;
            margin-bottom: 30px;
            color: var(--dark);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary);
        }

        .stat-card h3 {
            font-size: 1rem;
            color: #666;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--primary);
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .input-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
        }

        .value-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }

        .value-control button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .value-control button:hover {
            background: var(--primary);
            color: white;
        }

        .value-display {
            font-size: 3rem;
            font-weight: 800;
            color: var(--dark);
            min-width: 150px;
            text-align: center;
            border: none;
            background: transparent;
        }

        .record-list {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .record-item:last-child {
            border-bottom: none;
        }

        .record-date {
            font-weight: 600;
            color: var(--dark);
        }

        .record-values {
            display: flex;
            gap: 20px;
        }

        .record-value {
            text-align: center;
        }

        .record-value .label {
            font-size: 0.8rem;
            color: #666;
        }

        .record-value .value {
            font-weight: 700;
            font-size: 1.2rem;
        }

        /* æ’è¡Œæ¦œé é¢ */
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .ranking-table th {
            background: var(--light);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
        }

        .ranking-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .ranking-table tr:hover {
            background: var(--light);
        }

        .rank-badge {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            font-weight: 600;
        }

        .rank-1 { background: gold; color: #333; }
        .rank-2 { background: silver; color: #333; }
        .rank-3 { background: #cd7f32; color: white; }

        /* åœ˜éšŠé é¢ */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .team-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
        }

        .team-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 20px;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .auth-container {
                flex-direction: column;
                min-height: auto;
            }
            
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .input-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- ç™»å…¥/è¨»å†Šå®¹å™¨ -->
    <div class="container auth-container" id="auth-container">
        <div class="auth-left">
            <h1 class="auth-title">ğŸƒ é¦¬æ‹‰æ¾å¥èº«è¿½è¹¤</h1>
            <p class="auth-subtitle">å°ˆç‚ºåœ˜éšŠå¥èº«è¨­è¨ˆçš„å…¨æ–¹ä½è¿½è¹¤ç³»çµ±</p>
            
            <ul class="feature-list">
                <li><i class="fas fa-chart-line"></i> æ¯æ—¥å¥åº·æ•¸æ“šè¿½è¹¤</li>
                <li><i class="fas fa-users"></i> åœ˜éšŠæ¿€å‹µèˆ‡æ’å</li>
                <li><i class="fas fa-trophy"></i> ç©åˆ†ç³»çµ±èˆ‡æˆå°±</li>
                <li><i class="fas fa-medal"></i> å€‹äººèˆ‡åœ˜éšŠæ’è¡Œæ¦œ</li>
                <li><i class="fas fa-mobile-alt"></i> éŸ¿æ‡‰å¼è¨­è¨ˆï¼Œéš¨è™•å¯ç”¨</li>
            </ul>
        </div>
        
        <div class="auth-right">
            <h2 id="auth-form-title">æ­¡è¿å›ä¾†</h2>
            <p id="auth-form-subtitle">è«‹ç™»å…¥æ‚¨çš„å¸³è™Ÿ</p>
            
            <form id="auth-form">
                <div class="form-group">
                    <label for="email">é›»å­éƒµä»¶</label>
                    <input type="email" id="email" placeholder="your@email.com" required>
                </div>
                
                <div class="form-group">
                    <label for="password">å¯†ç¢¼</label>
                    <input type="password" id="password" placeholder="è‡³å°‘6å€‹å­—ç¬¦" required minlength="6">
                </div>
                
                <div class="error-message" id="auth-error"></div>
                
                <button type="submit" class="btn btn-primary" id="auth-submit-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span id="auth-submit-text">ç™»å…¥</span>
                </button>
                
                <div class="auth-switch">
                    <span id="auth-switch-text">é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ</span>
                    <a id="auth-switch-link" onclick="switchAuthMode()">ç«‹å³è¨»å†Š</a>
                </div>
            </form>
        </div>
    </div>

    <!-- ä¸»æ‡‰ç”¨å®¹å™¨ -->
    <div class="container main-container" id="main-container">
        <div class="sidebar">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">U</div>
                <div class="user-details">
                    <h3 id="user-name">ä½¿ç”¨è€…</h3>
                    <p id="user-email">user@example.com</p>
                    <p><small id="user-day">Day 1</small></p>
                </div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" onclick="showSection('dashboard')">
                        <i class="fas fa-home"></i>
                        <span>å„€è¡¨æ¿</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('record')">
                        <i class="fas fa-pencil-alt"></i>
                        <span>è¨˜éŒ„æ•¸æ“š</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('history')">
                        <i class="fas fa-history"></i>
                        <span>æ­·å²è¨˜éŒ„</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('team')">
                        <i class="fas fa-users"></i>
                        <span>æˆ‘çš„æˆ°éšŠ</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('ranking')">
                        <i class="fas fa-trophy"></i>
                        <span>æ’è¡Œæ¦œ</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showSection('profile')">
                        <i class="fas fa-user-cog"></i>
                        <span>å€‹äººè¨­å®š</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>ç™»å‡º</span>
                    </a>
                </li>
            </ul>
        </div>
        
        <div class="main-content">
            <!-- å„€è¡¨æ¿å€å¡Š -->
            <div id="dashboard-section" class="section">
                <h2 class="section-title">ğŸ“Š å¥èº«å„€è¡¨æ¿</h2>
                
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <h3>ä»Šæ—¥é«”é‡</h3>
                        <div class="stat-value" id="today-weight">-- kg</div>
                        <p><small id="weight-change">èˆ‡æ˜¨æ—¥æ¯”è¼ƒ: --</small></p>
                    </div>
                    
                    <div class="stat-card">
                        <h3>ä»Šæ—¥é«”è„‚ç‡</h3>
                        <div class="stat-value" id="today-fat">-- %</div>
                        <p><small id="fat-change">èˆ‡æ˜¨æ—¥æ¯”è¼ƒ: --</small></p>
                    </div>
                    
                    <div class="stat-card">
                        <h3>ä»Šæ—¥è‚Œè‚‰é‡</h3>
                        <div class="stat-value" id="today-muscle">-- kg</div>
                        <p><small id="muscle-change">èˆ‡æ˜¨æ—¥æ¯”è¼ƒ: --</small></p>
                    </div>
                    
                    <div class="stat-card">
                        <h3>é€£çºŒè¨˜éŒ„å¤©æ•¸</h3>
                        <div class="stat-value" id="streak-days">0</div>
                        <p><small>æŒçºŒåŠªåŠ›ä¸­ï¼</small></p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <h3>è¿‘æœŸè¶¨å‹¢</h3>
                    <div id="trend-chart-placeholder">
                        <p style="text-align: center; padding: 40px; color: #666;">
                            è¼‰å…¥æ•¸æ“šä¸­... (å»ºè­°æ•´åˆ Chart.js å¯è¦–åŒ–)
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- è¨˜éŒ„æ•¸æ“šå€å¡Š -->
            <div id="record-section" class="section" style="display: none;">
                <h2 class="section-title">ğŸ“ è¨˜éŒ„ä»Šæ—¥æ•¸æ“š</h2>
                <p style="color: #666; margin-bottom: 30px;">è«‹è¼¸å…¥æ‚¨ä»Šæ—¥çš„å¥åº·æ•¸æ“šï¼Œæ¯å¤©æœ€å¤šå¯æ›´æ–°3æ¬¡</p>
                
                <div class="input-group">
                    <div class="input-card">
                        <h3>é«”é‡ (kg)</h3>
                        <div class="value-control">
                            <button onclick="adjustValue('weight', -0.1)">-</button>
                            <input type="text" class="value-display" id="input-weight" value="65.0" readonly>
                            <button onclick="adjustValue('weight', 0.1)">+</button>
                        </div>
                        <p><small>ç¯„åœ: 30-200 kg</small></p>
                    </div>
                    
                    <div class="input-card">
                        <h3>é«”è„‚ç‡ (%)</h3>
                        <div class="value-control">
                            <button onclick="adjustValue('fat', -0.1)">-</button>
                            <input type="text" class="value-display" id="input-fat" value="25.0" readonly>
                            <button onclick="adjustValue('fat', 0.1)">+</button>
                        </div>
                        <p><small>ç¯„åœ: 5-60 %</small></p>
                    </div>
                    
                    <div class="input-card">
                        <h3>è‚Œè‚‰é‡ (kg)</h3>
                        <div class="value-control">
                            <button onclick="adjustValue('muscle', -0.1)">-</button>
                            <input type="text" class="value-display" id="input-muscle" value="30.0" readonly>
                            <button onclick="adjustValue('muscle', 0.1)">+</button>
                        </div>
                        <p><small>ç¯„åœ: 10-100 kg</small></p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="daily-note">ä»Šæ—¥å‚™è¨» (é¸å¡«)</label>
                    <textarea id="daily-note" rows="3" placeholder="è¨˜éŒ„ä»Šæ—¥çš„é£²é£Ÿæˆ–é‹å‹•æƒ…æ³..." style="width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px;"></textarea>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button class="btn btn-secondary" onclick="loadTodayData()">
                        <i class="fas fa-redo"></i> é‡æ–°è¼‰å…¥
                    </button>
                    <button class="btn btn-primary" onclick="submitDailyData()" id="submit-btn">
                        <i class="fas fa-paper-plane"></i> æäº¤æ•¸æ“š
                    </button>
                </div>
                
                <div class="error-message" id="submit-error"></div>
                
                <div class="stat-card" style="margin-top: 30px;">
                    <h3>ä»Šæ—¥æäº¤ç‹€æ…‹</h3>
                    <p>å·²æäº¤æ¬¡æ•¸: <span id="submit-count">0</span>/3 æ¬¡</p>
                    <p id="submit-time">æœ€å¾Œæäº¤æ™‚é–“: --</p>
                </div>
            </div>
            
            <!-- æ­·å²è¨˜éŒ„å€å¡Š -->
            <div id="history-section" class="section" style="display: none;">
                <h2 class="section-title">ğŸ“‹ æ­·å²è¨˜éŒ„</h2>
                
                <div class="record-list" id="history-list">
                    <p style="text-align: center; padding: 40px; color: #666;">è¼‰å…¥æ•¸æ“šä¸­...</p>
                </div>
            </div>
            
            <!-- åœ˜éšŠå€å¡Š -->
            <div id="team-section" class="section" style="display: none;">
                <h2 class="section-title">ğŸ‘¥ æˆ‘çš„æˆ°éšŠ</h2>
                
                <div id="team-info">
                    <p style="color: #666; margin-bottom: 20px;">è¼‰å…¥åœ˜éšŠè³‡è¨Šä¸­...</p>
                </div>
                
                <div class="team-grid" id="team-members">
                    <!-- åœ˜éšŠæˆå“¡å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
            
            <!-- æ’è¡Œæ¦œå€å¡Š -->
            <div id="ranking-section" class="section" style="display: none;">
                <h2 class="section-title">ğŸ† æ’è¡Œæ¦œ</h2>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="loadRanking('weight')">æ¸›é‡æ’å</button>
                    <button class="btn btn-secondary" onclick="loadRanking('points')">ç©åˆ†æ’å</button>
                    <button class="btn btn-secondary" onclick="loadRanking('teams')">åœ˜éšŠæ’å</button>
                </div>
                
                <div class="record-list">
                    <table class="ranking-table" id="ranking-table">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>å§“å</th>
                                <th>æ•¸æ“š</th>
                                <th>åœ˜éšŠ</th>
                            </tr>
                        </thead>
                        <tbody id="ranking-body">
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 40px;">é¸æ“‡æ’åé¡å‹</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- å€‹äººè¨­å®šå€å¡Š -->
            <div id="profile-section" class="section" style="display: none;">
                <h2 class="section-title">âš™ï¸ å€‹äººè¨­å®š</h2>
                
                <div class="input-group">
                    <div class="input-card">
                        <h3>å€‹äººé ­åƒ</h3>
                        <div class="user-avatar" id="profile-avatar" style="width: 100px; height: 100px; margin: 20px auto; cursor: pointer;" onclick="document.getElementById('avatar-upload').click()">
                            <i class="fas fa-user"></i>
                        </div>
                        <input type="file" id="avatar-upload" accept="image/*" style="display: none;" onchange="uploadAvatar()">
                        <p><small>é»æ“Šé ­åƒæ›´æ›</small></p>
                    </div>
                    
                    <div class="input-card">
                        <h3>å€‹äººè³‡è¨Š</h3>
                        <div style="margin-top: 20px;">
                            <div class="form-group">
                                <label>çœŸå¯¦å§“å</label>
                                <input type="text" id="profile-name" placeholder="è¼¸å…¥å§“å">
                            </div>
                            <div class="form-group">
                                <label>è¨ˆç•«é¡å‹</label>
                                <select id="profile-plan" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px;">
                                    <option value="slow_run">æ…¢è·‘è¨ˆç•«</option>
                                    <option value="fast_run">å¿«è·‘è¨ˆç•«</option>
                                    <option value="vip">VIPè¨ˆç•«</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="input-card" style="margin-top: 20px;">
                    <h3>åœ˜éšŠè¨­å®š</h3>
                    <div class="form-group">
                        <label>åŠ å…¥æˆ°éšŠ (é‚€è«‹ç¢¼)</label>
                        <input type="text" id="team-invite" placeholder="è¼¸å…¥éšŠé•·æä¾›çš„é‚€è«‹ç¢¼">
                    </div>
                    <button class="btn btn-primary" onclick="joinTeam()">
                        <i class="fas fa-users"></i> åŠ å…¥æˆ°éšŠ
                    </button>
                    <p id="team-invite-code" style="margin-top: 15px; display: none;">
                        <strong>æ‚¨çš„é‚€è«‹ç¢¼:</strong> <span id="invite-code-display"></span>
                    </p>
                </div>
                
                <button class="btn btn-primary" onclick="saveProfile()" style="margin-top: 30px; width: 100%;">
                    <i class="fas fa-save"></i> å„²å­˜æ‰€æœ‰è¨­å®š
                </button>
            </div>
        </div>
    </div>

    <script>
        // Supabase é…ç½® - æ›¿æ›æˆæ‚¨çš„å¯¦éš›è³‡æ–™
        const SUPABASE_URL = 'https://sdloakutxcsbshcqpxwn.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkbG9ha3V0eGNzYnNoY3FweHduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMTE4MjYsImV4cCI6MjA4MTY4NzgyNn0.5OBQQAinARnZQ6VSCrPl60NWmcSG-QiFMmVIJRW7g-0';
        
        // åˆå§‹åŒ– Supabase å®¢æˆ¶ç«¯
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // æ‡‰ç”¨ç‹€æ…‹
        let currentUser = null;
        let userProfile = null;
        let isLoginMode = true;
        let todayData = null;
        
        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            setupEventListeners();
        });
        
        // æª¢æŸ¥èªè­‰ç‹€æ…‹
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                await loadUserProfile();
                showMainApp();
            } else {
                showAuth();
            }
        }
        
        // åˆ‡æ›ç™»å…¥/è¨»å†Šæ¨¡å¼
        function switchAuthMode() {
            isLoginMode = !isLoginMode;
            
            if (isLoginMode) {
                document.getElementById('auth-form-title').textContent = 'æ­¡è¿å›ä¾†';
                document.getElementById('auth-form-subtitle').textContent = 'è«‹ç™»å…¥æ‚¨çš„å¸³è™Ÿ';
                document.getElementById('auth-submit-text').textContent = 'ç™»å…¥';
                document.getElementById('auth-switch-text').textContent = 'é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ';
                document.getElementById('auth-switch-link').textContent = 'ç«‹å³è¨»å†Š';
            } else {
                document.getElementById('auth-form-title').textContent = 'å»ºç«‹æ–°å¸³è™Ÿ';
                document.getElementById('auth-form-subtitle').textContent = 'è¨»å†Šé–‹å§‹æ‚¨çš„å¥èº«æ—…ç¨‹';
                document.getElementById('auth-submit-text').textContent = 'è¨»å†Š';
                document.getElementById('auth-switch-text').textContent = 'å·²æœ‰å¸³è™Ÿï¼Ÿ';
                document.getElementById('auth-switch-link').textContent = 'ç«‹å³ç™»å…¥';
            }
            
            document.getElementById('auth-error').style.display = 'none';
        }
        
        // è™•ç†èªè­‰è¡¨å–®æäº¤
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('auth-error');
            const submitBtn = document.getElementById('auth-submit-btn');
            
            errorElement.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è™•ç†ä¸­...';
            
            try {
                if (isLoginMode) {
                    // ç™»å…¥
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    
                    if (error) throw error;
                    
                    currentUser = data.user;
                    await loadUserProfile();
                    showMainApp();
                } else {
                    // è¨»å†Š
                    const { data, error } = await supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                full_name: email.split('@')[0]
                            }
                        }
                    });
                    
                    if (error) throw error;
                    
                    alert('è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥æ‚¨çš„é›»å­éƒµä»¶é€²è¡Œé©—è­‰ï¼ˆå¦‚éœ€è¦ï¼‰ï¼Œç„¶å¾Œç™»å…¥ã€‚');
                    switchAuthMode();
                }
            } catch (error) {
                errorElement.textContent = error.message;
                errorElement.style.display = 'block';
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = `<i class="fas fa-sign-in-alt"></i> <span id="auth-submit-text">${isLoginMode ? 'ç™»å…¥' : 'è¨»å†Š'}</span>`;
            }
        });
        
        // è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™
        async function loadUserProfile() {
            if (!currentUser) return;
            
            const { data, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();
            
            if (error) {
                console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡æ–™éŒ¯èª¤:', error);
                // å¦‚æœä½¿ç”¨è€…è³‡æ–™ä¸å­˜åœ¨ï¼Œå»ºç«‹ä¸€å€‹
                await createUserProfile();
                return;
            }
            
            userProfile = data;
            updateUserUI();
            
            // è¼‰å…¥ä»Šæ—¥æ•¸æ“š
            await loadTodayData();
            await loadHistory();
        }
        
        // å»ºç«‹ä½¿ç”¨è€…è³‡æ–™
        async function createUserProfile() {
            const { data, error } = await supabase
                .from('profiles')
                .insert([{
                    id: currentUser.id,
                    email: currentUser.email,
                    full_name: currentUser.user_metadata?.full_name || currentUser.email.split('@')[0],
                    role: 'member',
                    plan: 'slow_run',
                    points: 0
                }])
                .select()
                .single();
            
            if (error) {
                console.error('å»ºç«‹ä½¿ç”¨è€…è³‡æ–™éŒ¯èª¤:', error);
                return;
            }
            
            userProfile = data;
            updateUserUI();
        }
        
        // æ›´æ–°ä½¿ç”¨è€…ä»‹é¢
        function updateUserUI() {
            if (!userProfile) return;
            
            document.getElementById('user-name').textContent = userProfile.full_name || 'ä½¿ç”¨è€…';
            document.getElementById('user-email').textContent = userProfile.email;
            
            // è¨ˆç®—å¤©æ•¸ (å‡è¨­å¾è¨»å†Šæ—¥é–‹å§‹)
            const startDate = new Date(currentUser.created_at);
            const today = new Date();
            const dayDiff = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
            document.getElementById('user-day').textContent = `Day ${dayDiff}`;
            
            // æ›´æ–°é ­åƒ
            const avatarElement = document.getElementById('user-avatar');
            const profileAvatar = document.getElementById('profile-avatar');
            
            if (userProfile.avatar_url) {
                avatarElement.innerHTML = `<img src="${userProfile.avatar_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                profileAvatar.innerHTML = `<img src="${userProfile.avatar_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
            } else {
                const initials = (userProfile.full_name || 'U').charAt(0).toUpperCase();
                avatarElement.innerHTML = initials;
                profileAvatar.innerHTML = initials;
            }
            
            // æ›´æ–°å€‹äººè¨­å®šè¡¨å–®
            document.getElementById('profile-name').value = userProfile.full_name || '';
            document.getElementById('profile-plan').value = userProfile.plan || 'slow_run';
            
            // å¦‚æœæ˜¯éšŠé•·ï¼Œé¡¯ç¤ºé‚€è«‹ç¢¼
            if (userProfile.role === 'captain' && userProfile.current_team_id) {
                document.getElementById('team-invite-code').style.display = 'block';
                document.getElementById('invite-code-display').textContent = userProfile.current_team_id;
            }
        }
        
        // é¡¯ç¤ºèªè­‰é é¢
        function showAuth() {
            document.getElementById('auth-container').classList.add('active');
            document.getElementById('main-container').classList.remove('active');
        }
        
        // é¡¯ç¤ºä¸»æ‡‰ç”¨
        function showMainApp() {
            document.getElementById('auth-container').classList.remove('active');
            document.getElementById('main-container').classList.add('active');
            
            // é¡¯ç¤ºå„€è¡¨æ¿
            showSection('dashboard');
        }
        
        // åˆ‡æ›å€å¡Šé¡¯ç¤º
        function showSection(sectionId) {
            // éš±è—æ‰€æœ‰å€å¡Š
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            
            // æ›´æ–°å°èˆªé¸é …
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // é¡¯ç¤ºç›®æ¨™å€å¡Š
            document.getElementById(`${sectionId}-section`).style.display = 'block';
            
            // æ›´æ–°æ´»å‹•çš„å°èˆªé€£çµ
            document.querySelector(`.nav-link[onclick="showSection('${sectionId}')"]`).classList.add('active');
            
            // è¼‰å…¥ç‰¹å®šå€å¡Šçš„æ•¸æ“š
            if (sectionId === 'ranking') {
                loadRanking('weight');
            } else if (sectionId === 'team') {
                loadTeamInfo();
            }
        }
        
        // èª¿æ•´è¼¸å…¥æ•¸å€¼
        function adjustValue(type, change) {
            const inputElement = document.getElementById(`input-${type}`);
            let currentValue = parseFloat(inputElement.value) || 0;
            
            // æ ¹æ“šé¡å‹è¨­å®šç¯„åœ
            const ranges = {
                weight: { min: 30, max: 200, step: 0.1 },
                fat: { min: 5, max: 60, step: 0.1 },
                muscle: { min: 10, max: 100, step: 0.1 }
            };
            
            const range = ranges[type];
            let newValue = currentValue + change;
            
            // ç¢ºä¿åœ¨ç¯„åœå…§
            newValue = Math.max(range.min, Math.min(range.max, newValue));
            
            // å››æ¨äº”å…¥åˆ°å°æ•¸é»å¾Œä¸€ä½
            inputElement.value = newValue.toFixed(1);
        }
        
        // è¼‰å…¥ä»Šæ—¥æ•¸æ“š
        async function loadTodayData() {
            if (!currentUser) return;
            
            const today = new Date().toISOString().split('T')[0];
            
            const { data, error } = await supabase
                .from('weight_records')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('date', today)
                .single();
            
            if (error && error.code !== 'PGRST116') { // PGRST116 è¡¨ç¤ºæ²’æœ‰æ‰¾åˆ°è¨˜éŒ„
                console.error('è¼‰å…¥ä»Šæ—¥æ•¸æ“šéŒ¯èª¤:', error);
                return;
            }
            
            todayData = data;
            
            if (data) {
                // æ›´æ–°è¼¸å…¥å€¼
                document.getElementById('input-weight').value = parseFloat(data.weight).toFixed(1);
                document.getElementById('input-fat').value = parseFloat(data.fat_rate || 0).toFixed(1);
                document.getElementById('input-muscle').value = parseFloat(data.muscle_mass || 0).toFixed(1);
                document.getElementById('daily-note').value = data.daily_note || '';
                
                // æ›´æ–°å„€è¡¨æ¿
                document.getElementById('today-weight').textContent = `${parseFloat(data.weight).toFixed(1)} kg`;
                document.getElementById('today-fat').textContent = `${parseFloat(data.fat_rate || 0).toFixed(1)} %`;
                document.getElementById('today-muscle').textContent = `${parseFloat(data.muscle_mass || 0).toFixed(1)} kg`;
                
                // è¼‰å…¥æ˜¨æ—¥æ•¸æ“šä»¥è¨ˆç®—è®ŠåŒ–
                await loadYesterdayComparison();
                
                // æ›´æ–°æäº¤ç‹€æ…‹
                updateSubmitStatus();
            } else {
                // æ²’æœ‰ä»Šæ—¥æ•¸æ“šï¼Œé‡ç½®ç‚ºé è¨­å€¼
                document.getElementById('today-weight').textContent = '-- kg';
                document.getElementById('today-fat').textContent = '-- %';
                document.getElementById('today-muscle').textContent = '-- kg';
                
                document.getElementById('weight-change').textContent = 'èˆ‡æ˜¨æ—¥æ¯”è¼ƒ: --';
                document.getElementById('fat-change').textContent = 'èˆ‡æ˜¨æ—¥æ¯”è¼ƒ: --';
                document.getElementById('muscle-change').textContent = 'èˆ‡æ˜¨æ—¥æ¯”è¼ƒ: --';
            }
        }
        
        // è¼‰å…¥æ˜¨æ—¥æ•¸æ“šæ¯”è¼ƒ
        async function loadYesterdayComparison() {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            const { data, error } = await supabase
                .from('weight_records')
                .select('*')
                .eq('user_id', currentUser.id)
                .eq('date', yesterdayStr)
                .single();
            
            if (error || !data) return;
            
            // è¨ˆç®—è®ŠåŒ–
            const weightChange = todayData.weight - data.weight;
            const fatChange = (todayData.fat_rate || 0) - (data.fat_rate || 0);
            const muscleChange = (todayData.muscle_mass || 0) - (data.muscle_mass || 0);
            
            // æ›´æ–°é¡¯ç¤º
            document.getElementById('weight-change').textContent = 
                `èˆ‡æ˜¨æ—¥æ¯”è¼ƒ: ${weightChange >= 0 ? '+' : ''}${weightChange.toFixed(1)} kg`;
            document.getElementById('weight-change').style.color = weightChange < 0 ? '#4CAF50' : '#f44336';
            
            document.getElementById('fat-change').textContent = 
                `èˆ‡æ˜¨æ—¥æ¯”è¼ƒ: ${fatChange >= 0 ? '+' : ''}${fatChange.toFixed(1)} %`;
            document.getElementById('fat-change').style.color = fatChange < 0 ? '#4CAF50' : '#f44336';
            
            document.getElementById('muscle-change').textContent = 
                `èˆ‡æ˜¨æ—¥æ¯”è¼ƒ: ${muscleChange >= 0 ? '+' : ''}${muscleChange.toFixed(1)} kg`;
            document.getElementById('muscle-change').style.color = muscleChange > 0 ? '#4CAF50' : '#f44336';
        }
        
        // æ›´æ–°æäº¤ç‹€æ…‹
        function updateSubmitStatus() {
            if (!todayData) {
                document.getElementById('submit-count').textContent = '0';
                document.getElementById('submit-time').textContent = 'æœ€å¾Œæäº¤æ™‚é–“: --';
                return;
            }
            
            // è¨ˆç®—ä»Šå¤©æäº¤çš„æ¬¡æ•¸ï¼ˆæ ¹æ“šåŒä¸€å¤©çš„åŒuser_idè¨˜éŒ„æ•¸é‡ï¼‰
            // é€™éœ€è¦ä¸€å€‹é¡å¤–çš„æŸ¥è©¢ï¼Œä½†ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘å‡è¨­æ¯æ¢è¨˜éŒ„éƒ½æ˜¯ä¸€æ¬¡æäº¤
            document.getElementById('submit-count').textContent = '1';
            
            const submitTime = new Date(todayData.created_at).toLocaleTimeString('zh-TW');
            document.getElementById('submit-time').textContent = `æœ€å¾Œæäº¤æ™‚é–“: ${submitTime}`;
        }
        
        // æäº¤æ¯æ—¥æ•¸æ“š
        async function submitDailyData() {
            if (!currentUser) {
                alert('è«‹å…ˆç™»å…¥');
                return;
            }
            
            const weight = parseFloat(document.getElementById('input-weight').value);
            const fatRate = parseFloat(document.getElementById('input-fat').value);
            const muscleMass = parseFloat(document.getElementById('input-muscle').value);
            const dailyNote = document.getElementById('daily-note').value;
            
            const submitBtn = document.getElementById('submit-btn');
            const errorElement = document.getElementById('submit-error');
            
            errorElement.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æäº¤ä¸­...';
            
            try {
                const today = new Date().toISOString().split('T')[0];
                
                // æª¢æŸ¥æ˜¯å¦å·²æœ‰ä»Šæ—¥è¨˜éŒ„
                const { data: existingRecord } = await supabase
                    .from('weight_records')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .eq('date', today)
                    .single();
                
                let result;
                
                if (existingRecord) {
                    // æ›´æ–°ç¾æœ‰è¨˜éŒ„
                    result = await supabase
                        .from('weight_records')
                        .update({
                            weight: weight,
                            fat_rate: fatRate,
                            muscle_mass: muscleMass,
                            daily_note: dailyNote,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', existingRecord.id);
                } else {
                    // æ’å…¥æ–°è¨˜éŒ„
                    result = await supabase
                        .from('weight_records')
                        .insert([{
                            user_id: currentUser.id,
                            weight: weight,
                            fat_rate: fatRate,
                            muscle_mass: muscleMass,
                            date: today,
                            daily_note: dailyNote
                        }]);
                }
                
                if (result.error) throw result.error;
                
                alert('æ•¸æ“šæäº¤æˆåŠŸï¼');
                
                // é‡æ–°è¼‰å…¥æ•¸æ“š
                await loadTodayData();
                await loadHistory();
                
                // æ›´æ–°å„€è¡¨æ¿
                showSection('dashboard');
                
            } catch (error) {
                errorElement.textContent = `æäº¤å¤±æ•—: ${error.message}`;
                errorElement.style.display = 'block';
                console.error('æäº¤éŒ¯èª¤:', error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> æäº¤æ•¸æ“š';
            }
        }
        
        // è¼‰å…¥æ­·å²è¨˜éŒ„
        async function loadHistory() {
            if (!currentUser) return;
            
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '<p style="text-align: center; padding: 20px; color: #666;">è¼‰å…¥ä¸­...</p>';
            
            try {
                const { data, error } = await supabase
                    .from('weight_records')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('date', { ascending: false })
                    .limit(20);
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    historyList.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">å°šç„¡æ­·å²è¨˜éŒ„</p>';
                    return;
                }
                
                let html = '';
                data.forEach(record => {
                    const date = new Date(record.date).toLocaleDateString('zh-TW');
                    
                    html += `
                        <div class="record-item">
                            <div class="record-date">${date}</div>
                            <div class="record-values">
                                <div class="record-value">
                                    <div class="label">é«”é‡</div>
                                    <div class="value">${parseFloat(record.weight).toFixed(1)} kg</div>
                                </div>
                                <div class="record-value">
                                    <div class="label">é«”è„‚ç‡</div>
                                    <div class="value">${parseFloat(record.fat_rate || 0).toFixed(1)} %</div>
                                </div>
                                <div class="record-value">
                                    <div class="label">è‚Œè‚‰é‡</div>
                                    <div class="value">${parseFloat(record.muscle_mass || 0).toFixed(1)} kg</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                historyList.innerHTML = html;
            } catch (error) {
                console.error('è¼‰å…¥æ­·å²è¨˜éŒ„éŒ¯èª¤:', error);
                historyList.innerHTML = '<p style="text-align: center; padding: 40px; color: #f44336;">è¼‰å…¥å¤±æ•—</p>';
            }
        }
        
        // è¼‰å…¥åœ˜éšŠè³‡è¨Š
        async function loadTeamInfo() {
            if (!userProfile || !userProfile.current_team_id) {
                document.getElementById('team-info').innerHTML = `
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3>æ‚¨å°šæœªåŠ å…¥ä»»ä½•æˆ°éšŠ</h3>
                        <p>è«‹åœ¨å€‹äººè¨­å®šä¸­è¼¸å…¥æˆ°éšŠé‚€è«‹ç¢¼åŠ å…¥ï¼Œæˆ–è¯çµ¡éšŠé•·å–å¾—é‚€è«‹ç¢¼ã€‚</p>
                    </div>
                `;
                document.getElementById('team-members').innerHTML = '';
                return;
            }
            
            // è¼‰å…¥åœ˜éšŠæˆå“¡
            try {
                const { data: members, error } = await supabase
                    .from('profiles')
                    .select('id, full_name, avatar_url, role, points')
                    .eq('current_team_id', userProfile.current_team_id)
                    .order('points', { ascending: false });
                
                if (error) throw error;
                
                let membersHtml = '';
                if (members && members.length > 0) {
                    members.forEach(member => {
                        const avatar = member.avatar_url 
                            ? `<img src="${member.avatar_url}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`
                            : member.full_name?.charAt(0).toUpperCase() || 'M';
                        
                        membersHtml += `
                            <div class="team-card">
                                <div class="team-avatar">${avatar}</div>
                                <h3>${member.full_name || 'æˆå“¡'}</h3>
                                <p>${member.role === 'captain' ? 'ğŸ‘‘ éšŠé•·' : member.role === 'deputy' ? 'â­ å‰¯éšŠé•·' : 'ğŸ‘¤ æˆå“¡'}</p>
                                <p><strong>${member.points || 0} åˆ†</strong></p>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('team-members').innerHTML = membersHtml;
                
                // é¡¯ç¤ºåœ˜éšŠè³‡è¨Š
                document.getElementById('team-info').innerHTML = `
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h3>æˆ°éšŠ: ${userProfile.current_team_id}</h3>
                        <p>æˆå“¡æ•¸: ${members?.length || 0} äºº</p>
                        ${userProfile.role === 'captain' ? 
                            `<p><strong>æ‚¨çš„é‚€è«‹ç¢¼: ${userProfile.current_team_id}</strong></p>
                             <p>åˆ†äº«æ­¤é‚€è«‹ç¢¼çµ¦éšŠå‹è®“ä»–å€‘åŠ å…¥</p>` : ''}
                    </div>
                `;
                
            } catch (error) {
                console.error('è¼‰å…¥åœ˜éšŠè³‡è¨ŠéŒ¯èª¤:', error);
            }
        }
        
        // è¼‰å…¥æ’è¡Œæ¦œ
        async function loadRanking(type) {
            const rankingBody = document.getElementById('ranking-body');
            rankingBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px;">è¼‰å…¥ä¸­...</td></tr>';
            
            try {
                let data;
                
                if (type === 'weight') {
                    // æ¸›é‡æ’å (éœ€è¦è¨ˆç®—ç¸½æ¸›é‡)
                    const { data: records } = await supabase
                        .from('weight_records')
                        .select('user_id, weight, date, profiles(full_name, current_team_id)');
                    
                    // è¨ˆç®—æ¯å€‹ä½¿ç”¨è€…çš„æ¸›é‡
                    const userWeightMap = {};
                    
                    if (records) {
                        records.forEach(record => {
                            const userId = record.user_id;
                            if (!userWeightMap[userId]) {
                                userWeightMap[userId] = {
                                    name: record.profiles?.full_name || 'åŒ¿å',
                                    team: record.profiles?.current_team_id || 'ç„¡',
                                    weights: []
                                };
                            }
                            userWeightMap[userId].weights.push({
                                weight: record.weight,
                                date: record.date
                            });
                        });
                    }
                    
                    // è¨ˆç®—æ¸›é‡ä¸¦æ’åº
                    const ranking = Object.entries(userWeightMap)
                        .map(([userId, data]) => {
                            if (data.weights.length < 2) return null;
                            
                            // æŒ‰æ—¥æœŸæ’åº
                            data.weights.sort((a, b) => new Date(a.date) - new Date(b.date));
                            
                            const firstWeight = data.weights[0].weight;
                            const lastWeight = data.weights[data.weights.length - 1].weight;
                            const weightLost = firstWeight - lastWeight;
                            
                            return {
                                userId,
                                name: data.name,
                                team: data.team,
                                weightLost: weightLost > 0 ? weightLost : 0
                            };
                        })
                        .filter(item => item !== null)
                        .sort((a, b) => b.weightLost - a.weightLost)
                        .slice(0, 20);
                    
                    data = ranking;
                    
                } else if (type === 'points') {
                    // ç©åˆ†æ’å
                    const { data: profiles } = await supabase
                        .from('profiles')
                        .select('id, full_name, points, current_team_id')
                        .order('points', { ascending: false })
                        .limit(20);
                    
                    data = profiles || [];
                    
                } else if (type === 'teams') {
                    // åœ˜éšŠæ’å (å¹³å‡ç©åˆ†)
                    const { data: profiles } = await supabase
                        .from('profiles')
                        .select('current_team_id, points')
                        .not('current_team_id', 'is', null);
                    
                    // è¨ˆç®—åœ˜éšŠå¹³å‡ç©åˆ†
                    const teamMap = {};
                    
                    if (profiles) {
                        profiles.forEach(profile => {
                            const teamId = profile.current_team_id;
                            if (!teamMap[teamId]) {
                                teamMap[teamId] = {
                                    totalPoints: 0,
                                    memberCount: 0
                                };
                            }
                            teamMap[teamId].totalPoints += profile.points || 0;
                            teamMap[teamId].memberCount += 1;
                        });
                    }
                    
                    const teamRanking = Object.entries(teamMap)
                        .map(([teamId, data]) => ({
                            teamId,
                            avgPoints: data.memberCount > 0 ? Math.round(data.totalPoints / data.memberCount) : 0,
                            memberCount: data.memberCount
                        }))
                        .sort((a, b) => b.avgPoints - a.avgPoints)
                        .slice(0, 10);
                    
                    data = teamRanking;
                }
                
                // æ›´æ–°è¡¨æ ¼
                let html = '';
                
                if (type === 'teams') {
                    data.forEach((team, index) => {
                        const rankClass = index < 3 ? `rank-${index + 1}` : '';
                        
                        html += `
                            <tr>
                                <td><span class="rank-badge ${rankClass}">${index + 1}</span></td>
                                <td>${team.teamId}</td>
                                <td>${team.avgPoints} åˆ† (${team.memberCount}äºº)</td>
                                <td>å¹³å‡ç©åˆ†</td>
                            </tr>
                        `;
                    });
                } else {
                    data.forEach((item, index) => {
                        const rankClass = index < 3 ? `rank-${index + 1}` : '';
                        const value = type === 'weight' 
                            ? `${item.weightLost.toFixed(1)} kg` 
                            : `${item.points} åˆ†`;
                        
                        html += `
                            <tr>
                                <td><span class="rank-badge ${rankClass}">${index + 1}</span></td>
                                <td>${item.name}</td>
                                <td>${value}</td>
                                <td>${item.team || 'ç„¡'}</td>
                            </tr>
                        `;
                    });
                }
                
                rankingBody.innerHTML = html || '<tr><td colspan="4" style="text-align: center; padding: 40px;">æš«ç„¡æ•¸æ“š</td></tr>';
                
            } catch (error) {
                console.error('è¼‰å…¥æ’è¡Œæ¦œéŒ¯èª¤:', error);
                rankingBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px; color: #f44336;">è¼‰å…¥å¤±æ•—</td></tr>';
            }
        }
        
        // åŠ å…¥æˆ°éšŠ
        async function joinTeam() {
            const inviteCode = document.getElementById('team-invite').value.trim();
            
            if (!inviteCode) {
                alert('è«‹è¼¸å…¥é‚€è«‹ç¢¼');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({ current_team_id: inviteCode })
                    .eq('id', currentUser.id);
                
                if (error) throw error;
                
                alert('æˆåŠŸåŠ å…¥æˆ°éšŠï¼');
                userProfile.current_team_id = inviteCode;
                
                // é‡æ–°è¼‰å…¥åœ˜éšŠè³‡è¨Š
                loadTeamInfo();
                showSection('team');
                
            } catch (error) {
                alert(`åŠ å…¥æˆ°éšŠå¤±æ•—: ${error.message}`);
                console.error('åŠ å…¥æˆ°éšŠéŒ¯èª¤:', error);
            }
        }
        
        // ä¸Šå‚³é ­åƒ
        async function uploadAvatar() {
            const fileInput = document.getElementById('avatar-upload');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) { // 5MB
                alert('åœ–ç‰‡å¤§å°ä¸èƒ½è¶…é 5MB');
                return;
            }
            
            try {
                // ä¸Šå‚³åˆ° Supabase Storage
                const fileExt = file.name.split('.').pop();
                const fileName = `${currentUser.id}/${Date.now()}.${fileExt}`;
                
                const { error: uploadError } = await supabase.storage
                    .from('avatars')
                    .upload(fileName, file);
                
                if (uploadError) throw uploadError;
                
                // å–å¾—å…¬é–‹ URL
                const { data: { publicUrl } } = supabase.storage
                    .from('avatars')
                    .getPublicUrl(fileName);
                
                // æ›´æ–°ä½¿ç”¨è€…è³‡æ–™
                const { error: updateError } = await supabase
                    .from('profiles')
                    .update({ avatar_url: publicUrl })
                    .eq('id', currentUser.id);
                
                if (updateError) throw updateError;
                
                // æ›´æ–°æœ¬åœ°è³‡æ–™å’Œä»‹é¢
                userProfile.avatar_url = publicUrl;
                updateUserUI();
                
                alert('é ­åƒæ›´æ–°æˆåŠŸï¼');
                
            } catch (error) {
                alert(`ä¸Šå‚³é ­åƒå¤±æ•—: ${error.message}`);
                console.error('ä¸Šå‚³é ­åƒéŒ¯èª¤:', error);
            }
        }
        
        // å„²å­˜å€‹äººè¨­å®š
        async function saveProfile() {
            const fullName = document.getElementById('profile-name').value.trim();
            const plan = document.getElementById('profile-plan').value;
            
            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({
                        full_name: fullName,
                        plan: plan,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', currentUser.id);
                
                if (error) throw error;
                
                // æ›´æ–°æœ¬åœ°è³‡æ–™
                userProfile.full_name = fullName;
                userProfile.plan = plan;
                updateUserUI();
                
                alert('å€‹äººè¨­å®šå·²å„²å­˜ï¼');
                
            } catch (error) {
                alert(`å„²å­˜å¤±æ•—: ${error.message}`);
                console.error('å„²å­˜å€‹äººè¨­å®šéŒ¯èª¤:', error);
            }
        }
        
        // ç™»å‡º
        async function logout() {
            const { error } = await supabase.auth.signOut();
            
            if (error) {
                console.error('ç™»å‡ºéŒ¯èª¤:', error);
            }
            
            currentUser = null;
            userProfile = null;
            showAuth();
        }
        
        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // è¼¸å…¥æ¡†å¿«æ·éµ
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    // ESC éµé‡ç½®è¼¸å…¥å€¼
                    const inputs = ['weight', 'fat', 'muscle'];
                    inputs.forEach(type => {
                        const element = document.getElementById(`input-${type}`);
                        if (element) {
                            element.value = type === 'weight' ? '65.0' : 
                                           type === 'fat' ? '25.0' : '30.0';
                        }
                    });
                }
            });
        }
    </script>
</body>
</html>
